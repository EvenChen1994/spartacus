/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { inject, Injectable } from '@angular/core';
import { Store } from '@ngrx/store';
import { UserIdService } from '@spartacus/core';
import { of, using, combineLatest } from 'rxjs';
import { auditTime, filter, map, switchMap, tap } from 'rxjs/operators';
import { OrderActions } from '../store';
import { getOrderById, getOrderByIdEntity, } from '../store/selectors/order-by-id.selector';
import { getConsignmentTrackingById, getConsignmentTrackingByIdEntity, } from '../store/selectors/order-group.selectors';
import { OrderHistoryService } from './order-history.service';
import { OrderReturnRequestService } from './order-return-request.service';
import * as i0 from "@angular/core";
export class MyAccountV2OrderHistoryService {
    constructor() {
        this.orderReturnRequestService = inject(OrderReturnRequestService);
        this.store = inject(Store);
        this.userIdService = inject(UserIdService);
        this.orderHistoryService = inject(OrderHistoryService);
    }
    clearOrderList() {
        this.orderHistoryService.clearOrderList();
    }
    getOrderDetailsWithTracking(orderCode) {
        return this.getOrderDetails(orderCode).pipe(switchMap((order) => {
            //-----------------> filling consignment tracking
            const orderView = { ...order };
            orderView.consignments = [];
            const requests = (order.consignments ?? []).map((consignment) => {
                const consignmentView = { ...consignment };
                if (consignment.code && consignment.trackingID) {
                    return this.getConsignmentTracking(order?.code ?? '', consignment.code).pipe(map((trackingInfo) => {
                        consignmentView.consignmentTracking = trackingInfo;
                        orderView.consignments?.push(consignmentView);
                        return orderView;
                    }));
                }
                else {
                    orderView.consignments?.push(consignmentView);
                    return of(orderView);
                }
            });
            if (requests === undefined || requests.length < 1) {
                return of(orderView);
            }
            return combineLatest(requests).pipe(switchMap((orders) => {
                if (orders !== undefined) {
                    return of(orders[0]);
                }
                else {
                    return of(order);
                }
            }));
            //<-----------------
        }));
    }
    getOrderHistoryListWithDetails(pageSize) {
        const orderListView = {};
        return this.orderHistoryService.getOrderHistoryList(pageSize).pipe(switchMap((orderList) => {
            orderListView.pagination = orderList?.pagination;
            orderListView.sorts = orderList?.sorts;
            orderListView.orders = [];
            const requests = (orderList?.orders ?? []).map((order) => {
                const orderView = { ...order };
                return this.getOrderDetailsWithTracking(order?.code ?? '').pipe(map((orderDetail) => {
                    /** filling extra fields ---> */
                    orderView.returnable = orderDetail?.returnable;
                    orderView.totalItems = orderDetail?.totalItems;
                    orderView.entries = orderDetail?.entries;
                    orderView.consignments = orderDetail?.consignments;
                    orderView.unconsignedEntries = orderDetail?.unconsignedEntries;
                    orderView.returnRequests = [];
                    /** filling extra fields <--- */
                    orderListView.orders?.push(orderView);
                    return orderListView;
                }));
            });
            if (requests.length === 0) {
                // in case of no order
                requests.push(of(orderListView));
            }
            return combineLatest(requests);
        }), map((requests) => {
            if (requests !== undefined) {
                return requests[0];
            }
            else {
                return {};
            }
        }));
    }
    getOrderHistoryList(pageSize) {
        const orderHistoryListRequest = this.getOrderHistoryListWithDetails(pageSize);
        const returnRequestListRequest = this.orderReturnRequestService.getOrderReturnRequestList();
        return combineLatest([
            orderHistoryListRequest,
            returnRequestListRequest,
        ]).pipe(switchMap((responses) => {
            const returnRequests = responses?.[1]?.returnRequests;
            const orderHistory = responses?.[0];
            if (returnRequests && orderHistory?.orders) {
                if (orderHistory.pagination?.totalResults === 0) {
                    return of(orderHistory);
                }
                return orderHistory.orders.map((order) => {
                    const returnItems = returnRequests?.filter((returnItem) => returnItem.order?.code === order.code);
                    if (returnItems) {
                        order.returnRequests = returnItems;
                    }
                    return orderHistory;
                });
            }
            else {
                return of(orderHistory);
            }
        }));
    }
    getOrderDetailsValue(code) {
        return this.store
            .select(getOrderById(code))
            .pipe(filter((order) => Boolean(order)));
    }
    getOrderDetailsState(code) {
        return this.store.select(getOrderByIdEntity(code));
    }
    loadOrderDetails(code) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new OrderActions.LoadOrderById({
                userId,
                code,
            })),
        });
    }
    getOrderDetails(code) {
        const loading$ = this.getOrderDetailsState(code).pipe(auditTime(0), tap((state) => {
            if (!(state.loading || state.success || state.error)) {
                this.loadOrderDetails(code);
            }
        }));
        return using(() => loading$.subscribe(), () => this.getOrderDetailsValue(code));
    }
    getConsignmentTrackingValue(orderCode, consignmentCode) {
        return this.store
            .select(getConsignmentTrackingById(orderCode, consignmentCode))
            .pipe(filter((tracking) => Boolean(tracking)));
    }
    getConsignmentTrackingState(orderCode, consignmentCode) {
        return this.store.select(getConsignmentTrackingByIdEntity(orderCode, consignmentCode));
    }
    loadConsignmentTracking(orderCode, consignmentCode) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new OrderActions.LoadConsignmentTrackingById({
                orderCode,
                consignmentCode,
                userId,
            })),
        });
    }
    getConsignmentTracking(orderCode, consignmentCode) {
        const loading$ = this.getConsignmentTrackingState(orderCode, consignmentCode).pipe(auditTime(0), tap((state) => {
            if (!(state.loading || state.success || state.error)) {
                this.loadConsignmentTracking(orderCode, consignmentCode);
            }
        }));
        return using(() => loading$.subscribe(), () => this.getConsignmentTrackingValue(orderCode, consignmentCode));
    }
}
MyAccountV2OrderHistoryService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: MyAccountV2OrderHistoryService, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
MyAccountV2OrderHistoryService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: MyAccountV2OrderHistoryService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: MyAccountV2OrderHistoryService, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibXktYWNjb3VudC12Mi1vcmRlci1oaXN0b3J5LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvb3JkZXIvY29yZS9mYWNhZGUvbXktYWNjb3VudC12Mi1vcmRlci1oaXN0b3J5LnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7R0FJRztBQUVILE9BQU8sRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUM7QUFDcEMsT0FBTyxFQUFjLGFBQWEsRUFBRSxNQUFNLGlCQUFpQixDQUFDO0FBYTVELE9BQU8sRUFBYyxFQUFFLEVBQUUsS0FBSyxFQUFFLGFBQWEsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM1RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3hFLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSxVQUFVLENBQUM7QUFDeEMsT0FBTyxFQUNMLFlBQVksRUFDWixrQkFBa0IsR0FDbkIsTUFBTSx5Q0FBeUMsQ0FBQztBQUNqRCxPQUFPLEVBQ0wsMEJBQTBCLEVBQzFCLGdDQUFnQyxHQUNqQyxNQUFNLDBDQUEwQyxDQUFDO0FBQ2xELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxNQUFNLHlCQUF5QixDQUFDO0FBQzlELE9BQU8sRUFBRSx5QkFBeUIsRUFBRSxNQUFNLGdDQUFnQyxDQUFDOztBQUczRSxNQUFNLE9BQU8sOEJBQThCO0lBRDNDO1FBRVksOEJBQXlCLEdBQUcsTUFBTSxDQUFDLHlCQUF5QixDQUFDLENBQUM7UUFDOUQsVUFBSyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN0QixrQkFBYSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUN0Qyx3QkFBbUIsR0FBRyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztLQXFPN0Q7SUFuT0MsY0FBYztRQUNaLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUM1QyxDQUFDO0lBQ0QsMkJBQTJCLENBQ3pCLFNBQWlCO1FBRWpCLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLENBQUMsQ0FBQyxJQUFJLENBQ3pDLFNBQVMsQ0FBQyxDQUFDLEtBQVksRUFBRSxFQUFFO1lBQ3pCLGlEQUFpRDtZQUNqRCxNQUFNLFNBQVMsR0FBYyxFQUFFLEdBQUcsS0FBSyxFQUFFLENBQUM7WUFDMUMsU0FBUyxDQUFDLFlBQVksR0FBRyxFQUFFLENBQUM7WUFDNUIsTUFBTSxRQUFRLEdBQUcsQ0FBQyxLQUFLLENBQUMsWUFBWSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FDN0MsQ0FBQyxXQUF3QixFQUFFLEVBQUU7Z0JBQzNCLE1BQU0sZUFBZSxHQUFvQixFQUFFLEdBQUcsV0FBVyxFQUFFLENBQUM7Z0JBQzVELElBQUksV0FBVyxDQUFDLElBQUksSUFBSSxXQUFXLENBQUMsVUFBVSxFQUFFO29CQUM5QyxPQUFPLElBQUksQ0FBQyxzQkFBc0IsQ0FDaEMsS0FBSyxFQUFFLElBQUksSUFBSSxFQUFFLEVBQ2pCLFdBQVcsQ0FBQyxJQUFJLENBQ2pCLENBQUMsSUFBSSxDQUNKLEdBQUcsQ0FBQyxDQUFDLFlBQWlDLEVBQUUsRUFBRTt3QkFDeEMsZUFBZSxDQUFDLG1CQUFtQixHQUFHLFlBQVksQ0FBQzt3QkFDbkQsU0FBUyxDQUFDLFlBQVksRUFBRSxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7d0JBQzlDLE9BQU8sU0FBUyxDQUFDO29CQUNuQixDQUFDLENBQUMsQ0FDSCxDQUFDO2lCQUNIO3FCQUFNO29CQUNMLFNBQVMsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO29CQUM5QyxPQUFPLEVBQUUsQ0FBQyxTQUFTLENBQUMsQ0FBQztpQkFDdEI7WUFDSCxDQUFDLENBQ0YsQ0FBQztZQUNGLElBQUksUUFBUSxLQUFLLFNBQVMsSUFBSSxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtnQkFDakQsT0FBTyxFQUFFLENBQUMsU0FBUyxDQUFDLENBQUM7YUFDdEI7WUFDRCxPQUFPLGFBQWEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxJQUFJLENBQ2pDLFNBQVMsQ0FBQyxDQUFDLE1BQStCLEVBQUUsRUFBRTtnQkFDNUMsSUFBSSxNQUFNLEtBQUssU0FBUyxFQUFFO29CQUN4QixPQUFPLEVBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDdEI7cUJBQU07b0JBQ0wsT0FBTyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7aUJBQ2xCO1lBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQztZQUNGLG9CQUFvQjtRQUN0QixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVELDhCQUE4QixDQUM1QixRQUFnQjtRQUVoQixNQUFNLGFBQWEsR0FBeUIsRUFBRSxDQUFDO1FBQy9DLE9BQU8sSUFBSSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUFDLFFBQVEsQ0FBQyxDQUFDLElBQUksQ0FDaEUsU0FBUyxDQUFDLENBQUMsU0FBdUMsRUFBRSxFQUFFO1lBQ3BELGFBQWEsQ0FBQyxVQUFVLEdBQUcsU0FBUyxFQUFFLFVBQVUsQ0FBQztZQUNqRCxhQUFhLENBQUMsS0FBSyxHQUFHLFNBQVMsRUFBRSxLQUFLLENBQUM7WUFDdkMsYUFBYSxDQUFDLE1BQU0sR0FBRyxFQUFFLENBQUM7WUFDMUIsTUFBTSxRQUFRLEdBQUcsQ0FBQyxTQUFTLEVBQUUsTUFBTSxJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FDNUMsQ0FBQyxLQUFtQixFQUFFLEVBQUU7Z0JBQ3RCLE1BQU0sU0FBUyxHQUFxQixFQUFFLEdBQUcsS0FBSyxFQUFFLENBQUM7Z0JBQ2pELE9BQU8sSUFBSSxDQUFDLDJCQUEyQixDQUFDLEtBQUssRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLENBQUMsSUFBSSxDQUM3RCxHQUFHLENBQUMsQ0FBQyxXQUFrQyxFQUFFLEVBQUU7b0JBQ3pDLGdDQUFnQztvQkFDaEMsU0FBUyxDQUFDLFVBQVUsR0FBRyxXQUFXLEVBQUUsVUFBVSxDQUFDO29CQUMvQyxTQUFTLENBQUMsVUFBVSxHQUFHLFdBQVcsRUFBRSxVQUFVLENBQUM7b0JBQy9DLFNBQVMsQ0FBQyxPQUFPLEdBQUcsV0FBVyxFQUFFLE9BQU8sQ0FBQztvQkFDekMsU0FBUyxDQUFDLFlBQVksR0FBRyxXQUFXLEVBQUUsWUFBWSxDQUFDO29CQUNuRCxTQUFTLENBQUMsa0JBQWtCLEdBQUcsV0FBVyxFQUFFLGtCQUFrQixDQUFDO29CQUMvRCxTQUFTLENBQUMsY0FBYyxHQUFHLEVBQUUsQ0FBQztvQkFDOUIsZ0NBQWdDO29CQUNoQyxhQUFhLENBQUMsTUFBTSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztvQkFDdEMsT0FBTyxhQUFhLENBQUM7Z0JBQ3ZCLENBQUMsQ0FBQyxDQUNILENBQUM7WUFDSixDQUFDLENBQ0YsQ0FBQztZQUNGLElBQUksUUFBUSxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUU7Z0JBQ3pCLHNCQUFzQjtnQkFDdEIsUUFBUSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQzthQUNsQztZQUNELE9BQU8sYUFBYSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ2pDLENBQUMsQ0FBQyxFQUNGLEdBQUcsQ0FBQyxDQUFDLFFBQTRDLEVBQUUsRUFBRTtZQUNuRCxJQUFJLFFBQVEsS0FBSyxTQUFTLEVBQUU7Z0JBQzFCLE9BQU8sUUFBUSxDQUFDLENBQUMsQ0FBQyxDQUFDO2FBQ3BCO2lCQUFNO2dCQUNMLE9BQU8sRUFBRSxDQUFDO2FBQ1g7UUFDSCxDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVELG1CQUFtQixDQUNqQixRQUFnQjtRQUVoQixNQUFNLHVCQUF1QixHQUMzQixJQUFJLENBQUMsOEJBQThCLENBQUMsUUFBUSxDQUFDLENBQUM7UUFDaEQsTUFBTSx3QkFBd0IsR0FDNUIsSUFBSSxDQUFDLHlCQUF5QixDQUFDLHlCQUF5QixFQUFFLENBQUM7UUFDN0QsT0FBTyxhQUFhLENBQUM7WUFDbkIsdUJBQXVCO1lBQ3ZCLHdCQUF3QjtTQUN6QixDQUFDLENBQUMsSUFBSSxDQUNMLFNBQVMsQ0FDUCxDQUNFLFNBR0MsRUFDRCxFQUFFO1lBQ0YsTUFBTSxjQUFjLEdBQUcsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsY0FBYyxDQUFDO1lBQ3RELE1BQU0sWUFBWSxHQUFHLFNBQVMsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3BDLElBQUksY0FBYyxJQUFJLFlBQVksRUFBRSxNQUFNLEVBQUU7Z0JBQzFDLElBQUksWUFBWSxDQUFDLFVBQVUsRUFBRSxZQUFZLEtBQUssQ0FBQyxFQUFFO29CQUMvQyxPQUFPLEVBQUUsQ0FBQyxZQUFZLENBQUMsQ0FBQztpQkFDekI7Z0JBQ0QsT0FBTyxZQUFZLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFO29CQUN2QyxNQUFNLFdBQVcsR0FBRyxjQUFjLEVBQUUsTUFBTSxDQUN4QyxDQUFDLFVBQVUsRUFBRSxFQUFFLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxJQUFJLEtBQUssS0FBSyxDQUFDLElBQUksQ0FDdEQsQ0FBQztvQkFDRixJQUFJLFdBQVcsRUFBRTt3QkFDZixLQUFLLENBQUMsY0FBYyxHQUFHLFdBQVcsQ0FBQztxQkFDcEM7b0JBQ0QsT0FBTyxZQUFZLENBQUM7Z0JBQ3RCLENBQUMsQ0FBQyxDQUFDO2FBQ0o7aUJBQU07Z0JBQ0wsT0FBTyxFQUFFLENBQUMsWUFBWSxDQUFDLENBQUM7YUFDekI7UUFDSCxDQUFDLENBQ0YsQ0FDRixDQUFDO0lBQ0osQ0FBQztJQUVTLG9CQUFvQixDQUFDLElBQVk7UUFDekMsT0FBTyxJQUFJLENBQUMsS0FBSzthQUNkLE1BQU0sQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7YUFDMUIsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBRVMsb0JBQW9CLENBQzVCLElBQVk7UUFFWixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUM7SUFDckQsQ0FBQztJQUVTLGdCQUFnQixDQUFDLElBQVk7UUFDckMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDO1lBQzVDLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQ2pCLElBQUksWUFBWSxDQUFDLGFBQWEsQ0FBQztnQkFDN0IsTUFBTTtnQkFDTixJQUFJO2FBQ0wsQ0FBQyxDQUNIO1NBQ0osQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGVBQWUsQ0FBQyxJQUFZO1FBQzFCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQ25ELFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFDWixHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRTtZQUNaLElBQUksQ0FBQyxDQUFDLEtBQUssQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLE9BQU8sSUFBSSxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUU7Z0JBQ3BELElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxJQUFJLENBQUMsQ0FBQzthQUM3QjtRQUNILENBQUMsQ0FBQyxDQUNILENBQUM7UUFDRixPQUFPLEtBQUssQ0FDVixHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsU0FBUyxFQUFFLEVBQzFCLEdBQUcsRUFBRSxDQUFDLElBQUksQ0FBQyxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsQ0FDdEMsQ0FBQztJQUNKLENBQUM7SUFFUywyQkFBMkIsQ0FDbkMsU0FBaUIsRUFDakIsZUFBdUI7UUFFdkIsT0FBTyxJQUFJLENBQUMsS0FBSzthQUNkLE1BQU0sQ0FBQywwQkFBMEIsQ0FBQyxTQUFTLEVBQUUsZUFBZSxDQUFDLENBQUM7YUFDOUQsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuRCxDQUFDO0lBRVMsMkJBQTJCLENBQ25DLFNBQWlCLEVBQ2pCLGVBQXVCO1FBRXZCLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQ3RCLGdDQUFnQyxDQUFDLFNBQVMsRUFBRSxlQUFlLENBQUMsQ0FDN0QsQ0FBQztJQUNKLENBQUM7SUFFUyx1QkFBdUIsQ0FDL0IsU0FBaUIsRUFDakIsZUFBdUI7UUFFdkIsSUFBSSxDQUFDLGFBQWEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLENBQUMsU0FBUyxDQUFDO1lBQzVDLElBQUksRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFLENBQ2YsSUFBSSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQ2pCLElBQUksWUFBWSxDQUFDLDJCQUEyQixDQUFDO2dCQUMzQyxTQUFTO2dCQUNULGVBQWU7Z0JBQ2YsTUFBTTthQUNQLENBQUMsQ0FDSDtTQUNKLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRCxzQkFBc0IsQ0FDcEIsU0FBaUIsRUFDakIsZUFBdUI7UUFFdkIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLDJCQUEyQixDQUMvQyxTQUFTLEVBQ1QsZUFBZSxDQUNoQixDQUFDLElBQUksQ0FDSixTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQ1osR0FBRyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7WUFDWixJQUFJLENBQUMsQ0FBQyxLQUFLLENBQUMsT0FBTyxJQUFJLEtBQUssQ0FBQyxPQUFPLElBQUksS0FBSyxDQUFDLEtBQUssQ0FBQyxFQUFFO2dCQUNwRCxJQUFJLENBQUMsdUJBQXVCLENBQUMsU0FBUyxFQUFFLGVBQWUsQ0FBQyxDQUFDO2FBQzFEO1FBQ0gsQ0FBQyxDQUFDLENBQ0gsQ0FBQztRQUVGLE9BQU8sS0FBSyxDQUNWLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxTQUFTLEVBQUUsRUFDMUIsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLFNBQVMsRUFBRSxlQUFlLENBQUMsQ0FDbkUsQ0FBQztJQUNKLENBQUM7OzJIQXhPVSw4QkFBOEI7K0hBQTlCLDhCQUE4QjsyRkFBOUIsOEJBQThCO2tCQUQxQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgaW5qZWN0LCBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBTdG9yZSB9IGZyb20gJ0BuZ3J4L3N0b3JlJztcbmltcG9ydCB7IFN0YXRlVXRpbHMsIFVzZXJJZFNlcnZpY2UgfSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHtcbiAgQ29uc2lnbm1lbnQsXG4gIENvbnNpZ25tZW50VHJhY2tpbmcsXG4gIENvbnNpZ25tZW50VmlldyxcbiAgT3JkZXIsXG4gIE9yZGVySGlzdG9yeSxcbiAgT3JkZXJIaXN0b3J5TGlzdCxcbiAgT3JkZXJIaXN0b3J5TGlzdFZpZXcsXG4gIE9yZGVySGlzdG9yeVZpZXcsXG4gIE9yZGVyVmlldyxcbiAgUmV0dXJuUmVxdWVzdExpc3QsXG59IGZyb20gJ0BzcGFydGFjdXMvb3JkZXIvcm9vdCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgdXNpbmcsIGNvbWJpbmVMYXRlc3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGF1ZGl0VGltZSwgZmlsdGVyLCBtYXAsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgT3JkZXJBY3Rpb25zIH0gZnJvbSAnLi4vc3RvcmUnO1xuaW1wb3J0IHtcbiAgZ2V0T3JkZXJCeUlkLFxuICBnZXRPcmRlckJ5SWRFbnRpdHksXG59IGZyb20gJy4uL3N0b3JlL3NlbGVjdG9ycy9vcmRlci1ieS1pZC5zZWxlY3Rvcic7XG5pbXBvcnQge1xuICBnZXRDb25zaWdubWVudFRyYWNraW5nQnlJZCxcbiAgZ2V0Q29uc2lnbm1lbnRUcmFja2luZ0J5SWRFbnRpdHksXG59IGZyb20gJy4uL3N0b3JlL3NlbGVjdG9ycy9vcmRlci1ncm91cC5zZWxlY3RvcnMnO1xuaW1wb3J0IHsgT3JkZXJIaXN0b3J5U2VydmljZSB9IGZyb20gJy4vb3JkZXItaGlzdG9yeS5zZXJ2aWNlJztcbmltcG9ydCB7IE9yZGVyUmV0dXJuUmVxdWVzdFNlcnZpY2UgfSBmcm9tICcuL29yZGVyLXJldHVybi1yZXF1ZXN0LnNlcnZpY2UnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgTXlBY2NvdW50VjJPcmRlckhpc3RvcnlTZXJ2aWNlIHtcbiAgcHJvdGVjdGVkIG9yZGVyUmV0dXJuUmVxdWVzdFNlcnZpY2UgPSBpbmplY3QoT3JkZXJSZXR1cm5SZXF1ZXN0U2VydmljZSk7XG4gIHByb3RlY3RlZCBzdG9yZSA9IGluamVjdChTdG9yZSk7XG4gIHByb3RlY3RlZCB1c2VySWRTZXJ2aWNlID0gaW5qZWN0KFVzZXJJZFNlcnZpY2UpO1xuICBwcm90ZWN0ZWQgb3JkZXJIaXN0b3J5U2VydmljZSA9IGluamVjdChPcmRlckhpc3RvcnlTZXJ2aWNlKTtcblxuICBjbGVhck9yZGVyTGlzdCgpOiB2b2lkIHtcbiAgICB0aGlzLm9yZGVySGlzdG9yeVNlcnZpY2UuY2xlYXJPcmRlckxpc3QoKTtcbiAgfVxuICBnZXRPcmRlckRldGFpbHNXaXRoVHJhY2tpbmcoXG4gICAgb3JkZXJDb2RlOiBzdHJpbmdcbiAgKTogT2JzZXJ2YWJsZTxPcmRlclZpZXcgfCB1bmRlZmluZWQ+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRPcmRlckRldGFpbHMob3JkZXJDb2RlKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChvcmRlcjogT3JkZXIpID0+IHtcbiAgICAgICAgLy8tLS0tLS0tLS0tLS0tLS0tLT4gZmlsbGluZyBjb25zaWdubWVudCB0cmFja2luZ1xuICAgICAgICBjb25zdCBvcmRlclZpZXc6IE9yZGVyVmlldyA9IHsgLi4ub3JkZXIgfTtcbiAgICAgICAgb3JkZXJWaWV3LmNvbnNpZ25tZW50cyA9IFtdO1xuICAgICAgICBjb25zdCByZXF1ZXN0cyA9IChvcmRlci5jb25zaWdubWVudHMgPz8gW10pLm1hcChcbiAgICAgICAgICAoY29uc2lnbm1lbnQ6IENvbnNpZ25tZW50KSA9PiB7XG4gICAgICAgICAgICBjb25zdCBjb25zaWdubWVudFZpZXc6IENvbnNpZ25tZW50VmlldyA9IHsgLi4uY29uc2lnbm1lbnQgfTtcbiAgICAgICAgICAgIGlmIChjb25zaWdubWVudC5jb2RlICYmIGNvbnNpZ25tZW50LnRyYWNraW5nSUQpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29uc2lnbm1lbnRUcmFja2luZyhcbiAgICAgICAgICAgICAgICBvcmRlcj8uY29kZSA/PyAnJyxcbiAgICAgICAgICAgICAgICBjb25zaWdubWVudC5jb2RlXG4gICAgICAgICAgICAgICkucGlwZShcbiAgICAgICAgICAgICAgICBtYXAoKHRyYWNraW5nSW5mbzogQ29uc2lnbm1lbnRUcmFja2luZykgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc2lnbm1lbnRWaWV3LmNvbnNpZ25tZW50VHJhY2tpbmcgPSB0cmFja2luZ0luZm87XG4gICAgICAgICAgICAgICAgICBvcmRlclZpZXcuY29uc2lnbm1lbnRzPy5wdXNoKGNvbnNpZ25tZW50Vmlldyk7XG4gICAgICAgICAgICAgICAgICByZXR1cm4gb3JkZXJWaWV3O1xuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBvcmRlclZpZXcuY29uc2lnbm1lbnRzPy5wdXNoKGNvbnNpZ25tZW50Vmlldyk7XG4gICAgICAgICAgICAgIHJldHVybiBvZihvcmRlclZpZXcpO1xuICAgICAgICAgICAgfVxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgaWYgKHJlcXVlc3RzID09PSB1bmRlZmluZWQgfHwgcmVxdWVzdHMubGVuZ3RoIDwgMSkge1xuICAgICAgICAgIHJldHVybiBvZihvcmRlclZpZXcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KHJlcXVlc3RzKS5waXBlKFxuICAgICAgICAgIHN3aXRjaE1hcCgob3JkZXJzOiBPcmRlclZpZXdbXSB8IHVuZGVmaW5lZCkgPT4ge1xuICAgICAgICAgICAgaWYgKG9yZGVycyAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgICAgICAgIHJldHVybiBvZihvcmRlcnNbMF0pO1xuICAgICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKG9yZGVyKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgICAvLzwtLS0tLS0tLS0tLS0tLS0tLVxuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgZ2V0T3JkZXJIaXN0b3J5TGlzdFdpdGhEZXRhaWxzKFxuICAgIHBhZ2VTaXplOiBudW1iZXJcbiAgKTogT2JzZXJ2YWJsZTxPcmRlckhpc3RvcnlMaXN0VmlldyB8IHVuZGVmaW5lZD4ge1xuICAgIGNvbnN0IG9yZGVyTGlzdFZpZXc6IE9yZGVySGlzdG9yeUxpc3RWaWV3ID0ge307XG4gICAgcmV0dXJuIHRoaXMub3JkZXJIaXN0b3J5U2VydmljZS5nZXRPcmRlckhpc3RvcnlMaXN0KHBhZ2VTaXplKS5waXBlKFxuICAgICAgc3dpdGNoTWFwKChvcmRlckxpc3Q6IE9yZGVySGlzdG9yeUxpc3QgfCB1bmRlZmluZWQpID0+IHtcbiAgICAgICAgb3JkZXJMaXN0Vmlldy5wYWdpbmF0aW9uID0gb3JkZXJMaXN0Py5wYWdpbmF0aW9uO1xuICAgICAgICBvcmRlckxpc3RWaWV3LnNvcnRzID0gb3JkZXJMaXN0Py5zb3J0cztcbiAgICAgICAgb3JkZXJMaXN0Vmlldy5vcmRlcnMgPSBbXTtcbiAgICAgICAgY29uc3QgcmVxdWVzdHMgPSAob3JkZXJMaXN0Py5vcmRlcnMgPz8gW10pLm1hcChcbiAgICAgICAgICAob3JkZXI6IE9yZGVySGlzdG9yeSkgPT4ge1xuICAgICAgICAgICAgY29uc3Qgb3JkZXJWaWV3OiBPcmRlckhpc3RvcnlWaWV3ID0geyAuLi5vcmRlciB9O1xuICAgICAgICAgICAgcmV0dXJuIHRoaXMuZ2V0T3JkZXJEZXRhaWxzV2l0aFRyYWNraW5nKG9yZGVyPy5jb2RlID8/ICcnKS5waXBlKFxuICAgICAgICAgICAgICBtYXAoKG9yZGVyRGV0YWlsOiBPcmRlclZpZXcgfCB1bmRlZmluZWQpID0+IHtcbiAgICAgICAgICAgICAgICAvKiogZmlsbGluZyBleHRyYSBmaWVsZHMgLS0tPiAqL1xuICAgICAgICAgICAgICAgIG9yZGVyVmlldy5yZXR1cm5hYmxlID0gb3JkZXJEZXRhaWw/LnJldHVybmFibGU7XG4gICAgICAgICAgICAgICAgb3JkZXJWaWV3LnRvdGFsSXRlbXMgPSBvcmRlckRldGFpbD8udG90YWxJdGVtcztcbiAgICAgICAgICAgICAgICBvcmRlclZpZXcuZW50cmllcyA9IG9yZGVyRGV0YWlsPy5lbnRyaWVzO1xuICAgICAgICAgICAgICAgIG9yZGVyVmlldy5jb25zaWdubWVudHMgPSBvcmRlckRldGFpbD8uY29uc2lnbm1lbnRzO1xuICAgICAgICAgICAgICAgIG9yZGVyVmlldy51bmNvbnNpZ25lZEVudHJpZXMgPSBvcmRlckRldGFpbD8udW5jb25zaWduZWRFbnRyaWVzO1xuICAgICAgICAgICAgICAgIG9yZGVyVmlldy5yZXR1cm5SZXF1ZXN0cyA9IFtdO1xuICAgICAgICAgICAgICAgIC8qKiBmaWxsaW5nIGV4dHJhIGZpZWxkcyA8LS0tICovXG4gICAgICAgICAgICAgICAgb3JkZXJMaXN0Vmlldy5vcmRlcnM/LnB1c2gob3JkZXJWaWV3KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gb3JkZXJMaXN0VmlldztcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICApO1xuICAgICAgICBpZiAocmVxdWVzdHMubGVuZ3RoID09PSAwKSB7XG4gICAgICAgICAgLy8gaW4gY2FzZSBvZiBubyBvcmRlclxuICAgICAgICAgIHJlcXVlc3RzLnB1c2gob2Yob3JkZXJMaXN0VmlldykpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KHJlcXVlc3RzKTtcbiAgICAgIH0pLFxuICAgICAgbWFwKChyZXF1ZXN0czogT3JkZXJIaXN0b3J5TGlzdFZpZXdbXSB8IHVuZGVmaW5lZCkgPT4ge1xuICAgICAgICBpZiAocmVxdWVzdHMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICAgIHJldHVybiByZXF1ZXN0c1swXTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICByZXR1cm4ge307XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIGdldE9yZGVySGlzdG9yeUxpc3QoXG4gICAgcGFnZVNpemU6IG51bWJlclxuICApOiBPYnNlcnZhYmxlPE9yZGVySGlzdG9yeUxpc3RWaWV3IHwgdW5kZWZpbmVkPiB7XG4gICAgY29uc3Qgb3JkZXJIaXN0b3J5TGlzdFJlcXVlc3QgPVxuICAgICAgdGhpcy5nZXRPcmRlckhpc3RvcnlMaXN0V2l0aERldGFpbHMocGFnZVNpemUpO1xuICAgIGNvbnN0IHJldHVyblJlcXVlc3RMaXN0UmVxdWVzdCA9XG4gICAgICB0aGlzLm9yZGVyUmV0dXJuUmVxdWVzdFNlcnZpY2UuZ2V0T3JkZXJSZXR1cm5SZXF1ZXN0TGlzdCgpO1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIG9yZGVySGlzdG9yeUxpc3RSZXF1ZXN0LFxuICAgICAgcmV0dXJuUmVxdWVzdExpc3RSZXF1ZXN0LFxuICAgIF0pLnBpcGUoXG4gICAgICBzd2l0Y2hNYXAoXG4gICAgICAgIChcbiAgICAgICAgICByZXNwb25zZXM6IFtcbiAgICAgICAgICAgIE9yZGVySGlzdG9yeUxpc3RWaWV3IHwgdW5kZWZpbmVkLFxuICAgICAgICAgICAgUmV0dXJuUmVxdWVzdExpc3QgfCB1bmRlZmluZWRcbiAgICAgICAgICBdXG4gICAgICAgICkgPT4ge1xuICAgICAgICAgIGNvbnN0IHJldHVyblJlcXVlc3RzID0gcmVzcG9uc2VzPy5bMV0/LnJldHVyblJlcXVlc3RzO1xuICAgICAgICAgIGNvbnN0IG9yZGVySGlzdG9yeSA9IHJlc3BvbnNlcz8uWzBdO1xuICAgICAgICAgIGlmIChyZXR1cm5SZXF1ZXN0cyAmJiBvcmRlckhpc3Rvcnk/Lm9yZGVycykge1xuICAgICAgICAgICAgaWYgKG9yZGVySGlzdG9yeS5wYWdpbmF0aW9uPy50b3RhbFJlc3VsdHMgPT09IDApIHtcbiAgICAgICAgICAgICAgcmV0dXJuIG9mKG9yZGVySGlzdG9yeSk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICByZXR1cm4gb3JkZXJIaXN0b3J5Lm9yZGVycy5tYXAoKG9yZGVyKSA9PiB7XG4gICAgICAgICAgICAgIGNvbnN0IHJldHVybkl0ZW1zID0gcmV0dXJuUmVxdWVzdHM/LmZpbHRlcihcbiAgICAgICAgICAgICAgICAocmV0dXJuSXRlbSkgPT4gcmV0dXJuSXRlbS5vcmRlcj8uY29kZSA9PT0gb3JkZXIuY29kZVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICBpZiAocmV0dXJuSXRlbXMpIHtcbiAgICAgICAgICAgICAgICBvcmRlci5yZXR1cm5SZXF1ZXN0cyA9IHJldHVybkl0ZW1zO1xuICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIHJldHVybiBvcmRlckhpc3Rvcnk7XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG9mKG9yZGVySGlzdG9yeSk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRPcmRlckRldGFpbHNWYWx1ZShjb2RlOiBzdHJpbmcpOiBPYnNlcnZhYmxlPE9yZGVyPiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmVcbiAgICAgIC5zZWxlY3QoZ2V0T3JkZXJCeUlkKGNvZGUpKVxuICAgICAgLnBpcGUoZmlsdGVyKChvcmRlcikgPT4gQm9vbGVhbihvcmRlcikpKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRPcmRlckRldGFpbHNTdGF0ZShcbiAgICBjb2RlOiBzdHJpbmdcbiAgKTogT2JzZXJ2YWJsZTxTdGF0ZVV0aWxzLkxvYWRlclN0YXRlPE9yZGVyPj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnNlbGVjdChnZXRPcmRlckJ5SWRFbnRpdHkoY29kZSkpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGxvYWRPcmRlckRldGFpbHMoY29kZTogc3RyaW5nKSB7XG4gICAgdGhpcy51c2VySWRTZXJ2aWNlLnRha2VVc2VySWQodHJ1ZSkuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6ICh1c2VySWQpID0+XG4gICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICAgICAgbmV3IE9yZGVyQWN0aW9ucy5Mb2FkT3JkZXJCeUlkKHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIGNvZGUsXG4gICAgICAgICAgfSlcbiAgICAgICAgKSxcbiAgICB9KTtcbiAgfVxuXG4gIGdldE9yZGVyRGV0YWlscyhjb2RlOiBzdHJpbmcpOiBPYnNlcnZhYmxlPE9yZGVyPiB7XG4gICAgY29uc3QgbG9hZGluZyQgPSB0aGlzLmdldE9yZGVyRGV0YWlsc1N0YXRlKGNvZGUpLnBpcGUoXG4gICAgICBhdWRpdFRpbWUoMCksXG4gICAgICB0YXAoKHN0YXRlKSA9PiB7XG4gICAgICAgIGlmICghKHN0YXRlLmxvYWRpbmcgfHwgc3RhdGUuc3VjY2VzcyB8fCBzdGF0ZS5lcnJvcikpIHtcbiAgICAgICAgICB0aGlzLmxvYWRPcmRlckRldGFpbHMoY29kZSk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcbiAgICByZXR1cm4gdXNpbmcoXG4gICAgICAoKSA9PiBsb2FkaW5nJC5zdWJzY3JpYmUoKSxcbiAgICAgICgpID0+IHRoaXMuZ2V0T3JkZXJEZXRhaWxzVmFsdWUoY29kZSlcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldENvbnNpZ25tZW50VHJhY2tpbmdWYWx1ZShcbiAgICBvcmRlckNvZGU6IHN0cmluZyxcbiAgICBjb25zaWdubWVudENvZGU6IHN0cmluZ1xuICApOiBPYnNlcnZhYmxlPENvbnNpZ25tZW50VHJhY2tpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZVxuICAgICAgLnNlbGVjdChnZXRDb25zaWdubWVudFRyYWNraW5nQnlJZChvcmRlckNvZGUsIGNvbnNpZ25tZW50Q29kZSkpXG4gICAgICAucGlwZShmaWx0ZXIoKHRyYWNraW5nKSA9PiBCb29sZWFuKHRyYWNraW5nKSkpO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldENvbnNpZ25tZW50VHJhY2tpbmdTdGF0ZShcbiAgICBvcmRlckNvZGU6IHN0cmluZyxcbiAgICBjb25zaWdubWVudENvZGU6IHN0cmluZ1xuICApOiBPYnNlcnZhYmxlPFN0YXRlVXRpbHMuTG9hZGVyU3RhdGU8Q29uc2lnbm1lbnRUcmFja2luZz4+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5zZWxlY3QoXG4gICAgICBnZXRDb25zaWdubWVudFRyYWNraW5nQnlJZEVudGl0eShvcmRlckNvZGUsIGNvbnNpZ25tZW50Q29kZSlcbiAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGxvYWRDb25zaWdubWVudFRyYWNraW5nKFxuICAgIG9yZGVyQ29kZTogc3RyaW5nLFxuICAgIGNvbnNpZ25tZW50Q29kZTogc3RyaW5nXG4gICkge1xuICAgIHRoaXMudXNlcklkU2VydmljZS50YWtlVXNlcklkKHRydWUpLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiAodXNlcklkKSA9PlxuICAgICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKFxuICAgICAgICAgIG5ldyBPcmRlckFjdGlvbnMuTG9hZENvbnNpZ25tZW50VHJhY2tpbmdCeUlkKHtcbiAgICAgICAgICAgIG9yZGVyQ29kZSxcbiAgICAgICAgICAgIGNvbnNpZ25tZW50Q29kZSxcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICB9KVxuICAgICAgICApLFxuICAgIH0pO1xuICB9XG5cbiAgZ2V0Q29uc2lnbm1lbnRUcmFja2luZyhcbiAgICBvcmRlckNvZGU6IHN0cmluZyxcbiAgICBjb25zaWdubWVudENvZGU6IHN0cmluZ1xuICApOiBPYnNlcnZhYmxlPENvbnNpZ25tZW50VHJhY2tpbmc+IHtcbiAgICBjb25zdCBsb2FkaW5nJCA9IHRoaXMuZ2V0Q29uc2lnbm1lbnRUcmFja2luZ1N0YXRlKFxuICAgICAgb3JkZXJDb2RlLFxuICAgICAgY29uc2lnbm1lbnRDb2RlXG4gICAgKS5waXBlKFxuICAgICAgYXVkaXRUaW1lKDApLFxuICAgICAgdGFwKChzdGF0ZSkgPT4ge1xuICAgICAgICBpZiAoIShzdGF0ZS5sb2FkaW5nIHx8IHN0YXRlLnN1Y2Nlc3MgfHwgc3RhdGUuZXJyb3IpKSB7XG4gICAgICAgICAgdGhpcy5sb2FkQ29uc2lnbm1lbnRUcmFja2luZyhvcmRlckNvZGUsIGNvbnNpZ25tZW50Q29kZSk7XG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgKTtcblxuICAgIHJldHVybiB1c2luZyhcbiAgICAgICgpID0+IGxvYWRpbmckLnN1YnNjcmliZSgpLFxuICAgICAgKCkgPT4gdGhpcy5nZXRDb25zaWdubWVudFRyYWNraW5nVmFsdWUob3JkZXJDb2RlLCBjb25zaWdubWVudENvZGUpXG4gICAgKTtcbiAgfVxufVxuIl19