import { Injectable, inject } from '@angular/core';
import { createEffect, ofType } from '@ngrx/effects';
import { CartActions } from '@spartacus/cart/base/core';
import { GlobalMessageType, LoggerService, normalizeHttpError, } from '@spartacus/core';
import { of } from 'rxjs';
import { catchError, map, switchMap, withLatestFrom } from 'rxjs/operators';
import { SavedCartActions } from '../actions/index';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
import * as i2 from "../../connectors/saved-cart.connector";
import * as i3 from "@spartacus/cart/base/root";
import * as i4 from "@spartacus/core";
import * as i5 from "@spartacus/cart/base/core";
export class SavedCartEffects {
    constructor(actions$, savedCartConnector, activeCartService, globalMessageService, cartConnector) {
        this.actions$ = actions$;
        this.savedCartConnector = savedCartConnector;
        this.activeCartService = activeCartService;
        this.globalMessageService = globalMessageService;
        this.cartConnector = cartConnector;
        this.logger = inject(LoggerService);
        this.loadSavedCart$ = createEffect(() => this.actions$.pipe(ofType(SavedCartActions.LOAD_SAVED_CART), map((action) => action.payload), switchMap(({ userId, cartId }) => this.savedCartConnector.get(userId, cartId).pipe(switchMap((savedCart) => {
            return [
                new CartActions.LoadCartSuccess({
                    userId,
                    cartId,
                    cart: savedCart,
                }),
                new SavedCartActions.LoadSavedCartSuccess({ userId, cartId }),
            ];
        }), catchError((error) => of(new SavedCartActions.LoadSavedCartFail({
            userId,
            cartId,
            error: normalizeHttpError(error, this.logger),
        })))))));
        this.loadSavedCarts$ = createEffect(() => this.actions$.pipe(ofType(SavedCartActions.LOAD_SAVED_CARTS), map((action) => action.payload), switchMap(({ userId }) => this.savedCartConnector.getList(userId).pipe(switchMap((savedCarts) => {
            return [
                new CartActions.LoadCartsSuccess(savedCarts),
                new SavedCartActions.LoadSavedCartsSuccess({ userId }),
            ];
        }), catchError((error) => of(new SavedCartActions.LoadSavedCartsFail({
            userId,
            error: normalizeHttpError(error, this.logger),
        })))))));
        this.restoreSavedCart$ = createEffect(() => this.actions$.pipe(ofType(SavedCartActions.RESTORE_SAVED_CART), map((action) => action.payload), withLatestFrom(this.activeCartService.getActive()), switchMap(([{ userId, cartId }, activeCart]) => {
            const actions = [];
            if ((activeCart?.entries ?? []).length > 0) {
                if (activeCart.code) {
                    /**
                     * Instead of calling the SaveCartAction, we are calling the edit saved cart
                     * because we do not want to clear the state when we swap carts between active and saved cart
                     */
                    actions.push(new SavedCartActions.EditSavedCart({
                        userId,
                        cartId: activeCart.code,
                        saveCartName: '',
                        saveCartDescription: '',
                    }));
                }
            }
            return this.savedCartConnector.restoreSavedCart(userId, cartId).pipe(switchMap((savedCart) => {
                this.globalMessageService.add({
                    key: (activeCart?.entries ?? []).length > 0
                        ? 'savedCartList.swapCartWithActiveCart'
                        : 'savedCartList.swapCartNoActiveCart',
                    params: {
                        cartName: cartId,
                        previousCartName: activeCart.code,
                    },
                }, GlobalMessageType.MSG_TYPE_CONFIRMATION);
                return [
                    ...actions,
                    new CartActions.LoadCartSuccess({
                        userId,
                        cartId,
                        cart: savedCart,
                        extraData: { active: true },
                    }),
                    new SavedCartActions.RestoreSavedCartSuccess({ userId, cartId }),
                ];
            }), catchError((error) => of(new SavedCartActions.RestoreSavedCartFail({
                userId,
                cartId,
                error: normalizeHttpError(error, this.logger),
            }))));
        })));
        this.saveCart$ = createEffect(() => this.actions$.pipe(ofType(SavedCartActions.SAVE_CART), map((action) => action.payload), switchMap(({ userId, cartId, saveCartName, saveCartDescription }) => {
            return this.cartConnector
                .save(userId, cartId, saveCartName, saveCartDescription)
                .pipe(switchMap((savedCart) => {
                return [
                    new CartActions.ClearCartState(),
                    new CartActions.LoadCartSuccess({
                        userId,
                        cartId,
                        cart: savedCart,
                    }),
                    new SavedCartActions.SaveCartSuccess({
                        userId,
                        cartId,
                        saveCartName,
                        saveCartDescription,
                    }),
                ];
            }), catchError((error) => of(new SavedCartActions.SaveCartFail({
                userId,
                cartId,
                saveCartName,
                saveCartDescription,
                error: normalizeHttpError(error, this.logger),
            }))));
        })));
        this.editSavedCart$ = createEffect(() => this.actions$.pipe(ofType(SavedCartActions.EDIT_SAVED_CART), map((action) => action.payload), switchMap(({ userId, cartId, saveCartName, saveCartDescription }) => {
            return this.cartConnector
                .save(userId, cartId, saveCartName, saveCartDescription)
                .pipe(switchMap((savedCart) => {
                return [
                    new CartActions.LoadCartSuccess({
                        userId,
                        cartId,
                        cart: savedCart,
                    }),
                    new SavedCartActions.EditSavedCartSuccess({
                        userId,
                        cartId,
                        saveCartName,
                        saveCartDescription,
                    }),
                ];
            }), catchError((error) => of(new SavedCartActions.EditSavedCartFail({
                userId,
                cartId,
                saveCartName,
                saveCartDescription,
                error: normalizeHttpError(error, this.logger),
            }))));
        })));
        this.cloneSavedCart$ = createEffect(() => this.actions$.pipe(ofType(SavedCartActions.CLONE_SAVED_CART), map((action) => action.payload), switchMap(({ userId, cartId, saveCartName }) => {
            return this.savedCartConnector
                .cloneSavedCart(userId, cartId, saveCartName)
                .pipe(switchMap((_) => {
                return [
                    new SavedCartActions.CloneSavedCartSuccess({
                        userId,
                        cartId,
                        saveCartName,
                    }),
                    new SavedCartActions.RestoreSavedCart({
                        userId,
                        cartId,
                    }),
                    new SavedCartActions.LoadSavedCarts({ userId }),
                ];
            }), catchError((error) => of(new SavedCartActions.CloneSavedCartFail({
                userId,
                cartId,
                saveCartName,
                error: normalizeHttpError(error, this.logger),
            }))));
        })));
    }
}
SavedCartEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: SavedCartEffects, deps: [{ token: i1.Actions }, { token: i2.SavedCartConnector }, { token: i3.ActiveCartFacade }, { token: i4.GlobalMessageService }, { token: i5.CartConnector }], target: i0.ɵɵFactoryTarget.Injectable });
SavedCartEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: SavedCartEffects });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: SavedCartEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }, { type: i2.SavedCartConnector }, { type: i3.ActiveCartFacade }, { type: i4.GlobalMessageService }, { type: i5.CartConnector }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2F2ZWQtY2FydC5lZmZlY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvY2FydC9zYXZlZC1jYXJ0L2NvcmUvc3RvcmUvZWZmZWN0cy9zYXZlZC1jYXJ0LmVmZmVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFPQSxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQVcsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM5RCxPQUFPLEVBQUUsV0FBVyxFQUFpQixNQUFNLDJCQUEyQixDQUFDO0FBRXZFLE9BQU8sRUFFTCxpQkFBaUIsRUFDakIsYUFBYSxFQUNiLGtCQUFrQixHQUNuQixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBYyxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDdEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLGNBQWMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRTVFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLGtCQUFrQixDQUFDOzs7Ozs7O0FBR3BELE1BQU0sT0FBTyxnQkFBZ0I7SUErUTNCLFlBQ1UsUUFBaUIsRUFDakIsa0JBQXNDLEVBQ3RDLGlCQUFtQyxFQUNuQyxvQkFBMEMsRUFDMUMsYUFBNEI7UUFKNUIsYUFBUSxHQUFSLFFBQVEsQ0FBUztRQUNqQix1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLHNCQUFpQixHQUFqQixpQkFBaUIsQ0FBa0I7UUFDbkMseUJBQW9CLEdBQXBCLG9CQUFvQixDQUFzQjtRQUMxQyxrQkFBYSxHQUFiLGFBQWEsQ0FBZTtRQW5SNUIsV0FBTSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUV6QyxtQkFBYyxHQUlWLFlBQVksQ0FBQyxHQUFHLEVBQUUsQ0FDcEIsSUFBSSxDQUFD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QUFVIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlLCBpbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGlvbnMsIGNyZWF0ZUVmZmVjdCwgb2ZUeXBlIH0gZnJvbSAnQG5ncngvZWZmZWN0cyc7XG5pbXBvcnQgeyBDYXJ0QWN0aW9ucywgQ2FydENvbm5lY3RvciB9IGZyb20gJ0BzcGFydGFjdXMvY2FydC9iYXNlL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZlQ2FydEZhY2FkZSwgQ2FydCB9IGZyb20gJ0BzcGFydGFjdXMvY2FydC9iYXNlL3Jvb3QnO1xuaW1wb3J0IHtcbiAgR2xvYmFsTWVzc2FnZVNlcnZpY2UsXG4gIEdsb2JhbE1lc3NhZ2VUeXBlLFxuICBMb2dnZXJTZXJ2aWNlLFxuICBub3JtYWxpemVIdHRwRXJyb3IsXG59IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzd2l0Y2hNYXAsIHdpdGhMYXRlc3RGcm9tIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgU2F2ZWRDYXJ0Q29ubmVjdG9yIH0gZnJvbSAnLi4vLi4vY29ubmVjdG9ycy9zYXZlZC1jYXJ0LmNvbm5lY3Rvcic7XG5pbXBvcnQgeyBTYXZlZENhcnRBY3Rpb25zIH0gZnJvbSAnLi4vYWN0aW9ucy9pbmRleCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBTYXZlZENhcnRFZmZlY3RzIHtcbiAgcHJvdGVjdGVkIGxvZ2dlciA9IGluamVjdChMb2dnZXJTZXJ2aWNlKTtcblxuICBsb2FkU2F2ZWRDYXJ0JDogT2JzZXJ2YWJsZTxcbiAgICB8IENhcnRBY3Rpb25zLkxvYWRDYXJ0U3VjY2Vzc1xuICAgIHwgU2F2ZWRDYXJ0QWN0aW9ucy5Mb2FkU2F2ZWRDYXJ0RmFpbFxuICAgIHwgU2F2ZWRDYXJ0QWN0aW9ucy5Mb2FkU2F2ZWRDYXJ0U3VjY2Vzc1xuICA+ID0gY3JlYXRlRWZmZWN0KCgpID0+XG4gICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgb2ZUeXBlKFNhdmVkQ2FydEFjdGlvbnMuTE9BRF9TQVZFRF9DQVJUKSxcbiAgICAgIG1hcCgoYWN0aW9uOiBTYXZlZENhcnRBY3Rpb25zLkxvYWRTYXZlZENhcnQpID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICAgIHN3aXRjaE1hcCgoeyB1c2VySWQsIGNhcnRJZCB9KSA9PlxuICAgICAgICB0aGlzLnNhdmVkQ2FydENvbm5lY3Rvci5nZXQodXNlcklkLCBjYXJ0SWQpLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChzYXZlZENhcnQ6IENhcnQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgIG5ldyBDYXJ0QWN0aW9ucy5Mb2FkQ2FydFN1Y2Nlc3Moe1xuICAgICAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgICAgICBjYXJ0SWQsXG4gICAgICAgICAgICAgICAgY2FydDogc2F2ZWRDYXJ0LFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgbmV3IFNhdmVkQ2FydEFjdGlvbnMuTG9hZFNhdmVkQ2FydFN1Y2Nlc3MoeyB1c2VySWQsIGNhcnRJZCB9KSxcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgfSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PlxuICAgICAgICAgICAgb2YoXG4gICAgICAgICAgICAgIG5ldyBTYXZlZENhcnRBY3Rpb25zLkxvYWRTYXZlZENhcnRGYWlsKHtcbiAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgY2FydElkLFxuICAgICAgICAgICAgICAgIGVycm9yOiBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKSxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgIClcbiAgICApXG4gICk7XG5cbiAgbG9hZFNhdmVkQ2FydHMkOiBPYnNlcnZhYmxlPFxuICAgIHwgQ2FydEFjdGlvbnMuTG9hZENhcnRzU3VjY2Vzc1xuICAgIHwgU2F2ZWRDYXJ0QWN0aW9ucy5Mb2FkU2F2ZWRDYXJ0c0ZhaWxcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuTG9hZFNhdmVkQ2FydHNTdWNjZXNzXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoU2F2ZWRDYXJ0QWN0aW9ucy5MT0FEX1NBVkVEX0NBUlRTKSxcbiAgICAgIG1hcCgoYWN0aW9uOiBTYXZlZENhcnRBY3Rpb25zLkxvYWRTYXZlZENhcnRzKSA9PiBhY3Rpb24ucGF5bG9hZCksXG4gICAgICBzd2l0Y2hNYXAoKHsgdXNlcklkIH0pID0+XG4gICAgICAgIHRoaXMuc2F2ZWRDYXJ0Q29ubmVjdG9yLmdldExpc3QodXNlcklkKS5waXBlKFxuICAgICAgICAgIHN3aXRjaE1hcCgoc2F2ZWRDYXJ0czogQ2FydFtdKSA9PiB7XG4gICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICBuZXcgQ2FydEFjdGlvbnMuTG9hZENhcnRzU3VjY2VzcyhzYXZlZENhcnRzKSxcbiAgICAgICAgICAgICAgbmV3IFNhdmVkQ2FydEFjdGlvbnMuTG9hZFNhdmVkQ2FydHNTdWNjZXNzKHsgdXNlcklkIH0pLFxuICAgICAgICAgICAgXTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+XG4gICAgICAgICAgICBvZihcbiAgICAgICAgICAgICAgbmV3IFNhdmVkQ2FydEFjdGlvbnMuTG9hZFNhdmVkQ2FydHNGYWlsKHtcbiAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpLFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKVxuICAgIClcbiAgKTtcblxuICByZXN0b3JlU2F2ZWRDYXJ0JDogT2JzZXJ2YWJsZTxcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuUmVzdG9yZVNhdmVkQ2FydEZhaWxcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuUmVzdG9yZVNhdmVkQ2FydFN1Y2Nlc3NcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuTG9hZFNhdmVkQ2FydHNcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuU2F2ZUNhcnRcbiAgICB8IENhcnRBY3Rpb25zLkxvYWRDYXJ0U3VjY2Vzc1xuICAgIHwgQ2FydEFjdGlvbnMuU2V0QWN0aXZlQ2FydElkXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoU2F2ZWRDYXJ0QWN0aW9ucy5SRVNUT1JFX1NBVkVEX0NBUlQpLFxuICAgICAgbWFwKChhY3Rpb246IFNhdmVkQ2FydEFjdGlvbnMuUmVzdG9yZVNhdmVkQ2FydCkgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgd2l0aExhdGVzdEZyb20odGhpcy5hY3RpdmVDYXJ0U2VydmljZS5nZXRBY3RpdmUoKSksXG4gICAgICBzd2l0Y2hNYXAoKFt7IHVzZXJJZCwgY2FydElkIH0sIGFjdGl2ZUNhcnRdKSA9PiB7XG4gICAgICAgIGNvbnN0IGFjdGlvbnM6IGFueVtdID0gW107XG5cbiAgICAgICAgaWYgKChhY3RpdmVDYXJ0Py5lbnRyaWVzID8/IFtdKS5sZW5ndGggPiAwKSB7XG4gICAgICAgICAgaWYgKGFjdGl2ZUNhcnQuY29kZSkge1xuICAgICAgICAgICAgLyoqXG4gICAgICAgICAgICAgKiBJbnN0ZWFkIG9mIGNhbGxpbmcgdGhlIFNhdmVDYXJ0QWN0aW9uLCB3ZSBhcmUgY2FsbGluZyB0aGUgZWRpdCBzYXZlZCBjYXJ0XG4gICAgICAgICAgICAgKiBiZWNhdXNlIHdlIGRvIG5vdCB3YW50IHRvIGNsZWFyIHRoZSBzdGF0ZSB3aGVuIHdlIHN3YXAgY2FydHMgYmV0d2VlbiBhY3RpdmUgYW5kIHNhdmVkIGNhcnRcbiAgICAgICAgICAgICAqL1xuICAgICAgICAgICAgYWN0aW9ucy5wdXNoKFxuICAgICAgICAgICAgICBuZXcgU2F2ZWRDYXJ0QWN0aW9ucy5FZGl0U2F2ZWRDYXJ0KHtcbiAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgY2FydElkOiBhY3RpdmVDYXJ0LmNvZGUsXG4gICAgICAgICAgICAgICAgc2F2ZUNhcnROYW1lOiAnJyxcbiAgICAgICAgICAgICAgICBzYXZlQ2FydERlc2NyaXB0aW9uOiAnJyxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgcmV0dXJuIHRoaXMuc2F2ZWRDYXJ0Q29ubmVjdG9yLnJlc3RvcmVTYXZlZENhcnQodXNlcklkLCBjYXJ0SWQpLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChzYXZlZENhcnQ6IENhcnQpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZ2xvYmFsTWVzc2FnZVNlcnZpY2UuYWRkKFxuICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAga2V5OlxuICAgICAgICAgICAgICAgICAgKGFjdGl2ZUNhcnQ/LmVudHJpZXMgPz8gW10pLmxlbmd0aCA+IDBcbiAgICAgICAgICAgICAgICAgICAgPyAnc2F2ZWRDYXJ0TGlzdC5zd2FwQ2FydFdpdGhBY3RpdmVDYXJ0J1xuICAgICAgICAgICAgICAgICAgICA6ICdzYXZlZENhcnRMaXN0LnN3YXBDYXJ0Tm9BY3RpdmVDYXJ0JyxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHtcbiAgICAgICAgICAgICAgICAgIGNhcnROYW1lOiBjYXJ0SWQsXG4gICAgICAgICAgICAgICAgICBwcmV2aW91c0NhcnROYW1lOiBhY3RpdmVDYXJ0LmNvZGUsXG4gICAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgfSxcbiAgICAgICAgICAgICAgR2xvYmFsTWVzc2FnZVR5cGUuTVNHX1RZUEVfQ09ORklSTUFUSU9OXG4gICAgICAgICAgICApO1xuICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgLi4uYWN0aW9ucyxcbiAgICAgICAgICAgICAgbmV3IENhcnRBY3Rpb25zLkxvYWRDYXJ0U3VjY2Vzcyh7XG4gICAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICAgIGNhcnRJZCxcbiAgICAgICAgICAgICAgICBjYXJ0OiBzYXZlZENhcnQsXG4gICAgICAgICAgICAgICAgZXh0cmFEYXRhOiB7IGFjdGl2ZTogdHJ1ZSB9LFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgbmV3IFNhdmVkQ2FydEFjdGlvbnMuUmVzdG9yZVNhdmVkQ2FydFN1Y2Nlc3MoeyB1c2VySWQsIGNhcnRJZCB9KSxcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgfSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PlxuICAgICAgICAgICAgb2YoXG4gICAgICAgICAgICAgIG5ldyBTYXZlZENhcnRBY3Rpb25zLlJlc3RvcmVTYXZlZENhcnRGYWlsKHtcbiAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgY2FydElkLFxuICAgICAgICAgICAgICAgIGVycm9yOiBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKSxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgIClcbiAgKTtcblxuICBzYXZlQ2FydCQ6IE9ic2VydmFibGU8XG4gICAgfCBTYXZlZENhcnRBY3Rpb25zLlNhdmVDYXJ0RmFpbFxuICAgIHwgU2F2ZWRDYXJ0QWN0aW9ucy5TYXZlQ2FydFN1Y2Nlc3NcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuU2F2ZUNhcnRcbiAgICB8IENhcnRBY3Rpb25zLkxvYWRDYXJ0U3VjY2Vzc1xuICAgIHwgQ2FydEFjdGlvbnMuQ2xlYXJDYXJ0U3RhdGVcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShTYXZlZENhcnRBY3Rpb25zLlNBVkVfQ0FSVCksXG4gICAgICBtYXAoKGFjdGlvbjogU2F2ZWRDYXJ0QWN0aW9ucy5TYXZlQ2FydCkgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgc3dpdGNoTWFwKCh7IHVzZXJJZCwgY2FydElkLCBzYXZlQ2FydE5hbWUsIHNhdmVDYXJ0RGVzY3JpcHRpb24gfSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jYXJ0Q29ubmVjdG9yXG4gICAgICAgICAgLnNhdmUodXNlcklkLCBjYXJ0SWQsIHNhdmVDYXJ0TmFtZSwgc2F2ZUNhcnREZXNjcmlwdGlvbilcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoc2F2ZWRDYXJ0OiBDYXJ0KSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgbmV3IENhcnRBY3Rpb25zLkNsZWFyQ2FydFN0YXRlKCksXG4gICAgICAgICAgICAgICAgbmV3IENhcnRBY3Rpb25zLkxvYWRDYXJ0U3VjY2Vzcyh7XG4gICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgICBjYXJ0SWQsXG4gICAgICAgICAgICAgICAgICBjYXJ0OiBzYXZlZENhcnQsXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgbmV3IFNhdmVkQ2FydEFjdGlvbnMuU2F2ZUNhcnRTdWNjZXNzKHtcbiAgICAgICAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgICAgICAgIGNhcnRJZCxcbiAgICAgICAgICAgICAgICAgIHNhdmVDYXJ0TmFtZSxcbiAgICAgICAgICAgICAgICAgIHNhdmVDYXJ0RGVzY3JpcHRpb24sXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIF07XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT5cbiAgICAgICAgICAgICAgb2YoXG4gICAgICAgICAgICAgICAgbmV3IFNhdmVkQ2FydEFjdGlvbnMuU2F2ZUNhcnRGYWlsKHtcbiAgICAgICAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgICAgICAgIGNhcnRJZCxcbiAgICAgICAgICAgICAgICAgIHNhdmVDYXJ0TmFtZSxcbiAgICAgICAgICAgICAgICAgIHNhdmVDYXJ0RGVzY3JpcHRpb24sXG4gICAgICAgICAgICAgICAgICBlcnJvcjogbm9ybWFsaXplSHR0cEVycm9yKGVycm9yLCB0aGlzLmxvZ2dlciksXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICB9KVxuICAgIClcbiAgKTtcblxuICBlZGl0U2F2ZWRDYXJ0JDogT2JzZXJ2YWJsZTxcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuRWRpdFNhdmVkQ2FydEZhaWxcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuRWRpdFNhdmVkQ2FydFN1Y2Nlc3NcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuRWRpdFNhdmVkQ2FydFxuICAgIHwgQ2FydEFjdGlvbnMuTG9hZENhcnRTdWNjZXNzXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoU2F2ZWRDYXJ0QWN0aW9ucy5FRElUX1NBVkVEX0NBUlQpLFxuICAgICAgbWFwKChhY3Rpb246IFNhdmVkQ2FydEFjdGlvbnMuRWRpdFNhdmVkQ2FydCkgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgc3dpdGNoTWFwKCh7IHVzZXJJZCwgY2FydElkLCBzYXZlQ2FydE5hbWUsIHNhdmVDYXJ0RGVzY3JpcHRpb24gfSkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jYXJ0Q29ubmVjdG9yXG4gICAgICAgICAgLnNhdmUodXNlcklkLCBjYXJ0SWQsIHNhdmVDYXJ0TmFtZSwgc2F2ZUNhcnREZXNjcmlwdGlvbilcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoc2F2ZWRDYXJ0OiBDYXJ0KSA9PiB7XG4gICAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgbmV3IENhcnRBY3Rpb25zLkxvYWRDYXJ0U3VjY2Vzcyh7XG4gICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgICBjYXJ0SWQsXG4gICAgICAgICAgICAgICAgICBjYXJ0OiBzYXZlZENhcnQsXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgbmV3IFNhdmVkQ2FydEFjdGlvbnMuRWRpdFNhdmVkQ2FydFN1Y2Nlc3Moe1xuICAgICAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICAgICAgY2FydElkLFxuICAgICAgICAgICAgICAgICAgc2F2ZUNhcnROYW1lLFxuICAgICAgICAgICAgICAgICAgc2F2ZUNhcnREZXNjcmlwdGlvbixcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PlxuICAgICAgICAgICAgICBvZihcbiAgICAgICAgICAgICAgICBuZXcgU2F2ZWRDYXJ0QWN0aW9ucy5FZGl0U2F2ZWRDYXJ0RmFpbCh7XG4gICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgICBjYXJ0SWQsXG4gICAgICAgICAgICAgICAgICBzYXZlQ2FydE5hbWUsXG4gICAgICAgICAgICAgICAgICBzYXZlQ2FydERlc2NyaXB0aW9uLFxuICAgICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpLFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgICApO1xuICAgICAgfSlcbiAgICApXG4gICk7XG5cbiAgY2xvbmVTYXZlZENhcnQkOiBPYnNlcnZhYmxlPFxuICAgIHwgU2F2ZWRDYXJ0QWN0aW9ucy5DbG9uZVNhdmVkQ2FydEZhaWxcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuQ2xvbmVTYXZlZENhcnRTdWNjZXNzXG4gICAgfCBTYXZlZENhcnRBY3Rpb25zLkNsb25lU2F2ZWRDYXJ0XG4gICAgfCBTYXZlZENhcnRBY3Rpb25zLlJlc3RvcmVTYXZlZENhcnRcbiAgICB8IFNhdmVkQ2FydEFjdGlvbnMuTG9hZFNhdmVkQ2FydHNcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShTYXZlZENhcnRBY3Rpb25zLkNMT05FX1NBVkVEX0NBUlQpLFxuICAgICAgbWFwKChhY3Rpb246IFNhdmVkQ2FydEFjdGlvbnMuQ2xvbmVTYXZlZENhcnQpID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICAgIHN3aXRjaE1hcCgoeyB1c2VySWQsIGNhcnRJZCwgc2F2ZUNhcnROYW1lIH0pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuc2F2ZWRDYXJ0Q29ubmVjdG9yXG4gICAgICAgICAgLmNsb25lU2F2ZWRDYXJ0KHVzZXJJZCwgY2FydElkLCBzYXZlQ2FydE5hbWUpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKF8pID0+IHtcbiAgICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgICBuZXcgU2F2ZWRDYXJ0QWN0aW9ucy5DbG9uZVNhdmVkQ2FydFN1Y2Nlc3Moe1xuICAgICAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICAgICAgY2FydElkLFxuICAgICAgICAgICAgICAgICAgc2F2ZUNhcnROYW1lLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIG5ldyBTYXZlZENhcnRBY3Rpb25zLlJlc3RvcmVTYXZlZENhcnQoe1xuICAgICAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICAgICAgY2FydElkLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIG5ldyBTYXZlZENhcnRBY3Rpb25zLkxvYWRTYXZlZENhcnRzKHsgdXNlcklkIH0pLFxuICAgICAgICAgICAgICBdO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+XG4gICAgICAgICAgICAgIG9mKFxuICAgICAgICAgICAgICAgIG5ldyBTYXZlZENhcnRBY3Rpb25zLkNsb25lU2F2ZWRDYXJ0RmFpbCh7XG4gICAgICAgICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICAgICAgICBjYXJ0SWQsXG4gICAgICAgICAgICAgICAgICBzYXZlQ2FydE5hbWUsXG4gICAgICAgICAgICAgICAgICBlcnJvcjogbm9ybWFsaXplSHR0cEVycm9yKGVycm9yLCB0aGlzLmxvZ2dlciksXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICAgICk7XG4gICAgICB9KVxuICAgIClcbiAgKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFjdGlvbnMkOiBBY3Rpb25zLFxuICAgIHByaXZhdGUgc2F2ZWRDYXJ0Q29ubmVjdG9yOiBTYXZlZENhcnRDb25uZWN0b3IsXG4gICAgcHJpdmF0ZSBhY3RpdmVDYXJ0U2VydmljZTogQWN0aXZlQ2FydEZhY2FkZSxcbiAgICBwcml2YXRlIGdsb2JhbE1lc3NhZ2VTZXJ2aWNlOiBHbG9iYWxNZXNzYWdlU2VydmljZSxcbiAgICBwcml2YXRlIGNhcnRDb25uZWN0b3I6IENhcnRDb25uZWN0b3JcbiAgKSB7fVxufVxuIl19