/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { ChangeDetectionStrategy, Component, } from '@angular/core';
import { GlobalMessageService, GlobalMessageType, LanguageService, TranslationService, } from '@spartacus/core';
import { InvoicesFields, PDFInvoicesFacade, } from '@spartacus/pdf-invoices/root';
import { FileDownloadService, ICON_TYPE } from '@spartacus/storefront';
import { BehaviorSubject, combineLatest, EMPTY, Subscription, } from 'rxjs';
import { catchError, skip, switchMap, take, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/pdf-invoices/root";
import * as i2 from "@spartacus/core";
import * as i3 from "@spartacus/storefront";
import * as i4 from "@angular/common";
export class InvoicesListComponent {
    constructor(pdfInvoicesFacade, translationService, downloadService, languageService, globalMessageService) {
        this.pdfInvoicesFacade = pdfInvoicesFacade;
        this.translationService = translationService;
        this.downloadService = downloadService;
        this.languageService = languageService;
        this.globalMessageService = globalMessageService;
        /* For Enum use in HTML */
        this.ICON_TYPE = ICON_TYPE;
        this.PAGE_SIZE = 5; //Default page size
        this.sort = 'byInvoiceIdAsc';
        this.sortMapping = {
            byCreatedAtAsc: 'invoiceDate:asc',
            byCreatedAtDesc: 'invoiceDate:desc',
            byInvoiceIdAsc: 'invoiceId:asc',
            byInvoiceIdDesc: 'invoiceId:desc',
            byNetAmountAsc: 'netAmount:asc',
            byNetAmountDesc: 'netAmount:desc',
            byTotalAmountAsc: 'totalAmount:asc',
            byTotalAmountDesc: 'totalAmount:desc',
        };
        // Contains the initial query parameters and will be updated with current state of filters
        this._initQueryParams = {
            currentPage: 0,
            pageSize: this.PAGE_SIZE,
            fields: InvoicesFields.FULL,
            sort: this.sortMapping[this.sort], //backend supports sort codes like invoiceId:asc
        };
        // Triggers events on chaning the page, sort options
        this.queryParams$ = new BehaviorSubject(this._initQueryParams);
        // Used by template to subscribe to data from documents api
        this.invoicesList$ = this.queryParams$.pipe(switchMap((param) => this.pdfInvoicesFacade.getInvoicesForOrder(param)), tap((invoicesList) => (this.pagination = {
            currentPage: invoicesList.pagination?.page,
            pageSize: invoicesList.pagination?.count,
            totalPages: invoicesList.pagination?.totalPages,
            totalResults: invoicesList.pagination?.totalCount,
            sort: this.sortMapping[this.sort],
        })), catchError((error) => {
            if (error && this.getNotEnabledError(error)?.length) {
                this.globalMessageService.add({ key: 'pdfInvoices.featureNotEnabled' }, GlobalMessageType.MSG_TYPE_ERROR);
            }
            return EMPTY;
        }));
        this.subscription = new Subscription();
    }
    ngOnInit() {
        this.subscription.add(this.languageService
            .getActive()
            .pipe(skip(1))
            .subscribe(() => this.updateQueryParams({ fields: InvoicesFields.FULL })));
        this.getSortOptions();
    }
    updateQueryParams(partialParams) {
        // Overwrite each value present in partialParams to _queryParams
        Object.keys(partialParams).forEach((key) => (this._initQueryParams[key] = partialParams[key]));
        // Every request that doesn't specify fields should be set to DEFAULT
        if (!partialParams.fields) {
            this._initQueryParams.fields = InvoicesFields.DEFAULT;
        }
        this.queryParams$.next(this._initQueryParams);
    }
    pageChange(currentPage) {
        this.updateQueryParams({
            currentPage: currentPage,
        });
    }
    sortChange(sortCode) {
        this.sort = sortCode;
        this.updateQueryParams({
            sort: this.sortMapping[sortCode],
            currentPage: 0,
        });
    }
    downloadPDFInvoice(invoiceId, externalSystemId) {
        this.pdfInvoicesFacade
            .getInvoicePDF(invoiceId, externalSystemId)
            .pipe(take(1))
            .subscribe({
            next: (data) => {
                const file = new Blob([data], { type: data.type });
                const url = URL.createObjectURL(file);
                this.downloadService.download(url, `${invoiceId}.pdf`);
            },
        });
    }
    getSortOptions() {
        this.sortOptions = [];
        Object.keys(this.sortMapping).forEach((sortKey) => this.sortOptions.push({ code: sortKey, selected: false }));
        const translations = this.sortOptions.map((sort) => this.translationService.translate(`pdfInvoices.sorts.${sort.code}`));
        combineLatest(translations)
            .pipe(take(1))
            .subscribe((translated) => this.sortOptions.forEach((sort, index) => (sort.name = translated[index])));
    }
    getNotEnabledError(response) {
        return response?.details
            ? response.details.filter((error) => error?.type === 'UnknownResourceError')
            : [];
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
}
InvoicesListComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: InvoicesListComponent, deps: [{ token: i1.PDFInvoicesFacade }, { token: i2.TranslationService }, { token: i3.FileDownloadService }, { token: i2.LanguageService }, { token: i2.GlobalMessageService }], target: i0.ɵɵFactoryTarget.Component });
InvoicesListComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.9", type: InvoicesListComponent, selector: "cx-invoices-list", ngImport: i0, template: "<ng-container *ngIf=\"invoicesList$ | async as invoicesList\">\n  <ng-container\n    *ngIf=\"\n      invoicesList.pagination &&\n      invoicesList.pagination.totalCount &&\n      invoicesList.pagination.totalCount > 0\n    \"\n  >\n    <div>\n      <!-- HEADER -->\n      <div class=\"cx-invoices-list-header\">\n        <h2>\n          {{ 'pdfInvoices.invoicesTable.header' | cxTranslate }}\n        </h2>\n      </div>\n\n      <!-- BODY -->\n      <div class=\"cx-invoices-list-body\">\n        <div class=\"cx-invoices-list-sort top\">\n          <label class=\"cx-invoices-list-form-group form-group\">\n            <span>\n              {{ 'pdfInvoices.sortBy' | cxTranslate }}\n            </span>\n            <cx-sorting\n              [sortOptions]=\"sortOptions\"\n              (sortListEvent)=\"sortChange($event)\"\n              [selectedOption]=\"sort\"\n              placeholder=\"{{ 'pdfInvoices.sortBy' | cxTranslate }}\"\n              [ariaLabel]=\"'pdfInvoices.sortInvoices' | cxTranslate\"\n              ariaControls=\"cx-invoices-list-table\"\n            ></cx-sorting>\n          </label>\n          <div\n            class=\"cx-invoices-list-pagination\"\n            *ngIf=\"\n              invoicesList.pagination &&\n              invoicesList.pagination.totalPages &&\n              invoicesList.pagination.totalPages > 1\n            \"\n          >\n            <cx-pagination\n              [pagination]=\"pagination\"\n              (viewPageEvent)=\"pageChange($event)\"\n            ></cx-pagination>\n          </div>\n        </div>\n\n        <!-- TABLE -->\n        <table\n          id=\"cx-invoices-list-table\"\n          class=\"table cx-invoices-list-table\"\n          attr.aria-label=\"{{\n            'pdfInvoices.invoicesTable.label' | cxTranslate\n          }}\"\n        >\n          <thead class=\"cx-invoices-list-thead-mobile\">\n            <th scope=\"col\">\n              {{ 'pdfInvoices.invoicesTable.invoiceId' | cxTranslate }}\n            </th>\n            <th scope=\"col\">\n              {{ 'pdfInvoices.invoicesTable.createdAt' | cxTranslate }}\n            </th>\n            <th scope=\"col\">\n              {{ 'pdfInvoices.invoicesTable.netAmount' | cxTranslate }}\n            </th>\n            <th scope=\"col\">\n              {{ 'pdfInvoices.invoicesTable.totalAmount' | cxTranslate }}\n            </th>\n            <th scope=\"col\">\n              <cx-icon\n                [type]=\"ICON_TYPE.DOWNLOAD\"\n                class=\"cx-invoices-list-attachment-icon\"\n                title=\"{{\n                  'pdfInvoices.invoicesTable.attachment' | cxTranslate\n                }}\"\n              ></cx-icon>\n            </th>\n          </thead>\n          <tbody>\n            <tr\n              *ngFor=\"let invoice of invoicesList.invoices\"\n              class=\"cx-invoices-list-row\"\n            >\n              <td class=\"cx-invoices-list-code\">\n                <div class=\"cx-invoices-list-label\">\n                  {{ 'pdfInvoices.invoicesTable.invoiceId' | cxTranslate }}\n                </div>\n                <div class=\"cx-invoices-list-value\">\n                  {{ invoice.invoiceId }}\n                </div>\n              </td>\n              <td class=\"cx-invoices-list-date\">\n                <div class=\"cx-invoices-list-label\">\n                  {{ 'pdfInvoices.invoicesTable.createdAt' | cxTranslate }}\n                </div>\n                <div class=\"cx-invoices-list-value\">\n                  {{ invoice.createdAt | cxDate: 'longDate' }}\n                </div>\n              </td>\n              <td class=\"cx-invoices-list-monetary\">\n                <div class=\"cx-invoices-list-label\">\n                  {{ 'pdfInvoices.invoicesTable.netAmount' | cxTranslate }}\n                </div>\n                <div class=\"cx-invoices-list-value\">\n                  {{\n                    invoice.netAmount?.formattedValue\n                      ? invoice.netAmount?.formattedValue\n                      : invoice.netAmount?.currencyIso +\n                        '&nbsp;' +\n                        invoice.netAmount?.value\n                  }}\n                </div>\n              </td>\n              <td class=\"cx-invoices-list-monetary\">\n                <div class=\"cx-invoices-list-label\">\n                  {{ 'pdfInvoices.invoicesTable.totalAmount' | cxTranslate }}\n                </div>\n                <div class=\"cx-invoices-list-value\">\n                  {{\n                    invoice.totalAmount?.formattedValue\n                      ? invoice.totalAmount?.formattedValue\n                      : invoice.totalAmount?.currencyIso +\n                        '&nbsp;' +\n                        invoice.totalAmount?.value\n                  }}\n                </div>\n              </td>\n              <td class=\"cx-invoices-list-attachment\">\n                <div class=\"cx-invoices-list-label\">\n                  {{ 'pdfInvoices.invoicesTable.attachment' | cxTranslate }}\n                </div>\n                <div class=\"cx-invoices-list-value\">\n                  <button\n                    *ngIf=\"invoice.invoiceId\"\n                    class=\"cx-invoices-list-attachment-btn\"\n                    (click)=\"\n                      downloadPDFInvoice(\n                        invoice.invoiceId,\n                        invoice.externalSystemId\n                      )\n                    \"\n                    attr.aria-label=\"{{\n                      'pdfInvoices.invoicesTable.attachmentDescription'\n                        | cxTranslate\n                          : {\n                              id: invoice.invoiceId\n                            }\n                    }}\"\n                  >\n                    <cx-icon\n                      [type]=\"ICON_TYPE.FILE\"\n                      class=\"cx-invoices-list-attachment-icon\"\n                      title=\"{{\n                        'pdfInvoices.invoicesTable.download' | cxTranslate\n                      }}\"\n                    >\n                    </cx-icon>\n                    <span\n                      class=\"cx-invoices-list-attachment-text\"\n                      [innerText]=\"\n                        'pdfInvoices.invoicesTable.download' | cxTranslate\n                      \"\n                    >\n                    </span>\n                  </button>\n                </div>\n              </td>\n            </tr>\n          </tbody>\n        </table>\n\n        <!-- Select Form and Pagination Bottom -->\n        <div class=\"cx-invoices-list-sort bottom\">\n          <div\n            class=\"cx-invoices-list-pagination\"\n            *ngIf=\"\n              invoicesList.pagination &&\n              invoicesList.pagination.totalPages &&\n              invoicesList.pagination.totalPages > 1\n            \"\n          >\n            <cx-pagination\n              [pagination]=\"pagination\"\n              (viewPageEvent)=\"pageChange($event)\"\n            ></cx-pagination>\n          </div>\n        </div>\n      </div>\n    </div>\n  </ng-container>\n</ng-container>\n", dependencies: [{ kind: "directive", type: i4.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i4.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i3.SortingComponent, selector: "cx-sorting", inputs: ["sortOptions", "ariaControls", "ariaLabel", "selectedOption", "placeholder", "sortLabels"], outputs: ["sortListEvent"] }, { kind: "component", type: i3.PaginationComponent, selector: "cx-pagination", inputs: ["pageRoute", "queryParam", "defaultPage", "pagination"], outputs: ["viewPageEvent"] }, { kind: "component", type: i3.IconComponent, selector: "cx-icon,[cxIcon]", inputs: ["cxIcon", "type"] }, { kind: "pipe", type: i4.AsyncPipe, name: "async" }, { kind: "pipe", type: i2.TranslatePipe, name: "cxTranslate" }, { kind: "pipe", type: i2.CxDatePipe, name: "cxDate" }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: InvoicesListComponent, decorators: [{
            type: Component,
            args: [{ selector: 'cx-invoices-list', changeDetection: ChangeDetectionStrategy.OnPush, template: "<ng-container *ngIf=\"invoicesList$ | async as invoicesList\">\n  <ng-container\n    *ngIf=\"\n      invoicesList.pagination &&\n      invoicesList.pagination.totalCount &&\n      invoicesList.pagination.totalCount > 0\n    \"\n  >\n    <div>\n      <!-- HEADER -->\n      <div class=\"cx-invoices-list-header\">\n        <h2>\n          {{ 'pdfInvoices.invoicesTable.header' | cxTranslate }}\n        </h2>\n      </div>\n\n      <!-- BODY -->\n      <div class=\"cx-invoices-list-body\">\n        <div class=\"cx-invoices-list-sort top\">\n          <label class=\"cx-invoices-list-form-group form-group\">\n            <span>\n              {{ 'pdfInvoices.sortBy' | cxTranslate }}\n            </span>\n            <cx-sorting\n              [sortOptions]=\"sortOptions\"\n              (sortListEvent)=\"sortChange($event)\"\n              [selectedOption]=\"sort\"\n              placeholder=\"{{ 'pdfInvoices.sortBy' | cxTranslate }}\"\n              [ariaLabel]=\"'pdfInvoices.sortInvoices' | cxTranslate\"\n              ariaControls=\"cx-invoices-list-table\"\n            ></cx-sorting>\n          </label>\n          <div\n            class=\"cx-invoices-list-pagination\"\n            *ngIf=\"\n              invoicesList.pagination &&\n              invoicesList.pagination.totalPages &&\n              invoicesList.pagination.totalPages > 1\n            \"\n          >\n            <cx-pagination\n              [pagination]=\"pagination\"\n              (viewPageEvent)=\"pageChange($event)\"\n            ></cx-pagination>\n          </div>\n        </div>\n\n        <!-- TABLE -->\n        <table\n          id=\"cx-invoices-list-table\"\n          class=\"table cx-invoices-list-table\"\n          attr.aria-label=\"{{\n            'pdfInvoices.invoicesTable.label' | cxTranslate\n          }}\"\n        >\n          <thead class=\"cx-invoices-list-thead-mobile\">\n            <th scope=\"col\">\n              {{ 'pdfInvoices.invoicesTable.invoiceId' | cxTranslate }}\n            </th>\n            <th scope=\"col\">\n              {{ 'pdfInvoices.invoicesTable.createdAt' | cxTranslate }}\n            </th>\n            <th scope=\"col\">\n              {{ 'pdfInvoices.invoicesTable.netAmount' | cxTranslate }}\n            </th>\n            <th scope=\"col\">\n              {{ 'pdfInvoices.invoicesTable.totalAmount' | cxTranslate }}\n            </th>\n            <th scope=\"col\">\n              <cx-icon\n                [type]=\"ICON_TYPE.DOWNLOAD\"\n                class=\"cx-invoices-list-attachment-icon\"\n                title=\"{{\n                  'pdfInvoices.invoicesTable.attachment' | cxTranslate\n                }}\"\n              ></cx-icon>\n            </th>\n          </thead>\n          <tbody>\n            <tr\n              *ngFor=\"let invoice of invoicesList.invoices\"\n              class=\"cx-invoices-list-row\"\n            >\n              <td class=\"cx-invoices-list-code\">\n                <div class=\"cx-invoices-list-label\">\n                  {{ 'pdfInvoices.invoicesTable.invoiceId' | cxTranslate }}\n                </div>\n                <div class=\"cx-invoices-list-value\">\n                  {{ invoice.invoiceId }}\n                </div>\n              </td>\n              <td class=\"cx-invoices-list-date\">\n                <div class=\"cx-invoices-list-label\">\n                  {{ 'pdfInvoices.invoicesTable.createdAt' | cxTranslate }}\n                </div>\n                <div class=\"cx-invoices-list-value\">\n                  {{ invoice.createdAt | cxDate: 'longDate' }}\n                </div>\n              </td>\n              <td class=\"cx-invoices-list-monetary\">\n                <div class=\"cx-invoices-list-label\">\n                  {{ 'pdfInvoices.invoicesTable.netAmount' | cxTranslate }}\n                </div>\n                <div class=\"cx-invoices-list-value\">\n                  {{\n                    invoice.netAmount?.formattedValue\n                      ? invoice.netAmount?.formattedValue\n                      : invoice.netAmount?.currencyIso +\n                        '&nbsp;' +\n                        invoice.netAmount?.value\n                  }}\n                </div>\n              </td>\n              <td class=\"cx-invoices-list-monetary\">\n                <div class=\"cx-invoices-list-label\">\n                  {{ 'pdfInvoices.invoicesTable.totalAmount' | cxTranslate }}\n                </div>\n                <div class=\"cx-invoices-list-value\">\n                  {{\n                    invoice.totalAmount?.formattedValue\n                      ? invoice.totalAmount?.formattedValue\n                      : invoice.totalAmount?.currencyIso +\n                        '&nbsp;' +\n                        invoice.totalAmount?.value\n                  }}\n                </div>\n              </td>\n              <td class=\"cx-invoices-list-attachment\">\n                <div class=\"cx-invoices-list-label\">\n                  {{ 'pdfInvoices.invoicesTable.attachment' | cxTranslate }}\n                </div>\n                <div class=\"cx-invoices-list-value\">\n                  <button\n                    *ngIf=\"invoice.invoiceId\"\n                    class=\"cx-invoices-list-attachment-btn\"\n                    (click)=\"\n                      downloadPDFInvoice(\n                        invoice.invoiceId,\n                        invoice.externalSystemId\n                      )\n                    \"\n                    attr.aria-label=\"{{\n                      'pdfInvoices.invoicesTable.attachmentDescription'\n                        | cxTranslate\n                          : {\n                              id: invoice.invoiceId\n                            }\n                    }}\"\n                  >\n                    <cx-icon\n                      [type]=\"ICON_TYPE.FILE\"\n                      class=\"cx-invoices-list-attachment-icon\"\n                      title=\"{{\n                        'pdfInvoices.invoicesTable.download' | cxTranslate\n                      }}\"\n                    >\n                    </cx-icon>\n                    <span\n                      class=\"cx-invoices-list-attachment-text\"\n                      [innerText]=\"\n                        'pdfInvoices.invoicesTable.download' | cxTranslate\n                      \"\n                    >\n                    </span>\n                  </button>\n                </div>\n              </td>\n            </tr>\n          </tbody>\n        </table>\n\n        <!-- Select Form and Pagination Bottom -->\n        <div class=\"cx-invoices-list-sort bottom\">\n          <div\n            class=\"cx-invoices-list-pagination\"\n            *ngIf=\"\n              invoicesList.pagination &&\n              invoicesList.pagination.totalPages &&\n              invoicesList.pagination.totalPages > 1\n            \"\n          >\n            <cx-pagination\n              [pagination]=\"pagination\"\n              (viewPageEvent)=\"pageChange($event)\"\n            ></cx-pagination>\n          </div>\n        </div>\n      </div>\n    </div>\n  </ng-container>\n</ng-container>\n" }]
        }], ctorParameters: function () { return [{ type: i1.PDFInvoicesFacade }, { type: i2.TranslationService }, { type: i3.FileDownloadService }, { type: i2.LanguageService }, { type: i2.GlobalMessageService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW52b2ljZXMtbGlzdC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcGRmLWludm9pY2VzL2NvbXBvbmVudHMvaW52b2ljZXMtbGlzdC9pbnZvaWNlcy1saXN0LmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uL2ZlYXR1cmUtbGlicy9wZGYtaW52b2ljZXMvY29tcG9uZW50cy9pbnZvaWNlcy1saXN0L2ludm9pY2VzLWxpc3QuY29tcG9uZW50Lmh0bWwiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7R0FJRztBQUVILE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsU0FBUyxHQUdWLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFFTCxvQkFBb0IsRUFDcEIsaUJBQWlCLEVBRWpCLGVBQWUsRUFHZixrQkFBa0IsR0FDbkIsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLEVBRUwsY0FBYyxFQUVkLGlCQUFpQixHQUNsQixNQUFNLDhCQUE4QixDQUFDO0FBQ3RDLE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxTQUFTLEVBQUUsTUFBTSx1QkFBdUIsQ0FBQztBQUN2RSxPQUFPLEVBQ0wsZUFBZSxFQUNmLGFBQWEsRUFDYixLQUFLLEVBRUwsWUFBWSxHQUNiLE1BQU0sTUFBTSxDQUFDO0FBQ2QsT0FBTyxFQUFFLFVBQVUsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7O0FBT3hFLE1BQU0sT0FBTyxxQkFBcUI7SUEwRGhDLFlBQ1ksaUJBQW9DLEVBQ3BDLGtCQUFzQyxFQUN0QyxlQUFvQyxFQUNwQyxlQUFnQyxFQUNoQyxvQkFBMEM7UUFKMUMsc0JBQWlCLEdBQWpCLGlCQUFpQixDQUFtQjtRQUNwQyx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBQ3RDLG9CQUFlLEdBQWYsZUFBZSxDQUFxQjtRQUNwQyxv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QUFXLEVBQUUsQ0FBQztJQUNsQyxDQUFDOztrSEF0SlUscUJBQXFCO3NHQUFyQixxQkFBcUIsd0RDM0NsQywwaE9BK0xBOzJGRHBKYSxxQkFBcUI7a0JBTGpDLFNBQVM7K0JBQ0Usa0JBQWtCLG1CQUVYLHVCQUF1QixDQUFDLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMyBTQVAgU3BhcnRhY3VzIHRlYW0gPHNwYXJ0YWN1cy10ZWFtQHNhcC5jb20+XG4gKlxuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQge1xuICBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSxcbiAgQ29tcG9uZW50LFxuICBPbkRlc3Ryb3ksXG4gIE9uSW5pdCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBFcnJvck1vZGVsLFxuICBHbG9iYWxNZXNzYWdlU2VydmljZSxcbiAgR2xvYmFsTWVzc2FnZVR5cGUsXG4gIEh0dHBFcnJvck1vZGVsLFxuICBMYW5ndWFnZVNlcnZpY2UsXG4gIFBhZ2luYXRpb25Nb2RlbCxcbiAgU29ydE1vZGVsLFxuICBUcmFuc2xhdGlvblNlcnZpY2UsXG59IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQge1xuICBJbnZvaWNlUXVlcnlQYXJhbXMsXG4gIEludm9pY2VzRmllbGRzLFxuICBPcmRlckludm9pY2VMaXN0LFxuICBQREZJbnZvaWNlc0ZhY2FkZSxcbn0gZnJvbSAnQHNwYXJ0YWN1cy9wZGYtaW52b2ljZXMvcm9vdCc7XG5pbXBvcnQgeyBGaWxlRG93bmxvYWRTZXJ2aWNlLCBJQ09OX1RZUEUgfSBmcm9tICdAc3BhcnRhY3VzL3N0b3JlZnJvbnQnO1xuaW1wb3J0IHtcbiAgQmVoYXZpb3JTdWJqZWN0LFxuICBjb21iaW5lTGF0ZXN0LFxuICBFTVBUWSxcbiAgT2JzZXJ2YWJsZSxcbiAgU3Vic2NyaXB0aW9uLFxufSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIHNraXAsIHN3aXRjaE1hcCwgdGFrZSwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjeC1pbnZvaWNlcy1saXN0JyxcbiAgdGVtcGxhdGVVcmw6ICcuL2ludm9pY2VzLWxpc3QuY29tcG9uZW50Lmh0bWwnLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbn0pXG5leHBvcnQgY2xhc3MgSW52b2ljZXNMaXN0Q29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICAvKiBGb3IgRW51bSB1c2UgaW4gSFRNTCAqL1xuICBJQ09OX1RZUEUgPSBJQ09OX1RZUEU7XG5cbiAgcHJvdGVjdGVkIFBBR0VfU0laRSA9IDU7IC8vRGVmYXVsdCBwYWdlIHNpemVcblxuICBzb3J0T3B0aW9uczogU29ydE1vZGVsW107XG4gIHNvcnQgPSAnYnlJbnZvaWNlSWRBc2MnO1xuXG4gIHByb3RlY3RlZCBzb3J0TWFwcGluZzogeyBba2V5OiBzdHJpbmddOiBzdHJpbmcgfSA9IHtcbiAgICBieUNyZWF0ZWRBdEFzYzogJ2ludm9pY2VEYXRlOmFzYycsIC8vVE9ETzogKENYSU5ULTI0MzgpIHVwZGF0ZSB0aGUgc29ydCBjb2RlIGFmdGVyIHRoZSBBUEkgaXMgY2hhbmdlZFxuICAgIGJ5Q3JlYXRlZEF0RGVzYzogJ2ludm9pY2VEYXRlOmRlc2MnLCAvL1RPRE86IChDWElOVC0yNDM4KSB1cGRhdGUgdGhlIHNvcnQgY29kZSBhZnRlciB0aGUgQVBJIGlzIGNoYW5nZWRcbiAgICBieUludm9pY2VJZEFzYzogJ2ludm9pY2VJZDphc2MnLFxuICAgIGJ5SW52b2ljZUlkRGVzYzogJ2ludm9pY2VJZDpkZXNjJyxcbiAgICBieU5ldEFtb3VudEFzYzogJ25ldEFtb3VudDphc2MnLFxuICAgIGJ5TmV0QW1vdW50RGVzYzogJ25ldEFtb3VudDpkZXNjJyxcbiAgICBieVRvdGFsQW1vdW50QXNjOiAndG90YWxBbW91bnQ6YXNjJyxcbiAgICBieVRvdGFsQW1vdW50RGVzYzogJ3RvdGFsQW1vdW50OmRlc2MnLFxuICB9O1xuICBwYWdpbmF0aW9uOiBQYWdpbmF0aW9uTW9kZWw7XG5cbiAgLy8gQ29udGFpbnMgdGhlIGluaXRpYWwgcXVlcnkgcGFyYW1ldGVycyBhbmQgd2lsbCBiZSB1cGRhdGVkIHdpdGggY3VycmVudCBzdGF0ZSBvZiBmaWx0ZXJzXG4gIF9pbml0UXVlcnlQYXJhbXM6IEludm9pY2VRdWVyeVBhcmFtcyA9IHtcbiAgICBjdXJyZW50UGFnZTogMCxcbiAgICBwYWdlU2l6ZTogdGhpcy5QQUdFX1NJWkUsXG4gICAgZmllbGRzOiBJbnZvaWNlc0ZpZWxkcy5GVUxMLFxuICAgIHNvcnQ6IHRoaXMuc29ydE1hcHBpbmdbdGhpcy5zb3J0XSwgLy9iYWNrZW5kIHN1cHBvcnRzIHNvcnQgY29kZXMgbGlrZSBpbnZvaWNlSWQ6YXNjXG4gIH07XG5cbiAgLy8gVHJpZ2dlcnMgZXZlbnRzIG9uIGNoYW5pbmcgdGhlIHBhZ2UsIHNvcnQgb3B0aW9uc1xuICBxdWVyeVBhcmFtcyQgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PEludm9pY2VRdWVyeVBhcmFtcz4odGhpcy5faW5pdFF1ZXJ5UGFyYW1zKTtcblxuICAvLyBVc2VkIGJ5IHRlbXBsYXRlIHRvIHN1YnNjcmliZSB0byBkYXRhIGZyb20gZG9jdW1lbnRzIGFwaVxuICBpbnZvaWNlc0xpc3QkOiBPYnNlcnZhYmxlPE9yZGVySW52b2ljZUxpc3Q+ID0gdGhpcy5xdWVyeVBhcmFtcyQucGlwZShcbiAgICBzd2l0Y2hNYXAoKHBhcmFtKSA9PiB0aGlzLnBkZkludm9pY2VzRmFjYWRlLmdldEludm9pY2VzRm9yT3JkZXIocGFyYW0pKSxcbiAgICB0YXAoXG4gICAgICAoaW52b2ljZXNMaXN0KSA9PlxuICAgICAgICAodGhpcy5wYWdpbmF0aW9uID0ge1xuICAgICAgICAgIGN1cnJlbnRQYWdlOiBpbnZvaWNlc0xpc3QucGFnaW5hdGlvbj8ucGFnZSxcbiAgICAgICAgICBwYWdlU2l6ZTogaW52b2ljZXNMaXN0LnBhZ2luYXRpb24/LmNvdW50LFxuICAgICAgICAgIHRvdGFsUGFnZXM6IGludm9pY2VzTGlzdC5wYWdpbmF0aW9uPy50b3RhbFBhZ2VzLFxuICAgICAgICAgIHRvdGFsUmVzdWx0czogaW52b2ljZXNMaXN0LnBhZ2luYXRpb24/LnRvdGFsQ291bnQsXG4gICAgICAgICAgc29ydDogdGhpcy5zb3J0TWFwcGluZ1t0aGlzLnNvcnRdLFxuICAgICAgICB9KVxuICAgICksXG4gICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+IHtcbiAgICAgIGlmIChlcnJvciAmJiB0aGlzLmdldE5vdEVuYWJsZWRFcnJvcihlcnJvcik/Lmxlbmd0aCkge1xuICAgICAgICB0aGlzLmdsb2JhbE1lc3NhZ2VTZXJ2aWNlLmFkZChcbiAgICAgICAgICB7IGtleTogJ3BkZkludm9pY2VzLmZlYXR1cmVOb3RFbmFibGVkJyB9LFxuICAgICAgICAgIEdsb2JhbE1lc3NhZ2VUeXBlLk1TR19UWVBFX0VSUk9SXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICByZXR1cm4gRU1QVFk7XG4gICAgfSlcbiAgKTtcblxuICBwcm90ZWN0ZWQgc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBwZGZJbnZvaWNlc0ZhY2FkZTogUERGSW52b2ljZXNGYWNhZGUsXG4gICAgcHJvdGVjdGVkIHRyYW5zbGF0aW9uU2VydmljZTogVHJhbnNsYXRpb25TZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBkb3dubG9hZFNlcnZpY2U6IEZpbGVEb3dubG9hZFNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGxhbmd1YWdlU2VydmljZTogTGFuZ3VhZ2VTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBnbG9iYWxNZXNzYWdlU2VydmljZTogR2xvYmFsTWVzc2FnZVNlcnZpY2VcbiAgKSB7fVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgIHRoaXMubGFuZ3VhZ2VTZXJ2aWNlXG4gICAgICAgIC5nZXRBY3RpdmUoKVxuICAgICAgICAucGlwZShza2lwKDEpKVxuICAgICAgICAuc3Vic2NyaWJlKCgpID0+XG4gICAgICAgICAgdGhpcy51cGRhdGVRdWVyeVBhcmFtcyh7IGZpZWxkczogSW52b2ljZXNGaWVsZHMuRlVMTCB9KVxuICAgICAgICApXG4gICAgKTtcblxuICAgIHRoaXMuZ2V0U29ydE9wdGlvbnMoKTtcbiAgfVxuXG4gIHByb3RlY3RlZCB1cGRhdGVRdWVyeVBhcmFtcyhwYXJ0aWFsUGFyYW1zOiBJbnZvaWNlUXVlcnlQYXJhbXMpIHtcbiAgICAvLyBPdmVyd3JpdGUgZWFjaCB2YWx1ZSBwcmVzZW50IGluIHBhcnRpYWxQYXJhbXMgdG8gX3F1ZXJ5UGFyYW1zXG4gICAgT2JqZWN0LmtleXMocGFydGlhbFBhcmFtcykuZm9yRWFjaChcbiAgICAgIChrZXkpID0+XG4gICAgICAgICgodGhpcy5faW5pdFF1ZXJ5UGFyYW1zIGFzIGFueSlba2V5XSA9IChwYXJ0aWFsUGFyYW1zIGFzIGFueSlba2V5XSlcbiAgICApO1xuXG4gICAgLy8gRXZlcnkgcmVxdWVzdCB0aGF0IGRvZXNuJ3Qgc3BlY2lmeSBmaWVsZHMgc2hvdWxkIGJlIHNldCB0byBERUZBVUxUXG4gICAgaWYgKCFwYXJ0aWFsUGFyYW1zLmZpZWxkcykge1xuICAgICAgdGhpcy5faW5pdFF1ZXJ5UGFyYW1zLmZpZWxkcyA9IEludm9pY2VzRmllbGRzLkRFRkFVTFQ7XG4gICAgfVxuXG4gICAgdGhpcy5xdWVyeVBhcmFtcyQubmV4dCh0aGlzLl9pbml0UXVlcnlQYXJhbXMpO1xuICB9XG5cbiAgcGFnZUNoYW5nZShjdXJyZW50UGFnZTogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy51cGRhdGVRdWVyeVBhcmFtcyh7XG4gICAgICBjdXJyZW50UGFnZTogY3VycmVudFBhZ2UsXG4gICAgfSk7XG4gIH1cblxuICBzb3J0Q2hhbmdlKHNvcnRDb2RlOiBzdHJpbmcpOiB2b2lkIHtcbiAgICB0aGlzLnNvcnQgPSBzb3J0Q29kZTtcbiAgICB0aGlzLnVwZGF0ZVF1ZXJ5UGFyYW1zKHtcbiAgICAgIHNvcnQ6IHRoaXMuc29ydE1hcHBpbmdbc29ydENvZGVdLCAvL2JhY2tlbmQgc3VwcG9ydHMgc29ydCBjb2RlcyBsaWtlIGludm9pY2VJZDphc2NcbiAgICAgIGN1cnJlbnRQYWdlOiAwLFxuICAgIH0pO1xuICB9XG5cbiAgZG93bmxvYWRQREZJbnZvaWNlKGludm9pY2VJZDogc3RyaW5nLCBleHRlcm5hbFN5c3RlbUlkPzogc3RyaW5nKTogdm9pZCB7XG4gICAgdGhpcy5wZGZJbnZvaWNlc0ZhY2FkZVxuICAgICAgLmdldEludm9pY2VQREYoaW52b2ljZUlkLCBleHRlcm5hbFN5c3RlbUlkKVxuICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICBuZXh0OiAoZGF0YSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGZpbGUgPSBuZXcgQmxvYihbZGF0YV0sIHsgdHlwZTogZGF0YS50eXBlIH0pO1xuICAgICAgICAgIGNvbnN0IHVybCA9IFVSTC5jcmVhdGVPYmplY3RVUkwoZmlsZSk7XG4gICAgICAgICAgdGhpcy5kb3dubG9hZFNlcnZpY2UuZG93bmxvYWQodXJsLCBgJHtpbnZvaWNlSWR9LnBkZmApO1xuICAgICAgICB9LFxuICAgICAgfSk7XG4gIH1cblxuICBnZXRTb3J0T3B0aW9ucygpIHtcbiAgICB0aGlzLnNvcnRPcHRpb25zID0gW107XG4gICAgT2JqZWN0LmtleXModGhpcy5zb3J0TWFwcGluZykuZm9yRWFjaCgoc29ydEtleSkgPT5cbiAgICAgIHRoaXMuc29ydE9wdGlvbnMucHVzaCh7IGNvZGU6IHNvcnRLZXksIHNlbGVjdGVkOiBmYWxzZSB9KVxuICAgICk7XG5cbiAgICBjb25zdCB0cmFuc2xhdGlvbnMgPSB0aGlzLnNvcnRPcHRpb25zLm1hcCgoc29ydCkgPT5cbiAgICAgIHRoaXMudHJhbnNsYXRpb25TZXJ2aWNlLnRyYW5zbGF0ZShgcGRmSW52b2ljZXMuc29ydHMuJHtzb3J0LmNvZGV9YClcbiAgICApO1xuXG4gICAgY29tYmluZUxhdGVzdCh0cmFuc2xhdGlvbnMpXG4gICAgICAucGlwZSh0YWtlKDEpKVxuICAgICAgLnN1YnNjcmliZSgodHJhbnNsYXRlZCkgPT5cbiAgICAgICAgdGhpcy5zb3J0T3B0aW9ucy5mb3JFYWNoKFxuICAgICAgICAgIChzb3J0LCBpbmRleCkgPT4gKHNvcnQubmFtZSA9IHRyYW5zbGF0ZWRbaW5kZXhdKVxuICAgICAgICApXG4gICAgICApO1xuICB9XG5cbiAgZ2V0Tm90RW5hYmxlZEVycm9yKHJlc3BvbnNlOiBIdHRwRXJyb3JNb2RlbCk6IEVycm9yTW9kZWxbXSB7XG4gICAgcmV0dXJuIHJlc3BvbnNlPy5kZXRhaWxzXG4gICAgICA/IHJlc3BvbnNlLmRldGFpbHMuZmlsdGVyKFxuICAgICAgICAgIChlcnJvcjogYW55KSA9PiBlcnJvcj8udHlwZSA9PT0gJ1Vua25vd25SZXNvdXJjZUVycm9yJ1xuICAgICAgICApXG4gICAgICA6IFtdO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxufVxuIiwiPG5nLWNvbnRhaW5lciAqbmdJZj1cImludm9pY2VzTGlzdCQgfCBhc3luYyBhcyBpbnZvaWNlc0xpc3RcIj5cbiAgPG5nLWNvbnRhaW5lclxuICAgICpuZ0lmPVwiXG4gICAgICBpbnZvaWNlc0xpc3QucGFnaW5hdGlvbiAmJlxuICAgICAgaW52b2ljZXNMaXN0LnBhZ2luYXRpb24udG90YWxDb3VudCAmJlxuICAgICAgaW52b2ljZXNMaXN0LnBhZ2luYXRpb24udG90YWxDb3VudCA+IDBcbiAgICBcIlxuICA+XG4gICAgPGRpdj5cbiAgICAgIDwhLS0gSEVBREVSIC0tPlxuICAgICAgPGRpdiBjbGFzcz1cImN4LWludm9pY2VzLWxpc3QtaGVhZGVyXCI+XG4gICAgICAgIDxoMj5cbiAgICAgICAgICB7eyAncGRmSW52b2ljZXMuaW52b2ljZXNUYWJsZS5oZWFkZXInIHwgY3hUcmFuc2xhdGUgfX1cbiAgICAgICAgPC9oMj5cbiAgICAgIDwvZGl2PlxuXG4gICAgICA8IS0tIEJPRFkgLS0+XG4gICAgICA8ZGl2IGNsYXNzPVwiY3gtaW52b2ljZXMtbGlzdC1ib2R5XCI+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LXNvcnQgdG9wXCI+XG4gICAgICAgICAgPGxhYmVsIGNsYXNzPVwiY3gtaW52b2ljZXMtbGlzdC1mb3JtLWdyb3VwIGZvcm0tZ3JvdXBcIj5cbiAgICAgICAgICAgIDxzcGFuPlxuICAgICAgICAgICAgICB7eyAncGRmSW52b2ljZXMuc29ydEJ5JyB8IGN4VHJhbnNsYXRlIH19XG4gICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICA8Y3gtc29ydGluZ1xuICAgICAgICAgICAgICBbc29ydE9wdGlvbnNdPVwic29ydE9wdGlvbnNcIlxuICAgICAgICAgICAgICAoc29ydExpc3RFdmVudCk9XCJzb3J0Q2hhbmdlKCRldmVudClcIlxuICAgICAgICAgICAgICBbc2VsZWN0ZWRPcHRpb25dPVwic29ydFwiXG4gICAgICAgICAgICAgIHBsYWNlaG9sZGVyPVwie3sgJ3BkZkludm9pY2VzLnNvcnRCeScgfCBjeFRyYW5zbGF0ZSB9fVwiXG4gICAgICAgICAgICAgIFthcmlhTGFiZWxdPVwiJ3BkZkludm9pY2VzLnNvcnRJbnZvaWNlcycgfCBjeFRyYW5zbGF0ZVwiXG4gICAgICAgICAgICAgIGFyaWFDb250cm9scz1cImN4LWludm9pY2VzLWxpc3QtdGFibGVcIlxuICAgICAgICAgICAgPjwvY3gtc29ydGluZz5cbiAgICAgICAgICA8L2xhYmVsPlxuICAgICAgICAgIDxkaXZcbiAgICAgICAgICAgIGNsYXNzPVwiY3gtaW52b2ljZXMtbGlzdC1wYWdpbmF0aW9uXCJcbiAgICAgICAgICAgICpuZ0lmPVwiXG4gICAgICAgICAgICAgIGludm9pY2VzTGlzdC5wYWdpbmF0aW9uICYmXG4gICAgICAgICAgICAgIGludm9pY2VzTGlzdC5wYWdpbmF0aW9uLnRvdGFsUGFnZXMgJiZcbiAgICAgICAgICAgICAgaW52b2ljZXNMaXN0LnBhZ2luYXRpb24udG90YWxQYWdlcyA+IDFcbiAgICAgICAgICAgIFwiXG4gICAgICAgICAgPlxuICAgICAgICAgICAgPGN4LXBhZ2luYXRpb25cbiAgICAgICAgICAgICAgW3BhZ2luYXRpb25dPVwicGFnaW5hdGlvblwiXG4gICAgICAgICAgICAgICh2aWV3UGFnZUV2ZW50KT1cInBhZ2VDaGFuZ2UoJGV2ZW50KVwiXG4gICAgICAgICAgICA+PC9jeC1wYWdpbmF0aW9uPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICA8L2Rpdj5cblxuICAgICAgICA8IS0tIFRBQkxFIC0tPlxuICAgICAgICA8dGFibGVcbiAgICAgICAgICBpZD1cImN4LWludm9pY2VzLWxpc3QtdGFibGVcIlxuICAgICAgICAgIGNsYXNzPVwidGFibGUgY3gtaW52b2ljZXMtbGlzdC10YWJsZVwiXG4gICAgICAgICAgYXR0ci5hcmlhLWxhYmVsPVwie3tcbiAgICAgICAgICAgICdwZGZJbnZvaWNlcy5pbnZvaWNlc1RhYmxlLmxhYmVsJyB8IGN4VHJhbnNsYXRlXG4gICAgICAgICAgfX1cIlxuICAgICAgICA+XG4gICAgICAgICAgPHRoZWFkIGNsYXNzPVwiY3gtaW52b2ljZXMtbGlzdC10aGVhZC1tb2JpbGVcIj5cbiAgICAgICAgICAgIDx0aCBzY29wZT1cImNvbFwiPlxuICAgICAgICAgICAgICB7eyAncGRmSW52b2ljZXMuaW52b2ljZXNUYWJsZS5pbnZvaWNlSWQnIHwgY3hUcmFuc2xhdGUgfX1cbiAgICAgICAgICAgIDwvdGg+XG4gICAgICAgICAgICA8dGggc2NvcGU9XCJjb2xcIj5cbiAgICAgICAgICAgICAge3sgJ3BkZkludm9pY2VzLmludm9pY2VzVGFibGUuY3JlYXRlZEF0JyB8IGN4VHJhbnNsYXRlIH19XG4gICAgICAgICAgICA8L3RoPlxuICAgICAgICAgICAgPHRoIHNjb3BlPVwiY29sXCI+XG4gICAgICAgICAgICAgIHt7ICdwZGZJbnZvaWNlcy5pbnZvaWNlc1RhYmxlLm5ldEFtb3VudCcgfCBjeFRyYW5zbGF0ZSB9fVxuICAgICAgICAgICAgPC90aD5cbiAgICAgICAgICAgIDx0aCBzY29wZT1cImNvbFwiPlxuICAgICAgICAgICAgICB7eyAncGRmSW52b2ljZXMuaW52b2ljZXNUYWJsZS50b3RhbEFtb3VudCcgfCBjeFRyYW5zbGF0ZSB9fVxuICAgICAgICAgICAgPC90aD5cbiAgICAgICAgICAgIDx0aCBzY29wZT1cImNvbFwiPlxuICAgICAgICAgICAgICA8Y3gtaWNvblxuICAgICAgICAgICAgICAgIFt0eXBlXT1cIklDT05fVFlQRS5ET1dOTE9BRFwiXG4gICAgICAgICAgICAgICAgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LWF0dGFjaG1lbnQtaWNvblwiXG4gICAgICAgICAgICAgICAgdGl0bGU9XCJ7e1xuICAgICAgICAgICAgICAgICAgJ3BkZkludm9pY2VzLmludm9pY2VzVGFibGUuYXR0YWNobWVudCcgfCBjeFRyYW5zbGF0ZVxuICAgICAgICAgICAgICAgIH19XCJcbiAgICAgICAgICAgICAgPjwvY3gtaWNvbj5cbiAgICAgICAgICAgIDwvdGg+XG4gICAgICAgICAgPC90aGVhZD5cbiAgICAgICAgICA8dGJvZHk+XG4gICAgICAgICAgICA8dHJcbiAgICAgICAgICAgICAgKm5nRm9yPVwibGV0IGludm9pY2Ugb2YgaW52b2ljZXNMaXN0Lmludm9pY2VzXCJcbiAgICAgICAgICAgICAgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LXJvd1wiXG4gICAgICAgICAgICA+XG4gICAgICAgICAgICAgIDx0ZCBjbGFzcz1cImN4LWludm9pY2VzLWxpc3QtY29kZVwiPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LWxhYmVsXCI+XG4gICAgICAgICAgICAgICAgICB7eyAncGRmSW52b2ljZXMuaW52b2ljZXNUYWJsZS5pbnZvaWNlSWQnIHwgY3hUcmFuc2xhdGUgfX1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwiY3gtaW52b2ljZXMtbGlzdC12YWx1ZVwiPlxuICAgICAgICAgICAgICAgICAge3sgaW52b2ljZS5pbnZvaWNlSWQgfX1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgPC90ZD5cbiAgICAgICAgICAgICAgPHRkIGNsYXNzPVwiY3gtaW52b2ljZXMtbGlzdC1kYXRlXCI+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cImN4LWludm9pY2VzLWxpc3QtbGFiZWxcIj5cbiAgICAgICAgICAgICAgICAgIHt7ICdwZGZJbnZvaWNlcy5pbnZvaWNlc1RhYmxlLmNyZWF0ZWRBdCcgfCBjeFRyYW5zbGF0ZSB9fVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LXZhbHVlXCI+XG4gICAgICAgICAgICAgICAgICB7eyBpbnZvaWNlLmNyZWF0ZWRBdCB8IGN4RGF0ZTogJ2xvbmdEYXRlJyB9fVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICA8L3RkPlxuICAgICAgICAgICAgICA8dGQgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LW1vbmV0YXJ5XCI+XG4gICAgICAgICAgICAgICAgPGRpdiBjbGFzcz1cImN4LWludm9pY2VzLWxpc3QtbGFiZWxcIj5cbiAgICAgICAgICAgICAgICAgIHt7ICdwZGZJbnZvaWNlcy5pbnZvaWNlc1RhYmxlLm5ldEFtb3VudCcgfCBjeFRyYW5zbGF0ZSB9fVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LXZhbHVlXCI+XG4gICAgICAgICAgICAgICAgICB7e1xuICAgICAgICAgICAgICAgICAgICBpbnZvaWNlLm5ldEFtb3VudD8uZm9ybWF0dGVkVmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICA/IGludm9pY2UubmV0QW1vdW50Py5mb3JtYXR0ZWRWYWx1ZVxuICAgICAgICAgICAgICAgICAgICAgIDogaW52b2ljZS5uZXRBbW91bnQ/LmN1cnJlbmN5SXNvICtcbiAgICAgICAgICAgICAgICAgICAgICAgICcmbmJzcDsnICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGludm9pY2UubmV0QW1vdW50Py52YWx1ZVxuICAgICAgICAgICAgICAgICAgfX1cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgPC90ZD5cbiAgICAgICAgICAgICAgPHRkIGNsYXNzPVwiY3gtaW52b2ljZXMtbGlzdC1tb25ldGFyeVwiPlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LWxhYmVsXCI+XG4gICAgICAgICAgICAgICAgICB7eyAncGRmSW52b2ljZXMuaW52b2ljZXNUYWJsZS50b3RhbEFtb3VudCcgfCBjeFRyYW5zbGF0ZSB9fVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LXZhbHVlXCI+XG4gICAgICAgICAgICAgICAgICB7e1xuICAgICAgICAgICAgICAgICAgICBpbnZvaWNlLnRvdGFsQW1vdW50Py5mb3JtYXR0ZWRWYWx1ZVxuICAgICAgICAgICAgICAgICAgICAgID8gaW52b2ljZS50b3RhbEFtb3VudD8uZm9ybWF0dGVkVmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICA6IGludm9pY2UudG90YWxBbW91bnQ/LmN1cnJlbmN5SXNvICtcbiAgICAgICAgICAgICAgICAgICAgICAgICcmbmJzcDsnICtcbiAgICAgICAgICAgICAgICAgICAgICAgIGludm9pY2UudG90YWxBbW91bnQ/LnZhbHVlXG4gICAgICAgICAgICAgICAgICB9fVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICA8L3RkPlxuICAgICAgICAgICAgICA8dGQgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LWF0dGFjaG1lbnRcIj5cbiAgICAgICAgICAgICAgICA8ZGl2IGNsYXNzPVwiY3gtaW52b2ljZXMtbGlzdC1sYWJlbFwiPlxuICAgICAgICAgICAgICAgICAge3sgJ3BkZkludm9pY2VzLmludm9pY2VzVGFibGUuYXR0YWNobWVudCcgfCBjeFRyYW5zbGF0ZSB9fVxuICAgICAgICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LXZhbHVlXCI+XG4gICAgICAgICAgICAgICAgICA8YnV0dG9uXG4gICAgICAgICAgICAgICAgICAgICpuZ0lmPVwiaW52b2ljZS5pbnZvaWNlSWRcIlxuICAgICAgICAgICAgICAgICAgICBjbGFzcz1cImN4LWludm9pY2VzLWxpc3QtYXR0YWNobWVudC1idG5cIlxuICAgICAgICAgICAgICAgICAgICAoY2xpY2spPVwiXG4gICAgICAgICAgICAgICAgICAgICAgZG93bmxvYWRQREZJbnZvaWNlKFxuICAgICAgICAgICAgICAgICAgICAgICAgaW52b2ljZS5pbnZvaWNlSWQsXG4gICAgICAgICAgICAgICAgICAgICAgICBpbnZvaWNlLmV4dGVybmFsU3lzdGVtSWRcbiAgICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgICAgIFwiXG4gICAgICAgICAgICAgICAgICAgIGF0dHIuYXJpYS1sYWJlbD1cInt7XG4gICAgICAgICAgICAgICAgICAgICAgJ3BkZkludm9pY2VzLmludm9pY2VzVGFibGUuYXR0YWNobWVudERlc2NyaXB0aW9uJ1xuICAgICAgICAgICAgICAgICAgICAgICAgfCBjeFRyYW5zbGF0ZVxuICAgICAgICAgICAgICAgICAgICAgICAgICA6IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlkOiBpbnZvaWNlLmludm9pY2VJZFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgfX1cIlxuICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICA8Y3gtaWNvblxuICAgICAgICAgICAgICAgICAgICAgIFt0eXBlXT1cIklDT05fVFlQRS5GSUxFXCJcbiAgICAgICAgICAgICAgICAgICAgICBjbGFzcz1cImN4LWludm9pY2VzLWxpc3QtYXR0YWNobWVudC1pY29uXCJcbiAgICAgICAgICAgICAgICAgICAgICB0aXRsZT1cInt7XG4gICAgICAgICAgICAgICAgICAgICAgICAncGRmSW52b2ljZXMuaW52b2ljZXNUYWJsZS5kb3dubG9hZCcgfCBjeFRyYW5zbGF0ZVxuICAgICAgICAgICAgICAgICAgICAgIH19XCJcbiAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICA8L2N4LWljb24+XG4gICAgICAgICAgICAgICAgICAgIDxzcGFuXG4gICAgICAgICAgICAgICAgICAgICAgY2xhc3M9XCJjeC1pbnZvaWNlcy1saXN0LWF0dGFjaG1lbnQtdGV4dFwiXG4gICAgICAgICAgICAgICAgICAgICAgW2lubmVyVGV4dF09XCJcbiAgICAgICAgICAgICAgICAgICAgICAgICdwZGZJbnZvaWNlcy5pbnZvaWNlc1RhYmxlLmRvd25sb2FkJyB8IGN4VHJhbnNsYXRlXG4gICAgICAgICAgICAgICAgICAgICAgXCJcbiAgICAgICAgICAgICAgICAgICAgPlxuICAgICAgICAgICAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgICAgICAgICA8L2J1dHRvbj5cbiAgICAgICAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICAgICAgPC90ZD5cbiAgICAgICAgICAgIDwvdHI+XG4gICAgICAgICAgPC90Ym9keT5cbiAgICAgICAgPC90YWJsZT5cblxuICAgICAgICA8IS0tIFNlbGVjdCBGb3JtIGFuZCBQYWdpbmF0aW9uIEJvdHRvbSAtLT5cbiAgICAgICAgPGRpdiBjbGFzcz1cImN4LWludm9pY2VzLWxpc3Qtc29ydCBib3R0b21cIj5cbiAgICAgICAgICA8ZGl2XG4gICAgICAgICAgICBjbGFzcz1cImN4LWludm9pY2VzLWxpc3QtcGFnaW5hdGlvblwiXG4gICAgICAgICAgICAqbmdJZj1cIlxuICAgICAgICAgICAgICBpbnZvaWNlc0xpc3QucGFnaW5hdGlvbiAmJlxuICAgICAgICAgICAgICBpbnZvaWNlc0xpc3QucGFnaW5hdGlvbi50b3RhbFBhZ2VzICYmXG4gICAgICAgICAgICAgIGludm9pY2VzTGlzdC5wYWdpbmF0aW9uLnRvdGFsUGFnZXMgPiAxXG4gICAgICAgICAgICBcIlxuICAgICAgICAgID5cbiAgICAgICAgICAgIDxjeC1wYWdpbmF0aW9uXG4gICAgICAgICAgICAgIFtwYWdpbmF0aW9uXT1cInBhZ2luYXRpb25cIlxuICAgICAgICAgICAgICAodmlld1BhZ2VFdmVudCk9XCJwYWdlQ2hhbmdlKCRldmVudClcIlxuICAgICAgICAgICAgPjwvY3gtcGFnaW5hdGlvbj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICA8L2Rpdj5cbiAgPC9uZy1jb250YWluZXI+XG48L25nLWNvbnRhaW5lcj5cbiJdfQ==