/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { B2BPaymentTypeEnum, CheckoutPaymentTypeSetEvent, CheckoutPaymentTypesQueryReloadEvent, CheckoutPaymentTypesQueryResetEvent, } from '@spartacus/checkout/b2b/root';
import { CommandStrategy, OCC_USER_ID_ANONYMOUS, } from '@spartacus/core';
import { combineLatest, of, throwError } from 'rxjs';
import { concatMap, filter, map, switchMap, take, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/cart/base/root";
import * as i2 from "@spartacus/core";
import * as i3 from "../connectors/checkout-payment-type/checkout-payment-type.connector";
import * as i4 from "@spartacus/checkout/base/root";
export class CheckoutPaymentTypeService {
    getCheckoutPaymentTypesQueryReloadEvents() {
        return [CheckoutPaymentTypesQueryReloadEvent];
    }
    getCheckoutPaymentTypesQueryResetEvents() {
        return [CheckoutPaymentTypesQueryResetEvent];
    }
    constructor(activeCartFacade, userIdService, queryService, commandService, paymentTypeConnector, eventService, checkoutQueryFacade) {
        this.activeCartFacade = activeCartFacade;
        this.userIdService = userIdService;
        this.queryService = queryService;
        this.commandService = commandService;
        this.paymentTypeConnector = paymentTypeConnector;
        this.eventService = eventService;
        this.checkoutQueryFacade = checkoutQueryFacade;
        this.paymentTypesQuery = this.queryService.create(() => this.paymentTypeConnector.getPaymentTypes(), {
            reloadOn: this.getCheckoutPaymentTypesQueryReloadEvents(),
            resetOn: this.getCheckoutPaymentTypesQueryResetEvents(),
        });
        this.setPaymentTypeCommand = this.commandService.create(({ paymentTypeCode, purchaseOrderNumber }) => this.checkoutPreconditions().pipe(switchMap(([userId, cartId]) => this.paymentTypeConnector
            .setPaymentType(userId, cartId, paymentTypeCode, purchaseOrderNumber)
            .pipe(tap(() => this.eventService.dispatch({
            userId,
            cartId,
            paymentTypeCode,
            purchaseOrderNumber,
        }, CheckoutPaymentTypeSetEvent))))), {
            strategy: CommandStrategy.CancelPrevious,
        });
    }
    checkoutPreconditions() {
        return combineLatest([
            this.userIdService.takeUserId(),
            this.activeCartFacade.takeActiveCartId(),
            this.activeCartFacade.isGuestCart(),
        ]).pipe(take(1), map(([userId, cartId, isGuestCart]) => {
            if (!userId ||
                !cartId ||
                (userId === OCC_USER_ID_ANONYMOUS && !isGuestCart)) {
                throw new Error('Checkout conditions not met');
            }
            return [userId, cartId];
        }));
    }
    getPaymentTypesState() {
        return this.paymentTypesQuery.getState();
    }
    getPaymentTypes() {
        return this.getPaymentTypesState().pipe(concatMap((state) => state?.error
            ? throwError(state.error)
            : of(state)), map((state) => state.data ?? []));
    }
    setPaymentType(paymentTypeCode, purchaseOrderNumber) {
        return this.setPaymentTypeCommand.execute({
            paymentTypeCode,
            purchaseOrderNumber,
        });
    }
    getSelectedPaymentTypeState() {
        return this.checkoutQueryFacade
            .getCheckoutDetailsState()
            .pipe(map((state) => ({ ...state, data: state.data?.paymentType })));
    }
    isAccountPayment() {
        return this.getSelectedPaymentTypeState().pipe(filter((state) => !state.loading), map((state) => state.data?.code === B2BPaymentTypeEnum.ACCOUNT_PAYMENT));
    }
    getPurchaseOrderNumberState() {
        return this.checkoutQueryFacade
            .getCheckoutDetailsState()
            .pipe(map((state) => ({ ...state, data: state.data?.purchaseOrderNumber })));
    }
}
CheckoutPaymentTypeService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CheckoutPaymentTypeService, deps: [{ token: i1.ActiveCartFacade }, { token: i2.UserIdService }, { token: i2.QueryService }, { token: i2.CommandService }, { token: i3.CheckoutPaymentTypeConnector }, { token: i2.EventService }, { token: i4.CheckoutQueryFacade }], target: i0.ɵɵFactoryTarget.Injectable });
CheckoutPaymentTypeService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CheckoutPaymentTypeService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CheckoutPaymentTypeService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.ActiveCartFacade }, { type: i2.UserIdService }, { type: i2.QueryService }, { type: i2.CommandService }, { type: i3.CheckoutPaymentTypeConnector }, { type: i2.EventService }, { type: i4.CheckoutQueryFacade }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2hlY2tvdXQtcGF5bWVudC10eXBlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvY2hlY2tvdXQvYjJiL2NvcmUvZmFjYWRlL2NoZWNrb3V0LXBheW1lbnQtdHlwZS5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFDTCxrQkFBa0IsRUFFbEIsMkJBQTJCLEVBQzNCLG9DQUFvQyxFQUNwQyxtQ0FBbUMsR0FDcEMsTUFBTSw4QkFBOEIsQ0FBQztBQUV0QyxPQUFPLEVBR0wsZUFBZSxFQUdmLHFCQUFxQixHQU10QixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBYyxhQUFhLEVBQUUsRUFBRSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRSxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLElBQUksRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7O0FBSTlFLE1BQU0sT0FBTywwQkFBMEI7SUFDM0Isd0NBQXdDO1FBQ2hELE9BQU8sQ0FBQyxvQ0FBb0MsQ0FBQyxDQUFDO0lBQ2hELENBQUM7SUFDUyx1Q0FBdUM7UUFDL0MsT0FBTyxDQUFDLG1DQUFtQyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQStDRCxZQUNZLGdCQUFrQyxFQUNsQyxhQUE0QixFQUM1QixZQUEwQixFQUMxQixjQUE4QixFQUM5QixvQkFBa0QsRUFDbEQsWUFBMEIsRUFDMUIsbUJBQXdDO1FBTnhDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsa0JBQWEsR0FBYixhQUFhLENBQWU7UUFDNUIsaUJBQVksR0FBWixZQUFZLENBQWM7UUFDMUIsbUJBQWMsR0FBZCxjQUFjLENBQWdCO1FBQzlCLHlC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RyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUUsQ0FBQyxDQUFDLEVBQUUsR0FBRyxLQUFLLEVBQUUsSUFBSSxFQUFFLEtBQUssQ0FBQyxJQUFJLEVBQUUsV0FBVyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDekUsQ0FBQztJQUVELGdCQUFnQjtRQUNkLE9BQU8sSUFBSSxDQUFDLDJCQUEyQixFQUFFLENBQUMsSUFBSSxDQUM1QyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxFQUNqQyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsSUFBSSxLQUFLLGtCQUFrQixDQUFDLGVBQWUsQ0FBQyxDQUN4RSxDQUFDO0lBQ0osQ0FBQztJQUVELDJCQUEyQjtRQUN6QixPQUFPLElBQUksQ0FBQyxtQkFBbUI7YUFDNUIsdUJBQXVCLEVBQUU7YUFDekIsSUFBSSxDQUNILEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsQ0FBQyxFQUFFLEdBQUcsS0FBSyxFQUFFLElBQUksRUFBRSxLQUFLLENBQUMsSUFBSSxFQUFFLG1CQUFtQixFQUFFLENBQUMsQ0FBQyxDQUN0RSxDQUFDO0lBQ04sQ0FBQzs7dUhBaklVLDBCQUEwQjsySEFBMUIsMEJBQTBCOzJGQUExQiwwQkFBMEI7a0JBRHRDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMyBTQVAgU3BhcnRhY3VzIHRlYW0gPHNwYXJ0YWN1cy10ZWFtQHNhcC5jb20+XG4gKlxuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3RpdmVDYXJ0RmFjYWRlLCBQYXltZW50VHlwZSB9IGZyb20gJ0BzcGFydGFjdXMvY2FydC9iYXNlL3Jvb3QnO1xuaW1wb3J0IHtcbiAgQjJCUGF5bWVudFR5cGVFbnVtLFxuICBDaGVja291dFBheW1lbnRUeXBlRmFjYWRlLFxuICBDaGVja291dFBheW1lbnRUeXBlU2V0RXZlbnQsXG4gIENoZWNrb3V0UGF5bWVudFR5cGVzUXVlcnlSZWxvYWRFdmVudCxcbiAgQ2hlY2tvdXRQYXltZW50VHlwZXNRdWVyeVJlc2V0RXZlbnQsXG59IGZyb20gJ0BzcGFydGFjdXMvY2hlY2tvdXQvYjJiL3Jvb3QnO1xuaW1wb3J0IHsgQ2hlY2tvdXRRdWVyeUZhY2FkZSB9IGZyb20gJ0BzcGFydGFjdXMvY2hlY2tvdXQvYmFzZS9yb290JztcbmltcG9ydCB7XG4gIENvbW1hbmQsXG4gIENvbW1hbmRTZXJ2aWNlLFxuICBDb21tYW5kU3RyYXRlZ3ksXG4gIEV2ZW50U2VydmljZSxcbiAgSHR0cEVycm9yTW9kZWwsXG4gIE9DQ19VU0VSX0lEX0FOT05ZTU9VUyxcbiAgUXVlcnksXG4gIFF1ZXJ5Tm90aWZpZXIsXG4gIFF1ZXJ5U2VydmljZSxcbiAgUXVlcnlTdGF0ZSxcbiAgVXNlcklkU2VydmljZSxcbn0gZnJvbSAnQHNwYXJ0YWN1cy9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIGNvbWJpbmVMYXRlc3QsIG9mLCB0aHJvd0Vycm9yIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBjb25jYXRNYXAsIGZpbHRlciwgbWFwLCBzd2l0Y2hNYXAsIHRha2UsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENoZWNrb3V0UGF5bWVudFR5cGVDb25uZWN0b3IgfSBmcm9tICcuLi9jb25uZWN0b3JzL2NoZWNrb3V0LXBheW1lbnQtdHlwZS9jaGVja291dC1wYXltZW50LXR5cGUuY29ubmVjdG9yJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIENoZWNrb3V0UGF5bWVudFR5cGVTZXJ2aWNlIGltcGxlbWVudHMgQ2hlY2tvdXRQYXltZW50VHlwZUZhY2FkZSB7XG4gIHByb3RlY3RlZCBnZXRDaGVja291dFBheW1lbnRUeXBlc1F1ZXJ5UmVsb2FkRXZlbnRzKCk6IFF1ZXJ5Tm90aWZpZXJbXSB7XG4gICAgcmV0dXJuIFtDaGVja291dFBheW1lbnRUeXBlc1F1ZXJ5UmVsb2FkRXZlbnRdO1xuICB9XG4gIHByb3RlY3RlZCBnZXRDaGVja291dFBheW1lbnRUeXBlc1F1ZXJ5UmVzZXRFdmVudHMoKTogUXVlcnlOb3RpZmllcltdIHtcbiAgICByZXR1cm4gW0NoZWNrb3V0UGF5bWVudFR5cGVzUXVlcnlSZXNldEV2ZW50XTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwYXltZW50VHlwZXNRdWVyeTogUXVlcnk8UGF5bWVudFR5cGVbXT4gPSB0aGlzLnF1ZXJ5U2VydmljZS5jcmVhdGUoXG4gICAgKCkgPT4gdGhpcy5wYXltZW50VHlwZUNvbm5lY3Rvci5nZXRQYXltZW50VHlwZXMoKSxcbiAgICB7XG4gICAgICByZWxvYWRPbjogdGhpcy5nZXRDaGVja291dFBheW1lbnRUeXBlc1F1ZXJ5UmVsb2FkRXZlbnRzKCksXG4gICAgICByZXNldE9uOiB0aGlzLmdldENoZWNrb3V0UGF5bWVudFR5cGVzUXVlcnlSZXNldEV2ZW50cygpLFxuICAgIH1cbiAgKTtcblxuICBwcm90ZWN0ZWQgc2V0UGF5bWVudFR5cGVDb21tYW5kOiBDb21tYW5kPFxuICAgIHsgcGF5bWVudFR5cGVDb2RlOiBzdHJpbmc7IHB1cmNoYXNlT3JkZXJOdW1iZXI/OiBzdHJpbmcgfSxcbiAgICB1bmtub3duXG4gID4gPSB0aGlzLmNvbW1hbmRTZXJ2aWNlLmNyZWF0ZTx7XG4gICAgcGF5bWVudFR5cGVDb2RlOiBzdHJpbmc7XG4gICAgcHVyY2hhc2VPcmRlck51bWJlcj86IHN0cmluZztcbiAgfT4oXG4gICAgKHsgcGF5bWVudFR5cGVDb2RlLCBwdXJjaGFzZU9yZGVyTnVtYmVyIH0pID0+XG4gICAgICB0aGlzLmNoZWNrb3V0UHJlY29uZGl0aW9ucygpLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoW3VzZXJJZCwgY2FydElkXSkgPT5cbiAgICAgICAgICB0aGlzLnBheW1lbnRUeXBlQ29ubmVjdG9yXG4gICAgICAgICAgICAuc2V0UGF5bWVudFR5cGUoXG4gICAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgICAgY2FydElkLFxuICAgICAgICAgICAgICBwYXltZW50VHlwZUNvZGUsXG4gICAgICAgICAgICAgIHB1cmNoYXNlT3JkZXJOdW1iZXJcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICB0YXAoKCkgPT5cbiAgICAgICAgICAgICAgICB0aGlzLmV2ZW50U2VydmljZS5kaXNwYXRjaChcbiAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgICAgICAgICBjYXJ0SWQsXG4gICAgICAgICAgICAgICAgICAgIHBheW1lbnRUeXBlQ29kZSxcbiAgICAgICAgICAgICAgICAgICAgcHVyY2hhc2VPcmRlck51bWJlcixcbiAgICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAgICBDaGVja291dFBheW1lbnRUeXBlU2V0RXZlbnRcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICB7XG4gICAgICBzdHJhdGVneTogQ29tbWFuZFN0cmF0ZWd5LkNhbmNlbFByZXZpb3VzLFxuICAgIH1cbiAgKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgYWN0aXZlQ2FydEZhY2FkZTogQWN0aXZlQ2FydEZhY2FkZSxcbiAgICBwcm90ZWN0ZWQgdXNlcklkU2VydmljZTogVXNlcklkU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgcXVlcnlTZXJ2aWNlOiBRdWVyeVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGNvbW1hbmRTZXJ2aWNlOiBDb21tYW5kU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgcGF5bWVudFR5cGVDb25uZWN0b3I6IENoZWNrb3V0UGF5bWVudFR5cGVDb25uZWN0b3IsXG4gICAgcHJvdGVjdGVkIGV2ZW50U2VydmljZTogRXZlbnRTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBjaGVja291dFF1ZXJ5RmFjYWRlOiBDaGVja291dFF1ZXJ5RmFjYWRlXG4gICkge31cblxuICBwcm90ZWN0ZWQgY2hlY2tvdXRQcmVjb25kaXRpb25zKCk6IE9ic2VydmFibGU8W3N0cmluZywgc3RyaW5nXT4ge1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMudXNlcklkU2VydmljZS50YWtlVXNlcklkKCksXG4gICAgICB0aGlzLmFjdGl2ZUNhcnRGYWNhZGUudGFrZUFjdGl2ZUNhcnRJZCgpLFxuICAgICAgdGhpcy5hY3RpdmVDYXJ0RmFjYWRlLmlzR3Vlc3RDYXJ0KCksXG4gICAgXSkucGlwZShcbiAgICAgIHRha2UoMSksXG4gICAgICBtYXAoKFt1c2VySWQsIGNhcnRJZCwgaXNHdWVzdENhcnRdKSA9PiB7XG4gICAgICAgIGlmIChcbiAgICAgICAgICAhdXNlcklkIHx8XG4gICAgICAgICAgIWNhcnRJZCB8fFxuICAgICAgICAgICh1c2VySWQgPT09IE9DQ19VU0VSX0lEX0FOT05ZTU9VUyAmJiAhaXNHdWVzdENhcnQpXG4gICAgICAgICkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ2hlY2tvdXQgY29uZGl0aW9ucyBub3QgbWV0Jyk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIFt1c2VySWQsIGNhcnRJZF07XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBnZXRQYXltZW50VHlwZXNTdGF0ZSgpOiBPYnNlcnZhYmxlPFF1ZXJ5U3RhdGU8UGF5bWVudFR5cGVbXSB8IHVuZGVmaW5lZD4+IHtcbiAgICByZXR1cm4gdGhpcy5wYXltZW50VHlwZXNRdWVyeS5nZXRTdGF0ZSgpO1xuICB9XG5cbiAgZ2V0UGF5bWVudFR5cGVzKCk6IE9ic2VydmFibGU8UGF5bWVudFR5cGVbXT4ge1xuICAgIHJldHVybiB0aGlzLmdldFBheW1lbnRUeXBlc1N0YXRlKCkucGlwZShcbiAgICAgIGNvbmNhdE1hcCgoc3RhdGUpID0+XG4gICAgICAgIChzdGF0ZT8uZXJyb3IgYXMgSHR0cEVycm9yTW9kZWwpXG4gICAgICAgICAgPyB0aHJvd0Vycm9yKHN0YXRlLmVycm9yIGFzIEh0dHBFcnJvck1vZGVsKVxuICAgICAgICAgIDogb2Yoc3RhdGUpXG4gICAgICApLFxuICAgICAgbWFwKChzdGF0ZSkgPT4gc3RhdGUuZGF0YSA/PyBbXSlcbiAgICApO1xuICB9XG5cbiAgc2V0UGF5bWVudFR5cGUoXG4gICAgcGF5bWVudFR5cGVDb2RlOiBCMkJQYXltZW50VHlwZUVudW0sXG4gICAgcHVyY2hhc2VPcmRlck51bWJlcj86IHN0cmluZ1xuICApOiBPYnNlcnZhYmxlPHVua25vd24+IHtcbiAgICByZXR1cm4gdGhpcy5zZXRQYXltZW50VHlwZUNvbW1hbmQuZXhlY3V0ZSh7XG4gICAgICBwYXltZW50VHlwZUNvZGUsXG4gICAgICBwdXJjaGFzZU9yZGVyTnVtYmVyLFxuICAgIH0pO1xuICB9XG5cbiAgZ2V0U2VsZWN0ZWRQYXltZW50VHlwZVN0YXRlKCk6IE9ic2VydmFibGU8XG4gICAgUXVlcnlTdGF0ZTxQYXltZW50VHlwZSB8IHVuZGVmaW5lZD5cbiAgPiB7XG4gICAgcmV0dXJuIHRoaXMuY2hlY2tvdXRRdWVyeUZhY2FkZVxuICAgICAgLmdldENoZWNrb3V0RGV0YWlsc1N0YXRlKClcbiAgICAgIC5waXBlKG1hcCgoc3RhdGUpID0+ICh7IC4uLnN0YXRlLCBkYXRhOiBzdGF0ZS5kYXRhPy5wYXltZW50VHlwZSB9KSkpO1xuICB9XG5cbiAgaXNBY2NvdW50UGF5bWVudCgpOiBPYnNlcnZhYmxlPGJvb2xlYW4+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRTZWxlY3RlZFBheW1lbnRUeXBlU3RhdGUoKS5waXBlKFxuICAgICAgZmlsdGVyKChzdGF0ZSkgPT4gIXN0YXRlLmxvYWRpbmcpLFxuICAgICAgbWFwKChzdGF0ZSkgPT4gc3RhdGUuZGF0YT8uY29kZSA9PT0gQjJCUGF5bWVudFR5cGVFbnVtLkFDQ09VTlRfUEFZTUVOVClcbiAgICApO1xuICB9XG5cbiAgZ2V0UHVyY2hhc2VPcmRlck51bWJlclN0YXRlKCk6IE9ic2VydmFibGU8UXVlcnlTdGF0ZTxzdHJpbmcgfCB1bmRlZmluZWQ+PiB7XG4gICAgcmV0dXJuIHRoaXMuY2hlY2tvdXRRdWVyeUZhY2FkZVxuICAgICAgLmdldENoZWNrb3V0RGV0YWlsc1N0YXRlKClcbiAgICAgIC5waXBlKFxuICAgICAgICBtYXAoKHN0YXRlKSA9PiAoeyAuLi5zdGF0ZSwgZGF0YTogc3RhdGUuZGF0YT8ucHVyY2hhc2VPcmRlck51bWJlciB9KSlcbiAgICAgICk7XG4gIH1cbn1cbiJdfQ==