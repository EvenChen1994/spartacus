{"version":3,"file":"spartacus-smartedit-root.mjs","sources":["../../../feature-libs/smartedit/root/config/smart-edit-config.ts","../../../feature-libs/smartedit/root/feature-name.ts","../../../feature-libs/smartedit/root/services/smart-edit-launcher.service.ts","../../../feature-libs/smartedit/root/config/default-smart-edit-config.ts","../../../feature-libs/smartedit/root/http-interceptors/cms-ticket.interceptor.ts","../../../feature-libs/smartedit/root/http-interceptors/index.ts","../../../feature-libs/smartedit/root/smart-edit-root.module.ts","../../../feature-libs/smartedit/root/public_api.ts","../../../feature-libs/smartedit/root/spartacus-smartedit-root.ts"],"sourcesContent":["/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { Injectable } from '@angular/core';\nimport { Config } from '@spartacus/core';\n\n@Injectable({\n  providedIn: 'root',\n  useExisting: Config,\n})\nexport abstract class SmartEditConfig {\n  smartEdit?: {\n    storefrontPreviewRoute?: string;\n    allowOrigin?: string;\n  };\n}\n\ndeclare module '@spartacus/core' {\n  interface Config extends SmartEditConfig {}\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport const SMART_EDIT_FEATURE = 'smartEdit';\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { Location } from '@angular/common';\nimport { inject, Injectable } from '@angular/core';\nimport { FeatureModulesService, ScriptLoader } from '@spartacus/core';\nimport { SmartEditConfig } from '../config/smart-edit-config';\nimport { SMART_EDIT_FEATURE } from '../feature-name';\n\n/**\n * The SmartEditLauncherService is used to check whether Spartacus is launched inside Smart Edit;\n * it also gets cmsTicketId sent from Smart Edit.\n */\n@Injectable({\n  providedIn: 'root',\n})\nexport class SmartEditLauncherService {\n  protected readonly featureModulesService = inject(FeatureModulesService);\n  private _cmsTicketId: string | undefined;\n\n  get cmsTicketId(): string | undefined {\n    return this._cmsTicketId;\n  }\n\n  constructor(\n    protected config: SmartEditConfig,\n    protected location: Location,\n    protected scriptLoader: ScriptLoader\n  ) {}\n\n  /**\n   * load webApplicationInjector.js first when Spartacus launched inside SmartEdit\n   */\n  load(): void {\n    if (this.isLaunchedInSmartEdit()) {\n      this.featureModulesService.resolveFeature(SMART_EDIT_FEATURE).subscribe();\n\n      this.scriptLoader?.embedScript({\n        src: 'assets/webApplicationInjector.js',\n        params: undefined,\n        attributes: {\n          id: 'text/smartedit-injector',\n          'data-smartedit-allow-origin': this.config.smartEdit?.allowOrigin,\n        },\n      });\n    }\n  }\n\n  /**\n   * Indicates whether Spartacus is launched in SmartEdit\n   */\n  isLaunchedInSmartEdit(): boolean {\n    const path = this.location.path().split('?')[0];\n    const params = this.location.path().split('?')[1];\n    const cmsToken = params\n      ?.split('&')\n      .find((param) => param.startsWith('cmsTicketId='));\n    this._cmsTicketId = cmsToken?.split('=')[1];\n\n    return (\n      path.split('/').pop() === this.config.smartEdit?.storefrontPreviewRoute &&\n      !!this._cmsTicketId\n    );\n  }\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { SmartEditConfig } from './smart-edit-config';\n\nexport const defaultSmartEditConfig: SmartEditConfig = {\n  smartEdit: {\n    storefrontPreviewRoute: 'cx-preview',\n    allowOrigin: 'localhost:9002',\n  },\n};\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport {\n  HttpEvent,\n  HttpHandler,\n  HttpInterceptor,\n  HttpRequest,\n} from '@angular/common/http';\nimport { Injectable, inject } from '@angular/core';\nimport {\n  FeatureConfigService,\n  PageContext,\n  RoutingService,\n} from '@spartacus/core';\nimport { Observable } from 'rxjs';\nimport { switchMap, take } from 'rxjs/operators';\nimport { SmartEditLauncherService } from '../services/smart-edit-launcher.service';\n\n@Injectable({ providedIn: 'root' })\nexport class CmsTicketInterceptor implements HttpInterceptor {\n  routingService = inject(RoutingService);\n  featureConfig = inject(FeatureConfigService);\n  constructor(protected service: SmartEditLauncherService) {}\n\n  intercept(\n    request: HttpRequest<any>,\n    next: HttpHandler\n  ): Observable<HttpEvent<any>> {\n    const cmsTicketId = this.service.cmsTicketId;\n    if (!cmsTicketId) {\n      return next.handle(request);\n    }\n    if (\n      this.featureConfig.isLevel('6.6') &&\n      request.url.includes('/productList')\n    ) {\n      return this.setRequestForProductListPage(request, next, cmsTicketId);\n    }\n    if (request.url.includes('/cms/') || request.url.includes('/products/')) {\n      request = request.clone({\n        setParams: {\n          cmsTicketId,\n        },\n      });\n    }\n\n    return next.handle(request);\n  }\n\n  protected setRequestForProductListPage(\n    request: HttpRequest<any>,\n    next: HttpHandler,\n    cmsTicketId: string\n  ) {\n    return this.routingService.getPageContext().pipe(\n      take(1),\n      switchMap((pageContext: PageContext) => {\n        request = request.clone(\n          !!pageContext.id\n            ? {\n                setParams: {\n                  cmsTicketId,\n                  categoryCode: pageContext.id,\n                },\n              }\n            : {\n                setParams: {\n                  cmsTicketId,\n                },\n              }\n        );\n        return next.handle(request);\n      })\n    );\n  }\n}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { HTTP_INTERCEPTORS } from '@angular/common/http';\nimport { Provider } from '@angular/core';\nimport { CmsTicketInterceptor } from './cms-ticket.interceptor';\n\nexport const interceptors: Provider[] = [\n  {\n    provide: HTTP_INTERCEPTORS,\n    useExisting: CmsTicketInterceptor,\n    multi: true,\n  },\n];\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nimport { APP_INITIALIZER, NgModule } from '@angular/core';\nimport { provideDefaultConfig } from '@spartacus/core';\nimport { defaultSmartEditConfig } from './config/default-smart-edit-config';\nimport { interceptors } from './http-interceptors/index';\nimport { SmartEditLauncherService } from './services/smart-edit-launcher.service';\n\nexport function smartEditFactory(\n  smartEditLauncherService: SmartEditLauncherService\n): () => void {\n  const isReady = () => {\n    smartEditLauncherService.load();\n  };\n  return isReady;\n}\n\n@NgModule({\n  providers: [\n    ...interceptors,\n    provideDefaultConfig(defaultSmartEditConfig),\n    {\n      provide: APP_INITIALIZER,\n      useFactory: smartEditFactory,\n      deps: [SmartEditLauncherService],\n      multi: true,\n    },\n  ],\n})\nexport class SmartEditRootModule {}\n","/*\n * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>\n *\n * SPDX-License-Identifier: Apache-2.0\n */\n\nexport * from './config/smart-edit-config';\nexport * from './feature-name';\nexport * from './services/smart-edit-launcher.service';\nexport * from './smart-edit-root.module';\nexport * from './http-interceptors/cms-ticket.interceptor';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public_api';\n"],"names":["i1.SmartEditConfig","i1.SmartEditLauncherService"],"mappings":"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"}