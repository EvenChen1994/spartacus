/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { ChangeDetectionStrategy, Component, } from '@angular/core';
import { UntypedFormGroup } from '@angular/forms';
import { AnonymousConsentsService } from '@spartacus/core';
import { ICON_TYPE, LaunchDialogService, } from '@spartacus/storefront';
import { of, Subscription } from 'rxjs';
import { map } from 'rxjs/operators';
import { CdcReconsentComponentService } from './cdc-reconsent-component.service';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/storefront";
import * as i2 from "@spartacus/core";
import * as i3 from "./cdc-reconsent-component.service";
import * as i4 from "@angular/common";
export class CdcReconsentComponent {
    constructor(launchDialogService, anonymousConsentsService, cdcReconsentService) {
        this.launchDialogService = launchDialogService;
        this.anonymousConsentsService = anonymousConsentsService;
        this.cdcReconsentService = cdcReconsentService;
        this.subscription = new Subscription();
        this.form = new UntypedFormGroup({});
        this.iconTypes = ICON_TYPE;
        this.loaded$ = of(false);
        this.reconsentEvent = {};
        this.selectedConsents = [];
        this.disableSubmitButton = true;
        this.totalConsents = 0;
        this.focusConfig = {
            trap: true,
            block: true,
            autofocus: 'button',
            focusOnEscape: true,
        };
    }
    ngOnInit() {
        this.subscription.add(this.launchDialogService.data$.subscribe((data) => {
            this.reconsentEvent['user'] = data.user;
            this.reconsentEvent['password'] = data.password;
            this.reconsentEvent['regToken'] = data.regToken;
            this.reconsentEvent['errorMessage'] = data.errorMessage;
            this.loadConsents(data.consentIds);
        }));
    }
    loadConsents(reconsentIds) {
        this.templateList$ = this.anonymousConsentsService.getTemplates(true).pipe(map((templateList) => {
            const output = [];
            templateList.forEach((template) => {
                if (template.id && reconsentIds.includes(template.id)) {
                    output.push(template);
                }
            });
            this.totalConsents = output.length;
            return output;
        }));
        this.loaded$ = of(true);
    }
    onConsentChange(event) {
        if (event.given === false && event.template?.id) {
            const index = this.selectedConsents.indexOf(event.template.id);
            if (index !== -1) {
                this.selectedConsents.splice(index, 1);
            }
        }
        else if (event.given === true && event.template?.id) {
            this.selectedConsents.push(event.template.id);
        }
        if (this.totalConsents === this.selectedConsents.length) {
            this.disableSubmitButton = false;
        }
        else {
            this.disableSubmitButton = true;
        }
    }
    dismissDialog(reason, message) {
        if (reason === 'Proceed To Login') {
            this.loaded$ = of(false);
            this.cdcReconsentService.saveConsentAndLogin(this.selectedConsents, this.reconsentEvent);
        }
        else {
            this.cdcReconsentService.handleReconsentUpdateError(reason, message);
        }
    }
    ngOnDestroy() {
        this.subscription?.unsubscribe();
    }
}
CdcReconsentComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CdcReconsentComponent, deps: [{ token: i1.LaunchDialogService }, { token: i2.AnonymousConsentsService }, { token: i3.CdcReconsentComponentService }], target: i0.ɵɵFactoryTarget.Component });
CdcReconsentComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.9", type: CdcReconsentComponent, selector: "cx-anonymous-consent-dialog", ngImport: i0, template: "<div\n  class=\"cx-anonymous-consent-dialog\"\n  [cxFocus]=\"focusConfig\"\n  (esc)=\"dismissDialog('Escape pressed', reconsentEvent.errorMessage)\"\n>\n  <div class=\"cx-dialog-content\">\n    <!-- Modal Header -->\n    <ng-container *ngIf=\"loaded$ | async; else loading\">\n      <div class=\"cx-dialog-header\">\n        <h3>\n          {{ 'reconsent.dialog.title' | cxTranslate }}\n        </h3>\n        <button\n          type=\"button\"\n          class=\"close\"\n          [attr.aria-label]=\"'common.close' | cxTranslate\"\n          (click)=\"dismissDialog('Cross click', reconsentEvent.errorMessage)\"\n        >\n          <span aria-hidden=\"true\">\n            <cx-icon [type]=\"iconTypes.CLOSE\"></cx-icon>\n          </span>\n        </button>\n      </div>\n      <div class=\"cx-dialog-description\">\n        {{ 'reconsent.dialog.description' | cxTranslate }}\n        <div\n          class=\"cx-dialog-separator col-sm-12 d-xs-block d-sm-block d-md-none\"\n        ></div>\n      </div>\n      <div class=\"cx-dialog-buttons\"></div>\n      <!-- Modal Body -->\n      <div class=\"cx-dialog-body\" *ngIf=\"templateList$ | async as templateList\">\n        <div\n          class=\"cx-dialog-row col-sm-12 col-md-6\"\n          *ngFor=\"let consentTemplate of templateList\"\n        >\n          <cx-consent-management-form\n            [consentTemplate]=\"consentTemplate\"\n            (consentChanged)=\"onConsentChange($event)\"\n          ></cx-consent-management-form>\n        </div>\n      </div>\n      <!-- Actions -->\n      <div class=\"cx-dialog-buttons\">\n        <a\n          [class.disabled]=\"disableSubmitButton\"\n          (click)=\"\n            dismissDialog('Proceed To Login', reconsentEvent.errorMessage)\n          \"\n          class=\"btn btn-primary\"\n          autofocus\n          >{{ 'common.submit' | cxTranslate }}</a\n        >\n      </div>\n    </ng-container>\n  </div>\n\n  <ng-template #loading>\n    <cx-spinner></cx-spinner>\n  </ng-template>\n</div>\n", dependencies: [{ kind: "directive", type: i4.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i4.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i1.SpinnerComponent, selector: "cx-spinner" }, { kind: "component", type: i1.IconComponent, selector: "cx-icon,[cxIcon]", inputs: ["cxIcon", "type"] }, { kind: "directive", type: i1.FocusDirective, selector: "[cxFocus]", inputs: ["cxFocus"] }, { kind: "component", type: i1.ConsentManagementFormComponent, selector: "cx-consent-management-form", inputs: ["consentTemplate", "requiredConsents", "consent"], outputs: ["consentChanged"] }, { kind: "pipe", type: i4.AsyncPipe, name: "async" }, { kind: "pipe", type: i2.TranslatePipe, name: "cxTranslate" }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CdcReconsentComponent, decorators: [{
            type: Component,
            args: [{ selector: 'cx-anonymous-consent-dialog', changeDetection: ChangeDetectionStrategy.OnPush, template: "<div\n  class=\"cx-anonymous-consent-dialog\"\n  [cxFocus]=\"focusConfig\"\n  (esc)=\"dismissDialog('Escape pressed', reconsentEvent.errorMessage)\"\n>\n  <div class=\"cx-dialog-content\">\n    <!-- Modal Header -->\n    <ng-container *ngIf=\"loaded$ | async; else loading\">\n      <div class=\"cx-dialog-header\">\n        <h3>\n          {{ 'reconsent.dialog.title' | cxTranslate }}\n        </h3>\n        <button\n          type=\"button\"\n          class=\"close\"\n          [attr.aria-label]=\"'common.close' | cxTranslate\"\n          (click)=\"dismissDialog('Cross click', reconsentEvent.errorMessage)\"\n        >\n          <span aria-hidden=\"true\">\n            <cx-icon [type]=\"iconTypes.CLOSE\"></cx-icon>\n          </span>\n        </button>\n      </div>\n      <div class=\"cx-dialog-description\">\n        {{ 'reconsent.dialog.description' | cxTranslate }}\n        <div\n          class=\"cx-dialog-separator col-sm-12 d-xs-block d-sm-block d-md-none\"\n        ></div>\n      </div>\n      <div class=\"cx-dialog-buttons\"></div>\n      <!-- Modal Body -->\n      <div class=\"cx-dialog-body\" *ngIf=\"templateList$ | async as templateList\">\n        <div\n          class=\"cx-dialog-row col-sm-12 col-md-6\"\n          *ngFor=\"let consentTemplate of templateList\"\n        >\n          <cx-consent-management-form\n            [consentTemplate]=\"consentTemplate\"\n            (consentChanged)=\"onConsentChange($event)\"\n          ></cx-consent-management-form>\n        </div>\n      </div>\n      <!-- Actions -->\n      <div class=\"cx-dialog-buttons\">\n        <a\n          [class.disabled]=\"disableSubmitButton\"\n          (click)=\"\n            dismissDialog('Proceed To Login', reconsentEvent.errorMessage)\n          \"\n          class=\"btn btn-primary\"\n          autofocus\n          >{{ 'common.submit' | cxTranslate }}</a\n        >\n      </div>\n    </ng-container>\n  </div>\n\n  <ng-template #loading>\n    <cx-spinner></cx-spinner>\n  </ng-template>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: i1.LaunchDialogService }, { type: i2.AnonymousConsentsService }, { type: i3.CdcReconsentComponentService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2RjLXJlY29uc2VudC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9pbnRlZ3JhdGlvbi1saWJzL2NkYy91c2VyLWFjY291bnQvbG9naW4tZm9ybS9yZWNvbnNlbnQvY2RjLXJlY29uc2VudC5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi9pbnRlZ3JhdGlvbi1saWJzL2NkYy91c2VyLWFjY291bnQvbG9naW4tZm9ybS9yZWNvbnNlbnQvY2RjLXJlY29uc2VudC5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUNMLHVCQUF1QixFQUN2QixTQUFTLEdBR1YsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDbEQsT0FBTyxFQUFFLHdCQUF3QixFQUFtQixNQUFNLGlCQUFpQixDQUFDO0FBQzVFLE9BQU8sRUFFTCxTQUFTLEVBQ1QsbUJBQW1CLEdBQ3BCLE1BQU0sdUJBQXVCLENBQUM7QUFDL0IsT0FBTyxFQUFjLEVBQUUsRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDcEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQ3JDLE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLG1DQUFtQyxDQUFDOzs7Ozs7QUFPakYsTUFBTSxPQUFPLHFCQUFxQjtJQXFCaEMsWUFDWSxtQkFBd0MsRUFDeEMsd0JBQWtELEVBQ2xELG1CQUFpRDtRQUZqRCx3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBMEI7UUFDbEQsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUE4QjtRQXZCbkQsaUJBQVksR0FBRyxJQUFJLFlBQVksRUFBRSxDQUFDO1FBRTVDLFNBQUksR0FBcUIsSUFBSSxnQkFBZ0IsQ0FBQyxF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QUFDO1NBQ2xDO2FBQU07WUFDTCxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDO1NBQ2pDO0lBQ0gsQ0FBQztJQUVELGFBQWEsQ0FBQyxNQUFZLEVBQUUsT0FBZ0I7UUFDMUMsSUFBSSxNQUFNLEtBQUssa0JBQWtCLEVBQUU7WUFDakMsSUFBSSxDQUFDLE9BQU8sR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDekIsSUFBSSxDQUFDLG1CQUFtQixDQUFDLG1CQUFtQixDQUMxQyxJQUFJLENBQUMsZ0JBQWdCLEVBQ3JCLElBQUksQ0FBQyxjQUFjLENBQ3BCLENBQUM7U0FDSDthQUFNO1lBQ0wsSUFBSSxDQUFDLG1CQUFtQixDQUFDLDBCQUEwQixDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQztTQUN0RTtJQUNILENBQUM7SUFFRCxXQUFXO1FBQ1QsSUFBSSxDQUFDLFlBQVksRUFBRSxXQUFXLEVBQUUsQ0FBQztJQUNuQyxDQUFDOztrSEFyRlUscUJBQXFCO3NHQUFyQixxQkFBcUIsbUVDNUJsQyxxK0RBNkRBOzJGRGpDYSxxQkFBcUI7a0JBTGpDLFNBQVM7K0JBQ0UsNkJBQTZCLG1CQUV0Qix1QkFBdUIsQ0FBQyxNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHtcbiAgQ2hhbmdlRGV0ZWN0aW9uU3RyYXRlZ3ksXG4gIENvbXBvbmVudCxcbiAgT25EZXN0cm95LFxuICBPbkluaXQsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVW50eXBlZEZvcm1Hcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IEFub255bW91c0NvbnNlbnRzU2VydmljZSwgQ29uc2VudFRlbXBsYXRlIH0gZnJvbSAnQHNwYXJ0YWN1cy9jb3JlJztcbmltcG9ydCB7XG4gIEZvY3VzQ29uZmlnLFxuICBJQ09OX1RZUEUsXG4gIExhdW5jaERpYWxvZ1NlcnZpY2UsXG59IGZyb20gJ0BzcGFydGFjdXMvc3RvcmVmcm9udCc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDZGNSZWNvbnNlbnRDb21wb25lbnRTZXJ2aWNlIH0gZnJvbSAnLi9jZGMtcmVjb25zZW50LWNvbXBvbmVudC5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnY3gtYW5vbnltb3VzLWNvbnNlbnQtZGlhbG9nJywgLy9yZXVzaW5nIGV4aXN0aW5nIHNlbGVjdG9yXG4gIHRlbXBsYXRlVXJsOiAnLi9jZGMtcmVjb25zZW50LmNvbXBvbmVudC5odG1sJyxcbiAgY2hhbmdlRGV0ZWN0aW9uOiBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneS5PblB1c2gsXG59KVxuZXhwb3J0IGNsYXNzIENkY1JlY29uc2VudENvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgcHJvdGVjdGVkIHN1YnNjcmlwdGlvbiA9IG5ldyBTdWJzY3JpcHRpb24oKTtcblxuICBmb3JtOiBVbnR5cGVkRm9ybUdyb3VwID0gbmV3IFVudHlwZWRGb3JtR3JvdXAoe30pO1xuICBpY29uVHlwZXMgPSBJQ09OX1RZUEU7XG4gIGxvYWRlZCQ6IE9ic2VydmFibGU8Ym9vbGVhbj4gPSBvZihmYWxzZSk7XG5cbiAgdGVtcGxhdGVMaXN0JDogT2JzZXJ2YWJsZTxDb25zZW50VGVtcGxhdGVbXT47XG4gIHJlY29uc2VudEV2ZW50OiBhbnkgPSB7fTtcblxuICBzZWxlY3RlZENvbnNlbnRzOiBzdHJpbmdbXSA9IFtdO1xuICBkaXNhYmxlU3VibWl0QnV0dG9uOiBib29sZWFuID0gdHJ1ZTtcbiAgdG90YWxDb25zZW50czogbnVtYmVyID0gMDtcblxuICBmb2N1c0NvbmZpZzogRm9jdXNDb25maWcgPSB7XG4gICAgdHJhcDogdHJ1ZSxcbiAgICBibG9jazogdHJ1ZSxcbiAgICBhdXRvZm9jdXM6ICdidXR0b24nLFxuICAgIGZvY3VzT25Fc2NhcGU6IHRydWUsXG4gIH07XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGxhdW5jaERpYWxvZ1NlcnZpY2U6IExhdW5jaERpYWxvZ1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGFub255bW91c0NvbnNlbnRzU2VydmljZTogQW5vbnltb3VzQ29uc2VudHNTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBjZGNSZWNvbnNlbnRTZXJ2aWNlOiBDZGNSZWNvbnNlbnRDb21wb25lbnRTZXJ2aWNlXG4gICkge31cblxuICBuZ09uSW5pdCgpOiB2b2lkIHtcbiAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICB0aGlzLmxhdW5jaERpYWxvZ1NlcnZpY2UuZGF0YSQuc3Vic2NyaWJlKChkYXRhKSA9PiB7XG4gICAgICAgIHRoaXMucmVjb25zZW50RXZlbnRbJ3VzZXInXSA9IGRhdGEudXNlcjtcbiAgICAgICAgdGhpcy5yZWNvbnNlbnRFdmVudFsncGFzc3dvcmQnXSA9IGRhdGEucGFzc3dvcmQ7XG4gICAgICAgIHRoaXMucmVjb25zZW50RXZlbnRbJ3JlZ1Rva2VuJ10gPSBkYXRhLnJlZ1Rva2VuO1xuICAgICAgICB0aGlzLnJlY29uc2VudEV2ZW50WydlcnJvck1lc3NhZ2UnXSA9IGRhdGEuZXJyb3JNZXNzYWdlO1xuICAgICAgICB0aGlzLmxvYWRDb25zZW50cyhkYXRhLmNvbnNlbnRJZHMpO1xuICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgbG9hZENvbnNlbnRzKHJlY29uc2VudElkczogc3RyaW5nW10pOiB2b2lkIHtcbiAgICB0aGlzLnRlbXBsYXRlTGlzdCQgPSB0aGlzLmFub255bW91c0NvbnNlbnRzU2VydmljZS5nZXRUZW1wbGF0ZXModHJ1ZSkucGlwZShcbiAgICAgIG1hcCgodGVtcGxhdGVMaXN0KSA9PiB7XG4gICAgICAgIGNvbnN0IG91dHB1dDogQ29uc2VudFRlbXBsYXRlW10gPSBbXTtcbiAgICAgICAgdGVtcGxhdGVMaXN0LmZvckVhY2goKHRlbXBsYXRlKSA9PiB7XG4gICAgICAgICAgaWYgKHRlbXBsYXRlLmlkICYmIHJlY29uc2VudElkcy5pbmNsdWRlcyh0ZW1wbGF0ZS5pZCkpIHtcbiAgICAgICAgICAgIG91dHB1dC5wdXNoKHRlbXBsYXRlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgICAgICB0aGlzLnRvdGFsQ29uc2VudHMgPSBvdXRwdXQubGVuZ3RoO1xuICAgICAgICByZXR1cm4gb3V0cHV0O1xuICAgICAgfSlcbiAgICApO1xuICAgIHRoaXMubG9hZGVkJCA9IG9mKHRydWUpO1xuICB9XG5cbiAgb25Db25zZW50Q2hhbmdlKGV2ZW50OiB7IGdpdmVuOiBib29sZWFuOyB0ZW1wbGF0ZTogQ29uc2VudFRlbXBsYXRlIH0pIHtcbiAgICBpZiAoZXZlbnQuZ2l2ZW4gPT09IGZhbHNlICYmIGV2ZW50LnRlbXBsYXRlPy5pZCkge1xuICAgICAgY29uc3QgaW5kZXg6IG51bWJlciA9IHRoaXMuc2VsZWN0ZWRDb25zZW50cy5pbmRleE9mKGV2ZW50LnRlbXBsYXRlLmlkKTtcbiAgICAgIGlmIChpbmRleCAhPT0gLTEpIHtcbiAgICAgICAgdGhpcy5zZWxlY3RlZENvbnNlbnRzLnNwbGljZShpbmRleCwgMSk7XG4gICAgICB9XG4gICAgfSBlbHNlIGlmIChldmVudC5naXZlbiA9PT0gdHJ1ZSAmJiBldmVudC50ZW1wbGF0ZT8uaWQpIHtcbiAgICAgIHRoaXMuc2VsZWN0ZWRDb25zZW50cy5wdXNoKGV2ZW50LnRlbXBsYXRlLmlkKTtcbiAgICB9XG4gICAgaWYgKHRoaXMudG90YWxDb25zZW50cyA9PT0gdGhpcy5zZWxlY3RlZENvbnNlbnRzLmxlbmd0aCkge1xuICAgICAgdGhpcy5kaXNhYmxlU3VibWl0QnV0dG9uID0gZmFsc2U7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuZGlzYWJsZVN1Ym1pdEJ1dHRvbiA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgZGlzbWlzc0RpYWxvZyhyZWFzb24/OiBhbnksIG1lc3NhZ2U/OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAocmVhc29uID09PSAnUHJvY2VlZCBUbyBMb2dpbicpIHtcbiAgICAgIHRoaXMubG9hZGVkJCA9IG9mKGZhbHNlKTtcbiAgICAgIHRoaXMuY2RjUmVjb25zZW50U2VydmljZS5zYXZlQ29uc2VudEFuZExvZ2luKFxuICAgICAgICB0aGlzLnNlbGVjdGVkQ29uc2VudHMsXG4gICAgICAgIHRoaXMucmVjb25zZW50RXZlbnRcbiAgICAgICk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2RjUmVjb25zZW50U2VydmljZS5oYW5kbGVSZWNvbnNlbnRVcGRhdGVFcnJvcihyZWFzb24sIG1lc3NhZ2UpO1xuICAgIH1cbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uPy51bnN1YnNjcmliZSgpO1xuICB9XG59XG4iLCI8ZGl2XG4gIGNsYXNzPVwiY3gtYW5vbnltb3VzLWNvbnNlbnQtZGlhbG9nXCJcbiAgW2N4Rm9jdXNdPVwiZm9jdXNDb25maWdcIlxuICAoZXNjKT1cImRpc21pc3NEaWFsb2coJ0VzY2FwZSBwcmVzc2VkJywgcmVjb25zZW50RXZlbnQuZXJyb3JNZXNzYWdlKVwiXG4+XG4gIDxkaXYgY2xhc3M9XCJjeC1kaWFsb2ctY29udGVudFwiPlxuICAgIDwhLS0gTW9kYWwgSGVhZGVyIC0tPlxuICAgIDxuZy1jb250YWluZXIgKm5nSWY9XCJsb2FkZWQkIHwgYXN5bmM7IGVsc2UgbG9hZGluZ1wiPlxuICAgICAgPGRpdiBjbGFzcz1cImN4LWRpYWxvZy1oZWFkZXJcIj5cbiAgICAgICAgPGgzPlxuICAgICAgICAgIHt7ICdyZWNvbnNlbnQuZGlhbG9nLnRpdGxlJyB8IGN4VHJhbnNsYXRlIH19XG4gICAgICAgIDwvaDM+XG4gICAgICAgIDxidXR0b25cbiAgICAgICAgICB0eXBlPVwiYnV0dG9uXCJcbiAgICAgICAgICBjbGFzcz1cImNsb3NlXCJcbiAgICAgICAgICBbYXR0ci5hcmlhLWxhYmVsXT1cIidjb21tb24uY2xvc2UnIHwgY3hUcmFuc2xhdGVcIlxuICAgICAgICAgIChjbGljayk9XCJkaXNtaXNzRGlhbG9nKCdDcm9zcyBjbGljaycsIHJlY29uc2VudEV2ZW50LmVycm9yTWVzc2FnZSlcIlxuICAgICAgICA+XG4gICAgICAgICAgPHNwYW4gYXJpYS1oaWRkZW49XCJ0cnVlXCI+XG4gICAgICAgICAgICA8Y3gtaWNvbiBbdHlwZV09XCJpY29uVHlwZXMuQ0xPU0VcIj48L2N4LWljb24+XG4gICAgICAgICAgPC9zcGFuPlxuICAgICAgICA8L2J1dHRvbj5cbiAgICAgIDwvZGl2PlxuICAgICAgPGRpdiBjbGFzcz1cImN4LWRpYWxvZy1kZXNjcmlwdGlvblwiPlxuICAgICAgICB7eyAncmVjb25zZW50LmRpYWxvZy5kZXNjcmlwdGlvbicgfCBjeFRyYW5zbGF0ZSB9fVxuICAgICAgICA8ZGl2XG4gICAgICAgICAgY2xhc3M9XCJjeC1kaWFsb2ctc2VwYXJhdG9yIGNvbC1zbS0xMiBkLXhzLWJsb2NrIGQtc20tYmxvY2sgZC1tZC1ub25lXCJcbiAgICAgICAgPjwvZGl2PlxuICAgICAgPC9kaXY+XG4gICAgICA8ZGl2IGNsYXNzPVwiY3gtZGlhbG9nLWJ1dHRvbnNcIj48L2Rpdj5cbiAgICAgIDwhLS0gTW9kYWwgQm9keSAtLT5cbiAgICAgIDxkaXYgY2xhc3M9XCJjeC1kaWFsb2ctYm9keVwiICpuZ0lmPVwidGVtcGxhdGVMaXN0JCB8IGFzeW5jIGFzIHRlbXBsYXRlTGlzdFwiPlxuICAgICAgICA8ZGl2XG4gICAgICAgICAgY2xhc3M9XCJjeC1kaWFsb2ctcm93IGNvbC1zbS0xMiBjb2wtbWQtNlwiXG4gICAgICAgICAgKm5nRm9yPVwibGV0IGNvbnNlbnRUZW1wbGF0ZSBvZiB0ZW1wbGF0ZUxpc3RcIlxuICAgICAgICA+XG4gICAgICAgICAgPGN4LWNvbnNlbnQtbWFuYWdlbWVudC1mb3JtXG4gICAgICAgICAgICBbY29uc2VudFRlbXBsYXRlXT1cImNvbnNlbnRUZW1wbGF0ZVwiXG4gICAgICAgICAgICAoY29uc2VudENoYW5nZWQpPVwib25Db25zZW50Q2hhbmdlKCRldmVudClcIlxuICAgICAgICAgID48L2N4LWNvbnNlbnQtbWFuYWdlbWVudC1mb3JtPlxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvZGl2PlxuICAgICAgPCEtLSBBY3Rpb25zIC0tPlxuICAgICAgPGRpdiBjbGFzcz1cImN4LWRpYWxvZy1idXR0b25zXCI+XG4gICAgICAgIDxhXG4gICAgICAgICAgW2NsYXNzLmRpc2FibGVkXT1cImRpc2FibGVTdWJtaXRCdXR0b25cIlxuICAgICAgICAgIChjbGljayk9XCJcbiAgICAgICAgICAgIGRpc21pc3NEaWFsb2coJ1Byb2NlZWQgVG8gTG9naW4nLCByZWNvbnNlbnRFdmVudC5lcnJvck1lc3NhZ2UpXG4gICAgICAgICAgXCJcbiAgICAgICAgICBjbGFzcz1cImJ0biBidG4tcHJpbWFyeVwiXG4gICAgICAgICAgYXV0b2ZvY3VzXG4gICAgICAgICAgPnt7ICdjb21tb24uc3VibWl0JyB8IGN4VHJhbnNsYXRlIH19PC9hXG4gICAgICAgID5cbiAgICAgIDwvZGl2PlxuICAgIDwvbmctY29udGFpbmVyPlxuICA8L2Rpdj5cblxuICA8bmctdGVtcGxhdGUgI2xvYWRpbmc+XG4gICAgPGN4LXNwaW5uZXI+PC9jeC1zcGlubmVyPlxuICA8L25nLXRlbXBsYXRlPlxuPC9kaXY+XG4iXX0=