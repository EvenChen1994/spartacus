"use strict";var __defProp=Object.defineProperty,__name=(target,value)=>__defProp(target,"name",{value,configurable:!0});exports.id=580,exports.ids=[580],exports.modules={24580:(__unused_webpack___webpack_module__,__webpack_exports__,__webpack_require__)=>{__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{CdcModule:()=>CdcModule});var core=__webpack_require__(40305),common=__webpack_require__(89318),spartacus_core=__webpack_require__(46167),spartacus_cdc_root=__webpack_require__(95834),spartacus_storefront=__webpack_require__(25907),distinctUntilChanged=__webpack_require__(33029),tap=__webpack_require__(85171),take=__webpack_require__(95426);function GigyaRaasComponent_div_0_div_1_div_1_div_1_Template(rf,ctx){if(1&rf&&(core.TgZ(0,"div"),core._uU(1),core.qZA()),2&rf){const lang_r5=core.oxw().ngIf,data_r1=core.oxw(2).ngIf,ctx_r6=core.oxw();core.uIk("id",data_r1.containerID),core.xp6(1),core.hij(" ",ctx_r6.displayScreenSet(data_r1,lang_r5)," ")}}function GigyaRaasComponent_div_0_div_1_div_1_ng_template_2_Template(rf,ctx){if(1&rf){const _r13=core.EpF();core.TgZ(0,"a",4),core.NdJ("click",__name(function(){core.CHM(_r13);const lang_r5=core.oxw().ngIf,data_r1=core.oxw(2).ngIf,ctx_r11=core.oxw();return core.KtG(ctx_r11.showScreenSet(data_r1,lang_r5))},"GigyaRaasComponent_div_0_div_1_div_1_ng_template_2_Template_a_click_0_listener")),core._uU(1),core.qZA()}if(2&rf){const data_r1=core.oxw(3).ngIf;core.uIk("data-cdc-id",data_r1.uid)("data-profile-edit",data_r1.profileEdit),core.xp6(1),core.Oqu(data_r1.linkText)}}function GigyaRaasComponent_div_0_div_1_div_1_Template(rf,ctx){if(1&rf&&(core.TgZ(0,"div"),core.YNc(1,GigyaRaasComponent_div_0_div_1_div_1_div_1_Template,2,2,"div",2),core.YNc(2,GigyaRaasComponent_div_0_div_1_div_1_ng_template_2_Template,2,3,"ng-template",null,3,core.W1O),core.qZA()),2&rf){const _r7=core.MAs(3),data_r1=core.oxw(2).ngIf,ctx_r4=core.oxw();core.xp6(1),core.Q6J("ngIf",ctx_r4.displayInEmbedMode(data_r1))("ngIfElse",_r7)}}function GigyaRaasComponent_div_0_div_1_Template(rf,ctx){if(1&rf&&(core.TgZ(0,"div"),core.YNc(1,GigyaRaasComponent_div_0_div_1_div_1_Template,4,2,"div",0),core.ALo(2,"async"),core.qZA()),2&rf){const ctx_r2=core.oxw(2);core.xp6(1),core.Q6J("ngIf",core.lcZ(2,1,ctx_r2.language$))}}function GigyaRaasComponent_div_0_div_3_Template(rf,ctx){1&rf&&(core.TgZ(0,"div",5),core._uU(1),core.ALo(2,"cxTranslate"),core.ALo(3,"cxTranslate"),core.qZA()),2&rf&&(core.xp6(1),core.AsE(" ",core.lcZ(2,2,"errorHandlers.scriptFailedToLoad")," ",core.lcZ(3,4,"errorHandlers.refreshThePage")," "))}function GigyaRaasComponent_div_0_Template(rf,ctx){if(1&rf&&(core.TgZ(0,"div"),core.YNc(1,GigyaRaasComponent_div_0_div_1_Template,3,3,"div",0),core.ALo(2,"async"),core.YNc(3,GigyaRaasComponent_div_0_div_3_Template,4,6,"div",1),core.ALo(4,"async"),core.qZA()),2&rf){const ctx_r0=core.oxw();core.xp6(1),core.Q6J("ngIf",core.lcZ(2,2,ctx_r0.jsLoaded$)),core.xp6(2),core.Q6J("ngIf",core.lcZ(4,4,ctx_r0.jsError$))}}__name(GigyaRaasComponent_div_0_div_1_div_1_div_1_Template,"GigyaRaasComponent_div_0_div_1_div_1_div_1_Template"),__name(GigyaRaasComponent_div_0_div_1_div_1_ng_template_2_Template,"GigyaRaasComponent_div_0_div_1_div_1_ng_template_2_Template"),__name(GigyaRaasComponent_div_0_div_1_div_1_Template,"GigyaRaasComponent_div_0_div_1_div_1_Template"),__name(GigyaRaasComponent_div_0_div_1_Template,"GigyaRaasComponent_div_0_div_1_Template"),__name(GigyaRaasComponent_div_0_div_3_Template,"GigyaRaasComponent_div_0_div_3_Template"),__name(GigyaRaasComponent_div_0_Template,"GigyaRaasComponent_div_0_Template");class GigyaRaasComponent{constructor(component,baseSiteService,languageService,cdcConfig,winRef,cdcJSService,zone){this.component=component,this.baseSiteService=baseSiteService,this.languageService=languageService,this.cdcConfig=cdcConfig,this.winRef=winRef,this.cdcJSService=cdcJSService,this.zone=zone,this.renderScreenSet=!0}ngOnInit(){this.jsLoaded$=this.cdcJSService.didLoad(),this.jsError$=this.cdcJSService.didScriptFailToLoad(),this.language$=this.languageService.getActive().pipe((0,distinctUntilChanged.x)(),(0,tap.b)(()=>this.renderScreenSet=!0))}displayScreenSet(data,lang){this.renderScreenSet&&this.showScreenSet(data,lang),this.renderScreenSet=!1}showScreenSet(data,lang){this.winRef.nativeWindow?.gigya?.accounts?.showScreenSet({screenSet:data.screenSet,startScreen:data.startScreen,lang,...this.displayInEmbedMode(data)?{containerID:data.containerID}:{},...this.isLoginScreenSet(data)?{sessionExpiration:this.getSessionExpirationValue()}:{onAfterSubmit:(...params)=>{this.zone.run(()=>this.cdcJSService.onProfileUpdateEventHandler(...params))}}})}isLoginScreenSet(data){return!("true"===data.profileEdit)}getSessionExpirationValue(){if(void 0!==this.cdcConfig?.cdc){const filteredConfigs=this.cdcConfig.cdc.filter(conf=>conf.baseSite===this.getCurrentBaseSite());if(filteredConfigs&&filteredConfigs.length>0)return filteredConfigs[0].sessionExpiration}return 3600}getCurrentBaseSite(){let baseSite="";return this.baseSiteService.getActive().pipe((0,take.q)(1)).subscribe(data=>baseSite=data),baseSite}displayInEmbedMode(data){return!!("true"===data.embed&&data.containerID&&data.containerID.length>0)}}__name(GigyaRaasComponent,"GigyaRaasComponent"),GigyaRaasComponent.\u0275fac=__name(function(t){return new(t||GigyaRaasComponent)(core.Y36(spartacus_storefront.exf),core.Y36(spartacus_core.Do$),core.Y36(spartacus_core.TSl),core.Y36(spartacus_cdc_root.Y4),core.Y36(spartacus_core.X9E),core.Y36(spartacus_cdc_root.bF),core.Y36(core.R0b))},"GigyaRaasComponent_Factory"),GigyaRaasComponent.\u0275cmp=core.Xpm({type:GigyaRaasComponent,selectors:[["cx-gigya-raas"]],decls:2,vars:3,consts:[[4,"ngIf"],["class","js-error",4,"ngIf"],[4,"ngIf","ngIfElse"],["popupLink",""],[1,"popup-link",3,"click"],[1,"js-error"]],template:__name(function(rf,ctx){1&rf&&(core.YNc(0,GigyaRaasComponent_div_0_Template,5,6,"div",0),core.ALo(1,"async")),2&rf&&core.Q6J("ngIf",core.lcZ(1,1,ctx.component.data$))},"GigyaRaasComponent_Template"),dependencies:[common.O5,common.Ov,spartacus_core.X$D],styles:["cx-gigya-raas .popup-link{cursor:pointer;color:var(--cx-color-primary)}cx-gigya-raas .js-error{text-align:center;padding:4rem}\n"],encapsulation:2,changeDetection:0});class GigyaRaasModule{}__name(GigyaRaasModule,"GigyaRaasModule"),GigyaRaasModule.\u0275fac=__name(function(t){return new(t||GigyaRaasModule)},"GigyaRaasModule_Factory"),GigyaRaasModule.\u0275mod=core.oAB({type:GigyaRaasModule}),GigyaRaasModule.\u0275inj=core.cJS({imports:[common.ez,spartacus_core.LUR,spartacus_core.pEA.withConfig({cmsComponents:{GigyaRaasComponent:{component:GigyaRaasComponent}},layoutSlots:{GigyaLoginPageTemplate:{slots:["BodyContent","BottomContent"]}}})]});class CdcComponentsModule{}__name(CdcComponentsModule,"CdcComponentsModule"),CdcComponentsModule.\u0275fac=__name(function(t){return new(t||CdcComponentsModule)},"CdcComponentsModule_Factory"),CdcComponentsModule.\u0275mod=core.oAB({type:CdcComponentsModule}),CdcComponentsModule.\u0275inj=core.cJS({imports:[common.ez,GigyaRaasModule]});var http=__webpack_require__(48664),throwError=__webpack_require__(84724),of=__webpack_require__(95202),combineLatest=__webpack_require__(20085),empty=__webpack_require__(14614),catchError=__webpack_require__(2155),map=__webpack_require__(86466),switchMap=__webpack_require__(63714),mergeMap=__webpack_require__(37505),ngrx_store=__webpack_require__(91464),spartacus_asm_root=__webpack_require__(97283),ngrx_effects=__webpack_require__(48030);class CdcUserAuthenticationTokenService{constructor(http2,authConfigService){this.http=http2,this.authConfigService=authConfigService}loadTokenUsingCustomFlow(UID,UIDSignature,signatureTimestamp,idToken,baseSite){const url=this.authConfigService.getTokenEndpoint(),params=(new http.LE).set("client_id",this.authConfigService.getClientId()).set("client_secret",this.authConfigService.getClientSecret()).set("grant_type","custom").set("UID",encodeURIComponent(UID)).set("UIDSignature",encodeURIComponent(UIDSignature)).set("signatureTimestamp",encodeURIComponent(signatureTimestamp)).set("id_token",encodeURIComponent(idToken)).set("baseSite",encodeURIComponent(baseSite));return this.http.post(url,params).pipe((0,catchError.K)(error=>(0,throwError._)(error)))}}__name(CdcUserAuthenticationTokenService,"CdcUserAuthenticationTokenService"),CdcUserAuthenticationTokenService.\u0275fac=__name(function(t){return new(t||CdcUserAuthenticationTokenService)(core.LFG(http.eN),core.LFG(spartacus_core.dSP))},"CdcUserAuthenticationTokenService_Factory"),CdcUserAuthenticationTokenService.\u0275prov=core.Yz7({token:CdcUserAuthenticationTokenService,factory:CdcUserAuthenticationTokenService.\u0275fac});class CdcAuthModule{}__name(CdcAuthModule,"CdcAuthModule"),CdcAuthModule.\u0275fac=__name(function(t){return new(t||CdcAuthModule)},"CdcAuthModule_Factory"),CdcAuthModule.\u0275mod=core.oAB({type:CdcAuthModule}),CdcAuthModule.\u0275inj=core.cJS({providers:[CdcUserAuthenticationTokenService],imports:[common.ez,spartacus_core.nyr]});class LoadCdcUserTokenFail{constructor(payload){this.payload=payload,this.type="[Auth] Load CDC User Token Fail"}}__name(LoadCdcUserTokenFail,"LoadCdcUserTokenFail");class LoadCdcUserToken{constructor(payload){this.payload=payload,this.type="[Auth] Load CDC User Token"}}__name(LoadCdcUserToken,"LoadCdcUserToken");class CdcAuthService{constructor(store,authStorageService,userIdService,globalMessageService,authRedirectService){this.store=store,this.authStorageService=authStorageService,this.userIdService=userIdService,this.globalMessageService=globalMessageService,this.authRedirectService=authRedirectService}loginWithCustomCdcFlow(UID,UIDSignature,signatureTimestamp,idToken,baseSite){this.store.dispatch(new LoadCdcUserToken({UID,UIDSignature,signatureTimestamp,idToken,baseSite}))}isAsmAuthStorageService(service){return"getTokenTarget"in service}loginWithToken(token){let stream$=(0,of.of)(!0);this.isAsmAuthStorageService(this.authStorageService)&&(stream$=(0,combineLatest.aj)([this.authStorageService.getToken(),this.authStorageService.getTokenTarget()]).pipe((0,take.q)(1),(0,map.U)(([currentToken,tokenTarget])=>!!currentToken?.access_token&&tokenTarget===spartacus_asm_root.gt.CSAgent),(0,tap.b)(isAsmAgentLoggedIn=>{isAsmAgentLoggedIn&&this.globalMessageService.add({key:"asm.auth.agentLoggedInError"},spartacus_core.xUg.MSG_TYPE_ERROR)}),(0,map.U)(isAsmAgentLoggedIn=>!isAsmAgentLoggedIn))),stream$.pipe((0,take.q)(1)).subscribe(canLogin=>{canLogin&&(this.setTokenData(token),this.userIdService.setUserId(spartacus_core.zyp),this.store.dispatch(new spartacus_core.uQL.Login),this.globalMessageService.remove(spartacus_core.xUg.MSG_TYPE_ERROR),this.authRedirectService.redirect())})}setTokenData(token){if(this.authStorageService.setItem("access_token",token.access_token),token.granted_scopes&&Array.isArray(token.granted_scopes)&&this.authStorageService.setItem("granted_scopes",JSON.stringify(token.granted_scopes)),this.authStorageService.setItem("access_token_stored_at",""+Date.now()),token.expires_in){const expiresInMilliseconds=1e3*token.expires_in,expiresAt=(new Date).getTime()+expiresInMilliseconds;this.authStorageService.setItem("expires_at",""+expiresAt)}token.refresh_token&&this.authStorageService.setItem("refresh_token",token.refresh_token)}}__name(CdcAuthService,"CdcAuthService"),CdcAuthService.\u0275fac=__name(function(t){return new(t||CdcAuthService)(core.LFG(ngrx_store.yh),core.LFG(spartacus_core.jg0),core.LFG(spartacus_core.XBV),core.LFG(spartacus_core.IWp),core.LFG(spartacus_core.FUY))},"CdcAuthService_Factory"),CdcAuthService.\u0275prov=core.Yz7({token:CdcAuthService,factory:CdcAuthService.\u0275fac});const facadeProviders=[CdcAuthService,{provide:spartacus_cdc_root.Wz,useExisting:CdcAuthService}];class CdcEventBuilder{constructor(stateEventService,eventService){this.stateEventService=stateEventService,this.eventService=eventService,this.register()}register(){this.registerLoadUserTokenFail()}registerLoadUserTokenFail(){this.stateEventService.register({action:"[Auth] Load CDC User Token Fail",event:spartacus_cdc_root.yB})}}__name(CdcEventBuilder,"CdcEventBuilder"),CdcEventBuilder.\u0275fac=__name(function(t){return new(t||CdcEventBuilder)(core.LFG(spartacus_core.vL$),core.LFG(spartacus_core.POd))},"CdcEventBuilder_Factory"),CdcEventBuilder.\u0275prov=core.Yz7({token:CdcEventBuilder,factory:CdcEventBuilder.\u0275fac,providedIn:"root"});class CdcEventModule{constructor(_cdcEventBuilder){}}__name(CdcEventModule,"CdcEventModule"),CdcEventModule.\u0275fac=__name(function(t){return new(t||CdcEventModule)(core.LFG(CdcEventBuilder))},"CdcEventModule_Factory"),CdcEventModule.\u0275mod=core.oAB({type:CdcEventModule}),CdcEventModule.\u0275inj=core.cJS({});class CdcUserAddressesEffects{getAddresses(){return this.userIdService.takeUserId().pipe((0,take.q)(1),(0,switchMap.w)(userId=>this.userAddressConnector.getAll(userId)))}getDefaultAddress(addresses){return addresses.find(address=>!0===address?.defaultAddress)}getCountryName(countries,countryIsocode){return countries.find(country=>country.isocode===countryIsocode)?.name}updateDefaultAddressInCDC(){return this.getAddresses().pipe((0,take.q)(1),(0,switchMap.w)(addresses=>{const defaultAddress=this.getDefaultAddress(addresses)||{};return this.sendAddressToCDC(defaultAddress)}))}sendAddressToCDC(address){const formattedAddress=address.formattedAddress||" ";return this.userAddressService.getDeliveryCountries().pipe((0,take.q)(1),(0,switchMap.w)(countries=>{const countryName=this.getCountryName(countries,address.country?.isocode||" ")||" ";return this.cdcJsService.updateAddressWithoutScreenSet(formattedAddress,address.postalCode||" ",address.town||" ",countryName)}))}showErrorMessage(error){const errorMessage=error?.errorMessage||" ";this.messageService.add(errorMessage,spartacus_core.xUg.MSG_TYPE_ERROR)}constructor(actions$,userIdService,userAddressConnector,userAddressService,messageService,cdcJsService){this.actions$=actions$,this.userIdService=userIdService,this.userAddressConnector=userAddressConnector,this.userAddressService=userAddressService,this.messageService=messageService,this.cdcJsService=cdcJsService,this.addressFieldKeys=["line1","line2","region.name","town","postalCode"],this.cdcAddUserAddress$=(0,ngrx_effects.GW)(()=>this.actions$.pipe((0,ngrx_effects.l4)(spartacus_core.EJN.ADD_USER_ADDRESS_SUCCESS),(0,mergeMap.zg)(()=>this.updateDefaultAddressInCDC()),(0,tap.b)({error:error=>this.showErrorMessage(error)})),{dispatch:!1}),this.cdcUpdateUserAddress$=(0,ngrx_effects.GW)(()=>this.actions$.pipe((0,ngrx_effects.l4)(spartacus_core.EJN.UPDATE_USER_ADDRESS_SUCCESS),(0,mergeMap.zg)(()=>this.updateDefaultAddressInCDC()),(0,tap.b)({error:error=>this.showErrorMessage(error)})),{dispatch:!1}),this.cdcDeleteUserAddress$=(0,ngrx_effects.GW)(()=>this.actions$.pipe((0,ngrx_effects.l4)(spartacus_core.EJN.DELETE_USER_ADDRESS_SUCCESS),(0,mergeMap.zg)(()=>this.updateDefaultAddressInCDC()),(0,tap.b)({error:error=>this.showErrorMessage(error)})),{dispatch:!1})}}__name(CdcUserAddressesEffects,"CdcUserAddressesEffects"),CdcUserAddressesEffects.\u0275fac=__name(function(t){return new(t||CdcUserAddressesEffects)(core.LFG(ngrx_effects.eX),core.LFG(spartacus_core.XBV),core.LFG(spartacus_core.t3T),core.LFG(spartacus_core.kFJ),core.LFG(spartacus_core.IWp),core.LFG(spartacus_cdc_root.bF))},"CdcUserAddressesEffects_Factory"),CdcUserAddressesEffects.\u0275prov=core.Yz7({token:CdcUserAddressesEffects,factory:CdcUserAddressesEffects.\u0275fac});class CdcUserTokenEffects{constructor(actions$,userTokenService,globalMessageService,cdcAuthService){this.actions$=actions$,this.userTokenService=userTokenService,this.globalMessageService=globalMessageService,this.cdcAuthService=cdcAuthService,this.logger=(0,core.f3M)(spartacus_core.mQy),this.loadCdcUserToken$=(0,ngrx_effects.GW)(()=>this.actions$.pipe((0,ngrx_effects.l4)("[Auth] Load CDC User Token"),(0,map.U)(action=>action.payload),(0,mergeMap.zg)(payload=>this.userTokenService.loadTokenUsingCustomFlow(payload.UID,payload.UIDSignature,payload.signatureTimestamp,payload.idToken,payload.baseSite).pipe((0,switchMap.w)(token=>(this.cdcAuthService.loginWithToken(token),empty.E)),(0,catchError.K)(error=>(this.globalMessageService.add({key:"httpHandlers.badGateway"},spartacus_core.xUg.MSG_TYPE_ERROR),(0,of.of)(new LoadCdcUserTokenFail({error:(0,spartacus_core.cxH)(error,this.logger),initialActionPayload:payload}))))))))}}__name(CdcUserTokenEffects,"CdcUserTokenEffects"),CdcUserTokenEffects.\u0275fac=__name(function(t){return new(t||CdcUserTokenEffects)(core.LFG(ngrx_effects.eX),core.LFG(CdcUserAuthenticationTokenService),core.LFG(spartacus_core.IWp),core.LFG(CdcAuthService))},"CdcUserTokenEffects_Factory"),CdcUserTokenEffects.\u0275prov=core.Yz7({token:CdcUserTokenEffects,factory:CdcUserTokenEffects.\u0275fac});const effects=[CdcUserTokenEffects,CdcUserAddressesEffects];class CdcStoreModule{}__name(CdcStoreModule,"CdcStoreModule"),CdcStoreModule.\u0275fac=__name(function(t){return new(t||CdcStoreModule)},"CdcStoreModule_Factory"),CdcStoreModule.\u0275mod=core.oAB({type:CdcStoreModule}),CdcStoreModule.\u0275inj=core.cJS({providers:[CdcAuthService],imports:[common.ez,CdcAuthModule,ngrx_effects.sQ.forFeature(effects)]});class CdcCoreModule{}__name(CdcCoreModule,"CdcCoreModule"),CdcCoreModule.\u0275fac=__name(function(t){return new(t||CdcCoreModule)},"CdcCoreModule_Factory"),CdcCoreModule.\u0275mod=core.oAB({type:CdcCoreModule}),CdcCoreModule.\u0275inj=core.cJS({providers:[...facadeProviders],imports:[CdcAuthModule,CdcEventModule,CdcStoreModule]});class CdcModule{}__name(CdcModule,"CdcModule"),CdcModule.\u0275fac=__name(function(t){return new(t||CdcModule)},"CdcModule_Factory"),CdcModule.\u0275mod=core.oAB({type:CdcModule}),CdcModule.\u0275inj=core.cJS({imports:[CdcComponentsModule,CdcCoreModule]})}};