import { Injectable, inject } from '@angular/core';
import { createEffect, ofType } from '@ngrx/effects';
import { LoggerService, StateUtils, normalizeHttpError, } from '@spartacus/core';
import { from, of } from 'rxjs';
import { catchError, map, switchMap } from 'rxjs/operators';
import { BudgetActions, OrganizationActions } from '../actions/index';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
import * as i2 from "../../connectors/budget/budget.connector";
export class BudgetEffects {
    constructor(actions$, budgetConnector) {
        this.actions$ = actions$;
        this.budgetConnector = budgetConnector;
        this.logger = inject(LoggerService);
        this.loadBudget$ = createEffect(() => this.actions$.pipe(ofType(BudgetActions.LOAD_BUDGET), map((action) => action.payload), switchMap(({ userId, budgetCode }) => {
            return this.budgetConnector.get(userId, budgetCode).pipe(map((budget) => {
                return new BudgetActions.LoadBudgetSuccess([budget]);
            }), catchError((error) => of(new BudgetActions.LoadBudgetFail({
                budgetCode,
                error: normalizeHttpError(error, this.logger),
            }))));
        })));
        this.loadBudgets$ = createEffect(() => this.actions$.pipe(ofType(BudgetActions.LOAD_BUDGETS), map((action) => action.payload), switchMap((payload) => this.budgetConnector.getList(payload.userId, payload.params).pipe(switchMap((budgets) => {
            const { values, page } = StateUtils.normalizeListPage(budgets, 'code');
            return [
                new BudgetActions.LoadBudgetSuccess(values),
                new BudgetActions.LoadBudgetsSuccess({
                    page,
                    params: payload.params,
                }),
            ];
        }), catchError((error) => of(new BudgetActions.LoadBudgetsFail({
            params: payload.params,
            error: normalizeHttpError(error, this.logger),
        })))))));
        this.createBudget$ = createEffect(() => this.actions$.pipe(ofType(BudgetActions.CREATE_BUDGET), map((action) => action.payload), switchMap((payload) => this.budgetConnector.create(payload.userId, payload.budget).pipe(switchMap((data) => [
            new BudgetActions.CreateBudgetSuccess(data),
            new OrganizationActions.OrganizationClearData(),
        ]), catchError((error) => from([
            new BudgetActions.CreateBudgetFail({
                budgetCode: payload.budget.code ?? '',
                error: normalizeHttpError(error, this.logger),
            }),
            new OrganizationActions.OrganizationClearData(),
        ]))))));
        this.updateBudget$ = createEffect(() => this.actions$.pipe(ofType(BudgetActions.UPDATE_BUDGET), map((action) => action.payload), switchMap((payload) => this.budgetConnector
            .update(payload.userId, payload.budgetCode, payload.budget)
            .pipe(switchMap((data) => [
            new BudgetActions.UpdateBudgetSuccess(data),
            new OrganizationActions.OrganizationClearData(),
        ]), catchError((error) => from([
            new BudgetActions.UpdateBudgetFail({
                budgetCode: payload.budget.code ?? '',
                error: normalizeHttpError(error, this.logger),
            }),
            new OrganizationActions.OrganizationClearData(),
        ]))))));
    }
}
BudgetEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: BudgetEffects, deps: [{ token: i1.Actions }, { token: i2.BudgetConnector }], target: i0.ɵɵFactoryTarget.Injectable });
BudgetEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: BudgetEffects });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: BudgetEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }, { type: i2.BudgetConnector }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVkZ2V0LmVmZmVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL2ZlYXR1cmUtbGlicy9vcmdhbml6YXRpb24vYWRtaW5pc3RyYXRpb24vY29yZS9zdG9yZS9lZmZlY3RzL2J1ZGdldC5lZmZlY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBT0EsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFXLFlBQVksRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUVMLGFBQWEsRUFDYixVQUFVLEVBQ1Ysa0JBQWtCLEdBQ25CLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUFjLElBQUksRUFBRSxFQUFFLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDNUMsT0FBTyxFQUFFLFVBQVUsRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHNUQsT0FBTyxFQUFFLGFBQWEsRUFBRSxtQkFBbUIsRUFBRSxNQUFNLGtCQUFrQixDQUFDOzs7O0FBR3RFLE1BQU0sT0FBTyxhQUFhO0lBeUh4QixZQUNVLFFBQWlCLEVBQ2pCLGVBQWdDO1FBRGhDLGFBQVEsR0FBUixRQUFRLENBQVM7UUFDakIsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBMUhoQyxXQUFNLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRXpDLGdCQUFXLEdBRVAsWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FDaEIsTUFBTSxDQUFDLGFBQWEsQ0FBQyxXQUFXLENBQUMsRUFDakMsR0FBRyxDQUFDLENBQUMsTUFBZ0MsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLE9BQU8sQ0FBQyxFQUN6RCxTQUFTLENBQUMsQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFO1lB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aWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlLCBpbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IEFjdGlvbnMsIGNyZWF0ZUVmZmVjdCwgb2ZUeXBlIH0gZnJvbSAnQG5ncngvZWZmZWN0cyc7XG5pbXBvcnQge1xuICBFbnRpdGllc01vZGVsLFxuICBMb2dnZXJTZXJ2aWNlLFxuICBTdGF0ZVV0aWxzLFxuICBub3JtYWxpemVIdHRwRXJyb3IsXG59IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBmcm9tLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBCdWRnZXRDb25uZWN0b3IgfSBmcm9tICcuLi8uLi9jb25uZWN0b3JzL2J1ZGdldC9idWRnZXQuY29ubmVjdG9yJztcbmltcG9ydCB7IEJ1ZGdldCB9IGZyb20gJy4uLy4uL21vZGVsL2J1ZGdldC5tb2RlbCc7XG5pbXBvcnQgeyBCdWRnZXRBY3Rpb25zLCBPcmdhbml6YXRpb25BY3Rpb25zIH0gZnJvbSAnLi4vYWN0aW9ucy9pbmRleCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBCdWRnZXRFZmZlY3RzIHtcbiAgcHJvdGVjdGVkIGxvZ2dlciA9IGluamVjdChMb2dnZXJTZXJ2aWNlKTtcblxuICBsb2FkQnVkZ2V0JDogT2JzZXJ2YWJsZTxcbiAgICBCdWRnZXRBY3Rpb25zLkxvYWRCdWRnZXRTdWNjZXNzIHwgQnVkZ2V0QWN0aW9ucy5Mb2FkQnVkZ2V0RmFpbFxuICA+ID0gY3JlYXRlRWZmZWN0KCgpID0+XG4gICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgb2ZUeXBlKEJ1ZGdldEFjdGlvbnMuTE9BRF9CVURHRVQpLFxuICAgICAgbWFwKChhY3Rpb246IEJ1ZGdldEFjdGlvbnMuTG9hZEJ1ZGdldCkgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgc3dpdGNoTWFwKCh7IHVzZXJJZCwgYnVkZ2V0Q29kZSB9KSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmJ1ZGdldENvbm5lY3Rvci5nZXQodXNlcklkLCBidWRnZXRDb2RlKS5waXBlKFxuICAgICAgICAgIG1hcCgoYnVkZ2V0OiBCdWRnZXQpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQnVkZ2V0QWN0aW9ucy5Mb2FkQnVkZ2V0U3VjY2VzcyhbYnVkZ2V0XSk7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PlxuICAgICAgICAgICAgb2YoXG4gICAgICAgICAgICAgIG5ldyBCdWRnZXRBY3Rpb25zLkxvYWRCdWRnZXRGYWlsKHtcbiAgICAgICAgICAgICAgICBidWRnZXRDb2RlLFxuICAgICAgICAgICAgICAgIGVycm9yOiBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKSxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgIClcbiAgKTtcblxuICBsb2FkQnVkZ2V0cyQ6IE9ic2VydmFibGU8XG4gICAgfCBCdWRnZXRBY3Rpb25zLkxvYWRCdWRnZXRzU3VjY2Vzc1xuICAgIHwgQnVkZ2V0QWN0aW9ucy5Mb2FkQnVkZ2V0U3VjY2Vzc1xuICAgIHwgQnVkZ2V0QWN0aW9ucy5Mb2FkQnVkZ2V0c0ZhaWxcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShCdWRnZXRBY3Rpb25zLkxPQURfQlVER0VUUyksXG4gICAgICBtYXAoKGFjdGlvbjogQnVkZ2V0QWN0aW9ucy5Mb2FkQnVkZ2V0cykgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgc3dpdGNoTWFwKChwYXlsb2FkKSA9PlxuICAgICAgICB0aGlzLmJ1ZGdldENvbm5lY3Rvci5nZXRMaXN0KHBheWxvYWQudXNlcklkLCBwYXlsb2FkLnBhcmFtcykucGlwZShcbiAgICAgICAgICBzd2l0Y2hNYXAoKGJ1ZGdldHM6IEVudGl0aWVzTW9kZWw8QnVkZ2V0PikgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyB2YWx1ZXMsIHBhZ2UgfSA9IFN0YXRlVXRpbHMubm9ybWFsaXplTGlzdFBhZ2UoXG4gICAgICAgICAgICAgIGJ1ZGdldHMsXG4gICAgICAgICAgICAgICdjb2RlJ1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgIG5ldyBCdWRnZXRBY3Rpb25zLkxvYWRCdWRnZXRTdWNjZXNzKHZhbHVlcyksXG4gICAgICAgICAgICAgIG5ldyBCdWRnZXRBY3Rpb25zLkxvYWRCdWRnZXRzU3VjY2Vzcyh7XG4gICAgICAgICAgICAgICAgcGFnZSxcbiAgICAgICAgICAgICAgICBwYXJhbXM6IHBheWxvYWQucGFyYW1zLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIF07XG4gICAgICAgICAgfSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PlxuICAgICAgICAgICAgb2YoXG4gICAgICAgICAgICAgIG5ldyBCdWRnZXRBY3Rpb25zLkxvYWRCdWRnZXRzRmFpbCh7XG4gICAgICAgICAgICAgICAgcGFyYW1zOiBwYXlsb2FkLnBhcmFtcyxcbiAgICAgICAgICAgICAgICBlcnJvcjogbm9ybWFsaXplSHR0cEVycm9yKGVycm9yLCB0aGlzLmxvZ2dlciksXG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICApXG4gICAgICApXG4gICAgKVxuICApO1xuXG4gIGNyZWF0ZUJ1ZGdldCQ6IE9ic2VydmFibGU8XG4gICAgfCBCdWRnZXRBY3Rpb25zLkNyZWF0ZUJ1ZGdldFN1Y2Nlc3NcbiAgICB8IEJ1ZGdldEFjdGlvbnMuQ3JlYXRlQnVkZ2V0RmFpbFxuICAgIHwgT3JnYW5pemF0aW9uQWN0aW9ucy5Pcmdhbml6YXRpb25DbGVhckRhdGFcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShCdWRnZXRBY3Rpb25zLkNSRUFURV9CVURHRVQpLFxuICAgICAgbWFwKChhY3Rpb246IEJ1ZGdldEFjdGlvbnMuQ3JlYXRlQnVkZ2V0KSA9PiBhY3Rpb24ucGF5bG9hZCksXG4gICAgICBzd2l0Y2hNYXAoKHBheWxvYWQpID0+XG4gICAgICAgIHRoaXMuYnVkZ2V0Q29ubmVjdG9yLmNyZWF0ZShwYXlsb2FkLnVzZXJJZCwgcGF5bG9hZC5idWRnZXQpLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChkYXRhKSA9PiBbXG4gICAgICAgICAgICBuZXcgQnVkZ2V0QWN0aW9ucy5DcmVhdGVCdWRnZXRTdWNjZXNzKGRhdGEpLFxuICAgICAgICAgICAgbmV3IE9yZ2FuaXphdGlvbkFjdGlvbnMuT3JnYW5pemF0aW9uQ2xlYXJEYXRhKCksXG4gICAgICAgICAgXSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PlxuICAgICAgICAgICAgZnJvbShbXG4gICAgICAgICAgICAgIG5ldyBCdWRnZXRBY3Rpb25zLkNyZWF0ZUJ1ZGdldEZhaWwoe1xuICAgICAgICAgICAgICAgIGJ1ZGdldENvZGU6IHBheWxvYWQuYnVkZ2V0LmNvZGUgPz8gJycsXG4gICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgbmV3IE9yZ2FuaXphdGlvbkFjdGlvbnMuT3JnYW5pemF0aW9uQ2xlYXJEYXRhKCksXG4gICAgICAgICAgICBdKVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKVxuICAgIClcbiAgKTtcblxuICB1cGRhdGVCdWRnZXQkOiBPYnNlcnZhYmxlPFxuICAgIHwgQnVkZ2V0QWN0aW9ucy5VcGRhdGVCdWRnZXRTdWNjZXNzXG4gICAgfCBCdWRnZXRBY3Rpb25zLlVwZGF0ZUJ1ZGdldEZhaWxcbiAgICB8IE9yZ2FuaXphdGlvbkFjdGlvbnMuT3JnYW5pemF0aW9uQ2xlYXJEYXRhXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoQnVkZ2V0QWN0aW9ucy5VUERBVEVfQlVER0VUKSxcbiAgICAgIG1hcCgoYWN0aW9uOiBCdWRnZXRBY3Rpb25zLlVwZGF0ZUJ1ZGdldCkgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgc3dpdGNoTWFwKChwYXlsb2FkKSA9PlxuICAgICAgICB0aGlzLmJ1ZGdldENvbm5lY3RvclxuICAgICAgICAgIC51cGRhdGUocGF5bG9hZC51c2VySWQsIHBheWxvYWQuYnVkZ2V0Q29kZSwgcGF5bG9hZC5idWRnZXQpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKGRhdGEpID0+IFtcbiAgICAgICAgICAgICAgbmV3IEJ1ZGdldEFjdGlvbnMuVXBkYXRlQnVkZ2V0U3VjY2VzcyhkYXRhKSxcbiAgICAgICAgICAgICAgbmV3IE9yZ2FuaXphdGlvbkFjdGlvbnMuT3JnYW5pemF0aW9uQ2xlYXJEYXRhKCksXG4gICAgICAgICAgICBdKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT5cbiAgICAgICAgICAgICAgZnJvbShbXG4gICAgICAgICAgICAgICAgbmV3IEJ1ZGdldEFjdGlvbnMuVXBkYXRlQnVkZ2V0RmFpbCh7XG4gICAgICAgICAgICAgICAgICBidWRnZXRDb2RlOiBwYXlsb2FkLmJ1ZGdldC5jb2RlID8/ICcnLFxuICAgICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIG5ldyBPcmdhbml6YXRpb25BY3Rpb25zLk9yZ2FuaXphdGlvbkNsZWFyRGF0YSgpLFxuICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgIClcbiAgICApXG4gICk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhY3Rpb25zJDogQWN0aW9ucyxcbiAgICBwcml2YXRlIGJ1ZGdldENvbm5lY3RvcjogQnVkZ2V0Q29ubmVjdG9yXG4gICkge31cbn1cbiJdfQ==