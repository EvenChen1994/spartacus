import { Injectable, inject } from '@angular/core';
import { createEffect, ofType } from '@ngrx/effects';
import { LoggerService, StateUtils, normalizeHttpError, } from '@spartacus/core';
import { from, of } from 'rxjs';
import { catchError, groupBy, map, mergeMap, switchMap } from 'rxjs/operators';
import { BudgetActions, CostCenterActions, OrganizationActions, } from '../actions/index';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
import * as i2 from "../../connectors/cost-center/cost-center.connector";
export class CostCenterEffects {
    constructor(actions$, costCenterConnector) {
        this.actions$ = actions$;
        this.costCenterConnector = costCenterConnector;
        this.logger = inject(LoggerService);
        this.loadCostCenter$ = createEffect(() => this.actions$.pipe(ofType(CostCenterActions.LOAD_COST_CENTER), map((action) => action.payload), switchMap(({ userId, costCenterCode }) => {
            return this.costCenterConnector.get(userId, costCenterCode).pipe(map((costCenter) => {
                return new CostCenterActions.LoadCostCenterSuccess([costCenter]);
            }), catchError((error) => of(new CostCenterActions.LoadCostCenterFail({
                costCenterCode,
                error: normalizeHttpError(error, this.logger),
            }))));
        })));
        this.loadCostCenters$ = createEffect(() => this.actions$.pipe(ofType(CostCenterActions.LOAD_COST_CENTERS), map((action) => action.payload), switchMap((payload) => this.costCenterConnector.getList(payload.userId, payload.params).pipe(switchMap((costCenters) => {
            const { values, page } = StateUtils.normalizeListPage(costCenters, 'code');
            return [
                new CostCenterActions.LoadCostCenterSuccess(values),
                new CostCenterActions.LoadCostCentersSuccess({
                    page,
                    params: payload.params,
                }),
            ];
        }), catchError((error) => of(new CostCenterActions.LoadCostCentersFail({
            params: payload.params,
            error: normalizeHttpError(error, this.logger),
        })))))));
        this.createCostCenter$ = createEffect(() => this.actions$.pipe(ofType(CostCenterActions.CREATE_COST_CENTER), map((action) => action.payload), switchMap((payload) => this.costCenterConnector
            .create(payload.userId, payload.costCenter)
            .pipe(switchMap((data) => [
            new CostCenterActions.CreateCostCenterSuccess(data),
            new OrganizationActions.OrganizationClearData(),
        ]), catchError((error) => from([
            new CostCenterActions.CreateCostCenterFail({
                costCenterCode: payload.costCenter.code ?? '',
                error: normalizeHttpError(error, this.logger),
            }),
            new OrganizationActions.OrganizationClearData(),
        ]))))));
        this.updateCostCenter$ = createEffect(() => this.actions$.pipe(ofType(CostCenterActions.UPDATE_COST_CENTER), map((action) => action.payload), switchMap((payload) => this.costCenterConnector
            .update(payload.userId, payload.costCenterCode, payload.costCenter)
            .pipe(switchMap((data) => [
            new CostCenterActions.UpdateCostCenterSuccess(data),
            new OrganizationActions.OrganizationClearData(),
        ]), catchError((error) => from([
            new CostCenterActions.UpdateCostCenterFail({
                costCenterCode: payload.costCenter.code ?? '',
                error: normalizeHttpError(error, this.logger),
            }),
            new OrganizationActions.OrganizationClearData(),
        ]))))));
        this.loadAssignedBudgets$ = createEffect(() => this.actions$.pipe(ofType(CostCenterActions.LOAD_ASSIGNED_BUDGETS), map((action) => action.payload), groupBy(({ costCenterCode, params }) => StateUtils.serializeParams(costCenterCode, params)), mergeMap((group) => group.pipe(switchMap(({ userId, costCenterCode, params }) => this.costCenterConnector
            .getBudgets(userId, costCenterCode, params)
            .pipe(switchMap((budgets) => {
            const { values, page } = StateUtils.normalizeListPage(budgets, 'code');
            return [
                new BudgetActions.LoadBudgetSuccess(values),
                new CostCenterActions.LoadAssignedBudgetsSuccess({
                    costCenterCode,
                    page,
                    params,
                }),
            ];
        }), catchError((error) => of(new CostCenterActions.LoadAssignedBudgetsFail({
            costCenterCode,
            params,
            error: normalizeHttpError(error, this.logger),
        })))))))));
        this.assignBudgetToCostCenter$ = createEffect(() => this.actions$.pipe(ofType(CostCenterActions.ASSIGN_BUDGET), map((action) => action.payload), mergeMap(({ userId, costCenterCode, budgetCode }) => this.costCenterConnector
            .assignBudget(userId, costCenterCode, budgetCode)
            .pipe(switchMap(() => [
            new CostCenterActions.AssignBudgetSuccess({
                code: budgetCode,
                selected: true,
            }),
            new OrganizationActions.OrganizationClearData(),
        ]), catchError((error) => from([
            new CostCenterActions.AssignBudgetFail({
                budgetCode,
                error: normalizeHttpError(error, this.logger),
            }),
            new OrganizationActions.OrganizationClearData(),
        ]))))));
        this.unassignBudgetToCostCenter$ = createEffect(() => this.actions$.pipe(ofType(CostCenterActions.UNASSIGN_BUDGET), map((action) => action.payload), mergeMap(({ userId, costCenterCode, budgetCode }) => this.costCenterConnector
            .unassignBudget(userId, costCenterCode, budgetCode)
            .pipe(switchMap(() => [
            new CostCenterActions.UnassignBudgetSuccess({
                code: budgetCode,
                selected: false,
            }),
            new OrganizationActions.OrganizationClearData(),
        ]), catchError((error) => from([
            new CostCenterActions.UnassignBudgetFail({
                budgetCode,
                error: normalizeHttpError(error, this.logger),
            }),
            new OrganizationActions.OrganizationClearData(),
        ]))))));
    }
}
CostCenterEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CostCenterEffects, deps: [{ token: i1.Actions }, { token: i2.CostCenterConnector }], target: i0.ɵɵFactoryTarget.Injectable });
CostCenterEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CostCenterEffects });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CostCenterEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }, { type: i2.CostCenterConnector }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29zdC1jZW50ZXIuZWZmZWN0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL29yZ2FuaXphdGlvbi9hZG1pbmlzdHJhdGlvbi9jb3JlL3N0b3JlL2VmZmVjdHMvY29zdC1jZW50ZXIuZWZmZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQU9BLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ25ELE9BQU8sRUFBVyxZQUFZLEVBQUUsTUFBTSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzlELE9BQU8sRUFHTCxhQUFhLEVBQ2IsVUFBVSxFQUNWLGtCQUFrQixHQUNuQixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBYyxJQUFJLEVBQUUsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzVDLE9BQU8sRUFBRSxVQUFVLEVBQUUsT0FBTyxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHL0UsT0FBTyxFQUNMLGFBQWEsRUFDYixpQkFBaUIsRUFDakIsbUJBQW1CLEdBQ3BCLE1BQU0sa0JBQWtCLENBQUM7Ozs7QUFHMUIsTUFBTSxPQUFPLGlCQUFpQjtJQTZPNUIsWUFDVSxRQUFpQixFQUNqQixtQkFBd0M7UUFEeEMsYUFBUSxHQUFSLFFBQVEsQ0FBUztRQUNqQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBOU94QyxXQUFNLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRXpDLG9CQUFlLEdBR1gsWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FDaEIsTUFBTSxDQUFDLGlCQUFpQixDQUFDLGdCQUFnQixDQUFDLEVBQzFDLEdBQUcsQ0FBQyxDQUFDLE1BQXdDLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFD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ZUFBZSxDQUFDLEVBQ3pDLEdBQUcsQ0FBQyxDQUFDLE1BQXdDLEVBQUUsRUFBRSxDQUFDLE1BQU0sQ0FBQyxPQUFPLENBQUMsRUFDakUsUUFBUSxDQUFDLENBQUMsRUFBRSxNQUFNLEVBQUUsY0FBYyxFQUFFLFVBQVUsRUFBRSxFQUFFLEVBQUUsQ0FDbEQsSUFBSSxDQUFDLG1CQUFtQjthQUNyQixjQUFjLENBQUMsTUFBTSxFQUFFLGNBQWMsRUFBRSxVQUFVLENBQUM7YUFDbEQsSUFBSSxDQUNILFNBQVMsQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUNkLElBQUksaUJBQWlCLENBQUMscUJBQXFCLENBQUM7Z0JBQzFDLElBQUksRUFBRSxVQUFVO2dCQUNoQixRQUFRLEVBQUUsS0FBSzthQUNoQixDQUFDO1lBQ0YsSUFBSSxtQkFBbUIsQ0FBQyxxQkFBcUIsRUFBRTtTQUNoRCxDQUFDLEVBQ0YsVUFBVSxDQUFDLENBQUMsS0FBd0IsRUFBRSxFQUFFLENBQ3RDLElBQUksQ0FBQztZQUNILElBQUksaUJBQWlCLENBQUMsa0JBQWtCLENBQUM7Z0JBQ3ZDLFVBQVU7Z0JBQ1YsS0FBSyxFQUFFLGtCQUFrQixDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDO2FBQzlDLENBQUM7WUFDRixJQUFJLG1CQUFtQixDQUFDLHFCQUFxQixFQUFFO1NBQ2hELENBQUMsQ0FDSCxDQUNGLENBQ0osQ0FDRixDQUNGLENBQUM7SUFLQyxDQUFDOzs4R0FoUE8saUJBQWlCO2tIQUFqQixpQkFBaUI7MkZBQWpCLGlCQUFpQjtrQkFEN0IsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBTUERYLUZpbGVDb3B5cmlnaHRUZXh0OiAyMDIzIFNBUCBTcGFydGFjdXMgdGVhbSA8c3BhcnRhY3VzLXRlYW1Ac2FwLmNvbT5cbiAqXG4gKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMFxuICovXG5cbmltcG9ydCB7IEh0dHBFcnJvclJlc3BvbnNlIH0gZnJvbSAnQGFuZ3VsYXIvY29tbW9uL2h0dHAnO1xuaW1wb3J0IHsgSW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3Rpb25zLCBjcmVhdGVFZmZlY3QsIG9mVHlwZSB9IGZyb20gJ0BuZ3J4L2VmZmVjdHMnO1xuaW1wb3J0IHtcbiAgQ29zdENlbnRlcixcbiAgRW50aXRpZXNNb2RlbCxcbiAgTG9nZ2VyU2VydmljZSxcbiAgU3RhdGVVdGlscyxcbiAgbm9ybWFsaXplSHR0cEVycm9yLFxufSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgZnJvbSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIGdyb3VwQnksIG1hcCwgbWVyZ2VNYXAsIHN3aXRjaE1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENvc3RDZW50ZXJDb25uZWN0b3IgfSBmcm9tICcuLi8uLi9jb25uZWN0b3JzL2Nvc3QtY2VudGVyL2Nvc3QtY2VudGVyLmNvbm5lY3Rvcic7XG5pbXBvcnQgeyBCdWRnZXQgfSBmcm9tICcuLi8uLi9tb2RlbC9idWRnZXQubW9kZWwnO1xuaW1wb3J0IHtcbiAgQnVkZ2V0QWN0aW9ucyxcbiAgQ29zdENlbnRlckFjdGlvbnMsXG4gIE9yZ2FuaXphdGlvbkFjdGlvbnMsXG59IGZyb20gJy4uL2FjdGlvbnMvaW5kZXgnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ29zdENlbnRlckVmZmVjdHMge1xuICBwcm90ZWN0ZWQgbG9nZ2VyID0gaW5qZWN0KExvZ2dlclNlcnZpY2UpO1xuXG4gIGxvYWRDb3N0Q2VudGVyJDogT2JzZXJ2YWJsZTxcbiAgICB8IENvc3RDZW50ZXJBY3Rpb25zLkxvYWRDb3N0Q2VudGVyU3VjY2Vzc1xuICAgIHwgQ29zdENlbnRlckFjdGlvbnMuTG9hZENvc3RDZW50ZXJGYWlsXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoQ29zdENlbnRlckFjdGlvbnMuTE9BRF9DT1NUX0NFTlRFUiksXG4gICAgICBtYXAoKGFjdGlvbjogQ29zdENlbnRlckFjdGlvbnMuTG9hZENvc3RDZW50ZXIpID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICAgIHN3aXRjaE1hcCgoeyB1c2VySWQsIGNvc3RDZW50ZXJDb2RlIH0pID0+IHtcbiAgICAgICAgcmV0dXJuIHRoaXMuY29zdENlbnRlckNvbm5lY3Rvci5nZXQodXNlcklkLCBjb3N0Q2VudGVyQ29kZSkucGlwZShcbiAgICAgICAgICBtYXAoKGNvc3RDZW50ZXI6IENvc3RDZW50ZXIpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgQ29zdENlbnRlckFjdGlvbnMuTG9hZENvc3RDZW50ZXJTdWNjZXNzKFtjb3N0Q2VudGVyXSk7XG4gICAgICAgICAgfSksXG4gICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PlxuICAgICAgICAgICAgb2YoXG4gICAgICAgICAgICAgIG5ldyBDb3N0Q2VudGVyQWN0aW9ucy5Mb2FkQ29zdENlbnRlckZhaWwoe1xuICAgICAgICAgICAgICAgIGNvc3RDZW50ZXJDb2RlLFxuICAgICAgICAgICAgICAgIGVycm9yOiBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKSxcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgICk7XG4gICAgICB9KVxuICAgIClcbiAgKTtcblxuICBsb2FkQ29zdENlbnRlcnMkOiBPYnNlcnZhYmxlPFxuICAgIHwgQ29zdENlbnRlckFjdGlvbnMuTG9hZENvc3RDZW50ZXJzU3VjY2Vzc1xuICAgIHwgQ29zdENlbnRlckFjdGlvbnMuTG9hZENvc3RDZW50ZXJTdWNjZXNzXG4gICAgfCBDb3N0Q2VudGVyQWN0aW9ucy5Mb2FkQ29zdENlbnRlcnNGYWlsXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoQ29zdENlbnRlckFjdGlvbnMuTE9BRF9DT1NUX0NFTlRFUlMpLFxuICAgICAgbWFwKChhY3Rpb246IENvc3RDZW50ZXJBY3Rpb25zLkxvYWRDb3N0Q2VudGVycykgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgc3dpdGNoTWFwKChwYXlsb2FkKSA9PlxuICAgICAgICB0aGlzLmNvc3RDZW50ZXJDb25uZWN0b3IuZ2V0TGlzdChwYXlsb2FkLnVzZXJJZCwgcGF5bG9hZC5wYXJhbXMpLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChjb3N0Q2VudGVyczogRW50aXRpZXNNb2RlbDxDb3N0Q2VudGVyPikgPT4ge1xuICAgICAgICAgICAgY29uc3QgeyB2YWx1ZXMsIHBhZ2UgfSA9IFN0YXRlVXRpbHMubm9ybWFsaXplTGlzdFBhZ2UoXG4gICAgICAgICAgICAgIGNvc3RDZW50ZXJzLFxuICAgICAgICAgICAgICAnY29kZSdcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICBuZXcgQ29zdENlbnRlckFjdGlvbnMuTG9hZENvc3RDZW50ZXJTdWNjZXNzKHZhbHVlcyksXG4gICAgICAgICAgICAgIG5ldyBDb3N0Q2VudGVyQWN0aW9ucy5Mb2FkQ29zdENlbnRlcnNTdWNjZXNzKHtcbiAgICAgICAgICAgICAgICBwYWdlLFxuICAgICAgICAgICAgICAgIHBhcmFtczogcGF5bG9hZC5wYXJhbXMsXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgXTtcbiAgICAgICAgICB9KSxcbiAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+XG4gICAgICAgICAgICBvZihcbiAgICAgICAgICAgICAgbmV3IENvc3RDZW50ZXJBY3Rpb25zLkxvYWRDb3N0Q2VudGVyc0ZhaWwoe1xuICAgICAgICAgICAgICAgIHBhcmFtczogcGF5bG9hZC5wYXJhbXMsXG4gICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpLFxuICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKVxuICAgIClcbiAgKTtcblxuICBjcmVhdGVDb3N0Q2VudGVyJDogT2JzZXJ2YWJsZTxcbiAgICB8IENvc3RDZW50ZXJBY3Rpb25zLkNyZWF0ZUNvc3RDZW50ZXJTdWNjZXNzXG4gICAgfCBDb3N0Q2VudGVyQWN0aW9ucy5DcmVhdGVDb3N0Q2VudGVyRmFpbFxuICAgIHwgT3JnYW5pemF0aW9uQWN0aW9ucy5Pcmdhbml6YXRpb25DbGVhckRhdGFcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShDb3N0Q2VudGVyQWN0aW9ucy5DUkVBVEVfQ09TVF9DRU5URVIpLFxuICAgICAgbWFwKChhY3Rpb246IENvc3RDZW50ZXJBY3Rpb25zLkNyZWF0ZUNvc3RDZW50ZXIpID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICAgIHN3aXRjaE1hcCgocGF5bG9hZCkgPT5cbiAgICAgICAgdGhpcy5jb3N0Q2VudGVyQ29ubmVjdG9yXG4gICAgICAgICAgLmNyZWF0ZShwYXlsb2FkLnVzZXJJZCwgcGF5bG9hZC5jb3N0Q2VudGVyKVxuICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChkYXRhKSA9PiBbXG4gICAgICAgICAgICAgIG5ldyBDb3N0Q2VudGVyQWN0aW9ucy5DcmVhdGVDb3N0Q2VudGVyU3VjY2VzcyhkYXRhKSxcbiAgICAgICAgICAgICAgbmV3IE9yZ2FuaXphdGlvbkFjdGlvbnMuT3JnYW5pemF0aW9uQ2xlYXJEYXRhKCksXG4gICAgICAgICAgICBdKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT5cbiAgICAgICAgICAgICAgZnJvbShbXG4gICAgICAgICAgICAgICAgbmV3IENvc3RDZW50ZXJBY3Rpb25zLkNyZWF0ZUNvc3RDZW50ZXJGYWlsKHtcbiAgICAgICAgICAgICAgICAgIGNvc3RDZW50ZXJDb2RlOiBwYXlsb2FkLmNvc3RDZW50ZXIuY29kZSA/PyAnJyxcbiAgICAgICAgICAgICAgICAgIGVycm9yOiBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKSxcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBuZXcgT3JnYW5pemF0aW9uQWN0aW9ucy5Pcmdhbml6YXRpb25DbGVhckRhdGEoKSxcbiAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICApXG4gICAgKVxuICApO1xuXG4gIHVwZGF0ZUNvc3RDZW50ZXIkOiBPYnNlcnZhYmxlPFxuICAgIHwgQ29zdENlbnRlckFjdGlvbnMuVXBkYXRlQ29zdENlbnRlclN1Y2Nlc3NcbiAgICB8IENvc3RDZW50ZXJBY3Rpb25zLlVwZGF0ZUNvc3RDZW50ZXJGYWlsXG4gICAgfCBPcmdhbml6YXRpb25BY3Rpb25zLk9yZ2FuaXphdGlvbkNsZWFyRGF0YVxuICA+ID0gY3JlYXRlRWZmZWN0KCgpID0+XG4gICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgb2ZUeXBlKENvc3RDZW50ZXJBY3Rpb25zLlVQREFURV9DT1NUX0NFTlRFUiksXG4gICAgICBtYXAoKGFjdGlvbjogQ29zdENlbnRlckFjdGlvbnMuVXBkYXRlQ29zdENlbnRlcikgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgc3dpdGNoTWFwKChwYXlsb2FkKSA9PlxuICAgICAgICB0aGlzLmNvc3RDZW50ZXJDb25uZWN0b3JcbiAgICAgICAgICAudXBkYXRlKHBheWxvYWQudXNlcklkLCBwYXlsb2FkLmNvc3RDZW50ZXJDb2RlLCBwYXlsb2FkLmNvc3RDZW50ZXIpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKGRhdGEpID0+IFtcbiAgICAgICAgICAgICAgbmV3IENvc3RDZW50ZXJBY3Rpb25zLlVwZGF0ZUNvc3RDZW50ZXJTdWNjZXNzKGRhdGEpLFxuICAgICAgICAgICAgICBuZXcgT3JnYW5pemF0aW9uQWN0aW9ucy5Pcmdhbml6YXRpb25DbGVhckRhdGEoKSxcbiAgICAgICAgICAgIF0pLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PlxuICAgICAgICAgICAgICBmcm9tKFtcbiAgICAgICAgICAgICAgICBuZXcgQ29zdENlbnRlckFjdGlvbnMuVXBkYXRlQ29zdENlbnRlckZhaWwoe1xuICAgICAgICAgICAgICAgICAgY29zdENlbnRlckNvZGU6IHBheWxvYWQuY29zdENlbnRlci5jb2RlID8/ICcnLFxuICAgICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIG5ldyBPcmdhbml6YXRpb25BY3Rpb25zLk9yZ2FuaXphdGlvbkNsZWFyRGF0YSgpLFxuICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgIClcbiAgICApXG4gICk7XG5cbiAgbG9hZEFzc2lnbmVkQnVkZ2V0cyQ6IE9ic2VydmFibGU8XG4gICAgfCBDb3N0Q2VudGVyQWN0aW9ucy5Mb2FkQXNzaWduZWRCdWRnZXRzU3VjY2Vzc1xuICAgIHwgQnVkZ2V0QWN0aW9ucy5Mb2FkQnVkZ2V0U3VjY2Vzc1xuICAgIHwgQ29zdENlbnRlckFjdGlvbnMuTG9hZEFzc2lnbmVkQnVkZ2V0c0ZhaWxcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShDb3N0Q2VudGVyQWN0aW9ucy5MT0FEX0FTU0lHTkVEX0JVREdFVFMpLFxuICAgICAgbWFwKChhY3Rpb246IENvc3RDZW50ZXJBY3Rpb25zLkxvYWRBc3NpZ25lZEJ1ZGdldHMpID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICAgIGdyb3VwQnkoKHsgY29zdENlbnRlckNvZGUsIHBhcmFtcyB9KSA9PlxuICAgICAgICBTdGF0ZVV0aWxzLnNlcmlhbGl6ZVBhcmFtcyhjb3N0Q2VudGVyQ29kZSwgcGFyYW1zKVxuICAgICAgKSxcbiAgICAgIG1lcmdlTWFwKChncm91cCkgPT5cbiAgICAgICAgZ3JvdXAucGlwZShcbiAgICAgICAgICBzd2l0Y2hNYXAoKHsgdXNlcklkLCBjb3N0Q2VudGVyQ29kZSwgcGFyYW1zIH0pID0+XG4gICAgICAgICAgICB0aGlzLmNvc3RDZW50ZXJDb25uZWN0b3JcbiAgICAgICAgICAgICAgLmdldEJ1ZGdldHModXNlcklkLCBjb3N0Q2VudGVyQ29kZSwgcGFyYW1zKVxuICAgICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgICBzd2l0Y2hNYXAoKGJ1ZGdldHM6IEVudGl0aWVzTW9kZWw8QnVkZ2V0PikgPT4ge1xuICAgICAgICAgICAgICAgICAgY29uc3QgeyB2YWx1ZXMsIHBhZ2UgfSA9IFN0YXRlVXRpbHMubm9ybWFsaXplTGlzdFBhZ2UoXG4gICAgICAgICAgICAgICAgICAgIGJ1ZGdldHMsXG4gICAgICAgICAgICAgICAgICAgICdjb2RlJ1xuICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgIHJldHVybiBbXG4gICAgICAgICAgICAgICAgICAgIG5ldyBCdWRnZXRBY3Rpb25zLkxvYWRCdWRnZXRTdWNjZXNzKHZhbHVlcyksXG4gICAgICAgICAgICAgICAgICAgIG5ldyBDb3N0Q2VudGVyQWN0aW9ucy5Mb2FkQXNzaWduZWRCdWRnZXRzU3VjY2Vzcyh7XG4gICAgICAgICAgICAgICAgICAgICAgY29zdENlbnRlckNvZGUsXG4gICAgICAgICAgICAgICAgICAgICAgcGFnZSxcbiAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMsXG4gICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgXTtcbiAgICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcjogSHR0cEVycm9yUmVzcG9uc2UpID0+XG4gICAgICAgICAgICAgICAgICBvZihcbiAgICAgICAgICAgICAgICAgICAgbmV3IENvc3RDZW50ZXJBY3Rpb25zLkxvYWRBc3NpZ25lZEJ1ZGdldHNGYWlsKHtcbiAgICAgICAgICAgICAgICAgICAgICBjb3N0Q2VudGVyQ29kZSxcbiAgICAgICAgICAgICAgICAgICAgICBwYXJhbXMsXG4gICAgICAgICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpLFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKVxuICAgIClcbiAgKTtcblxuICBhc3NpZ25CdWRnZXRUb0Nvc3RDZW50ZXIkOiBPYnNlcnZhYmxlPFxuICAgIHwgQ29zdENlbnRlckFjdGlvbnMuQXNzaWduQnVkZ2V0U3VjY2Vzc1xuICAgIHwgQ29zdENlbnRlckFjdGlvbnMuQXNzaWduQnVkZ2V0RmFpbFxuICAgIHwgT3JnYW5pemF0aW9uQWN0aW9ucy5Pcmdhbml6YXRpb25DbGVhckRhdGFcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShDb3N0Q2VudGVyQWN0aW9ucy5BU1NJR05fQlVER0VUKSxcbiAgICAgIG1hcCgoYWN0aW9uOiBDb3N0Q2VudGVyQWN0aW9ucy5Bc3NpZ25CdWRnZXQpID0+IGFjdGlvbi5wYXlsb2FkKSxcbiAgICAgIG1lcmdlTWFwKCh7IHVzZXJJZCwgY29zdENlbnRlckNvZGUsIGJ1ZGdldENvZGUgfSkgPT5cbiAgICAgICAgdGhpcy5jb3N0Q2VudGVyQ29ubmVjdG9yXG4gICAgICAgICAgLmFzc2lnbkJ1ZGdldCh1c2VySWQsIGNvc3RDZW50ZXJDb2RlLCBidWRnZXRDb2RlKVxuICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKCgpID0+IFtcbiAgICAgICAgICAgICAgbmV3IENvc3RDZW50ZXJBY3Rpb25zLkFzc2lnbkJ1ZGdldFN1Y2Nlc3Moe1xuICAgICAgICAgICAgICAgIGNvZGU6IGJ1ZGdldENvZGUsXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IHRydWUsXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICBuZXcgT3JnYW5pemF0aW9uQWN0aW9ucy5Pcmdhbml6YXRpb25DbGVhckRhdGEoKSxcbiAgICAgICAgICAgIF0pLFxuICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PlxuICAgICAgICAgICAgICBmcm9tKFtcbiAgICAgICAgICAgICAgICBuZXcgQ29zdENlbnRlckFjdGlvbnMuQXNzaWduQnVkZ2V0RmFpbCh7XG4gICAgICAgICAgICAgICAgICBidWRnZXRDb2RlLFxuICAgICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIG5ldyBPcmdhbml6YXRpb25BY3Rpb25zLk9yZ2FuaXphdGlvbkNsZWFyRGF0YSgpLFxuICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgIClcbiAgICApXG4gICk7XG5cbiAgdW5hc3NpZ25CdWRnZXRUb0Nvc3RDZW50ZXIkOiBPYnNlcnZhYmxlPFxuICAgIHwgQ29zdENlbnRlckFjdGlvbnMuVW5hc3NpZ25CdWRnZXRTdWNjZXNzXG4gICAgfCBDb3N0Q2VudGVyQWN0aW9ucy5VbmFzc2lnbkJ1ZGdldEZhaWxcbiAgICB8IE9yZ2FuaXphdGlvbkFjdGlvbnMuT3JnYW5pemF0aW9uQ2xlYXJEYXRhXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoQ29zdENlbnRlckFjdGlvbnMuVU5BU1NJR05fQlVER0VUKSxcbiAgICAgIG1hcCgoYWN0aW9uOiBDb3N0Q2VudGVyQWN0aW9ucy5VbmFzc2lnbkJ1ZGdldCkgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgbWVyZ2VNYXAoKHsgdXNlcklkLCBjb3N0Q2VudGVyQ29kZSwgYnVkZ2V0Q29kZSB9KSA9PlxuICAgICAgICB0aGlzLmNvc3RDZW50ZXJDb25uZWN0b3JcbiAgICAgICAgICAudW5hc3NpZ25CdWRnZXQodXNlcklkLCBjb3N0Q2VudGVyQ29kZSwgYnVkZ2V0Q29kZSlcbiAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiBbXG4gICAgICAgICAgICAgIG5ldyBDb3N0Q2VudGVyQWN0aW9ucy5VbmFzc2lnbkJ1ZGdldFN1Y2Nlc3Moe1xuICAgICAgICAgICAgICAgIGNvZGU6IGJ1ZGdldENvZGUsXG4gICAgICAgICAgICAgICAgc2VsZWN0ZWQ6IGZhbHNlLFxuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgbmV3IE9yZ2FuaXphdGlvbkFjdGlvbnMuT3JnYW5pemF0aW9uQ2xlYXJEYXRhKCksXG4gICAgICAgICAgICBdKSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yOiBIdHRwRXJyb3JSZXNwb25zZSkgPT5cbiAgICAgICAgICAgICAgZnJvbShbXG4gICAgICAgICAgICAgICAgbmV3IENvc3RDZW50ZXJBY3Rpb25zLlVuYXNzaWduQnVkZ2V0RmFpbCh7XG4gICAgICAgICAgICAgICAgICBidWRnZXRDb2RlLFxuICAgICAgICAgICAgICAgICAgZXJyb3I6IG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpLFxuICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgIG5ldyBPcmdhbml6YXRpb25BY3Rpb25zLk9yZ2FuaXphdGlvbkNsZWFyRGF0YSgpLFxuICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgIClcbiAgICApXG4gICk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBhY3Rpb25zJDogQWN0aW9ucyxcbiAgICBwcml2YXRlIGNvc3RDZW50ZXJDb25uZWN0b3I6IENvc3RDZW50ZXJDb25uZWN0b3JcbiAgKSB7fVxufVxuIl19