/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { queueScheduler, using } from 'rxjs';
import { auditTime, filter, map, observeOn, tap } from 'rxjs/operators';
import { UserGroupActions } from '../store/actions/index';
import { getAvailableOrderApprovalPermissions, getAvailableOrgCustomers, getUserGroup, getUserGroupList, getUserGroupState, getUserGroupValue, } from '../store/selectors/user-group.selector';
import { getItemStatus } from '../utils/get-item-status';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/store";
import * as i2 from "@spartacus/core";
export class UserGroupService {
    constructor(store, userIdService) {
        this.store = store;
        this.userIdService = userIdService;
    }
    load(userGroupId) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.LoadUserGroup({
                userId,
                userGroupId,
            })),
            error: () => {
                // TODO: for future releases, refactor this part to thrown errors
            },
        });
    }
    loadList(params) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.LoadUserGroups({ userId, params })),
            error: () => {
                // TODO: for future releases, refactor this part to thrown errors
            },
        });
    }
    getUserGroup(userGroupId) {
        return this.store.select(getUserGroup(userGroupId));
    }
    getUserGroupValue(userGroupId) {
        return this.store
            .select(getUserGroupValue(userGroupId))
            .pipe(filter((userGroup) => Boolean(userGroup)));
    }
    getUserGroupList(params) {
        return this.store.select(getUserGroupList(params));
    }
    getAvailableOrgCustomersList(userGroupId, params) {
        return this.store.select(getAvailableOrgCustomers(userGroupId, params));
    }
    getAvailableOrderApprovalPermissionsList(userGroupId, params) {
        return this.store.select(getAvailableOrderApprovalPermissions(userGroupId, params));
    }
    get(userGroupUid) {
        const loading$ = this.getUserGroup(userGroupUid).pipe(auditTime(0), tap((state) => {
            if (!(state.loading || state.success || state.error)) {
                this.load(userGroupUid);
            }
        }));
        return using(() => loading$.subscribe(), () => this.getUserGroupValue(userGroupUid));
    }
    getList(params) {
        return this.getUserGroupList(params).pipe(observeOn(queueScheduler), tap((process) => {
            if (!(process.loading || process.success || process.error)) {
                this.loadList(params);
            }
        }), filter((process) => Boolean(process.success || process.error)), map((result) => result.value));
    }
    create(userGroup) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.CreateUserGroup({
                userId,
                userGroup,
            })),
            error: () => {
                // TODO: for future releases, refactor this part to thrown errors
            },
        });
    }
    update(userGroupId, userGroup) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.UpdateUserGroup({
                userId,
                userGroupId,
                userGroup,
            })),
            error: () => {
                // TODO: for future releases, refactor this part to thrown errors
            },
        });
    }
    getLoadingStatus(budgetCode) {
        return getItemStatus(this.getUserGroup(budgetCode));
    }
    delete(userGroupId) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.DeleteUserGroup({
                userId,
                userGroupId,
            })),
            error: () => {
                // TODO: for future releases, refactor this part to thrown errors
            },
        });
    }
    loadAvailableOrgCustomers(userGroupId, params) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.LoadAvailableOrgCustomers({
                userId,
                userGroupId,
                params,
            })),
            error: () => {
                // TODO: for future releases, refactor this part to thrown errors
            },
        });
    }
    loadAvailableOrderApprovalPermissions(userGroupId, params) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.LoadPermissions({
                userId,
                userGroupId,
                params,
            })),
            error: () => {
                // TODO: for future releases, refactor this part to thrown errors
            },
        });
    }
    getAvailableOrgCustomers(userGroupId, params) {
        return this.getAvailableOrgCustomersList(userGroupId, params).pipe(observeOn(queueScheduler), tap((process) => {
            if (!(process.loading || process.success || process.error)) {
                this.loadAvailableOrgCustomers(userGroupId, params);
            }
        }), filter((process) => Boolean(process.success || process.error)), map((result) => result.value));
    }
    getAvailableOrderApprovalPermissions(userGroupId, params) {
        return this.getAvailableOrderApprovalPermissionsList(userGroupId, params).pipe(observeOn(queueScheduler), tap((process) => {
            if (!(process.loading || process.success || process.error)) {
                this.loadAvailableOrderApprovalPermissions(userGroupId, params);
            }
        }), filter((process) => Boolean(process.success || process.error)), map((result) => result.value));
    }
    assignMember(userGroupId, customerId) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.AssignMember({
                userId,
                userGroupId,
                customerId,
            })),
            error: () => {
                // TODO: for future releases, refactor this part to thrown errors
            },
        });
    }
    unassignMember(userGroupId, customerId) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.UnassignMember({
                userId,
                userGroupId,
                customerId,
            })),
            error: () => {
                // Intentional empty arrow function
            },
        });
    }
    unassignAllMembers(userGroupId) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.UnassignAllMembers({
                userId,
                userGroupId,
            })),
            error: () => {
                // Intentional empty arrow function
            },
        });
    }
    assignPermission(userGroupId, permissionUid) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.AssignPermission({
                userId,
                userGroupId,
                permissionUid,
            })),
            error: () => {
                // Intentional empty arrow function
            },
        });
    }
    unassignPermission(userGroupId, permissionUid) {
        this.userIdService.takeUserId(true).subscribe({
            next: (userId) => this.store.dispatch(new UserGroupActions.UnassignPermission({
                userId,
                userGroupId,
                permissionUid,
            })),
            error: () => {
                // Intentional empty arrow function
            },
        });
    }
    getUserGroupState(code) {
        return this.store.select(getUserGroupState(code));
    }
    getErrorState(code) {
        return this.getUserGroupState(code).pipe(map((state) => state.error ?? false));
    }
}
UserGroupService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: UserGroupService, deps: [{ token: i1.Store }, { token: i2.UserIdService }], target: i0.ɵɵFactoryTarget.Injectable });
UserGroupService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: UserGroupService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: UserGroupService, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }], ctorParameters: function () { return [{ type: i1.Store }, { type: i2.UserIdService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXNlci1ncm91cC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL29yZ2FuaXphdGlvbi9hZG1pbmlzdHJhdGlvbi9jb3JlL3NlcnZpY2VzL3VzZXItZ3JvdXAuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGVBQWUsQ0FBQztBQVMzQyxPQUFPLEVBQWMsY0FBYyxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN6RCxPQUFPLEVBQUUsU0FBUyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBSXhFLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLHdCQUF3QixDQUFDO0FBRTFELE9BQU8sRUFDTCxvQ0FBb0MsRUFDcEMsd0JBQXdCLEVBQ3hCLFlBQVksRUFDWixnQkFBZ0IsRUFDaEIsaUJBQWlCLEVBQ2pCLGlCQUFpQixHQUNsQixNQUFNLHdDQUF3QyxDQUFDO0FBQ2hELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQzs7OztBQUd6RCxNQUFNLE9BQU8sZ0JBQWdCO0lBQzNCLFlBQ1ksS0FBbUMsRUFDbkMsYUFBNEI7UUFENUIsVUFBSyxHQUFMLEtBQUssQ0FBOEI7UUFDbkMsa0JBQWEsR0FBYixhQUFhLENBQWU7SUFDckMsQ0FBQztJQUVKLElBQUksQ0FBQyxXQUFtQjtRQUN0QixJQUFJLENBQUMsYUFBYSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxTQUFTLENBQUM7WUFDNUMsSUFBSSxFQUFFLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FDZixJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FDakIsSUFBSSxnQkFBZ0IsQ0FBQyxhQUFhLENBQUM7Z0JBQ2pDLE1BQU07Z0JBQ04sV0FBVzth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SSxDQUFDLENBQUMsSUFBSSxDQUN0QyxHQUFHLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxLQUFLLElBQUksS0FBSyxDQUFDLENBQ3JDLENBQUM7SUFDSixDQUFDOzs2R0EzVFUsZ0JBQWdCO2lIQUFoQixnQkFBZ0IsY0FESCxNQUFNOzJGQUNuQixnQkFBZ0I7a0JBRDVCLFVBQVU7bUJBQUMsRUFBRSxVQUFVLEVBQUUsTUFBTSxFQUFFIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgU3RvcmUgfSBmcm9tICdAbmdyeC9zdG9yZSc7XG5pbXBvcnQge1xuICBCMkJVc2VyLFxuICBFbnRpdGllc01vZGVsLFxuICBTZWFyY2hDb25maWcsXG4gIFN0YXRlVXRpbHMsXG4gIFVzZXJJZFNlcnZpY2UsXG59IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBxdWV1ZVNjaGVkdWxlciwgdXNpbmcgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGF1ZGl0VGltZSwgZmlsdGVyLCBtYXAsIG9ic2VydmVPbiwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgT3JnYW5pemF0aW9uSXRlbVN0YXR1cyB9IGZyb20gJy4uL21vZGVsL29yZ2FuaXphdGlvbi1pdGVtLXN0YXR1cyc7XG5pbXBvcnQgeyBQZXJtaXNzaW9uIH0gZnJvbSAnLi4vbW9kZWwvcGVybWlzc2lvbi5tb2RlbCc7XG5pbXBvcnQgeyBVc2VyR3JvdXAgfSBmcm9tICcuLi9tb2RlbC91c2VyLWdyb3VwLm1vZGVsJztcbmltcG9ydCB7IFVzZXJHcm91cEFjdGlvbnMgfSBmcm9tICcuLi9zdG9yZS9hY3Rpb25zL2luZGV4JztcbmltcG9ydCB7IFN0YXRlV2l0aE9yZ2FuaXphdGlvbiB9IGZyb20gJy4uL3N0b3JlL29yZ2FuaXphdGlvbi1zdGF0ZSc7XG5pbXBvcnQge1xuICBnZXRBdmFpbGFibGVPcmRlckFwcHJvdmFsUGVybWlzc2lvbnMsXG4gIGdldEF2YWlsYWJsZU9yZ0N1c3RvbWVycyxcbiAgZ2V0VXNlckdyb3VwLFxuICBnZXRVc2VyR3JvdXBMaXN0LFxuICBnZXRVc2VyR3JvdXBTdGF0ZSxcbiAgZ2V0VXNlckdyb3VwVmFsdWUsXG59IGZyb20gJy4uL3N0b3JlL3NlbGVjdG9ycy91c2VyLWdyb3VwLnNlbGVjdG9yJztcbmltcG9ydCB7IGdldEl0ZW1TdGF0dXMgfSBmcm9tICcuLi91dGlscy9nZXQtaXRlbS1zdGF0dXMnO1xuXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxuZXhwb3J0IGNsYXNzIFVzZXJHcm91cFNlcnZpY2Uge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgc3RvcmU6IFN0b3JlPFN0YXRlV2l0aE9yZ2FuaXphdGlvbj4sXG4gICAgcHJvdGVjdGVkIHVzZXJJZFNlcnZpY2U6IFVzZXJJZFNlcnZpY2VcbiAgKSB7fVxuXG4gIGxvYWQodXNlckdyb3VwSWQ6IHN0cmluZykge1xuICAgIHRoaXMudXNlcklkU2VydmljZS50YWtlVXNlcklkKHRydWUpLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiAodXNlcklkKSA9PlxuICAgICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKFxuICAgICAgICAgIG5ldyBVc2VyR3JvdXBBY3Rpb25zLkxvYWRVc2VyR3JvdXAoe1xuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgdXNlckdyb3VwSWQsXG4gICAgICAgICAgfSlcbiAgICAgICAgKSxcbiAgICAgIGVycm9yOiAoKSA9PiB7XG4gICAgICAgIC8vIFRPRE86IGZvciBmdXR1cmUgcmVsZWFzZXMsIHJlZmFjdG9yIHRoaXMgcGFydCB0byB0aHJvd24gZXJyb3JzXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgbG9hZExpc3QocGFyYW1zOiBTZWFyY2hDb25maWcpIHtcbiAgICB0aGlzLnVzZXJJZFNlcnZpY2UudGFrZVVzZXJJZCh0cnVlKS5zdWJzY3JpYmUoe1xuICAgICAgbmV4dDogKHVzZXJJZCkgPT5cbiAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICBuZXcgVXNlckdyb3VwQWN0aW9ucy5Mb2FkVXNlckdyb3Vwcyh7IHVzZXJJZCwgcGFyYW1zIH0pXG4gICAgICAgICksXG4gICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAvLyBUT0RPOiBmb3IgZnV0dXJlIHJlbGVhc2VzLCByZWZhY3RvciB0aGlzIHBhcnQgdG8gdGhyb3duIGVycm9yc1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VXNlckdyb3VwKFxuICAgIHVzZXJHcm91cElkOiBzdHJpbmdcbiAgKTogT2JzZXJ2YWJsZTxTdGF0ZVV0aWxzLkxvYWRlclN0YXRlPFVzZXJHcm91cD4+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5zZWxlY3QoZ2V0VXNlckdyb3VwKHVzZXJHcm91cElkKSk7XG4gIH1cblxuICBwcml2YXRlIGdldFVzZXJHcm91cFZhbHVlKHVzZXJHcm91cElkOiBzdHJpbmcpOiBPYnNlcnZhYmxlPFVzZXJHcm91cD4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlXG4gICAgICAuc2VsZWN0KGdldFVzZXJHcm91cFZhbHVlKHVzZXJHcm91cElkKSlcbiAgICAgIC5waXBlKGZpbHRlcigodXNlckdyb3VwKSA9PiBCb29sZWFuKHVzZXJHcm91cCkpKTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VXNlckdyb3VwTGlzdChcbiAgICBwYXJhbXM6IFNlYXJjaENvbmZpZ1xuICApOiBPYnNlcnZhYmxlPFN0YXRlVXRpbHMuTG9hZGVyU3RhdGU8RW50aXRpZXNNb2RlbDxVc2VyR3JvdXA+Pj4ge1xuICAgIHJldHVybiB0aGlzLnN0b3JlLnNlbGVjdChnZXRVc2VyR3JvdXBMaXN0KHBhcmFtcykpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBdmFpbGFibGVPcmdDdXN0b21lcnNMaXN0KFxuICAgIHVzZXJHcm91cElkOiBzdHJpbmcsXG4gICAgcGFyYW1zOiBTZWFyY2hDb25maWdcbiAgKTogT2JzZXJ2YWJsZTxTdGF0ZVV0aWxzLkxvYWRlclN0YXRlPEVudGl0aWVzTW9kZWw8QjJCVXNlcj4+PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUuc2VsZWN0KGdldEF2YWlsYWJsZU9yZ0N1c3RvbWVycyh1c2VyR3JvdXBJZCwgcGFyYW1zKSk7XG4gIH1cblxuICBwcml2YXRlIGdldEF2YWlsYWJsZU9yZGVyQXBwcm92YWxQZXJtaXNzaW9uc0xpc3QoXG4gICAgdXNlckdyb3VwSWQ6IHN0cmluZyxcbiAgICBwYXJhbXM6IFNlYXJjaENvbmZpZ1xuICApOiBPYnNlcnZhYmxlPFN0YXRlVXRpbHMuTG9hZGVyU3RhdGU8RW50aXRpZXNNb2RlbDxQZXJtaXNzaW9uPj4+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZS5zZWxlY3QoXG4gICAgICBnZXRBdmFpbGFibGVPcmRlckFwcHJvdmFsUGVybWlzc2lvbnModXNlckdyb3VwSWQsIHBhcmFtcylcbiAgICApO1xuICB9XG5cbiAgZ2V0KHVzZXJHcm91cFVpZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxVc2VyR3JvdXA+IHtcbiAgICBjb25zdCBsb2FkaW5nJCA9IHRoaXMuZ2V0VXNlckdyb3VwKHVzZXJHcm91cFVpZCkucGlwZShcbiAgICAgIGF1ZGl0VGltZSgwKSxcbiAgICAgIHRhcCgoc3RhdGUpID0+IHtcbiAgICAgICAgaWYgKCEoc3RhdGUubG9hZGluZyB8fCBzdGF0ZS5zdWNjZXNzIHx8IHN0YXRlLmVycm9yKSkge1xuICAgICAgICAgIHRoaXMubG9hZCh1c2VyR3JvdXBVaWQpO1xuICAgICAgICB9XG4gICAgICB9KVxuICAgICk7XG5cbiAgICByZXR1cm4gdXNpbmcoXG4gICAgICAoKSA9PiBsb2FkaW5nJC5zdWJzY3JpYmUoKSxcbiAgICAgICgpID0+IHRoaXMuZ2V0VXNlckdyb3VwVmFsdWUodXNlckdyb3VwVWlkKVxuICAgICk7XG4gIH1cblxuICBnZXRMaXN0KFxuICAgIHBhcmFtczogU2VhcmNoQ29uZmlnXG4gICk6IE9ic2VydmFibGU8RW50aXRpZXNNb2RlbDxVc2VyR3JvdXA+IHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0VXNlckdyb3VwTGlzdChwYXJhbXMpLnBpcGUoXG4gICAgICBvYnNlcnZlT24ocXVldWVTY2hlZHVsZXIpLFxuICAgICAgdGFwKChwcm9jZXNzOiBTdGF0ZVV0aWxzLkxvYWRlclN0YXRlPEVudGl0aWVzTW9kZWw8VXNlckdyb3VwPj4pID0+IHtcbiAgICAgICAgaWYgKCEocHJvY2Vzcy5sb2FkaW5nIHx8IHByb2Nlc3Muc3VjY2VzcyB8fCBwcm9jZXNzLmVycm9yKSkge1xuICAgICAgICAgIHRoaXMubG9hZExpc3QocGFyYW1zKTtcbiAgICAgICAgfVxuICAgICAgfSksXG4gICAgICBmaWx0ZXIoKHByb2Nlc3M6IFN0YXRlVXRpbHMuTG9hZGVyU3RhdGU8RW50aXRpZXNNb2RlbDxVc2VyR3JvdXA+PikgPT5cbiAgICAgICAgQm9vbGVhbihwcm9jZXNzLnN1Y2Nlc3MgfHwgcHJvY2Vzcy5lcnJvcilcbiAgICAgICksXG4gICAgICBtYXAoKHJlc3VsdCkgPT4gcmVzdWx0LnZhbHVlKVxuICAgICk7XG4gIH1cblxuICBjcmVhdGUodXNlckdyb3VwOiBVc2VyR3JvdXApIHtcbiAgICB0aGlzLnVzZXJJZFNlcnZpY2UudGFrZVVzZXJJZCh0cnVlKS5zdWJzY3JpYmUoe1xuICAgICAgbmV4dDogKHVzZXJJZCkgPT5cbiAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICBuZXcgVXNlckdyb3VwQWN0aW9ucy5DcmVhdGVVc2VyR3JvdXAoe1xuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgdXNlckdyb3VwLFxuICAgICAgICAgIH0pXG4gICAgICAgICksXG4gICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAvLyBUT0RPOiBmb3IgZnV0dXJlIHJlbGVhc2VzLCByZWZhY3RvciB0aGlzIHBhcnQgdG8gdGhyb3duIGVycm9yc1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHVwZGF0ZSh1c2VyR3JvdXBJZDogc3RyaW5nLCB1c2VyR3JvdXA6IFVzZXJHcm91cCkge1xuICAgIHRoaXMudXNlcklkU2VydmljZS50YWtlVXNlcklkKHRydWUpLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiAodXNlcklkKSA9PlxuICAgICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKFxuICAgICAgICAgIG5ldyBVc2VyR3JvdXBBY3Rpb25zLlVwZGF0ZVVzZXJHcm91cCh7XG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICB1c2VyR3JvdXBJZCxcbiAgICAgICAgICAgIHVzZXJHcm91cCxcbiAgICAgICAgICB9KVxuICAgICAgICApLFxuICAgICAgZXJyb3I6ICgpID0+IHtcbiAgICAgICAgLy8gVE9ETzogZm9yIGZ1dHVyZSByZWxlYXNlcywgcmVmYWN0b3IgdGhpcyBwYXJ0IHRvIHRocm93biBlcnJvcnNcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBnZXRMb2FkaW5nU3RhdHVzKFxuICAgIGJ1ZGdldENvZGU6IHN0cmluZ1xuICApOiBPYnNlcnZhYmxlPE9yZ2FuaXphdGlvbkl0ZW1TdGF0dXM8VXNlckdyb3VwPj4ge1xuICAgIHJldHVybiBnZXRJdGVtU3RhdHVzKHRoaXMuZ2V0VXNlckdyb3VwKGJ1ZGdldENvZGUpKTtcbiAgfVxuXG4gIGRlbGV0ZSh1c2VyR3JvdXBJZDogc3RyaW5nKSB7XG4gICAgdGhpcy51c2VySWRTZXJ2aWNlLnRha2VVc2VySWQodHJ1ZSkuc3Vic2NyaWJlKHtcbiAgICAgIG5leHQ6ICh1c2VySWQpID0+XG4gICAgICAgIHRoaXMuc3RvcmUuZGlzcGF0Y2goXG4gICAgICAgICAgbmV3IFVzZXJHcm91cEFjdGlvbnMuRGVsZXRlVXNlckdyb3VwKHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIHVzZXJHcm91cElkLFxuICAgICAgICAgIH0pXG4gICAgICAgICksXG4gICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAvLyBUT0RPOiBmb3IgZnV0dXJlIHJlbGVhc2VzLCByZWZhY3RvciB0aGlzIHBhcnQgdG8gdGhyb3duIGVycm9yc1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGxvYWRBdmFpbGFibGVPcmdDdXN0b21lcnModXNlckdyb3VwSWQ6IHN0cmluZywgcGFyYW1zOiBTZWFyY2hDb25maWcpIHtcbiAgICB0aGlzLnVzZXJJZFNlcnZpY2UudGFrZVVzZXJJZCh0cnVlKS5zdWJzY3JpYmUoe1xuICAgICAgbmV4dDogKHVzZXJJZCkgPT5cbiAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICBuZXcgVXNlckdyb3VwQWN0aW9ucy5Mb2FkQXZhaWxhYmxlT3JnQ3VzdG9tZXJzKHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIHVzZXJHcm91cElkLFxuICAgICAgICAgICAgcGFyYW1zLFxuICAgICAgICAgIH0pXG4gICAgICAgICksXG4gICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAvLyBUT0RPOiBmb3IgZnV0dXJlIHJlbGVhc2VzLCByZWZhY3RvciB0aGlzIHBhcnQgdG8gdGhyb3duIGVycm9yc1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGxvYWRBdmFpbGFibGVPcmRlckFwcHJvdmFsUGVybWlzc2lvbnMoXG4gICAgdXNlckdyb3VwSWQ6IHN0cmluZyxcbiAgICBwYXJhbXM6IFNlYXJjaENvbmZpZ1xuICApIHtcbiAgICB0aGlzLnVzZXJJZFNlcnZpY2UudGFrZVVzZXJJZCh0cnVlKS5zdWJzY3JpYmUoe1xuICAgICAgbmV4dDogKHVzZXJJZCkgPT5cbiAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICBuZXcgVXNlckdyb3VwQWN0aW9ucy5Mb2FkUGVybWlzc2lvbnMoe1xuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgdXNlckdyb3VwSWQsXG4gICAgICAgICAgICBwYXJhbXMsXG4gICAgICAgICAgfSlcbiAgICAgICAgKSxcbiAgICAgIGVycm9yOiAoKSA9PiB7XG4gICAgICAgIC8vIFRPRE86IGZvciBmdXR1cmUgcmVsZWFzZXMsIHJlZmFjdG9yIHRoaXMgcGFydCB0byB0aHJvd24gZXJyb3JzXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgZ2V0QXZhaWxhYmxlT3JnQ3VzdG9tZXJzKFxuICAgIHVzZXJHcm91cElkOiBzdHJpbmcsXG4gICAgcGFyYW1zOiBTZWFyY2hDb25maWdcbiAgKTogT2JzZXJ2YWJsZTxFbnRpdGllc01vZGVsPEIyQlVzZXI+IHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0QXZhaWxhYmxlT3JnQ3VzdG9tZXJzTGlzdCh1c2VyR3JvdXBJZCwgcGFyYW1zKS5waXBlKFxuICAgICAgb2JzZXJ2ZU9uKHF1ZXVlU2NoZWR1bGVyKSxcbiAgICAgIHRhcCgocHJvY2VzczogU3RhdGVVdGlscy5Mb2FkZXJTdGF0ZTxFbnRpdGllc01vZGVsPEIyQlVzZXI+PikgPT4ge1xuICAgICAgICBpZiAoIShwcm9jZXNzLmxvYWRpbmcgfHwgcHJvY2Vzcy5zdWNjZXNzIHx8IHByb2Nlc3MuZXJyb3IpKSB7XG4gICAgICAgICAgdGhpcy5sb2FkQXZhaWxhYmxlT3JnQ3VzdG9tZXJzKHVzZXJHcm91cElkLCBwYXJhbXMpO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIGZpbHRlcigocHJvY2VzczogU3RhdGVVdGlscy5Mb2FkZXJTdGF0ZTxFbnRpdGllc01vZGVsPEIyQlVzZXI+PikgPT5cbiAgICAgICAgQm9vbGVhbihwcm9jZXNzLnN1Y2Nlc3MgfHwgcHJvY2Vzcy5lcnJvcilcbiAgICAgICksXG4gICAgICBtYXAoKHJlc3VsdCkgPT4gcmVzdWx0LnZhbHVlKVxuICAgICk7XG4gIH1cblxuICBnZXRBdmFpbGFibGVPcmRlckFwcHJvdmFsUGVybWlzc2lvbnMoXG4gICAgdXNlckdyb3VwSWQ6IHN0cmluZyxcbiAgICBwYXJhbXM6IFNlYXJjaENvbmZpZ1xuICApOiBPYnNlcnZhYmxlPEVudGl0aWVzTW9kZWw8UGVybWlzc2lvbj4gfCB1bmRlZmluZWQ+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRBdmFpbGFibGVPcmRlckFwcHJvdmFsUGVybWlzc2lvbnNMaXN0KFxuICAgICAgdXNlckdyb3VwSWQsXG4gICAgICBwYXJhbXNcbiAgICApLnBpcGUoXG4gICAgICBvYnNlcnZlT24ocXVldWVTY2hlZHVsZXIpLFxuICAgICAgdGFwKChwcm9jZXNzOiBTdGF0ZVV0aWxzLkxvYWRlclN0YXRlPEVudGl0aWVzTW9kZWw8UGVybWlzc2lvbj4+KSA9PiB7XG4gICAgICAgIGlmICghKHByb2Nlc3MubG9hZGluZyB8fCBwcm9jZXNzLnN1Y2Nlc3MgfHwgcHJvY2Vzcy5lcnJvcikpIHtcbiAgICAgICAgICB0aGlzLmxvYWRBdmFpbGFibGVPcmRlckFwcHJvdmFsUGVybWlzc2lvbnModXNlckdyb3VwSWQsIHBhcmFtcyk7XG4gICAgICAgIH1cbiAgICAgIH0pLFxuICAgICAgZmlsdGVyKChwcm9jZXNzOiBTdGF0ZVV0aWxzLkxvYWRlclN0YXRlPEVudGl0aWVzTW9kZWw8UGVybWlzc2lvbj4+KSA9PlxuICAgICAgICBCb29sZWFuKHByb2Nlc3Muc3VjY2VzcyB8fCBwcm9jZXNzLmVycm9yKVxuICAgICAgKSxcbiAgICAgIG1hcCgocmVzdWx0KSA9PiByZXN1bHQudmFsdWUpXG4gICAgKTtcbiAgfVxuXG4gIGFzc2lnbk1lbWJlcih1c2VyR3JvdXBJZDogc3RyaW5nLCBjdXN0b21lcklkOiBzdHJpbmcpIHtcbiAgICB0aGlzLnVzZXJJZFNlcnZpY2UudGFrZVVzZXJJZCh0cnVlKS5zdWJzY3JpYmUoe1xuICAgICAgbmV4dDogKHVzZXJJZCkgPT5cbiAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICBuZXcgVXNlckdyb3VwQWN0aW9ucy5Bc3NpZ25NZW1iZXIoe1xuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgdXNlckdyb3VwSWQsXG4gICAgICAgICAgICBjdXN0b21lcklkLFxuICAgICAgICAgIH0pXG4gICAgICAgICksXG4gICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAvLyBUT0RPOiBmb3IgZnV0dXJlIHJlbGVhc2VzLCByZWZhY3RvciB0aGlzIHBhcnQgdG8gdGhyb3duIGVycm9yc1xuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHVuYXNzaWduTWVtYmVyKHVzZXJHcm91cElkOiBzdHJpbmcsIGN1c3RvbWVySWQ6IHN0cmluZykge1xuICAgIHRoaXMudXNlcklkU2VydmljZS50YWtlVXNlcklkKHRydWUpLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiAodXNlcklkKSA9PlxuICAgICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKFxuICAgICAgICAgIG5ldyBVc2VyR3JvdXBBY3Rpb25zLlVuYXNzaWduTWVtYmVyKHtcbiAgICAgICAgICAgIHVzZXJJZCxcbiAgICAgICAgICAgIHVzZXJHcm91cElkLFxuICAgICAgICAgICAgY3VzdG9tZXJJZCxcbiAgICAgICAgICB9KVxuICAgICAgICApLFxuICAgICAgZXJyb3I6ICgpID0+IHtcbiAgICAgICAgLy8gSW50ZW50aW9uYWwgZW1wdHkgYXJyb3cgZnVuY3Rpb25cbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICB1bmFzc2lnbkFsbE1lbWJlcnModXNlckdyb3VwSWQ6IHN0cmluZykge1xuICAgIHRoaXMudXNlcklkU2VydmljZS50YWtlVXNlcklkKHRydWUpLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiAodXNlcklkKSA9PlxuICAgICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKFxuICAgICAgICAgIG5ldyBVc2VyR3JvdXBBY3Rpb25zLlVuYXNzaWduQWxsTWVtYmVycyh7XG4gICAgICAgICAgICB1c2VySWQsXG4gICAgICAgICAgICB1c2VyR3JvdXBJZCxcbiAgICAgICAgICB9KVxuICAgICAgICApLFxuICAgICAgZXJyb3I6ICgpID0+IHtcbiAgICAgICAgLy8gSW50ZW50aW9uYWwgZW1wdHkgYXJyb3cgZnVuY3Rpb25cbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBhc3NpZ25QZXJtaXNzaW9uKHVzZXJHcm91cElkOiBzdHJpbmcsIHBlcm1pc3Npb25VaWQ6IHN0cmluZykge1xuICAgIHRoaXMudXNlcklkU2VydmljZS50YWtlVXNlcklkKHRydWUpLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiAodXNlcklkKSA9PlxuICAgICAgICB0aGlzLnN0b3JlLmRpc3BhdGNoKFxuICAgICAgICAgIG5ldyBVc2VyR3JvdXBBY3Rpb25zLkFzc2lnblBlcm1pc3Npb24oe1xuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgdXNlckdyb3VwSWQsXG4gICAgICAgICAgICBwZXJtaXNzaW9uVWlkLFxuICAgICAgICAgIH0pXG4gICAgICAgICksXG4gICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAvLyBJbnRlbnRpb25hbCBlbXB0eSBhcnJvdyBmdW5jdGlvblxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHVuYXNzaWduUGVybWlzc2lvbih1c2VyR3JvdXBJZDogc3RyaW5nLCBwZXJtaXNzaW9uVWlkOiBzdHJpbmcpIHtcbiAgICB0aGlzLnVzZXJJZFNlcnZpY2UudGFrZVVzZXJJZCh0cnVlKS5zdWJzY3JpYmUoe1xuICAgICAgbmV4dDogKHVzZXJJZCkgPT5cbiAgICAgICAgdGhpcy5zdG9yZS5kaXNwYXRjaChcbiAgICAgICAgICBuZXcgVXNlckdyb3VwQWN0aW9ucy5VbmFzc2lnblBlcm1pc3Npb24oe1xuICAgICAgICAgICAgdXNlcklkLFxuICAgICAgICAgICAgdXNlckdyb3VwSWQsXG4gICAgICAgICAgICBwZXJtaXNzaW9uVWlkLFxuICAgICAgICAgIH0pXG4gICAgICAgICksXG4gICAgICBlcnJvcjogKCkgPT4ge1xuICAgICAgICAvLyBJbnRlbnRpb25hbCBlbXB0eSBhcnJvdyBmdW5jdGlvblxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIHByaXZhdGUgZ2V0VXNlckdyb3VwU3RhdGUoXG4gICAgY29kZTogc3RyaW5nXG4gICk6IE9ic2VydmFibGU8U3RhdGVVdGlscy5Mb2FkZXJTdGF0ZTxVc2VyR3JvdXA+PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmUuc2VsZWN0KGdldFVzZXJHcm91cFN0YXRlKGNvZGUpKTtcbiAgfVxuXG4gIGdldEVycm9yU3RhdGUoY29kZTogc3RyaW5nKTogT2JzZXJ2YWJsZTxib29sZWFuPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0VXNlckdyb3VwU3RhdGUoY29kZSkucGlwZShcbiAgICAgIG1hcCgoc3RhdGUpID0+IHN0YXRlLmVycm9yID8/IGZhbHNlKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==