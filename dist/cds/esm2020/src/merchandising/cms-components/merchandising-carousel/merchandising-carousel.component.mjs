/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { ChangeDetectionStrategy, Component } from '@angular/core';
import { EMPTY, using } from 'rxjs';
import { distinctUntilKeyChanged, filter, map, shareReplay, switchMap, take, tap, } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/storefront";
import * as i2 from "./merchandising-carousel.component.service";
import * as i3 from "@spartacus/core";
import * as i4 from "@angular/common";
import * as i5 from "../directives/attributes/attributes.directive";
import * as i6 from "@angular/router";
export class MerchandisingCarouselComponent {
    constructor(componentData, merchandisingCarouselComponentService, routingService, intersectionService, el) {
        this.componentData = componentData;
        this.merchandisingCarouselComponentService = merchandisingCarouselComponentService;
        this.routingService = routingService;
        this.intersectionService = intersectionService;
        this.el = el;
        /**
         * returns an Observable string for the title.
         */
        this.title$ = this.componentData.data$.pipe(filter((data) => Boolean(data)), map((data) => data.title));
        this.fetchProducts$ = this.componentData.data$.pipe(filter((data) => Boolean(data)), distinctUntilKeyChanged('strategy'), switchMap((data) => this.merchandisingCarouselComponentService.getMerchandisingCarouselModel(data)), tap((data) => {
            if (typeof data.backgroundColor === 'string') {
                this.el.nativeElement.style.setProperty('--cx-color-background', data.backgroundColor);
            }
            if (typeof data.textColor === 'string') {
                this.el.nativeElement.style.setProperty('--cx-color-text', data.textColor);
            }
        }), shareReplay({ bufferSize: 1, refCount: true }));
        this.intersection$ = this.fetchProducts$.pipe(take(1), switchMap(() => this.routingService.getPageContext().pipe(switchMap(() => this.componentData.data$), map((data) => this.merchandisingCarouselComponentService.getMerchandisingCaourselViewportThreshold(data)), switchMap((threshold) => this.intersectionService
            .isIntersected(this.el.nativeElement, {
            threshold,
        })
            .pipe(filter((carouselIsVisible) => carouselIsVisible), switchMap((_) => {
            return this.merchandisingCarouselComponentService
                .sendCarouselViewEvent(this.lastEventModelId, this.fetchProducts$)
                .pipe(tap((model) => {
                this.lastEventModelId = model.id;
            }), switchMap(() => EMPTY));
        }))))));
        this.merchandisingCarouselModel$ = using(() => this.intersection$.subscribe(), () => this.fetchProducts$);
        this.lastEventModelId = '';
    }
    onMerchandisingCarouselItemClick(merchandisingCarouselModel, clickedProduct) {
        this.merchandisingCarouselComponentService.sendCarouselItemClickedEvent(merchandisingCarouselModel, clickedProduct);
    }
}
MerchandisingCarouselComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: MerchandisingCarouselComponent, deps: [{ token: i1.CmsComponentData }, { token: i2.MerchandisingCarouselComponentService }, { token: i3.RoutingService }, { token: i1.IntersectionService }, { token: i0.ElementRef }], target: i0.ɵɵFactoryTarget.Component });
MerchandisingCarouselComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.9", type: MerchandisingCarouselComponent, selector: "cx-merchandising-carousel", ngImport: i0, template: "<ng-container\n  *ngIf=\"merchandisingCarouselModel$ | async as merchandisingCarouselModel\"\n>\n  <div\n    class=\"data-cx-merchandising-carousel\"\n    [cxAttributes]=\"merchandisingCarouselModel.metadata\"\n    [cxAttributesNamePrefix]=\"'data-cx-merchandising-carousel'\"\n  ></div>\n  <cx-carousel\n    [items]=\"merchandisingCarouselModel.items$\"\n    [title]=\"title$ | async\"\n    [template]=\"carouselItem\"\n    itemWidth=\"285px\"\n  >\n  </cx-carousel>\n\n  <ng-template #carouselItem let-item=\"item\">\n    <div\n      class=\"data-cx-merchandising-product\"\n      [cxAttributes]=\"item.metadata\"\n      [cxAttributesNamePrefix]=\"'data-cx-merchandising-product'\"\n    ></div>\n    <a\n      tabindex=\"0\"\n      [routerLink]=\"{ cxRoute: 'product', params: item } | cxUrl\"\n      (click)=\"\n        onMerchandisingCarouselItemClick(merchandisingCarouselModel, item)\n      \"\n    >\n      <cx-media\n        *ngIf=\"item.images?.PRIMARY\"\n        [container]=\"item.images.PRIMARY\"\n        format=\"product\"\n      >\n      </cx-media>\n      <h4>{{ item.name }}</h4>\n      <div class=\"price\">\n        {{ item.price?.formattedValue }}\n      </div>\n      <div class=\"price\" *ngIf=\"item.stock?.stockLevel > 0; else outOfStock\">\n        {{ item.stock?.stockLevelStatus }} : {{ item.stock?.stockLevel }}\n      </div>\n      <ng-template #outOfStock>\n        <div class=\"price\">\n          {{ item.stock?.stockLevelStatus }}\n        </div>\n      </ng-template>\n    </a>\n  </ng-template>\n</ng-container>\n", dependencies: [{ kind: "directive", type: i4.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "directive", type: i5.AttributesDirective, selector: "[cxAttributes]", inputs: ["cxAttributes", "cxAttributesNamePrefix"] }, { kind: "component", type: i1.CarouselComponent, selector: "cx-carousel", inputs: ["title", "items", "template", "itemWidth", "hideIndicators", "indicatorIcon", "previousIcon", "nextIcon"] }, { kind: "component", type: i1.MediaComponent, selector: "cx-media", inputs: ["container", "format", "alt", "role", "loading"], outputs: ["loaded"] }, { kind: "directive", type: i6.RouterLink, selector: "[routerLink]", inputs: ["target", "queryParams", "fragment", "queryParamsHandling", "state", "relativeTo", "preserveFragment", "skipLocationChange", "replaceUrl", "routerLink"] }, { kind: "pipe", type: i4.AsyncPipe, name: "async" }, { kind: "pipe", type: i3.UrlPipe, name: "cxUrl" }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: MerchandisingCarouselComponent, decorators: [{
            type: Component,
            args: [{ selector: 'cx-merchandising-carousel', changeDetection: ChangeDetectionStrategy.OnPush, template: "<ng-container\n  *ngIf=\"merchandisingCarouselModel$ | async as merchandisingCarouselModel\"\n>\n  <div\n    class=\"data-cx-merchandising-carousel\"\n    [cxAttributes]=\"merchandisingCarouselModel.metadata\"\n    [cxAttributesNamePrefix]=\"'data-cx-merchandising-carousel'\"\n  ></div>\n  <cx-carousel\n    [items]=\"merchandisingCarouselModel.items$\"\n    [title]=\"title$ | async\"\n    [template]=\"carouselItem\"\n    itemWidth=\"285px\"\n  >\n  </cx-carousel>\n\n  <ng-template #carouselItem let-item=\"item\">\n    <div\n      class=\"data-cx-merchandising-product\"\n      [cxAttributes]=\"item.metadata\"\n      [cxAttributesNamePrefix]=\"'data-cx-merchandising-product'\"\n    ></div>\n    <a\n      tabindex=\"0\"\n      [routerLink]=\"{ cxRoute: 'product', params: item } | cxUrl\"\n      (click)=\"\n        onMerchandisingCarouselItemClick(merchandisingCarouselModel, item)\n      \"\n    >\n      <cx-media\n        *ngIf=\"item.images?.PRIMARY\"\n        [container]=\"item.images.PRIMARY\"\n        format=\"product\"\n      >\n      </cx-media>\n      <h4>{{ item.name }}</h4>\n      <div class=\"price\">\n        {{ item.price?.formattedValue }}\n      </div>\n      <div class=\"price\" *ngIf=\"item.stock?.stockLevel > 0; else outOfStock\">\n        {{ item.stock?.stockLevelStatus }} : {{ item.stock?.stockLevel }}\n      </div>\n      <ng-template #outOfStock>\n        <div class=\"price\">\n          {{ item.stock?.stockLevelStatus }}\n        </div>\n      </ng-template>\n    </a>\n  </ng-template>\n</ng-container>\n" }]
        }], ctorParameters: function () { return [{ type: i1.CmsComponentData }, { type: i2.MerchandisingCarouselComponentService }, { type: i3.RoutingService }, { type: i1.IntersectionService }, { type: i0.ElementRef }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVyY2hhbmRpc2luZy1jYXJvdXNlbC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9pbnRlZ3JhdGlvbi1saWJzL2Nkcy9zcmMvbWVyY2hhbmRpc2luZy9jbXMtY29tcG9uZW50cy9tZXJjaGFuZGlzaW5nLWNhcm91c2VsL21lcmNoYW5kaXNpbmctY2Fyb3VzZWwuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vaW50ZWdyYXRpb24tbGlicy9jZHMvc3JjL21lcmNoYW5kaXNpbmcvY21zLWNvbXBvbmVudHMvbWVyY2hhbmRpc2luZy1jYXJvdXNlbC9tZXJjaGFuZGlzaW5nLWNhcm91c2VsLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsU0FBUyxFQUFjLE1BQU0sZUFBZSxDQUFDO0FBRy9FLE9BQU8sRUFBRSxLQUFLLEVBQWMsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ2hELE9BQU8sRUFDTCx1QkFBdUIsRUFDdkIsTUFBTSxFQUNOLEdBQUcsRUFDSCxXQUFXLEVBQ1gsU0FBUyxFQUNULElBQUksRUFDSixHQUFHLEdBQ0osTUFBTSxnQkFBZ0IsQ0FBQzs7Ozs7Ozs7QUFXeEIsTUFBTSxPQUFPLDhCQUE4QjtJQUd6QyxZQUNZLGFBQXNDLEVBQ3RDLHFDQUE0RSxFQUM1RSxjQUE4QixFQUM5QixtQkFBd0MsRUFDeEMsRUFBYztRQUpkLGtCQUFhLEdBQWIsYUFBYSxDQUF5QjtRQUN0QywwQ0FBcUMsR0FBckMscUNBQXFDLENBQXVDO1FBQzVFLG1CQUFjLEdBQWQsY0FBYyxDQUFnQjtRQUM5Qix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLE9BQUUsR0FBRixFQUFFLENBQVk7UUFLMUI7O1dBRUc7UUFDSCxXQUFNLEdBQW1DLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxD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QzlCLDBCQUFzRCxFQUN0RCxjQUFvQztRQUVwQyxJQUFJLENBQUMscUNBQXFDLENBQUMsNEJBQTRCLENBQ3JFLDBCQUEwQixFQUMxQixjQUFjLENBQ2YsQ0FBQztJQUNKLENBQUM7OzJIQWhHVSw4QkFBOEI7K0dBQTlCLDhCQUE4QixpRUM3QjNDLDhnREFrREE7MkZEckJhLDhCQUE4QjtrQkFMMUMsU0FBUzsrQkFDRSwyQkFBMkIsbUJBRXBCLHVCQUF1QixDQUFDLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMyBTQVAgU3BhcnRhY3VzIHRlYW0gPHNwYXJ0YWN1cy10ZWFtQHNhcC5jb20+XG4gKlxuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQgeyBDaGFuZ2VEZXRlY3Rpb25TdHJhdGVneSwgQ29tcG9uZW50LCBFbGVtZW50UmVmIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBSb3V0aW5nU2VydmljZSB9IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBDbXNDb21wb25lbnREYXRhLCBJbnRlcnNlY3Rpb25TZXJ2aWNlIH0gZnJvbSAnQHNwYXJ0YWN1cy9zdG9yZWZyb250JztcbmltcG9ydCB7IEVNUFRZLCBPYnNlcnZhYmxlLCB1c2luZyB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgZGlzdGluY3RVbnRpbEtleUNoYW5nZWQsXG4gIGZpbHRlcixcbiAgbWFwLFxuICBzaGFyZVJlcGxheSxcbiAgc3dpdGNoTWFwLFxuICB0YWtlLFxuICB0YXAsXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENtc01lcmNoYW5kaXNpbmdDYXJvdXNlbENvbXBvbmVudCBhcyBtb2RlbCB9IGZyb20gJy4uLy4uLy4uL2Nkcy1tb2RlbHMvY21zLm1vZGVsJztcbmltcG9ydCB7IE1lcmNoYW5kaXNpbmdQcm9kdWN0IH0gZnJvbSAnLi4vLi4vbW9kZWwvaW5kZXgnO1xuaW1wb3J0IHsgTWVyY2hhbmRpc2luZ0Nhcm91c2VsQ29tcG9uZW50U2VydmljZSB9IGZyb20gJy4vbWVyY2hhbmRpc2luZy1jYXJvdXNlbC5jb21wb25lbnQuc2VydmljZSc7XG5pbXBvcnQgeyBNZXJjaGFuZGlzaW5nQ2Fyb3VzZWxNb2RlbCB9IGZyb20gJy4vbW9kZWwvaW5kZXgnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjeC1tZXJjaGFuZGlzaW5nLWNhcm91c2VsJyxcbiAgdGVtcGxhdGVVcmw6ICcuL21lcmNoYW5kaXNpbmctY2Fyb3VzZWwuY29tcG9uZW50Lmh0bWwnLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbn0pXG5leHBvcnQgY2xhc3MgTWVyY2hhbmRpc2luZ0Nhcm91c2VsQ29tcG9uZW50IHtcbiAgcHJvdGVjdGVkIGxhc3RFdmVudE1vZGVsSWQ6IHN0cmluZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgY29tcG9uZW50RGF0YTogQ21zQ29tcG9uZW50RGF0YTxtb2RlbD4sXG4gICAgcHJvdGVjdGVkIG1lcmNoYW5kaXNpbmdDYXJvdXNlbENvbXBvbmVudFNlcnZpY2U6IE1lcmNoYW5kaXNpbmdDYXJvdXNlbENvbXBvbmVudFNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHJvdXRpbmdTZXJ2aWNlOiBSb3V0aW5nU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgaW50ZXJzZWN0aW9uU2VydmljZTogSW50ZXJzZWN0aW9uU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgZWw6IEVsZW1lbnRSZWZcbiAgKSB7XG4gICAgdGhpcy5sYXN0RXZlbnRNb2RlbElkID0gJyc7XG4gIH1cblxuICAvKipcbiAgICogcmV0dXJucyBhbiBPYnNlcnZhYmxlIHN0cmluZyBmb3IgdGhlIHRpdGxlLlxuICAgKi9cbiAgdGl0bGUkOiBPYnNlcnZhYmxlPHN0cmluZyB8IHVuZGVmaW5lZD4gPSB0aGlzLmNvbXBvbmVudERhdGEuZGF0YSQucGlwZShcbiAgICBmaWx0ZXIoKGRhdGEpID0+IEJvb2xlYW4oZGF0YSkpLFxuICAgIG1hcCgoZGF0YSkgPT4gZGF0YS50aXRsZSlcbiAgKTtcblxuICBwcml2YXRlIGZldGNoUHJvZHVjdHMkOiBPYnNlcnZhYmxlPE1lcmNoYW5kaXNpbmdDYXJvdXNlbE1vZGVsPiA9XG4gICAgdGhpcy5jb21wb25lbnREYXRhLmRhdGEkLnBpcGUoXG4gICAgICBmaWx0ZXIoKGRhdGEpID0+IEJvb2xlYW4oZGF0YSkpLFxuICAgICAgZGlzdGluY3RVbnRpbEtleUNoYW5nZWQoJ3N0cmF0ZWd5JyksXG4gICAgICBzd2l0Y2hNYXAoKGRhdGEpID0+XG4gICAgICAgIHRoaXMubWVyY2hhbmRpc2luZ0Nhcm91c2VsQ29tcG9uZW50U2VydmljZS5nZXRNZXJjaGFuZGlzaW5nQ2Fyb3VzZWxNb2RlbChcbiAgICAgICAgICBkYXRhXG4gICAgICAgIClcbiAgICAgICksXG4gICAgICB0YXAoKGRhdGEpID0+IHtcbiAgICAgICAgaWYgKHR5cGVvZiBkYXRhLmJhY2tncm91bmRDb2xvciA9PT0gJ3N0cmluZycpIHtcbiAgICAgICAgICB0aGlzLmVsLm5hdGl2ZUVsZW1lbnQuc3R5bGUuc2V0UHJvcGVydHkoXG4gICAgICAgICAgICAnLS1jeC1jb2xvci1iYWNrZ3JvdW5kJyxcbiAgICAgICAgICAgIGRhdGEuYmFja2dyb3VuZENvbG9yXG4gICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgICBpZiAodHlwZW9mIGRhdGEudGV4dENvbG9yID09PSAnc3RyaW5nJykge1xuICAgICAgICAgIHRoaXMuZWwubmF0aXZlRWxlbWVudC5zdHlsZS5zZXRQcm9wZXJ0eShcbiAgICAgICAgICAgICctLWN4LWNvbG9yLXRleHQnLFxuICAgICAgICAgICAgZGF0YS50ZXh0Q29sb3JcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9KSxcbiAgICAgIHNoYXJlUmVwbGF5KHsgYnVmZmVyU2l6ZTogMSwgcmVmQ291bnQ6IHRydWUgfSlcbiAgICApO1xuXG4gIHByaXZhdGUgaW50ZXJzZWN0aW9uJDogT2JzZXJ2YWJsZTx2b2lkPiA9IHRoaXMuZmV0Y2hQcm9kdWN0cyQucGlwZShcbiAgICB0YWtlKDEpLFxuICAgIHN3aXRjaE1hcCgoKSA9PlxuICAgICAgdGhpcy5yb3V0aW5nU2VydmljZS5nZXRQYWdlQ29udGV4dCgpLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoKSA9PiB0aGlzLmNvbXBvbmVudERhdGEuZGF0YSQpLFxuICAgICAgICBtYXAoKGRhdGEpID0+XG4gICAgICAgICAgdGhpcy5tZXJjaGFuZGlzaW5nQ2Fyb3VzZWxDb21wb25lbnRTZXJ2aWNlLmdldE1lcmNoYW5kaXNpbmdDYW91cnNlbFZpZXdwb3J0VGhyZXNob2xkKFxuICAgICAgICAgICAgZGF0YVxuICAgICAgICAgIClcbiAgICAgICAgKSxcbiAgICAgICAgc3dpdGNoTWFwKCh0aHJlc2hvbGQpID0+XG4gICAgICAgICAgdGhpcy5pbnRlcnNlY3Rpb25TZXJ2aWNlXG4gICAgICAgICAgICAuaXNJbnRlcnNlY3RlZCh0aGlzLmVsLm5hdGl2ZUVsZW1lbnQsIHtcbiAgICAgICAgICAgICAgdGhyZXNob2xkLFxuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICBmaWx0ZXIoKGNhcm91c2VsSXNWaXNpYmxlKSA9PiBjYXJvdXNlbElzVmlzaWJsZSksXG4gICAgICAgICAgICAgIHN3aXRjaE1hcCgoXykgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiB0aGlzLm1lcmNoYW5kaXNpbmdDYXJvdXNlbENvbXBvbmVudFNlcnZpY2VcbiAgICAgICAgICAgICAgICAgIC5zZW5kQ2Fyb3VzZWxWaWV3RXZlbnQoXG4gICAgICAgICAgICAgICAgICAgIHRoaXMubGFzdEV2ZW50TW9kZWxJZCxcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5mZXRjaFByb2R1Y3RzJFxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgIHRhcCgobW9kZWwpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICB0aGlzLmxhc3RFdmVudE1vZGVsSWQgPSBtb2RlbC5pZDtcbiAgICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICAgIHN3aXRjaE1hcCgoKSA9PiBFTVBUWSlcbiAgICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgIClcbiAgICApXG4gICk7XG5cbiAgbWVyY2hhbmRpc2luZ0Nhcm91c2VsTW9kZWwkID0gdXNpbmcoXG4gICAgKCkgPT4gdGhpcy5pbnRlcnNlY3Rpb24kLnN1YnNjcmliZSgpLFxuICAgICgpID0+IHRoaXMuZmV0Y2hQcm9kdWN0cyRcbiAgKTtcblxuICBvbk1lcmNoYW5kaXNpbmdDYXJvdXNlbEl0ZW1DbGljayhcbiAgICBtZXJjaGFuZGlzaW5nQ2Fyb3VzZWxNb2RlbDogTWVyY2hhbmRpc2luZ0Nhcm91c2VsTW9kZWwsXG4gICAgY2xpY2tlZFByb2R1Y3Q6IE1lcmNoYW5kaXNpbmdQcm9kdWN0XG4gICk6IHZvaWQge1xuICAgIHRoaXMubWVyY2hhbmRpc2luZ0Nhcm91c2VsQ29tcG9uZW50U2VydmljZS5zZW5kQ2Fyb3VzZWxJdGVtQ2xpY2tlZEV2ZW50KFxuICAgICAgbWVyY2hhbmRpc2luZ0Nhcm91c2VsTW9kZWwsXG4gICAgICBjbGlja2VkUHJvZHVjdFxuICAgICk7XG4gIH1cbn1cbiIsIjxuZy1jb250YWluZXJcbiAgKm5nSWY9XCJtZXJjaGFuZGlzaW5nQ2Fyb3VzZWxNb2RlbCQgfCBhc3luYyBhcyBtZXJjaGFuZGlzaW5nQ2Fyb3VzZWxNb2RlbFwiXG4+XG4gIDxkaXZcbiAgICBjbGFzcz1cImRhdGEtY3gtbWVyY2hhbmRpc2luZy1jYXJvdXNlbFwiXG4gICAgW2N4QXR0cmlidXRlc109XCJtZXJjaGFuZGlzaW5nQ2Fyb3VzZWxNb2RlbC5tZXRhZGF0YVwiXG4gICAgW2N4QXR0cmlidXRlc05hbWVQcmVmaXhdPVwiJ2RhdGEtY3gtbWVyY2hhbmRpc2luZy1jYXJvdXNlbCdcIlxuICA+PC9kaXY+XG4gIDxjeC1jYXJvdXNlbFxuICAgIFtpdGVtc109XCJtZXJjaGFuZGlzaW5nQ2Fyb3VzZWxNb2RlbC5pdGVtcyRcIlxuICAgIFt0aXRsZV09XCJ0aXRsZSQgfCBhc3luY1wiXG4gICAgW3RlbXBsYXRlXT1cImNhcm91c2VsSXRlbVwiXG4gICAgaXRlbVdpZHRoPVwiMjg1cHhcIlxuICA+XG4gIDwvY3gtY2Fyb3VzZWw+XG5cbiAgPG5nLXRlbXBsYXRlICNjYXJvdXNlbEl0ZW0gbGV0LWl0ZW09XCJpdGVtXCI+XG4gICAgPGRpdlxuICAgICAgY2xhc3M9XCJkYXRhLWN4LW1lcmNoYW5kaXNpbmctcHJvZHVjdFwiXG4gICAgICBbY3hBdHRyaWJ1dGVzXT1cIml0ZW0ubWV0YWRhdGFcIlxuICAgICAgW2N4QXR0cmlidXRlc05hbWVQcmVmaXhdPVwiJ2RhdGEtY3gtbWVyY2hhbmRpc2luZy1wcm9kdWN0J1wiXG4gICAgPjwvZGl2PlxuICAgIDxhXG4gICAgICB0YWJpbmRleD1cIjBcIlxuICAgICAgW3JvdXRlckxpbmtdPVwieyBjeFJvdXRlOiAncHJvZHVjdCcsIHBhcmFtczogaXRlbSB9IHwgY3hVcmxcIlxuICAgICAgKGNsaWNrKT1cIlxuICAgICAgICBvbk1lcmNoYW5kaXNpbmdDYXJvdXNlbEl0ZW1DbGljayhtZXJjaGFuZGlzaW5nQ2Fyb3VzZWxNb2RlbCwgaXRlbSlcbiAgICAgIFwiXG4gICAgPlxuICAgICAgPGN4LW1lZGlhXG4gICAgICAgICpuZ0lmPVwiaXRlbS5pbWFnZXM/LlBSSU1BUllcIlxuICAgICAgICBbY29udGFpbmVyXT1cIml0ZW0uaW1hZ2VzLlBSSU1BUllcIlxuICAgICAgICBmb3JtYXQ9XCJwcm9kdWN0XCJcbiAgICAgID5cbiAgICAgIDwvY3gtbWVkaWE+XG4gICAgICA8aDQ+e3sgaXRlbS5uYW1lIH19PC9oND5cbiAgICAgIDxkaXYgY2xhc3M9XCJwcmljZVwiPlxuICAgICAgICB7eyBpdGVtLnByaWNlPy5mb3JtYXR0ZWRWYWx1ZSB9fVxuICAgICAgPC9kaXY+XG4gICAgICA8ZGl2IGNsYXNzPVwicHJpY2VcIiAqbmdJZj1cIml0ZW0uc3RvY2s/LnN0b2NrTGV2ZWwgPiAwOyBlbHNlIG91dE9mU3RvY2tcIj5cbiAgICAgICAge3sgaXRlbS5zdG9jaz8uc3RvY2tMZXZlbFN0YXR1cyB9fSA6IHt7IGl0ZW0uc3RvY2s/LnN0b2NrTGV2ZWwgfX1cbiAgICAgIDwvZGl2PlxuICAgICAgPG5nLXRlbXBsYXRlICNvdXRPZlN0b2NrPlxuICAgICAgICA8ZGl2IGNsYXNzPVwicHJpY2VcIj5cbiAgICAgICAgICB7eyBpdGVtLnN0b2NrPy5zdG9ja0xldmVsU3RhdHVzIH19XG4gICAgICAgIDwvZGl2PlxuICAgICAgPC9uZy10ZW1wbGF0ZT5cbiAgICA8L2E+XG4gIDwvbmctdGVtcGxhdGU+XG48L25nLWNvbnRhaW5lcj5cbiJdfQ==