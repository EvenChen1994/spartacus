/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { isPlatformBrowser } from '@angular/common';
import { Inject, Injectable, PLATFORM_ID, inject, } from '@angular/core';
import { LoggerService } from '@spartacus/core';
import { BehaviorSubject, Subscription, fromEvent, merge, } from 'rxjs';
import { distinctUntilChanged, filter, map, shareReplay, take, tap, } from 'rxjs/operators';
import { InternalProfileTagEventNames, } from '../model/profile-tag.model';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/core";
import * as i2 from "../../config/index";
export class ProfileTagEventService {
    constructor(winRef, config, baseSiteService, platform) {
        this.winRef = winRef;
        this.config = config;
        this.baseSiteService = baseSiteService;
        this.platform = platform;
        this.subscription = new Subscription();
        this.profileTagDebug = false;
        this.profileTagEvents$ = merge(this.setConsentReference(), this.debugModeChanged());
        this.logger = inject(LoggerService);
        this.initWindow();
        this.setConsentReferenceFromLocalStorage();
    }
    setConsentReferenceFromLocalStorage() {
        if (this.winRef.isBrowser() && this.winRef.localStorage) {
            const profileTagMetadata = JSON.parse(this.winRef.localStorage.getItem('profiletag') || '{"cr":{}}');
            this.subscription.add(this.baseSiteService
                .getActive()
                .pipe(take(1))
                .subscribe((baseSite) => {
                this.latestConsentReference = new BehaviorSubject(profileTagMetadata.cr[`${baseSite}-consentReference`]?.consentReference);
            }));
        }
    }
    getProfileTagEvents() {
        return this.profileTagEvents$;
    }
    getConsentReference() {
        if (!this.consentReference$) {
            this.consentReference$ = fromEvent(this.winRef.nativeWindow, InternalProfileTagEventNames.CONSENT_REFERENCE_LOADED).pipe(map((event) => event), map((event) => event.detail.consentReference), shareReplay(1));
        }
        return this.consentReference$;
    }
    handleConsentWithdrawn() {
        this.consentReference$ = null;
        this.latestConsentReference.next(null);
    }
    addTracker() {
        return this.baseSiteService.getActive().pipe(filter(() => isPlatformBrowser(this.platform)), filter((siteId) => Boolean(siteId)), distinctUntilChanged(), tap(() => this.addScript()), tap((siteId) => this.createConfig(siteId)));
    }
    notifyProfileTagOfEventOccurrence(event) {
        try {
            this.profileTagWindow.Y_TRACKING.eventLayer.push(event);
        }
        catch (e) {
            this.logger.log(`Unexpected error when calling profiletag push method ${e}`);
        }
    }
    setConsentReference() {
        return this.getConsentReference().pipe(tap((consentReference) => this.latestConsentReference.next(consentReference)));
    }
    debugModeChanged() {
        return fromEvent(this.winRef.nativeWindow, InternalProfileTagEventNames.DEBUG_FLAG_CHANGED).pipe(map((event) => event), tap((event) => (this.profileTagDebug = event.detail.debug)));
    }
    createConfig(siteId) {
        const newConfig = {
            ...this.config.cds.profileTag,
            tenant: this.config.cds.tenant,
            siteId,
            spa: true,
        };
        this.exposeConfig(newConfig);
    }
    /*
     * Checks if the script with the given source exists in the document or not.
     */
    isScriptLoaded(scriptSource) {
        return !!this.winRef.document.querySelector(`script[src="${scriptSource}"]`);
    }
    addScript() {
        if (this.isScriptLoaded(this.config.cds.profileTag.javascriptUrl)) {
            return;
        }
        const profileTagScript = this.winRef.document.createElement('script');
        profileTagScript.type = 'text/javascript';
        profileTagScript.async = true;
        profileTagScript.src = this.config.cds.profileTag.javascriptUrl;
        this.winRef.document
            .getElementsByTagName('head')[0]
            .appendChild(profileTagScript);
    }
    initWindow() {
        if (!isPlatformBrowser(this.platform)) {
            return;
        }
        this.profileTagWindow = this.winRef.nativeWindow;
        this.profileTagWindow.Y_TRACKING = this.profileTagWindow.Y_TRACKING || {};
        this.profileTagWindow.Y_TRACKING.eventLayer =
            this.profileTagWindow.Y_TRACKING.eventLayer || [];
    }
    exposeConfig(options) {
        const q = this.profileTagWindow.Y_TRACKING.q || [];
        if (q.length !== 0) {
            return;
        }
        q.push([options]);
        this.profileTagWindow.Y_TRACKING.q = q;
    }
    ngOnDestroy() {
        if (this.subscription) {
            this.subscription.unsubscribe();
        }
    }
}
ProfileTagEventService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ProfileTagEventService, deps: [{ token: i1.WindowRef }, { token: i2.CdsConfig }, { token: i1.BaseSiteService }, { token: PLATFORM_ID }], target: i0.ɵɵFactoryTarget.Injectable });
ProfileTagEventService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ProfileTagEventService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ProfileTagEventService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.WindowRef }, { type: i2.CdsConfig }, { type: i1.BaseSiteService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvZmlsZXRhZy1ldmVudC5zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vaW50ZWdyYXRpb24tbGlicy9jZHMvc3JjL3Byb2ZpbGV0YWcvc2VydmljZXMvcHJvZmlsZXRhZy1ldmVudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUNwRCxPQUFPLEVBQ0wsTUFBTSxFQUNOLFVBQVUsRUFFVixXQUFXLEVBQ1gsTUFBTSxHQUNQLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBbUIsYUFBYSxFQUFhLE1BQU0saUJBQWlCLENBQUM7QUFDNUUsT0FBTyxFQUNMLGVBQWUsRUFFZixZQUFZLEVBQ1osU0FBUyxFQUNULEtBQUssR0FDTixNQUFNLE1BQU0sQ0FBQztBQUNkLE9BQU8sRUFDTCxvQkFBb0IsRUFDcEIsTUFBTSxFQUNOLEdBQUcsRUFDSCxXQUFXLEVBQ1gsSUFBSSxFQUNKLEdBQUcsR0FDSixNQUFNLGdCQUFnQixDQUFDO0FBRXhCLE9BQU8sRUFHTCw0QkFBNEIsR0FJN0IsTUFBTSw0QkFBNEIsQ0FBQzs7OztBQUtwQyxNQUFNLE9BQU8sc0JBQXNCO0lBYWpDLFlBQ1UsTUFBaUIsRUFDakIsTUFBaUIsRUFDakIsZUFBZ0MsRUFDWCxRQUFhO1FBSGxDLFdBQU0sR0FBTixNQUFNLENBQVc7UUFDakIsV0FBTSxHQUFOLE1BQU0sQ0FBVztRQUNqQixvQkFBZSxHQUFmLGVBQWUsQ0FBaUI7UUFDWCxhQUFRLEdBQVIsUUFBUSxDQUFLO1FBaEJsQyxpQkFBWSxHQUFpQixJQUFJLFlBQVksRUFBRSxDQUFDO1FBRTFELG9CQUFlLEdBQUcsS0FBSyxDQUFDO1FBR2hCLHNCQUFpQixHQUFHLEtBQUssQ0FDL0IsSUFBSSxDQUFDLG1CQUFtQixFQUFFLEVBQzFCLElBQUksQ0FBQyxnQkFBZ0Is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QztJQUVELFdBQVc7UUFDVCxJQUFJLElBQUksQ0FBQyxZQUFZLEVBQUU7WUFDckIsSUFBSSxDQUFDLFlBQVksQ0FBQyxXQUFXLEVBQUUsQ0FBQztTQUNqQztJQUNILENBQUM7O21IQWpLVSxzQkFBc0IsbUdBaUJ2QixXQUFXO3VIQWpCVixzQkFBc0IsY0FGckIsTUFBTTsyRkFFUCxzQkFBc0I7a0JBSGxDLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzswQkFrQkksTUFBTTsyQkFBQyxXQUFXIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgaXNQbGF0Zm9ybUJyb3dzZXIgfSBmcm9tICdAYW5ndWxhci9jb21tb24nO1xuaW1wb3J0IHtcbiAgSW5qZWN0LFxuICBJbmplY3RhYmxlLFxuICBPbkRlc3Ryb3ksXG4gIFBMQVRGT1JNX0lELFxuICBpbmplY3QsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQmFzZVNpdGVTZXJ2aWNlLCBMb2dnZXJTZXJ2aWNlLCBXaW5kb3dSZWYgfSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHtcbiAgQmVoYXZpb3JTdWJqZWN0LFxuICBPYnNlcnZhYmxlLFxuICBTdWJzY3JpcHRpb24sXG4gIGZyb21FdmVudCxcbiAgbWVyZ2UsXG59IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgZGlzdGluY3RVbnRpbENoYW5nZWQsXG4gIGZpbHRlcixcbiAgbWFwLFxuICBzaGFyZVJlcGxheSxcbiAgdGFrZSxcbiAgdGFwLFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDZHNDb25maWcgfSBmcm9tICcuLi8uLi9jb25maWcvaW5kZXgnO1xuaW1wb3J0IHtcbiAgQ29uc2VudFJlZmVyZW5jZUV2ZW50LFxuICBEZWJ1Z0V2ZW50LFxuICBJbnRlcm5hbFByb2ZpbGVUYWdFdmVudE5hbWVzLFxuICBQcm9maWxlVGFnSnNDb25maWcsXG4gIFByb2ZpbGVUYWdQdXNoRXZlbnQsXG4gIFByb2ZpbGVUYWdXaW5kb3dPYmplY3QsXG59IGZyb20gJy4uL21vZGVsL3Byb2ZpbGUtdGFnLm1vZGVsJztcblxuQEluamVjdGFibGUoe1xuICBwcm92aWRlZEluOiAncm9vdCcsXG59KVxuZXhwb3J0IGNsYXNzIFByb2ZpbGVUYWdFdmVudFNlcnZpY2UgaW1wbGVtZW50cyBPbkRlc3Ryb3kge1xuICBwcm90ZWN0ZWQgc3Vic2NyaXB0aW9uOiBTdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG4gIGxhdGVzdENvbnNlbnRSZWZlcmVuY2U6IEJlaGF2aW9yU3ViamVjdDxzdHJpbmcgfCBudWxsPjtcbiAgcHJvZmlsZVRhZ0RlYnVnID0gZmFsc2U7XG4gIHByaXZhdGUgY29uc2VudFJlZmVyZW5jZSQ6IE9ic2VydmFibGU8c3RyaW5nIHwgbnVsbD47XG4gIHByaXZhdGUgcHJvZmlsZVRhZ1dpbmRvdzogUHJvZmlsZVRhZ1dpbmRvd09iamVjdDtcbiAgcHJpdmF0ZSBwcm9maWxlVGFnRXZlbnRzJCA9IG1lcmdlKFxuICAgIHRoaXMuc2V0Q29uc2VudFJlZmVyZW5jZSgpLFxuICAgIHRoaXMuZGVidWdNb2RlQ2hhbmdlZCgpXG4gICk7XG5cbiAgcHJvdGVjdGVkIGxvZ2dlciA9IGluamVjdChMb2dnZXJTZXJ2aWNlKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHdpblJlZjogV2luZG93UmVmLFxuICAgIHByaXZhdGUgY29uZmlnOiBDZHNDb25maWcsXG4gICAgcHJpdmF0ZSBiYXNlU2l0ZVNlcnZpY2U6IEJhc2VTaXRlU2VydmljZSxcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtOiBhbnlcbiAgKSB7XG4gICAgdGhpcy5pbml0V2luZG93KCk7XG4gICAgdGhpcy5zZXRDb25zZW50UmVmZXJlbmNlRnJvbUxvY2FsU3RvcmFnZSgpO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXRDb25zZW50UmVmZXJlbmNlRnJvbUxvY2FsU3RvcmFnZSgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy53aW5SZWYuaXNCcm93c2VyKCkgJiYgdGhpcy53aW5SZWYubG9jYWxTdG9yYWdlKSB7XG4gICAgICBjb25zdCBwcm9maWxlVGFnTWV0YWRhdGEgPSBKU09OLnBhcnNlKFxuICAgICAgICB0aGlzLndpblJlZi5sb2NhbFN0b3JhZ2UuZ2V0SXRlbSgncHJvZmlsZXRhZycpIHx8ICd7XCJjclwiOnt9fSdcbiAgICAgICk7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICAgIHRoaXMuYmFzZVNpdGVTZXJ2aWNlXG4gICAgICAgICAgLmdldEFjdGl2ZSgpXG4gICAgICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgICAgICAuc3Vic2NyaWJlKChiYXNlU2l0ZSkgPT4ge1xuICAgICAgICAgICAgdGhpcy5sYXRlc3RDb25zZW50UmVmZXJlbmNlID0gbmV3IEJlaGF2aW9yU3ViamVjdChcbiAgICAgICAgICAgICAgcHJvZmlsZVRhZ01ldGFkYXRhLmNyW1xuICAgICAgICAgICAgICAgIGAke2Jhc2VTaXRlfS1jb25zZW50UmVmZXJlbmNlYFxuICAgICAgICAgICAgICBdPy5jb25zZW50UmVmZXJlbmNlXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH0pXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGdldFByb2ZpbGVUYWdFdmVudHMoKTogT2JzZXJ2YWJsZTxzdHJpbmcgfCBEZWJ1Z0V2ZW50IHwgRXZlbnQ+IHtcbiAgICByZXR1cm4gdGhpcy5wcm9maWxlVGFnRXZlbnRzJDtcbiAgfVxuXG4gIGdldENvbnNlbnRSZWZlcmVuY2UoKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICBpZiAoIXRoaXMuY29uc2VudFJlZmVyZW5jZSQpIHtcbiAgICAgIHRoaXMuY29uc2VudFJlZmVyZW5jZSQgPSBmcm9tRXZlbnQoXG4gICAgICAgIHRoaXMud2luUmVmLm5hdGl2ZVdpbmRvdyxcbiAgICAgICAgSW50ZXJuYWxQcm9maWxlVGFnRXZlbnROYW1lcy5DT05TRU5UX1JFRkVSRU5DRV9MT0FERURcbiAgICAgICkucGlwZShcbiAgICAgICAgbWFwKChldmVudCkgPT4gPENvbnNlbnRSZWZlcmVuY2VFdmVudD5ldmVudCksXG4gICAgICAgIG1hcCgoZXZlbnQpID0+IGV2ZW50LmRldGFpbC5jb25zZW50UmVmZXJlbmNlKSxcbiAgICAgICAgc2hhcmVSZXBsYXkoMSlcbiAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmNvbnNlbnRSZWZlcmVuY2UkO1xuICB9XG5cbiAgaGFuZGxlQ29uc2VudFdpdGhkcmF3bigpOiB2b2lkIHtcbiAgICB0aGlzLmNvbnNlbnRSZWZlcmVuY2UkID0gbnVsbDtcbiAgICB0aGlzLmxhdGVzdENvbnNlbnRSZWZlcmVuY2UubmV4dChudWxsKTtcbiAgfVxuXG4gIGFkZFRyYWNrZXIoKTogT2JzZXJ2YWJsZTxzdHJpbmc+IHtcbiAgICByZXR1cm4gdGhpcy5iYXNlU2l0ZVNlcnZpY2UuZ2V0QWN0aXZlKCkucGlwZShcbiAgICAgIGZpbHRlcigoKSA9PiBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtKSksXG4gICAgICBmaWx0ZXIoKHNpdGVJZDogc3RyaW5nKSA9PiBCb29sZWFuKHNpdGVJZCkpLFxuICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKSxcbiAgICAgIHRhcCgoKSA9PiB0aGlzLmFkZFNjcmlwdCgpKSxcbiAgICAgIHRhcCgoc2l0ZUlkOiBzdHJpbmcpID0+IHRoaXMuY3JlYXRlQ29uZmlnKHNpdGVJZCkpXG4gICAgKTtcbiAgfVxuXG4gIG5vdGlmeVByb2ZpbGVUYWdPZkV2ZW50T2NjdXJyZW5jZShldmVudDogUHJvZmlsZVRhZ1B1c2hFdmVudCk6IHZvaWQge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLnByb2ZpbGVUYWdXaW5kb3cuWV9UUkFDS0lORy5ldmVudExheWVyLnB1c2goZXZlbnQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmxvZyhcbiAgICAgICAgYFVuZXhwZWN0ZWQgZXJyb3Igd2hlbiBjYWxsaW5nIHByb2ZpbGV0YWcgcHVzaCBtZXRob2QgJHtlfWBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBzZXRDb25zZW50UmVmZXJlbmNlKCk6IE9ic2VydmFibGU8c3RyaW5nPiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0Q29uc2VudFJlZmVyZW5jZSgpLnBpcGUoXG4gICAgICB0YXAoKGNvbnNlbnRSZWZlcmVuY2UpID0+XG4gICAgICAgIHRoaXMubGF0ZXN0Q29uc2VudFJlZmVyZW5jZS5uZXh0KGNvbnNlbnRSZWZlcmVuY2UpXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIHByaXZhdGUgZGVidWdNb2RlQ2hhbmdlZCgpOiBPYnNlcnZhYmxlPERlYnVnRXZlbnQ+IHtcbiAgICByZXR1cm4gZnJvbUV2ZW50KFxuICAgICAgdGhpcy53aW5SZWYubmF0aXZlV2luZG93LFxuICAgICAgSW50ZXJuYWxQcm9maWxlVGFnRXZlbnROYW1lcy5ERUJVR19GTEFHX0NIQU5HRURcbiAgICApLnBpcGUoXG4gICAgICBtYXAoKGV2ZW50KSA9PiA8RGVidWdFdmVudD5ldmVudCksXG4gICAgICB0YXAoKGV2ZW50KSA9PiAodGhpcy5wcm9maWxlVGFnRGVidWcgPSBldmVudC5kZXRhaWwuZGVidWcpKVxuICAgICk7XG4gIH1cblxuICBwcml2YXRlIGNyZWF0ZUNvbmZpZyhzaXRlSWQ6IHN0cmluZyk6IHZvaWQge1xuICAgIGNvbnN0IG5ld0NvbmZpZzogUHJvZmlsZVRhZ0pzQ29uZmlnID0ge1xuICAgICAgLi4udGhpcy5jb25maWcuY2RzLnByb2ZpbGVUYWcsXG4gICAgICB0ZW5hbnQ6IHRoaXMuY29uZmlnLmNkcy50ZW5hbnQsXG4gICAgICBzaXRlSWQsXG4gICAgICBzcGE6IHRydWUsXG4gICAgfTtcbiAgICB0aGlzLmV4cG9zZUNvbmZpZyhuZXdDb25maWcpO1xuICB9XG5cbiAgLypcbiAgICogQ2hlY2tzIGlmIHRoZSBzY3JpcHQgd2l0aCB0aGUgZ2l2ZW4gc291cmNlIGV4aXN0cyBpbiB0aGUgZG9jdW1lbnQgb3Igbm90LlxuICAgKi9cbiAgcHJpdmF0ZSBpc1NjcmlwdExvYWRlZChzY3JpcHRTb3VyY2U6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAhIXRoaXMud2luUmVmLmRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IoXG4gICAgICBgc2NyaXB0W3NyYz1cIiR7c2NyaXB0U291cmNlfVwiXWBcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhZGRTY3JpcHQoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNTY3JpcHRMb2FkZWQodGhpcy5jb25maWcuY2RzLnByb2ZpbGVUYWcuamF2YXNjcmlwdFVybCkpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgY29uc3QgcHJvZmlsZVRhZ1NjcmlwdCA9IHRoaXMud2luUmVmLmRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ3NjcmlwdCcpO1xuICAgIHByb2ZpbGVUYWdTY3JpcHQudHlwZSA9ICd0ZXh0L2phdmFzY3JpcHQnO1xuICAgIHByb2ZpbGVUYWdTY3JpcHQuYXN5bmMgPSB0cnVlO1xuICAgIHByb2ZpbGVUYWdTY3JpcHQuc3JjID0gdGhpcy5jb25maWcuY2RzLnByb2ZpbGVUYWcuamF2YXNjcmlwdFVybDtcbiAgICB0aGlzLndpblJlZi5kb2N1bWVudFxuICAgICAgLmdldEVsZW1lbnRzQnlUYWdOYW1lKCdoZWFkJylbMF1cbiAgICAgIC5hcHBlbmRDaGlsZChwcm9maWxlVGFnU2NyaXB0KTtcbiAgfVxuXG4gIHByaXZhdGUgaW5pdFdpbmRvdygpOiB2b2lkIHtcbiAgICBpZiAoIWlzUGxhdGZvcm1Ccm93c2VyKHRoaXMucGxhdGZvcm0pKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIHRoaXMucHJvZmlsZVRhZ1dpbmRvdyA9IDxQcm9maWxlVGFnV2luZG93T2JqZWN0PihcbiAgICAgICg8dW5rbm93bj50aGlzLndpblJlZi5uYXRpdmVXaW5kb3cpXG4gICAgKTtcbiAgICB0aGlzLnByb2ZpbGVUYWdXaW5kb3cuWV9UUkFDS0lORyA9IHRoaXMucHJvZmlsZVRhZ1dpbmRvdy5ZX1RSQUNLSU5HIHx8IHt9O1xuICAgIHRoaXMucHJvZmlsZVRhZ1dpbmRvdy5ZX1RSQUNLSU5HLmV2ZW50TGF5ZXIgPVxuICAgICAgdGhpcy5wcm9maWxlVGFnV2luZG93LllfVFJBQ0tJTkcuZXZlbnRMYXllciB8fCBbXTtcbiAgfVxuXG4gIHByaXZhdGUgZXhwb3NlQ29uZmlnKG9wdGlvbnM6IFByb2ZpbGVUYWdKc0NvbmZpZyk6IHZvaWQge1xuICAgIGNvbnN0IHEgPSB0aGlzLnByb2ZpbGVUYWdXaW5kb3cuWV9UUkFDS0lORy5xIHx8IFtdO1xuICAgIGlmIChxLmxlbmd0aCAhPT0gMCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBxLnB1c2goW29wdGlvbnNdKTtcbiAgICB0aGlzLnByb2ZpbGVUYWdXaW5kb3cuWV9UUkFDS0lORy5xID0gcTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLnN1YnNjcmlwdGlvbikge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cbn1cbiJdfQ==