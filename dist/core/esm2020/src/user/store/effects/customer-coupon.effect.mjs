/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable, inject } from '@angular/core';
import { createEffect, ofType } from '@ngrx/effects';
import { of } from 'rxjs';
import { catchError, map, mergeMap } from 'rxjs/operators';
import { LoggerService } from '../../../logger';
import { normalizeHttpError } from '../../../util/normalize-http-error';
import * as fromCustomerCouponsAction from '../actions/customer-coupon.action';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
import * as i2 from "../../connectors/customer-coupon/customer-coupon.connector";
export class CustomerCouponEffects {
    constructor(actions$, customerCouponConnector) {
        this.actions$ = actions$;
        this.customerCouponConnector = customerCouponConnector;
        this.logger = inject(LoggerService);
        this.loadCustomerCoupons$ = createEffect(() => this.actions$.pipe(ofType(fromCustomerCouponsAction.LOAD_CUSTOMER_COUPONS), map((action) => action.payload), mergeMap((payload) => {
            return this.customerCouponConnector
                .getCustomerCoupons(payload.userId, payload.pageSize, payload.currentPage, payload.sort)
                .pipe(map((coupons) => {
                return new fromCustomerCouponsAction.LoadCustomerCouponsSuccess(coupons);
            }), catchError((error) => of(new fromCustomerCouponsAction.LoadCustomerCouponsFail(normalizeHttpError(error, this.logger)))));
        })));
        this.subscribeCustomerCoupon$ = createEffect(() => this.actions$.pipe(ofType(fromCustomerCouponsAction.SUBSCRIBE_CUSTOMER_COUPON), map((action) => action.payload), mergeMap((payload) => {
            return this.customerCouponConnector
                .turnOnNotification(payload.userId, payload.couponCode)
                .pipe(map((data) => {
                return new fromCustomerCouponsAction.SubscribeCustomerCouponSuccess(data);
            }), catchError((error) => of(new fromCustomerCouponsAction.SubscribeCustomerCouponFail(normalizeHttpError(error, this.logger)))));
        })));
        this.unsubscribeCustomerCoupon$ = createEffect(() => this.actions$.pipe(ofType(fromCustomerCouponsAction.UNSUBSCRIBE_CUSTOMER_COUPON), map((action) => action.payload), mergeMap((payload) => {
            return this.customerCouponConnector
                .turnOffNotification(payload.userId, payload.couponCode)
                .pipe(map(() => {
                return new fromCustomerCouponsAction.UnsubscribeCustomerCouponSuccess(payload.couponCode);
            }), catchError((error) => of(new fromCustomerCouponsAction.UnsubscribeCustomerCouponFail(normalizeHttpError(error, this.logger)))));
        })));
        this.claimCustomerCoupon$ = createEffect(() => this.actions$.pipe(ofType(fromCustomerCouponsAction.CLAIM_CUSTOMER_COUPON), map((action) => action.payload), mergeMap((payload) => {
            return this.customerCouponConnector
                .claimCustomerCoupon(payload.userId, payload.couponCode)
                .pipe(map((data) => {
                return new fromCustomerCouponsAction.ClaimCustomerCouponSuccess(data);
            }), catchError((error) => of(new fromCustomerCouponsAction.ClaimCustomerCouponFail(normalizeHttpError(error, this.logger)))));
        })));
        this.disclaimCustomerCoupon$ = createEffect(() => this.actions$.pipe(ofType(fromCustomerCouponsAction.DISCLAIM_CUSTOMER_COUPON), map((action) => action.payload), mergeMap((payload) => {
            return this.customerCouponConnector
                .disclaimCustomerCoupon(payload.userId, payload.couponCode)
                .pipe(map((data) => {
                return new fromCustomerCouponsAction.DisclaimCustomerCouponSuccess(data);
            }), catchError((error) => of(new fromCustomerCouponsAction.DisclaimCustomerCouponFail(normalizeHttpError(error, this.logger)))));
        })));
    }
}
CustomerCouponEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CustomerCouponEffects, deps: [{ token: i1.Actions }, { token: i2.CustomerCouponConnector }], target: i0.ɵɵFactoryTarget.Injectable });
CustomerCouponEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CustomerCouponEffects });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CustomerCouponEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }, { type: i2.CustomerCouponConnector }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VzdG9tZXItY291cG9uLmVmZmVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uL3Byb2plY3RzL2NvcmUvc3JjL3VzZXIvc3RvcmUvZWZmZWN0cy9jdXN0b21lci1jb3Vwb24uZWZmZWN0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUNuRCxPQUFPLEVBQVcsWUFBWSxFQUFFLE1BQU0sRUFBRSxNQUFNLGVBQWUsQ0FBQztBQUM5RCxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFFBQVEsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBQzNELE9BQU8sRUFBRSxhQUFhLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUVoRCxPQUFPLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxvQ0FBb0MsQ0FBQztBQUV4RSxPQUFPLEtBQUsseUJBQXlCLE1BQU0sbUNBQW1DLENBQUM7Ozs7QUFHL0UsTUFBTSxPQUFPLHFCQUFxQjtJQXlKaEMsWUFDVSxRQUFpQixFQUNqQix1QkFBZ0Q7UUFEaEQsYUFBUSxHQUFSLFFBQVEsQ0FBUztRQUNqQiw0QkFBdUIsR0FBdkIsdUJBQXVCLENBQXlCO1FBMUpoRCxXQUFNLEdBQUcsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRXpDLHlCQUFvQixHQUNsQixZQUFZLENBQUMsR0FBRyxFQUFFLENBQ2hCLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUNoQixNQUFNLENBQUMseUJBQXlCLENBQUMscUJBQXFCLENBQUMsRUFDdkQsR0FBRyxDQUNELENBQUMsTUFBcUQsRUFBRSxFQUFFLENBQ3hELE1BQU0sQ0FBQyxPQUFPLENBQ2pCLEVBQ0QsUUFBUSxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUU7WUFD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QWtCLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FDdkMsQ0FDRixDQUNGLENBQ0YsQ0FBQztRQUNOLENBQUMsQ0FBQyxDQUNILENBQ0YsQ0FBQztJQUtELENBQUM7O2tIQTVKTyxxQkFBcUI7c0hBQXJCLHFCQUFxQjsyRkFBckIscUJBQXFCO2tCQURqQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3Rpb25zLCBjcmVhdGVFZmZlY3QsIG9mVHlwZSB9IGZyb20gJ0BuZ3J4L2VmZmVjdHMnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGNhdGNoRXJyb3IsIG1hcCwgbWVyZ2VNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBMb2dnZXJTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vLi4vbG9nZ2VyJztcbmltcG9ydCB7IEN1c3RvbWVyQ291cG9uU2VhcmNoUmVzdWx0IH0gZnJvbSAnLi4vLi4vLi4vbW9kZWwvY3VzdG9tZXItY291cG9uLm1vZGVsJztcbmltcG9ydCB7IG5vcm1hbGl6ZUh0dHBFcnJvciB9IGZyb20gJy4uLy4uLy4uL3V0aWwvbm9ybWFsaXplLWh0dHAtZXJyb3InO1xuaW1wb3J0IHsgQ3VzdG9tZXJDb3Vwb25Db25uZWN0b3IgfSBmcm9tICcuLi8uLi9jb25uZWN0b3JzL2N1c3RvbWVyLWNvdXBvbi9jdXN0b21lci1jb3Vwb24uY29ubmVjdG9yJztcbmltcG9ydCAqIGFzIGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24gZnJvbSAnLi4vYWN0aW9ucy9jdXN0b21lci1jb3Vwb24uYWN0aW9uJztcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIEN1c3RvbWVyQ291cG9uRWZmZWN0cyB7XG4gIHByb3RlY3RlZCBsb2dnZXIgPSBpbmplY3QoTG9nZ2VyU2VydmljZSk7XG5cbiAgbG9hZEN1c3RvbWVyQ291cG9ucyQ6IE9ic2VydmFibGU8ZnJvbUN1c3RvbWVyQ291cG9uc0FjdGlvbi5DdXN0b21lckNvdXBvbkFjdGlvbj4gPVxuICAgIGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgICBvZlR5cGUoZnJvbUN1c3RvbWVyQ291cG9uc0FjdGlvbi5MT0FEX0NVU1RPTUVSX0NPVVBPTlMpLFxuICAgICAgICBtYXAoXG4gICAgICAgICAgKGFjdGlvbjogZnJvbUN1c3RvbWVyQ291cG9uc0FjdGlvbi5Mb2FkQ3VzdG9tZXJDb3Vwb25zKSA9PlxuICAgICAgICAgICAgYWN0aW9uLnBheWxvYWRcbiAgICAgICAgKSxcbiAgICAgICAgbWVyZ2VNYXAoKHBheWxvYWQpID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5jdXN0b21lckNvdXBvbkNvbm5lY3RvclxuICAgICAgICAgICAgLmdldEN1c3RvbWVyQ291cG9ucyhcbiAgICAgICAgICAgICAgcGF5bG9hZC51c2VySWQsXG4gICAgICAgICAgICAgIHBheWxvYWQucGFnZVNpemUsXG4gICAgICAgICAgICAgIHBheWxvYWQuY3VycmVudFBhZ2UsXG4gICAgICAgICAgICAgIHBheWxvYWQuc29ydFxuICAgICAgICAgICAgKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgIG1hcCgoY291cG9uczogQ3VzdG9tZXJDb3Vwb25TZWFyY2hSZXN1bHQpID0+IHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24uTG9hZEN1c3RvbWVyQ291cG9uc1N1Y2Nlc3MoXG4gICAgICAgICAgICAgICAgICBjb3Vwb25zXG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PlxuICAgICAgICAgICAgICAgIG9mKFxuICAgICAgICAgICAgICAgICAgbmV3IGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24uTG9hZEN1c3RvbWVyQ291cG9uc0ZhaWwoXG4gICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICB9KVxuICAgICAgKVxuICAgICk7XG5cbiAgc3Vic2NyaWJlQ3VzdG9tZXJDb3Vwb24kOiBPYnNlcnZhYmxlPGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24uQ3VzdG9tZXJDb3Vwb25BY3Rpb24+ID1cbiAgICBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgICAgb2ZUeXBlKGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24uU1VCU0NSSUJFX0NVU1RPTUVSX0NPVVBPTiksXG4gICAgICAgIG1hcChcbiAgICAgICAgICAoYWN0aW9uOiBmcm9tQ3VzdG9tZXJDb3Vwb25zQWN0aW9uLlN1YnNjcmliZUN1c3RvbWVyQ291cG9uKSA9PlxuICAgICAgICAgICAgYWN0aW9uLnBheWxvYWRcbiAgICAgICAgKSxcbiAgICAgICAgbWVyZ2VNYXAoKHBheWxvYWQpID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5jdXN0b21lckNvdXBvbkNvbm5lY3RvclxuICAgICAgICAgICAgLnR1cm5Pbk5vdGlmaWNhdGlvbihwYXlsb2FkLnVzZXJJZCwgcGF5bG9hZC5jb3Vwb25Db2RlKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgIG1hcCgoZGF0YTogYW55KSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBmcm9tQ3VzdG9tZXJDb3Vwb25zQWN0aW9uLlN1YnNjcmliZUN1c3RvbWVyQ291cG9uU3VjY2VzcyhcbiAgICAgICAgICAgICAgICAgIGRhdGFcbiAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICB9KSxcbiAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+XG4gICAgICAgICAgICAgICAgb2YoXG4gICAgICAgICAgICAgICAgICBuZXcgZnJvbUN1c3RvbWVyQ291cG9uc0FjdGlvbi5TdWJzY3JpYmVDdXN0b21lckNvdXBvbkZhaWwoXG4gICAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpXG4gICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApO1xuICAgICAgICB9KVxuICAgICAgKVxuICAgICk7XG5cbiAgdW5zdWJzY3JpYmVDdXN0b21lckNvdXBvbiQ6IE9ic2VydmFibGU8ZnJvbUN1c3RvbWVyQ291cG9uc0FjdGlvbi5DdXN0b21lckNvdXBvbkFjdGlvbj4gPVxuICAgIGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgICBvZlR5cGUoZnJvbUN1c3RvbWVyQ291cG9uc0FjdGlvbi5VTlNVQlNDUklCRV9DVVNUT01FUl9DT1VQT04pLFxuICAgICAgICBtYXAoXG4gICAgICAgICAgKGFjdGlvbjogZnJvbUN1c3RvbWVyQ291cG9uc0FjdGlvbi5VbnN1YnNjcmliZUN1c3RvbWVyQ291cG9uKSA9PlxuICAgICAgICAgICAgYWN0aW9uLnBheWxvYWRcbiAgICAgICAgKSxcbiAgICAgICAgbWVyZ2VNYXAoKHBheWxvYWQpID0+IHtcbiAgICAgICAgICByZXR1cm4gdGhpcy5jdXN0b21lckNvdXBvbkNvbm5lY3RvclxuICAgICAgICAgICAgLnR1cm5PZmZOb3RpZmljYXRpb24ocGF5bG9hZC51c2VySWQsIHBheWxvYWQuY291cG9uQ29kZSlcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICBtYXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgZnJvbUN1c3RvbWVyQ291cG9uc0FjdGlvbi5VbnN1YnNjcmliZUN1c3RvbWVyQ291cG9uU3VjY2VzcyhcbiAgICAgICAgICAgICAgICAgIHBheWxvYWQuY291cG9uQ29kZVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT5cbiAgICAgICAgICAgICAgICBvZihcbiAgICAgICAgICAgICAgICAgIG5ldyBmcm9tQ3VzdG9tZXJDb3Vwb25zQWN0aW9uLlVuc3Vic2NyaWJlQ3VzdG9tZXJDb3Vwb25GYWlsKFxuICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKVxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICApO1xuXG4gIGNsYWltQ3VzdG9tZXJDb3Vwb24kOiBPYnNlcnZhYmxlPGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24uQ3VzdG9tZXJDb3Vwb25BY3Rpb24+ID1cbiAgICBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgICAgb2ZUeXBlKGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24uQ0xBSU1fQ1VTVE9NRVJfQ09VUE9OKSxcbiAgICAgICAgbWFwKFxuICAgICAgICAgIChhY3Rpb246IGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24uQ2xhaW1DdXN0b21lckNvdXBvbikgPT5cbiAgICAgICAgICAgIGFjdGlvbi5wYXlsb2FkXG4gICAgICAgICksXG4gICAgICAgIG1lcmdlTWFwKChwYXlsb2FkKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuY3VzdG9tZXJDb3Vwb25Db25uZWN0b3JcbiAgICAgICAgICAgIC5jbGFpbUN1c3RvbWVyQ291cG9uKHBheWxvYWQudXNlcklkLCBwYXlsb2FkLmNvdXBvbkNvZGUpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgbWFwKChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBmcm9tQ3VzdG9tZXJDb3Vwb25zQWN0aW9uLkNsYWltQ3VzdG9tZXJDb3Vwb25TdWNjZXNzKFxuICAgICAgICAgICAgICAgICAgZGF0YVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT5cbiAgICAgICAgICAgICAgICBvZihcbiAgICAgICAgICAgICAgICAgIG5ldyBmcm9tQ3VzdG9tZXJDb3Vwb25zQWN0aW9uLkNsYWltQ3VzdG9tZXJDb3Vwb25GYWlsKFxuICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKVxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICApO1xuXG4gIGRpc2NsYWltQ3VzdG9tZXJDb3Vwb24kOiBPYnNlcnZhYmxlPGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24uQ3VzdG9tZXJDb3Vwb25BY3Rpb24+ID1cbiAgICBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgICAgb2ZUeXBlKGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24uRElTQ0xBSU1fQ1VTVE9NRVJfQ09VUE9OKSxcbiAgICAgICAgbWFwKFxuICAgICAgICAgIChhY3Rpb246IGZyb21DdXN0b21lckNvdXBvbnNBY3Rpb24uRGlzY2xhaW1DdXN0b21lckNvdXBvbikgPT5cbiAgICAgICAgICAgIGFjdGlvbi5wYXlsb2FkXG4gICAgICAgICksXG4gICAgICAgIG1lcmdlTWFwKChwYXlsb2FkKSA9PiB7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuY3VzdG9tZXJDb3Vwb25Db25uZWN0b3JcbiAgICAgICAgICAgIC5kaXNjbGFpbUN1c3RvbWVyQ291cG9uKHBheWxvYWQudXNlcklkLCBwYXlsb2FkLmNvdXBvbkNvZGUpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgbWFwKChkYXRhKSA9PiB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIG5ldyBmcm9tQ3VzdG9tZXJDb3Vwb25zQWN0aW9uLkRpc2NsYWltQ3VzdG9tZXJDb3Vwb25TdWNjZXNzKFxuICAgICAgICAgICAgICAgICAgZGF0YVxuICAgICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT5cbiAgICAgICAgICAgICAgICBvZihcbiAgICAgICAgICAgICAgICAgIG5ldyBmcm9tQ3VzdG9tZXJDb3Vwb25zQWN0aW9uLkRpc2NsYWltQ3VzdG9tZXJDb3Vwb25GYWlsKFxuICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKVxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfSlcbiAgICAgIClcbiAgICApO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByaXZhdGUgYWN0aW9ucyQ6IEFjdGlvbnMsXG4gICAgcHJpdmF0ZSBjdXN0b21lckNvdXBvbkNvbm5lY3RvcjogQ3VzdG9tZXJDb3Vwb25Db25uZWN0b3JcbiAgKSB7fVxufVxuIl19