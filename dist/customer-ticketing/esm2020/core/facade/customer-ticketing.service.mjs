/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { CommandStrategy, } from '@spartacus/core';
import { GetTicketAssociatedObjectsQueryReloadEvent, GetTicketAssociatedObjectsQueryResetEvent, GetTicketCategoryQueryReloadEvent, GetTicketCategoryQueryResetEvent, GetTicketQueryReloadEvent, GetTicketQueryResetEvent, GetTicketsQueryReloadEvents, GetTicketsQueryResetEvents, NewMessageEvent, TicketClosedEvent, TicketCreatedEvent, TicketReopenedEvent, UploadAttachmentSuccessEvent, } from '@spartacus/customer-ticketing/root';
import { combineLatest, of, throwError } from 'rxjs';
import { concatMap, distinctUntilChanged, map, switchMap, take, tap, } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/core";
import * as i2 from "../connectors/customer-ticketing.connector";
export class CustomerTicketingService {
    getTicketCategoriesQueryReloadEvents() {
        return [GetTicketCategoryQueryReloadEvent];
    }
    getTicketCategoriesQueryResetEvents() {
        return [GetTicketCategoryQueryResetEvent];
    }
    getTicketAssociatedObjectsQueryReloadEvents() {
        return [GetTicketAssociatedObjectsQueryReloadEvent];
    }
    getTicketAssociatedObjectsQueryResetEvents() {
        return [GetTicketAssociatedObjectsQueryResetEvent];
    }
    getTicketQueryReloadEvents() {
        return [GetTicketQueryReloadEvent];
    }
    getTicketQueryResetEvents() {
        return [GetTicketQueryResetEvent];
    }
    getTicketsQueryReloadEvents() {
        return [GetTicketsQueryReloadEvents];
    }
    getTicketsQueryResetEvents() {
        return [GetTicketsQueryResetEvents];
    }
    getTicketsQuery$(pageSize, currentPage, sort) {
        return this.queryService.create(() => this.customerTicketingListPreConditions().pipe(switchMap((customerId) => this.customerTicketingConnector.getTickets(customerId, pageSize, currentPage, sort))), {
            reloadOn: this.getTicketsQueryReloadEvents(),
            resetOn: this.getTicketsQueryResetEvents(),
        });
    }
    customerTicketingPreConditions() {
        return combineLatest([
            this.userIdService.getUserId(),
            this.routingService.getParams().pipe(map((params) => params.ticketCode), distinctUntilChanged()),
        ]).pipe(take(1), map(([userId, ticketId]) => {
            if (!userId) {
                throw new Error('Customer ticketing pre conditions not met');
            }
            return [userId, ticketId];
        }));
    }
    customerTicketingListPreConditions() {
        return this.userIdService.getUserId().pipe(take(1), map((userId) => {
            if (!userId) {
                throw new Error('Customer ticketing list pre conditions not met');
            }
            return userId;
        }));
    }
    constructor(queryService, commandService, userIdService, customerTicketingConnector, routingService, eventService) {
        this.queryService = queryService;
        this.commandService = commandService;
        this.userIdService = userIdService;
        this.customerTicketingConnector = customerTicketingConnector;
        this.routingService = routingService;
        this.eventService = eventService;
        this.createTicketCommand = this.commandService.create((ticketStarted) => this.customerTicketingPreConditions().pipe(switchMap(([customerId]) => this.customerTicketingConnector.createTicket(customerId, ticketStarted)), tap(() => {
            this.eventService.dispatch({}, TicketCreatedEvent);
        })), {
            strategy: CommandStrategy.Queue,
        });
        this.createTicketEventCommand = this.commandService.create((payload) => this.customerTicketingPreConditions().pipe(switchMap(([customerId, ticketId]) => this.customerTicketingConnector
            .createTicketEvent(customerId, ticketId, payload.ticketEvent)
            .pipe(tap(() => {
            if (payload.ticketEvent.toStatus?.id === "CLOSED" /* STATUS.CLOSED */) {
                this.eventService.dispatch({}, TicketClosedEvent);
            }
            else if (!payload.containsAttachment) {
                if (payload.ticketEvent.toStatus?.id === "OPEN" /* STATUS.OPEN */ ||
                    payload.ticketEvent.toStatus?.id === "INPROCESS" /* STATUS.INPROCESS */) {
                    this.eventService.dispatch({}, TicketReopenedEvent);
                }
                else {
                    this.eventService.dispatch({}, NewMessageEvent);
                }
            }
        })))), {
            strategy: CommandStrategy.Queue,
        });
        this.uploadAttachmentCommand = this.commandService.create((payload) => this.customerTicketingPreConditions().pipe(switchMap(([customerId, ticketId]) => this.customerTicketingConnector
            .uploadAttachment(customerId, payload.ticketId ?? ticketId, payload.eventCode, payload.file)
            .pipe(tap(() => this.eventService.dispatch({}, UploadAttachmentSuccessEvent))))), {
            strategy: CommandStrategy.Queue,
        });
        this.downloadAttachmentCommand = this.commandService.create((payload) => this.customerTicketingPreConditions().pipe(switchMap(([customerId, ticketId]) => this.customerTicketingConnector.downloadAttachment(customerId, ticketId, payload.eventCode, payload.attachmentId))), {
            strategy: CommandStrategy.Queue,
        });
        this.getTicketQuery$ = this.queryService.create(() => this.customerTicketingPreConditions().pipe(switchMap(([customerId, ticketId]) => this.customerTicketingConnector.getTicket(customerId, ticketId))), {
            reloadOn: this.getTicketQueryReloadEvents(),
            resetOn: this.getTicketQueryResetEvents(),
        });
        this.getTicketCategoriesQuery = this.queryService.create(() => this.customerTicketingConnector.getTicketCategories(), {
            reloadOn: this.getTicketCategoriesQueryReloadEvents(),
            resetOn: this.getTicketCategoriesQueryResetEvents(),
        });
        this.getTicketAssociatedObjectsQuery = this.queryService.create(() => this.customerTicketingPreConditions().pipe(switchMap(([customerId]) => this.customerTicketingConnector.getTicketAssociatedObjects(customerId))), {
            reloadOn: this.getTicketAssociatedObjectsQueryReloadEvents(),
            resetOn: this.getTicketAssociatedObjectsQueryResetEvents(),
        });
    }
    getTicketAssociatedObjectsState() {
        return this.getTicketAssociatedObjectsQuery.getState();
    }
    getTicketAssociatedObjects() {
        return this.getTicketAssociatedObjectsState().pipe(concatMap((state) => state?.error ? throwError(state.error) : of(state)), map((state) => state.data ?? []));
    }
    getTicketCategoriesState() {
        return this.getTicketCategoriesQuery.getState();
    }
    getTicketCategories() {
        return this.getTicketCategoriesState().pipe(map((state) => state.data ?? []));
    }
    getTicketState() {
        return this.getTicketQuery$.getState();
    }
    getTicket() {
        return this.getTicketState().pipe(map((state) => state.data));
    }
    createTicket(ticketStarted) {
        return this.createTicketCommand.execute(ticketStarted);
    }
    getTicketsState(pageSize, currentPage, sort) {
        return this.getTicketsQuery$(pageSize, currentPage, sort).getState();
    }
    getTickets(pageSize, currentPage, sort) {
        return this.getTicketsState(pageSize, currentPage, sort).pipe(map((state) => state.data));
    }
    createTicketEvent(ticketEvent, containsAttachment = false) {
        return this.createTicketEventCommand.execute({
            ticketEvent,
            containsAttachment,
        });
    }
    uploadAttachment(file, eventCode, ticketId) {
        return this.uploadAttachmentCommand.execute({ file, eventCode, ticketId });
    }
    downloadAttachment(eventCode, attachmentId) {
        return this.downloadAttachmentCommand.execute({ eventCode, attachmentId });
    }
}
CustomerTicketingService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CustomerTicketingService, deps: [{ token: i1.QueryService }, { token: i1.CommandService }, { token: i1.UserIdService }, { token: i2.CustomerTicketingConnector }, { token: i1.RoutingService }, { token: i1.EventService }], target: i0.ɵɵFactoryTarget.Injectable });
CustomerTicketingService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CustomerTicketingService });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CustomerTicketingService, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.QueryService }, { type: i1.CommandService }, { type: i1.UserIdService }, { type: i2.CustomerTicketingConnector }, { type: i1.RoutingService }, { type: i1.EventService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3VzdG9tZXItdGlja2V0aW5nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvY3VzdG9tZXItdGlja2V0aW5nL2NvcmUvZmFjYWRlL2N1c3RvbWVyLXRpY2tldGluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQzNDLE9BQU8sRUFHTCxlQUFlLEdBU2hCLE1BQU0saUJBQWlCLENBQUM7QUFDekIsT0FBTyxFQUlMLDBDQUEwQyxFQUMxQyx5Q0FBeUMsRUFDekMsaUNBQWlDLEVBQ2pDLGdDQUFnQyxFQUNoQyx5QkFBeUIsRUFDekIsd0JBQXdCLEVBQ3hCLDJCQUEyQixFQUMzQiwwQkFBMEIsRUFDMUIsZUFBZSxFQUVmLGlCQUFpQixFQUNqQixrQkFBa0IsRUFJbEIsbUJBQW1CLEVBRW5CLDRCQUE0QixHQUM3QixNQUFNLG9DQUFvQyxDQUFDO0FBQzVDLE9BQU8sRUFBRSxhQUFhLEVBQWMsRUFBRSxFQUFFLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNqRSxPQUFPLEVBQ0wsU0FBUyxFQUNULG9CQUFvQixFQUNwQixHQUFHLEVBQ0gsU0FBUyxFQUNULElBQUksRUFDSixHQUFHLEdBQ0osTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUl4QixNQUFNLE9BQU8sd0JBQXdCO0lBQ3pCLG9DQUFvQztRQUM1QyxPQUFPLENBQUMsaUNBQWlDLENBQUMsQ0FBQztJQUM3QyxDQUFDO0lBQ1MsbUNBQW1DO1FBQzNDLE9BQU8sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0lBQzVDLENBQUM7SUFDUywyQ0FBMkM7UUFDbkQsT0FBTyxDQUFDLDBDQUEwQyxDQUFDLENBQUM7SUFDdEQsQ0FBQztJQUNTLDBDQUEwQztRQUNsRCxPQUFPLENBQUMseUNBQXlDLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lB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LENBQUMsQ0FBQyxJQUFJLENBQzNELEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUMzQixDQUFDO0lBQ0osQ0FBQztJQUVELGlCQUFpQixDQUNmLFdBQXdCLEVBQ3hCLGtCQUFrQixHQUFHLEtBQUs7UUFFMUIsT0FBTyxJQUFJLENBQUMsd0JBQXdCLENBQUMsT0FBTyxDQUFDO1lBQzNDLFdBQVc7WUFDWCxrQkFBa0I7U0FDbkIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELGdCQUFnQixDQUNkLElBQVUsRUFDVixTQUFpQixFQUNqQixRQUFpQjtRQUVqQixPQUFPLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxPQUFPLENBQUMsRUFBRSxJQUFJLEVBQUUsU0FBUyxFQUFFLFFBQVEsRUFBRSxDQUFDLENBQUM7SUFDN0UsQ0FBQztJQUVELGtCQUFrQixDQUNoQixTQUFpQixFQUNqQixZQUFvQjtRQUVwQixPQUFPLElBQUksQ0FBQyx5QkFBeUIsQ0FBQyxPQUFPLENBQUMsRUFBRSxTQUFTLEVBQUUsWUFBWSxFQUFFLENBQUMsQ0FBQztJQUM3RSxDQUFDOztxSEE1VFUsd0JBQXdCO3lIQUF4Qix3QkFBd0I7MkZBQXhCLHdCQUF3QjtrQkFEcEMsVUFBVSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBTUERYLUZpbGVDb3B5cmlnaHRUZXh0OiAyMDIzIFNBUCBTcGFydGFjdXMgdGVhbSA8c3BhcnRhY3VzLXRlYW1Ac2FwLmNvbT5cbiAqXG4gKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMFxuICovXG5cbmltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIENvbW1hbmQsXG4gIENvbW1hbmRTZXJ2aWNlLFxuICBDb21tYW5kU3RyYXRlZ3ksXG4gIEV2ZW50U2VydmljZSxcbiAgSHR0cEVycm9yTW9kZWwsXG4gIFF1ZXJ5LFxuICBRdWVyeU5vdGlmaWVyLFxuICBRdWVyeVNlcnZpY2UsXG4gIFF1ZXJ5U3RhdGUsXG4gIFJvdXRpbmdTZXJ2aWNlLFxuICBVc2VySWRTZXJ2aWNlLFxufSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHtcbiAgQXNzb2NpYXRlZE9iamVjdCxcbiAgQ2F0ZWdvcnksXG4gIEN1c3RvbWVyVGlja2V0aW5nRmFjYWRlLFxuICBHZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0c1F1ZXJ5UmVsb2FkRXZlbnQsXG4gIEdldFRpY2tldEFzc29jaWF0ZWRPYmplY3RzUXVlcnlSZXNldEV2ZW50LFxuICBHZXRUaWNrZXRDYXRlZ29yeVF1ZXJ5UmVsb2FkRXZlbnQsXG4gIEdldFRpY2tldENhdGVnb3J5UXVlcnlSZXNldEV2ZW50LFxuICBHZXRUaWNrZXRRdWVyeVJlbG9hZEV2ZW50LFxuICBHZXRUaWNrZXRRdWVyeVJlc2V0RXZlbnQsXG4gIEdldFRpY2tldHNRdWVyeVJlbG9hZEV2ZW50cyxcbiAgR2V0VGlja2V0c1F1ZXJ5UmVzZXRFdmVudHMsXG4gIE5ld01lc3NhZ2VFdmVudCxcbiAgU1RBVFVTLFxuICBUaWNrZXRDbG9zZWRFdmVudCxcbiAgVGlja2V0Q3JlYXRlZEV2ZW50LFxuICBUaWNrZXREZXRhaWxzLFxuICBUaWNrZXRFdmVudCxcbiAgVGlja2V0TGlzdCxcbiAgVGlja2V0UmVvcGVuZWRFdmVudCxcbiAgVGlja2V0U3RhcnRlcixcbiAgVXBsb2FkQXR0YWNobWVudFN1Y2Nlc3NFdmVudCxcbn0gZnJvbSAnQHNwYXJ0YWN1cy9jdXN0b21lci10aWNrZXRpbmcvcm9vdCc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBPYnNlcnZhYmxlLCBvZiwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgY29uY2F0TWFwLFxuICBkaXN0aW5jdFVudGlsQ2hhbmdlZCxcbiAgbWFwLFxuICBzd2l0Y2hNYXAsXG4gIHRha2UsXG4gIHRhcCxcbn0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuaW1wb3J0IHsgQ3VzdG9tZXJUaWNrZXRpbmdDb25uZWN0b3IgfSBmcm9tICcuLi9jb25uZWN0b3JzL2N1c3RvbWVyLXRpY2tldGluZy5jb25uZWN0b3InO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ3VzdG9tZXJUaWNrZXRpbmdTZXJ2aWNlIGltcGxlbWVudHMgQ3VzdG9tZXJUaWNrZXRpbmdGYWNhZGUge1xuICBwcm90ZWN0ZWQgZ2V0VGlja2V0Q2F0ZWdvcmllc1F1ZXJ5UmVsb2FkRXZlbnRzKCk6IFF1ZXJ5Tm90aWZpZXJbXSB7XG4gICAgcmV0dXJuIFtHZXRUaWNrZXRDYXRlZ29yeVF1ZXJ5UmVsb2FkRXZlbnRdO1xuICB9XG4gIHByb3RlY3RlZCBnZXRUaWNrZXRDYXRlZ29yaWVzUXVlcnlSZXNldEV2ZW50cygpOiBRdWVyeU5vdGlmaWVyW10ge1xuICAgIHJldHVybiBbR2V0VGlja2V0Q2F0ZWdvcnlRdWVyeVJlc2V0RXZlbnRdO1xuICB9XG4gIHByb3RlY3RlZCBnZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0c1F1ZXJ5UmVsb2FkRXZlbnRzKCk6IFF1ZXJ5Tm90aWZpZXJbXSB7XG4gICAgcmV0dXJuIFtHZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0c1F1ZXJ5UmVsb2FkRXZlbnRdO1xuICB9XG4gIHByb3RlY3RlZCBnZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0c1F1ZXJ5UmVzZXRFdmVudHMoKTogUXVlcnlOb3RpZmllcltdIHtcbiAgICByZXR1cm4gW0dldFRpY2tldEFzc29jaWF0ZWRPYmplY3RzUXVlcnlSZXNldEV2ZW50XTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRUaWNrZXRRdWVyeVJlbG9hZEV2ZW50cygpOiBRdWVyeU5vdGlmaWVyW10ge1xuICAgIHJldHVybiBbR2V0VGlja2V0UXVlcnlSZWxvYWRFdmVudF07XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0VGlja2V0UXVlcnlSZXNldEV2ZW50cygpOiBRdWVyeU5vdGlmaWVyW10ge1xuICAgIHJldHVybiBbR2V0VGlja2V0UXVlcnlSZXNldEV2ZW50XTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRUaWNrZXRzUXVlcnlSZWxvYWRFdmVudHMoKTogUXVlcnlOb3RpZmllcltdIHtcbiAgICByZXR1cm4gW0dldFRpY2tldHNRdWVyeVJlbG9hZEV2ZW50c107XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0VGlja2V0c1F1ZXJ5UmVzZXRFdmVudHMoKTogUXVlcnlOb3RpZmllcltdIHtcbiAgICByZXR1cm4gW0dldFRpY2tldHNRdWVyeVJlc2V0RXZlbnRzXTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjcmVhdGVUaWNrZXRDb21tYW5kOiBDb21tYW5kPFRpY2tldFN0YXJ0ZXIsIFRpY2tldERldGFpbHM+ID1cbiAgICB0aGlzLmNvbW1hbmRTZXJ2aWNlLmNyZWF0ZTxUaWNrZXRTdGFydGVyLCBUaWNrZXREZXRhaWxzPihcbiAgICAgICh0aWNrZXRTdGFydGVkKSA9PlxuICAgICAgICB0aGlzLmN1c3RvbWVyVGlja2V0aW5nUHJlQ29uZGl0aW9ucygpLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChbY3VzdG9tZXJJZF0pID0+XG4gICAgICAgICAgICB0aGlzLmN1c3RvbWVyVGlja2V0aW5nQ29ubmVjdG9yLmNyZWF0ZVRpY2tldChcbiAgICAgICAgICAgICAgY3VzdG9tZXJJZCxcbiAgICAgICAgICAgICAgdGlja2V0U3RhcnRlZFxuICAgICAgICAgICAgKVxuICAgICAgICAgICksXG4gICAgICAgICAgdGFwKCgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZXZlbnRTZXJ2aWNlLmRpc3BhdGNoKHt9LCBUaWNrZXRDcmVhdGVkRXZlbnQpO1xuICAgICAgICAgIH0pXG4gICAgICAgICksXG4gICAgICB7XG4gICAgICAgIHN0cmF0ZWd5OiBDb21tYW5kU3RyYXRlZ3kuUXVldWUsXG4gICAgICB9XG4gICAgKTtcblxuICBwcm90ZWN0ZWQgY3JlYXRlVGlja2V0RXZlbnRDb21tYW5kOiBDb21tYW5kPFxuICAgIHsgdGlja2V0RXZlbnQ6IFRpY2tldEV2ZW50OyBjb250YWluc0F0dGFjaG1lbnQ/OiBib29sZWFuIH0sXG4gICAgVGlja2V0RXZlbnRcbiAgPiA9IHRoaXMuY29tbWFuZFNlcnZpY2UuY3JlYXRlPFxuICAgIHsgdGlja2V0RXZlbnQ6IFRpY2tldEV2ZW50OyBjb250YWluc0F0dGFjaG1lbnQ/OiBib29sZWFuIH0sXG4gICAgVGlja2V0RXZlbnRcbiAgPihcbiAgICAocGF5bG9hZCkgPT5cbiAgICAgIHRoaXMuY3VzdG9tZXJUaWNrZXRpbmdQcmVDb25kaXRpb25zKCkucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKChbY3VzdG9tZXJJZCwgdGlja2V0SWRdKSA9PlxuICAgICAgICAgIHRoaXMuY3VzdG9tZXJUaWNrZXRpbmdDb25uZWN0b3JcbiAgICAgICAgICAgIC5jcmVhdGVUaWNrZXRFdmVudChjdXN0b21lcklkLCB0aWNrZXRJZCwgcGF5bG9hZC50aWNrZXRFdmVudClcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICB0YXAoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmIChwYXlsb2FkLnRpY2tldEV2ZW50LnRvU3RhdHVzPy5pZCA9PT0gU1RBVFVTLkNMT1NFRCkge1xuICAgICAgICAgICAgICAgICAgdGhpcy5ldmVudFNlcnZpY2UuZGlzcGF0Y2goe30sIFRpY2tldENsb3NlZEV2ZW50KTtcbiAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKCFwYXlsb2FkLmNvbnRhaW5zQXR0YWNobWVudCkge1xuICAgICAgICAgICAgICAgICAgaWYgKFxuICAgICAgICAgICAgICAgICAgICBwYXlsb2FkLnRpY2tldEV2ZW50LnRvU3RhdHVzPy5pZCA9PT0gU1RBVFVTLk9QRU4gfHxcbiAgICAgICAgICAgICAgICAgICAgcGF5bG9hZC50aWNrZXRFdmVudC50b1N0YXR1cz8uaWQgPT09IFNUQVRVUy5JTlBST0NFU1NcbiAgICAgICAgICAgICAgICAgICkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV2ZW50U2VydmljZS5kaXNwYXRjaCh7fSwgVGlja2V0UmVvcGVuZWRFdmVudCk7XG4gICAgICAgICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmV2ZW50U2VydmljZS5kaXNwYXRjaCh7fSwgTmV3TWVzc2FnZUV2ZW50KTtcbiAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICksXG4gICAge1xuICAgICAgc3RyYXRlZ3k6IENvbW1hbmRTdHJhdGVneS5RdWV1ZSxcbiAgICB9XG4gICk7XG5cbiAgcHJvdGVjdGVkIHVwbG9hZEF0dGFjaG1lbnRDb21tYW5kOiBDb21tYW5kPHtcbiAgICBmaWxlOiBGaWxlO1xuICAgIGV2ZW50Q29kZTogc3RyaW5nO1xuICAgIHRpY2tldElkPzogc3RyaW5nO1xuICB9PiA9IHRoaXMuY29tbWFuZFNlcnZpY2UuY3JlYXRlPHtcbiAgICBmaWxlOiBGaWxlO1xuICAgIGV2ZW50Q29kZTogc3RyaW5nO1xuICAgIHRpY2tldElkPzogc3RyaW5nO1xuICB9PihcbiAgICAocGF5bG9hZCkgPT5cbiAgICAgIHRoaXMuY3VzdG9tZXJUaWNrZXRpbmdQcmVDb25kaXRpb25zKCkucGlwZShcbiAgICAgICAgc3dpdGNoTWFwKChbY3VzdG9tZXJJZCwgdGlja2V0SWRdKSA9PlxuICAgICAgICAgIHRoaXMuY3VzdG9tZXJUaWNrZXRpbmdDb25uZWN0b3JcbiAgICAgICAgICAgIC51cGxvYWRBdHRhY2htZW50KFxuICAgICAgICAgICAgICBjdXN0b21lcklkLFxuICAgICAgICAgICAgICBwYXlsb2FkLnRpY2tldElkID8/IHRpY2tldElkLFxuICAgICAgICAgICAgICBwYXlsb2FkLmV2ZW50Q29kZSxcbiAgICAgICAgICAgICAgcGF5bG9hZC5maWxlXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgdGFwKCgpID0+XG4gICAgICAgICAgICAgICAgdGhpcy5ldmVudFNlcnZpY2UuZGlzcGF0Y2goe30sIFVwbG9hZEF0dGFjaG1lbnRTdWNjZXNzRXZlbnQpXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICB7XG4gICAgICBzdHJhdGVneTogQ29tbWFuZFN0cmF0ZWd5LlF1ZXVlLFxuICAgIH1cbiAgKTtcblxuICBwcm90ZWN0ZWQgZG93bmxvYWRBdHRhY2htZW50Q29tbWFuZDogQ29tbWFuZDx7XG4gICAgZXZlbnRDb2RlOiBzdHJpbmc7XG4gICAgYXR0YWNobWVudElkOiBzdHJpbmc7XG4gIH0+ID0gdGhpcy5jb21tYW5kU2VydmljZS5jcmVhdGU8eyBldmVudENvZGU6IHN0cmluZzsgYXR0YWNobWVudElkOiBzdHJpbmcgfT4oXG4gICAgKHBheWxvYWQpID0+XG4gICAgICB0aGlzLmN1c3RvbWVyVGlja2V0aW5nUHJlQ29uZGl0aW9ucygpLnBpcGUoXG4gICAgICAgIHN3aXRjaE1hcCgoW2N1c3RvbWVySWQsIHRpY2tldElkXSkgPT5cbiAgICAgICAgICB0aGlzLmN1c3RvbWVyVGlja2V0aW5nQ29ubmVjdG9yLmRvd25sb2FkQXR0YWNobWVudChcbiAgICAgICAgICAgIGN1c3RvbWVySWQsXG4gICAgICAgICAgICB0aWNrZXRJZCxcbiAgICAgICAgICAgIHBheWxvYWQuZXZlbnRDb2RlLFxuICAgICAgICAgICAgcGF5bG9hZC5hdHRhY2htZW50SWRcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICksXG4gICAge1xuICAgICAgc3RyYXRlZ3k6IENvbW1hbmRTdHJhdGVneS5RdWV1ZSxcbiAgICB9XG4gICk7XG5cbiAgcHJvdGVjdGVkIGdldFRpY2tldFF1ZXJ5JDogUXVlcnk8VGlja2V0RGV0YWlscyB8IHVuZGVmaW5lZD4gPVxuICAgIHRoaXMucXVlcnlTZXJ2aWNlLmNyZWF0ZTxUaWNrZXREZXRhaWxzIHwgdW5kZWZpbmVkPihcbiAgICAgICgpID0+XG4gICAgICAgIHRoaXMuY3VzdG9tZXJUaWNrZXRpbmdQcmVDb25kaXRpb25zKCkucGlwZShcbiAgICAgICAgICBzd2l0Y2hNYXAoKFtjdXN0b21lcklkLCB0aWNrZXRJZF0pID0+XG4gICAgICAgICAgICB0aGlzLmN1c3RvbWVyVGlja2V0aW5nQ29ubmVjdG9yLmdldFRpY2tldChjdXN0b21lcklkLCB0aWNrZXRJZClcbiAgICAgICAgICApXG4gICAgICAgICksXG4gICAgICB7XG4gICAgICAgIHJlbG9hZE9uOiB0aGlzLmdldFRpY2tldFF1ZXJ5UmVsb2FkRXZlbnRzKCksXG4gICAgICAgIHJlc2V0T246IHRoaXMuZ2V0VGlja2V0UXVlcnlSZXNldEV2ZW50cygpLFxuICAgICAgfVxuICAgICk7XG5cbiAgcHJvdGVjdGVkIGdldFRpY2tldHNRdWVyeSQoXG4gICAgcGFnZVNpemU6IG51bWJlcixcbiAgICBjdXJyZW50UGFnZTogbnVtYmVyLFxuICAgIHNvcnQ6IHN0cmluZ1xuICApOiBRdWVyeTxUaWNrZXRMaXN0IHwgdW5kZWZpbmVkPiB7XG4gICAgcmV0dXJuIHRoaXMucXVlcnlTZXJ2aWNlLmNyZWF0ZTxUaWNrZXRMaXN0IHwgdW5kZWZpbmVkPihcbiAgICAgICgpID0+XG4gICAgICAgIHRoaXMuY3VzdG9tZXJUaWNrZXRpbmdMaXN0UHJlQ29uZGl0aW9ucygpLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChjdXN0b21lcklkKSA9PlxuICAgICAgICAgICAgdGhpcy5jdXN0b21lclRpY2tldGluZ0Nvbm5lY3Rvci5nZXRUaWNrZXRzKFxuICAgICAgICAgICAgICBjdXN0b21lcklkLFxuICAgICAgICAgICAgICBwYWdlU2l6ZSxcbiAgICAgICAgICAgICAgY3VycmVudFBhZ2UsXG4gICAgICAgICAgICAgIHNvcnRcbiAgICAgICAgICAgIClcbiAgICAgICAgICApXG4gICAgICAgICksXG4gICAgICB7XG4gICAgICAgIHJlbG9hZE9uOiB0aGlzLmdldFRpY2tldHNRdWVyeVJlbG9hZEV2ZW50cygpLFxuICAgICAgICByZXNldE9uOiB0aGlzLmdldFRpY2tldHNRdWVyeVJlc2V0RXZlbnRzKCksXG4gICAgICB9XG4gICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRUaWNrZXRDYXRlZ29yaWVzUXVlcnk6IFF1ZXJ5PENhdGVnb3J5W10+ID1cbiAgICB0aGlzLnF1ZXJ5U2VydmljZS5jcmVhdGUoXG4gICAgICAoKSA9PiB0aGlzLmN1c3RvbWVyVGlja2V0aW5nQ29ubmVjdG9yLmdldFRpY2tldENhdGVnb3JpZXMoKSxcbiAgICAgIHtcbiAgICAgICAgcmVsb2FkT246IHRoaXMuZ2V0VGlja2V0Q2F0ZWdvcmllc1F1ZXJ5UmVsb2FkRXZlbnRzKCksXG4gICAgICAgIHJlc2V0T246IHRoaXMuZ2V0VGlja2V0Q2F0ZWdvcmllc1F1ZXJ5UmVzZXRFdmVudHMoKSxcbiAgICAgIH1cbiAgICApO1xuXG4gIHByb3RlY3RlZCBnZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0c1F1ZXJ5OiBRdWVyeTxBc3NvY2lhdGVkT2JqZWN0W10+ID1cbiAgICB0aGlzLnF1ZXJ5U2VydmljZS5jcmVhdGUoXG4gICAgICAoKSA9PlxuICAgICAgICB0aGlzLmN1c3RvbWVyVGlja2V0aW5nUHJlQ29uZGl0aW9ucygpLnBpcGUoXG4gICAgICAgICAgc3dpdGNoTWFwKChbY3VzdG9tZXJJZF0pID0+XG4gICAgICAgICAgICB0aGlzLmN1c3RvbWVyVGlja2V0aW5nQ29ubmVjdG9yLmdldFRpY2tldEFzc29jaWF0ZWRPYmplY3RzKFxuICAgICAgICAgICAgICBjdXN0b21lcklkXG4gICAgICAgICAgICApXG4gICAgICAgICAgKVxuICAgICAgICApLFxuICAgICAge1xuICAgICAgICByZWxvYWRPbjogdGhpcy5nZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0c1F1ZXJ5UmVsb2FkRXZlbnRzKCksXG4gICAgICAgIHJlc2V0T246IHRoaXMuZ2V0VGlja2V0QXNzb2NpYXRlZE9iamVjdHNRdWVyeVJlc2V0RXZlbnRzKCksXG4gICAgICB9XG4gICAgKTtcblxuICBwcm90ZWN0ZWQgY3VzdG9tZXJUaWNrZXRpbmdQcmVDb25kaXRpb25zKCk6IE9ic2VydmFibGU8W3N0cmluZywgc3RyaW5nXT4ge1xuICAgIHJldHVybiBjb21iaW5lTGF0ZXN0KFtcbiAgICAgIHRoaXMudXNlcklkU2VydmljZS5nZXRVc2VySWQoKSxcbiAgICAgIHRoaXMucm91dGluZ1NlcnZpY2UuZ2V0UGFyYW1zKCkucGlwZShcbiAgICAgICAgbWFwKChwYXJhbXMpID0+IHBhcmFtcy50aWNrZXRDb2RlKSxcbiAgICAgICAgZGlzdGluY3RVbnRpbENoYW5nZWQoKVxuICAgICAgKSxcbiAgICBdKS5waXBlKFxuICAgICAgdGFrZSgxKSxcbiAgICAgIG1hcCgoW3VzZXJJZCwgdGlja2V0SWRdKSA9PiB7XG4gICAgICAgIGlmICghdXNlcklkKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdDdXN0b21lciB0aWNrZXRpbmcgcHJlIGNvbmRpdGlvbnMgbm90IG1ldCcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBbdXNlcklkLCB0aWNrZXRJZF07XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgY3VzdG9tZXJUaWNrZXRpbmdMaXN0UHJlQ29uZGl0aW9ucygpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIHJldHVybiB0aGlzLnVzZXJJZFNlcnZpY2UuZ2V0VXNlcklkKCkucGlwZShcbiAgICAgIHRha2UoMSksXG4gICAgICBtYXAoKHVzZXJJZCkgPT4ge1xuICAgICAgICBpZiAoIXVzZXJJZCkge1xuICAgICAgICAgIHRocm93IG5ldyBFcnJvcignQ3VzdG9tZXIgdGlja2V0aW5nIGxpc3QgcHJlIGNvbmRpdGlvbnMgbm90IG1ldCcpO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiB1c2VySWQ7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgcXVlcnlTZXJ2aWNlOiBRdWVyeVNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGNvbW1hbmRTZXJ2aWNlOiBDb21tYW5kU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgdXNlcklkU2VydmljZTogVXNlcklkU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgY3VzdG9tZXJUaWNrZXRpbmdDb25uZWN0b3I6IEN1c3RvbWVyVGlja2V0aW5nQ29ubmVjdG9yLFxuICAgIHByb3RlY3RlZCByb3V0aW5nU2VydmljZTogUm91dGluZ1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGV2ZW50U2VydmljZTogRXZlbnRTZXJ2aWNlXG4gICkge31cblxuICBnZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0c1N0YXRlKCk6IE9ic2VydmFibGU8XG4gICAgUXVlcnlTdGF0ZTxBc3NvY2lhdGVkT2JqZWN0W10+XG4gID4ge1xuICAgIHJldHVybiB0aGlzLmdldFRpY2tldEFzc29jaWF0ZWRPYmplY3RzUXVlcnkuZ2V0U3RhdGUoKTtcbiAgfVxuICBnZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0cygpOiBPYnNlcnZhYmxlPEFzc29jaWF0ZWRPYmplY3RbXT4ge1xuICAgIHJldHVybiB0aGlzLmdldFRpY2tldEFzc29jaWF0ZWRPYmplY3RzU3RhdGUoKS5waXBlKFxuICAgICAgY29uY2F0TWFwKChzdGF0ZSkgPT5cbiAgICAgICAgc3RhdGU/LmVycm9yID8gdGhyb3dFcnJvcihzdGF0ZS5lcnJvciBhcyBIdHRwRXJyb3JNb2RlbCkgOiBvZihzdGF0ZSlcbiAgICAgICksXG4gICAgICBtYXAoKHN0YXRlKSA9PiBzdGF0ZS5kYXRhID8/IFtdKVxuICAgICk7XG4gIH1cblxuICBnZXRUaWNrZXRDYXRlZ29yaWVzU3RhdGUoKTogT2JzZXJ2YWJsZTxRdWVyeVN0YXRlPENhdGVnb3J5W10+PiB7XG4gICAgcmV0dXJuIHRoaXMuZ2V0VGlja2V0Q2F0ZWdvcmllc1F1ZXJ5LmdldFN0YXRlKCk7XG4gIH1cblxuICBnZXRUaWNrZXRDYXRlZ29yaWVzKCk6IE9ic2VydmFibGU8Q2F0ZWdvcnlbXT4ge1xuICAgIHJldHVybiB0aGlzLmdldFRpY2tldENhdGVnb3JpZXNTdGF0ZSgpLnBpcGUoXG4gICAgICBtYXAoKHN0YXRlKSA9PiBzdGF0ZS5kYXRhID8/IFtdKVxuICAgICk7XG4gIH1cblxuICBnZXRUaWNrZXRTdGF0ZSgpOiBPYnNlcnZhYmxlPFF1ZXJ5U3RhdGU8VGlja2V0RGV0YWlscyB8IHVuZGVmaW5lZD4+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRUaWNrZXRRdWVyeSQuZ2V0U3RhdGUoKTtcbiAgfVxuXG4gIGdldFRpY2tldCgpOiBPYnNlcnZhYmxlPFRpY2tldERldGFpbHMgfCB1bmRlZmluZWQ+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRUaWNrZXRTdGF0ZSgpLnBpcGUobWFwKChzdGF0ZSkgPT4gc3RhdGUuZGF0YSkpO1xuICB9XG5cbiAgY3JlYXRlVGlja2V0KFxuICAgIHRpY2tldFN0YXJ0ZWQ6IFRpY2tldFN0YXJ0ZXJcbiAgKTogT2JzZXJ2YWJsZTxUaWNrZXRTdGFydGVyIHwgVGlja2V0RGV0YWlscz4ge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVRpY2tldENvbW1hbmQuZXhlY3V0ZSh0aWNrZXRTdGFydGVkKTtcbiAgfVxuXG4gIGdldFRpY2tldHNTdGF0ZShcbiAgICBwYWdlU2l6ZTogbnVtYmVyLFxuICAgIGN1cnJlbnRQYWdlOiBudW1iZXIsXG4gICAgc29ydDogc3RyaW5nXG4gICk6IE9ic2VydmFibGU8UXVlcnlTdGF0ZTxUaWNrZXRMaXN0IHwgdW5kZWZpbmVkPj4ge1xuICAgIHJldHVybiB0aGlzLmdldFRpY2tldHNRdWVyeSQocGFnZVNpemUsIGN1cnJlbnRQYWdlLCBzb3J0KS5nZXRTdGF0ZSgpO1xuICB9XG5cbiAgZ2V0VGlja2V0cyhcbiAgICBwYWdlU2l6ZTogbnVtYmVyLFxuICAgIGN1cnJlbnRQYWdlOiBudW1iZXIsXG4gICAgc29ydDogc3RyaW5nXG4gICk6IE9ic2VydmFibGU8VGlja2V0TGlzdCB8IHVuZGVmaW5lZD4ge1xuICAgIHJldHVybiB0aGlzLmdldFRpY2tldHNTdGF0ZShwYWdlU2l6ZSwgY3VycmVudFBhZ2UsIHNvcnQpLnBpcGUoXG4gICAgICBtYXAoKHN0YXRlKSA9PiBzdGF0ZS5kYXRhKVxuICAgICk7XG4gIH1cblxuICBjcmVhdGVUaWNrZXRFdmVudChcbiAgICB0aWNrZXRFdmVudDogVGlja2V0RXZlbnQsXG4gICAgY29udGFpbnNBdHRhY2htZW50ID0gZmFsc2VcbiAgKTogT2JzZXJ2YWJsZTxUaWNrZXRFdmVudD4ge1xuICAgIHJldHVybiB0aGlzLmNyZWF0ZVRpY2tldEV2ZW50Q29tbWFuZC5leGVjdXRlKHtcbiAgICAgIHRpY2tldEV2ZW50LFxuICAgICAgY29udGFpbnNBdHRhY2htZW50LFxuICAgIH0pO1xuICB9XG5cbiAgdXBsb2FkQXR0YWNobWVudChcbiAgICBmaWxlOiBGaWxlLFxuICAgIGV2ZW50Q29kZTogc3RyaW5nLFxuICAgIHRpY2tldElkPzogc3RyaW5nXG4gICk6IE9ic2VydmFibGU8dW5rbm93bj4ge1xuICAgIHJldHVybiB0aGlzLnVwbG9hZEF0dGFjaG1lbnRDb21tYW5kLmV4ZWN1dGUoeyBmaWxlLCBldmVudENvZGUsIHRpY2tldElkIH0pO1xuICB9XG5cbiAgZG93bmxvYWRBdHRhY2htZW50KFxuICAgIGV2ZW50Q29kZTogc3RyaW5nLFxuICAgIGF0dGFjaG1lbnRJZDogc3RyaW5nXG4gICk6IE9ic2VydmFibGU8dW5rbm93bj4ge1xuICAgIHJldHVybiB0aGlzLmRvd25sb2FkQXR0YWNobWVudENvbW1hbmQuZXhlY3V0ZSh7IGV2ZW50Q29kZSwgYXR0YWNobWVudElkIH0pO1xuICB9XG59XG4iXX0=