/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { HttpHeaders } from '@angular/common/http';
import { Injectable, inject } from '@angular/core';
import { LoggerService, normalizeHttpError, } from '@spartacus/core';
import { CUSTOMER_TICKETING_ASSOCIATED_OBJECTS_NORMALIZER, CUSTOMER_TICKETING_CATEGORY_NORMALIZER, CUSTOMER_TICKETING_CREATE_NORMALIZER, CUSTOMER_TICKETING_DETAILS_NORMALIZER, CUSTOMER_TICKETING_EVENT_NORMALIZER, CUSTOMER_TICKETING_FILE_NORMALIZER, CUSTOMER_TICKETING_LIST_NORMALIZER, } from '@spartacus/customer-ticketing/core';
import { throwError } from 'rxjs';
import { catchError, map, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@spartacus/core";
export class OccCustomerTicketingAdapter {
    constructor(http, occEndpoints, converter) {
        this.http = http;
        this.occEndpoints = occEndpoints;
        this.converter = converter;
        this.logger = inject(LoggerService);
    }
    getTicketAssociatedObjects(customerId) {
        return this.http
            .get(this.getTicketAssociatedObjectsEndpoint(customerId))
            .pipe(catchError((error) => throwError(normalizeHttpError(error, this.logger))), map((associatedObjectList) => associatedObjectList.ticketAssociatedObjects ?? []), this.converter.pipeableMany(CUSTOMER_TICKETING_ASSOCIATED_OBJECTS_NORMALIZER));
    }
    getTicketAssociatedObjectsEndpoint(customerId) {
        return this.occEndpoints.buildUrl('getTicketAssociatedObjects', {
            urlParams: {
                customerId,
            },
        });
    }
    getTicketCategories() {
        return this.http
            .get(this.getTicketCategoriesEndpoint())
            .pipe(catchError((error) => throwError(normalizeHttpError(error, this.logger))), map((categoryList) => categoryList.ticketCategories ?? []), this.converter.pipeableMany(CUSTOMER_TICKETING_CATEGORY_NORMALIZER));
    }
    getTicketCategoriesEndpoint() {
        return this.occEndpoints.buildUrl('getTicketCategories');
    }
    getTicket(customerId, ticketId) {
        return this.http
            .get(this.getTicketEndpoint(customerId, ticketId))
            .pipe(catchError((errorResponse) => {
            return throwError(normalizeHttpError(errorResponse, this.logger));
        }), tap((ticket) => ticket.ticketEvents?.reverse()), this.converter.pipeable(CUSTOMER_TICKETING_DETAILS_NORMALIZER));
    }
    getTicketEndpoint(customerId, ticketId) {
        return this.occEndpoints.buildUrl('getTicket', {
            urlParams: {
                customerId,
                ticketId,
            },
        });
    }
    createTicket(customerId, ticket) {
        return this.http
            .post(this.getCreateTicketEndpoint(customerId), ticket, {
            headers: new HttpHeaders().set('Content-Type', 'application/json'),
        })
            .pipe(catchError((error) => throwError(normalizeHttpError(error, this.logger))), this.converter.pipeable(CUSTOMER_TICKETING_CREATE_NORMALIZER));
    }
    getCreateTicketEndpoint(customerId) {
        return this.occEndpoints.buildUrl('createTicket', {
            urlParams: {
                customerId,
            },
        });
    }
    getTickets(customerId, pageSize, currentPage, sort) {
        return this.http
            .get(this.getTicketsEndpoint(customerId, pageSize, currentPage, sort))
            .pipe(catchError((error) => throwError(normalizeHttpError(error, this.logger))), this.converter.pipeable(CUSTOMER_TICKETING_LIST_NORMALIZER));
    }
    getTicketsEndpoint(customerId, pageSize, currentPage, sort) {
        return this.occEndpoints.buildUrl('getTickets', {
            urlParams: {
                customerId,
            },
            queryParams: {
                pageSize,
                currentPage,
                sort,
            },
        });
    }
    createTicketEvent(customerId, ticketId, ticketEvent) {
        return this.http
            .post(this.getCreateTicketEventEndpoint(customerId, ticketId), ticketEvent, {
            headers: new HttpHeaders().set('Content-Type', 'application/json'),
        })
            .pipe(catchError((error) => throwError(normalizeHttpError(error, this.logger))), this.converter.pipeable(CUSTOMER_TICKETING_EVENT_NORMALIZER));
    }
    getCreateTicketEventEndpoint(customerId, ticketId) {
        return this.occEndpoints.buildUrl('createTicketEvent', {
            urlParams: {
                customerId,
                ticketId,
            },
        });
    }
    uploadAttachment(customerId, ticketId, eventCode, file) {
        const formData = new FormData();
        formData.append('ticketEventAttachment', file);
        return this.http
            .post(this.getUploadAttachmentEndpoint(customerId, ticketId, eventCode), formData)
            .pipe(catchError((error) => throwError(normalizeHttpError(error, this.logger))), this.converter.pipeable(CUSTOMER_TICKETING_FILE_NORMALIZER));
    }
    getUploadAttachmentEndpoint(customerId, ticketId, eventCode) {
        return this.occEndpoints.buildUrl('uploadAttachment', {
            urlParams: {
                customerId,
                ticketId,
                eventCode,
            },
        });
    }
    downloadAttachment(customerId, ticketId, eventCode, attachmentId) {
        const httpOptions = {
            responseType: 'blob',
        };
        return this.http
            .get(this.getDownloadAttachmentEndpoint(customerId, ticketId, eventCode, attachmentId), httpOptions)
            .pipe(catchError((error) => throwError(normalizeHttpError(error, this.logger))), this.converter.pipeable(CUSTOMER_TICKETING_FILE_NORMALIZER));
    }
    getDownloadAttachmentEndpoint(customerId, ticketId, eventCode, attachmentId) {
        return this.occEndpoints.buildUrl('downloadAttachment', {
            urlParams: {
                customerId,
                ticketId,
                eventCode,
                attachmentId,
            },
        });
    }
}
OccCustomerTicketingAdapter.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: OccCustomerTicketingAdapter, deps: [{ token: i1.HttpClient }, { token: i2.OccEndpointsService }, { token: i2.ConverterService }], target: i0.ɵɵFactoryTarget.Injectable });
OccCustomerTicketingAdapter.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: OccCustomerTicketingAdapter });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: OccCustomerTicketingAdapter, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.HttpClient }, { type: i2.OccEndpointsService }, { type: i2.ConverterService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoib2NjLWN1c3RvbWVyLXRpY2tldGluZy5hZGFwdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL2N1c3RvbWVyLXRpY2tldGluZy9vY2MvYWRhcHRlcnMvb2NjLWN1c3RvbWVyLXRpY2tldGluZy5hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQWMsV0FBVyxFQUFFLE1BQU0sc0JBQXNCLENBQUM7QUFDL0QsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUVMLGFBQWEsRUFFYixrQkFBa0IsR0FDbkIsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLEVBQ0wsZ0RBQWdELEVBQ2hELHNDQUFzQyxFQUN0QyxvQ0FBb0MsRUFDcEMscUNBQXFDLEVBQ3JDLG1DQUFtQyxFQUNuQyxrQ0FBa0MsRUFDbEMsa0NBQWtDLEdBRW5DLE1BQU0sb0NBQW9DLENBQUM7QUFXNUMsT0FBTyxFQUFjLFVBQVUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUM5QyxPQUFPLEVBQUUsVUFBVSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQzs7OztBQUd0RCxNQUFNLE9BQU8sMkJBQTJCO0lBR3RDLFlBQ1ksSUFBZ0IsRUFDaEIsWUFBaUMsRUFDakMsU0FBMkI7UUFGM0IsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQixpQkFBWSxHQUFaLFlBQVksQ0FBcUI7UUFDakMsY0FBUyxHQUFULFNBQVMsQ0FBa0I7UUFMN0IsV0FBTSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztJQU10QyxDQUFDO0lBQ0osMEJBQTBCLENBQ3hCLFVBQWtCO1FBRWxCLE9BQU8sSUFBSSxDQUFDLElBQUk7YUFDYixHQUFHLENBQ0YsSUFBSSxDQUFDLGtDQUFrQyxDQUFDLFVBQVUsQ0FBQyxDQUNwRDthQUNB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U0FDRixDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQsa0JBQWtCLENBQ2hCLFVBQWtCLEVBQ2xCLFFBQWdCLEVBQ2hCLFNBQWlCLEVBQ2pCLFlBQW9CO1FBRXBCLE1BQU0sV0FBVyxHQUFHO1lBQ2xCLFlBQVksRUFBRSxNQUFnQjtTQUMvQixDQUFDO1FBQ0YsT0FBTyxJQUFJLENBQUMsSUFBSTthQUNiLEdBQUcsQ0FDRixJQUFJLENBQUMsNkJBQTZCLENBQ2hDLFVBQVUsRUFDVixRQUFRLEVBQ1IsU0FBUyxFQUNULFlBQVksQ0FDYixFQUNELFdBQVcsQ0FDWjthQUNBLElBQUksQ0FDSCxVQUFVLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUNuQixVQUFVLENBQUMsa0JBQWtCLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUNuRCxFQUNELElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLGtDQUFrQyxDQUFDLENBQzVELENBQUM7SUFDTixDQUFDO0lBRVMsNkJBQTZCLENBQ3JDLFVBQWtCLEVBQ2xCLFFBQWdCLEVBQ2hCLFNBQWlCLEVBQ2pCLFlBQW9CO1FBRXBCLE9BQU8sSUFBSSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUMsb0JBQW9CLEVBQUU7WUFDdEQsU0FBUyxFQUFFO2dCQUNULFVBQVU7Z0JBQ1YsUUFBUTtnQkFDUixTQUFTO2dCQUNULFlBQVk7YUFDYjtTQUNGLENBQUMsQ0FBQztJQUNMLENBQUM7O3dIQXBQVSwyQkFBMkI7NEhBQTNCLDJCQUEyQjsyRkFBM0IsMkJBQTJCO2tCQUR2QyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSHR0cENsaWVudCwgSHR0cEhlYWRlcnMgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlLCBpbmplY3QgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIENvbnZlcnRlclNlcnZpY2UsXG4gIExvZ2dlclNlcnZpY2UsXG4gIE9jY0VuZHBvaW50c1NlcnZpY2UsXG4gIG5vcm1hbGl6ZUh0dHBFcnJvcixcbn0gZnJvbSAnQHNwYXJ0YWN1cy9jb3JlJztcbmltcG9ydCB7XG4gIENVU1RPTUVSX1RJQ0tFVElOR19BU1NPQ0lBVEVEX09CSkVDVFNfTk9STUFMSVpFUixcbiAgQ1VTVE9NRVJfVElDS0VUSU5HX0NBVEVHT1JZX05PUk1BTElaRVIsXG4gIENVU1RPTUVSX1RJQ0tFVElOR19DUkVBVEVfTk9STUFMSVpFUixcbiAgQ1VTVE9NRVJfVElDS0VUSU5HX0RFVEFJTFNfTk9STUFMSVpFUixcbiAgQ1VTVE9NRVJfVElDS0VUSU5HX0VWRU5UX05PUk1BTElaRVIsXG4gIENVU1RPTUVSX1RJQ0tFVElOR19GSUxFX05PUk1BTElaRVIsXG4gIENVU1RPTUVSX1RJQ0tFVElOR19MSVNUX05PUk1BTElaRVIsXG4gIEN1c3RvbWVyVGlja2V0aW5nQWRhcHRlcixcbn0gZnJvbSAnQHNwYXJ0YWN1cy9jdXN0b21lci10aWNrZXRpbmcvY29yZSc7XG5pbXBvcnQge1xuICBBc3NvY2lhdGVkT2JqZWN0LFxuICBBc3NvY2lhdGVkT2JqZWN0c0xpc3QsXG4gIENhdGVnb3JpZXNMaXN0LFxuICBDYXRlZ29yeSxcbiAgVGlja2V0RGV0YWlscyxcbiAgVGlja2V0RXZlbnQsXG4gIFRpY2tldExpc3QsXG4gIFRpY2tldFN0YXJ0ZXIsXG59IGZyb20gJ0BzcGFydGFjdXMvY3VzdG9tZXItdGlja2V0aW5nL3Jvb3QnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgdGhyb3dFcnJvciB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCB0YXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBPY2NDdXN0b21lclRpY2tldGluZ0FkYXB0ZXIgaW1wbGVtZW50cyBDdXN0b21lclRpY2tldGluZ0FkYXB0ZXIge1xuICBwcm90ZWN0ZWQgbG9nZ2VyID0gaW5qZWN0KExvZ2dlclNlcnZpY2UpO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBodHRwOiBIdHRwQ2xpZW50LFxuICAgIHByb3RlY3RlZCBvY2NFbmRwb2ludHM6IE9jY0VuZHBvaW50c1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGNvbnZlcnRlcjogQ29udmVydGVyU2VydmljZVxuICApIHt9XG4gIGdldFRpY2tldEFzc29jaWF0ZWRPYmplY3RzKFxuICAgIGN1c3RvbWVySWQ6IHN0cmluZ1xuICApOiBPYnNlcnZhYmxlPEFzc29jaWF0ZWRPYmplY3RbXT4ge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQ8QXNzb2NpYXRlZE9iamVjdHNMaXN0PihcbiAgICAgICAgdGhpcy5nZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0c0VuZHBvaW50KGN1c3RvbWVySWQpXG4gICAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+XG4gICAgICAgICAgdGhyb3dFcnJvcihub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKSlcbiAgICAgICAgKSxcbiAgICAgICAgbWFwKFxuICAgICAgICAgIChhc3NvY2lhdGVkT2JqZWN0TGlzdCkgPT5cbiAgICAgICAgICAgIGFzc29jaWF0ZWRPYmplY3RMaXN0LnRpY2tldEFzc29jaWF0ZWRPYmplY3RzID8/IFtdXG4gICAgICAgICksXG4gICAgICAgIHRoaXMuY29udmVydGVyLnBpcGVhYmxlTWFueShcbiAgICAgICAgICBDVVNUT01FUl9USUNLRVRJTkdfQVNTT0NJQVRFRF9PQkpFQ1RTX05PUk1BTElaRVJcbiAgICAgICAgKVxuICAgICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0c0VuZHBvaW50KGN1c3RvbWVySWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMub2NjRW5kcG9pbnRzLmJ1aWxkVXJsKCdnZXRUaWNrZXRBc3NvY2lhdGVkT2JqZWN0cycsIHtcbiAgICAgIHVybFBhcmFtczoge1xuICAgICAgICBjdXN0b21lcklkLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGdldFRpY2tldENhdGVnb3JpZXMoKTogT2JzZXJ2YWJsZTxDYXRlZ29yeVtdPiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLmdldDxDYXRlZ29yaWVzTGlzdD4odGhpcy5nZXRUaWNrZXRDYXRlZ29yaWVzRW5kcG9pbnQoKSlcbiAgICAgIC5waXBlKFxuICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT5cbiAgICAgICAgICB0aHJvd0Vycm9yKG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpKVxuICAgICAgICApLFxuICAgICAgICBtYXAoKGNhdGVnb3J5TGlzdCkgPT4gY2F0ZWdvcnlMaXN0LnRpY2tldENhdGVnb3JpZXMgPz8gW10pLFxuICAgICAgICB0aGlzLmNvbnZlcnRlci5waXBlYWJsZU1hbnkoQ1VTVE9NRVJfVElDS0VUSU5HX0NBVEVHT1JZX05PUk1BTElaRVIpXG4gICAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldFRpY2tldENhdGVnb3JpZXNFbmRwb2ludCgpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLm9jY0VuZHBvaW50cy5idWlsZFVybCgnZ2V0VGlja2V0Q2F0ZWdvcmllcycpO1xuICB9XG5cbiAgZ2V0VGlja2V0KGN1c3RvbWVySWQ6IHN0cmluZywgdGlja2V0SWQ6IHN0cmluZyk6IE9ic2VydmFibGU8VGlja2V0RGV0YWlscz4ge1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQ8VGlja2V0RGV0YWlscz4odGhpcy5nZXRUaWNrZXRFbmRwb2ludChjdXN0b21lcklkLCB0aWNrZXRJZCkpXG4gICAgICAucGlwZShcbiAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3JSZXNwb25zZSkgPT4ge1xuICAgICAgICAgIHJldHVybiB0aHJvd0Vycm9yKG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvclJlc3BvbnNlLCB0aGlzLmxvZ2dlcikpO1xuICAgICAgICB9KSxcbiAgICAgICAgdGFwKCh0aWNrZXQpID0+IHRpY2tldC50aWNrZXRFdmVudHM/LnJldmVyc2UoKSksXG4gICAgICAgIHRoaXMuY29udmVydGVyLnBpcGVhYmxlKENVU1RPTUVSX1RJQ0tFVElOR19ERVRBSUxTX05PUk1BTElaRVIpXG4gICAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldFRpY2tldEVuZHBvaW50KGN1c3RvbWVySWQ6IHN0cmluZywgdGlja2V0SWQ6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMub2NjRW5kcG9pbnRzLmJ1aWxkVXJsKCdnZXRUaWNrZXQnLCB7XG4gICAgICB1cmxQYXJhbXM6IHtcbiAgICAgICAgY3VzdG9tZXJJZCxcbiAgICAgICAgdGlja2V0SWQsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgY3JlYXRlVGlja2V0KFxuICAgIGN1c3RvbWVySWQ6IHN0cmluZyxcbiAgICB0aWNrZXQ6IFRpY2tldFN0YXJ0ZXJcbiAgKTogT2JzZXJ2YWJsZTxUaWNrZXRTdGFydGVyPiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8VGlja2V0U3RhcnRlcj4odGhpcy5nZXRDcmVhdGVUaWNrZXRFbmRwb2ludChjdXN0b21lcklkKSwgdGlja2V0LCB7XG4gICAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycygpLnNldCgnQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKSxcbiAgICAgIH0pXG4gICAgICAucGlwZShcbiAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+XG4gICAgICAgICAgdGhyb3dFcnJvcihub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKSlcbiAgICAgICAgKSxcbiAgICAgICAgdGhpcy5jb252ZXJ0ZXIucGlwZWFibGUoQ1VTVE9NRVJfVElDS0VUSU5HX0NSRUFURV9OT1JNQUxJWkVSKVxuICAgICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRDcmVhdGVUaWNrZXRFbmRwb2ludChjdXN0b21lcklkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiB0aGlzLm9jY0VuZHBvaW50cy5idWlsZFVybCgnY3JlYXRlVGlja2V0Jywge1xuICAgICAgdXJsUGFyYW1zOiB7XG4gICAgICAgIGN1c3RvbWVySWQsXG4gICAgICB9LFxuICAgIH0pO1xuICB9XG5cbiAgZ2V0VGlja2V0cyhcbiAgICBjdXN0b21lcklkOiBzdHJpbmcsXG4gICAgcGFnZVNpemU/OiBudW1iZXIsXG4gICAgY3VycmVudFBhZ2U/OiBudW1iZXIsXG4gICAgc29ydD86IHN0cmluZ1xuICApOiBPYnNlcnZhYmxlPFRpY2tldExpc3Q+IHtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAuZ2V0PFRpY2tldExpc3Q+KFxuICAgICAgICB0aGlzLmdldFRpY2tldHNFbmRwb2ludChjdXN0b21lcklkLCBwYWdlU2l6ZSwgY3VycmVudFBhZ2UsIHNvcnQpXG4gICAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+XG4gICAgICAgICAgdGhyb3dFcnJvcihub3JtYWxpemVIdHRwRXJyb3IoZXJyb3IsIHRoaXMubG9nZ2VyKSlcbiAgICAgICAgKSxcbiAgICAgICAgdGhpcy5jb252ZXJ0ZXIucGlwZWFibGUoQ1VTVE9NRVJfVElDS0VUSU5HX0xJU1RfTk9STUFMSVpFUilcbiAgICAgICk7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0VGlja2V0c0VuZHBvaW50KFxuICAgIGN1c3RvbWVySWQ6IHN0cmluZyxcbiAgICBwYWdlU2l6ZT86IG51bWJlcixcbiAgICBjdXJyZW50UGFnZT86IG51bWJlcixcbiAgICBzb3J0Pzogc3RyaW5nXG4gICk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMub2NjRW5kcG9pbnRzLmJ1aWxkVXJsKCdnZXRUaWNrZXRzJywge1xuICAgICAgdXJsUGFyYW1zOiB7XG4gICAgICAgIGN1c3RvbWVySWQsXG4gICAgICB9LFxuICAgICAgcXVlcnlQYXJhbXM6IHtcbiAgICAgICAgcGFnZVNpemUsXG4gICAgICAgIGN1cnJlbnRQYWdlLFxuICAgICAgICBzb3J0LFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxuXG4gIGNyZWF0ZVRpY2tldEV2ZW50KFxuICAgIGN1c3RvbWVySWQ6IHN0cmluZyxcbiAgICB0aWNrZXRJZDogc3RyaW5nLFxuICAgIHRpY2tldEV2ZW50OiBUaWNrZXRFdmVudFxuICApOiBPYnNlcnZhYmxlPFRpY2tldEV2ZW50PiB7XG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBvc3Q8VGlja2V0RXZlbnQ+KFxuICAgICAgICB0aGlzLmdldENyZWF0ZVRpY2tldEV2ZW50RW5kcG9pbnQoY3VzdG9tZXJJZCwgdGlja2V0SWQpLFxuICAgICAgICB0aWNrZXRFdmVudCxcbiAgICAgICAge1xuICAgICAgICAgIGhlYWRlcnM6IG5ldyBIdHRwSGVhZGVycygpLnNldCgnQ29udGVudC1UeXBlJywgJ2FwcGxpY2F0aW9uL2pzb24nKSxcbiAgICAgICAgfVxuICAgICAgKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PlxuICAgICAgICAgIHRocm93RXJyb3Iobm9ybWFsaXplSHR0cEVycm9yKGVycm9yLCB0aGlzLmxvZ2dlcikpXG4gICAgICAgICksXG4gICAgICAgIHRoaXMuY29udmVydGVyLnBpcGVhYmxlKENVU1RPTUVSX1RJQ0tFVElOR19FVkVOVF9OT1JNQUxJWkVSKVxuICAgICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRDcmVhdGVUaWNrZXRFdmVudEVuZHBvaW50KFxuICAgIGN1c3RvbWVySWQ6IHN0cmluZyxcbiAgICB0aWNrZXRJZDogc3RyaW5nXG4gICk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMub2NjRW5kcG9pbnRzLmJ1aWxkVXJsKCdjcmVhdGVUaWNrZXRFdmVudCcsIHtcbiAgICAgIHVybFBhcmFtczoge1xuICAgICAgICBjdXN0b21lcklkLFxuICAgICAgICB0aWNrZXRJZCxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICB1cGxvYWRBdHRhY2htZW50KFxuICAgIGN1c3RvbWVySWQ6IHN0cmluZyxcbiAgICB0aWNrZXRJZDogc3RyaW5nLFxuICAgIGV2ZW50Q29kZTogc3RyaW5nLFxuICAgIGZpbGU6IEZpbGVcbiAgKTogT2JzZXJ2YWJsZTx1bmtub3duPiB7XG4gICAgY29uc3QgZm9ybURhdGE6IEZvcm1EYXRhID0gbmV3IEZvcm1EYXRhKCk7XG4gICAgZm9ybURhdGEuYXBwZW5kKCd0aWNrZXRFdmVudEF0dGFjaG1lbnQnLCBmaWxlKTtcblxuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5wb3N0KFxuICAgICAgICB0aGlzLmdldFVwbG9hZEF0dGFjaG1lbnRFbmRwb2ludChjdXN0b21lcklkLCB0aWNrZXRJZCwgZXZlbnRDb2RlKSxcbiAgICAgICAgZm9ybURhdGFcbiAgICAgIClcbiAgICAgIC5waXBlKFxuICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT5cbiAgICAgICAgICB0aHJvd0Vycm9yKG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpKVxuICAgICAgICApLFxuICAgICAgICB0aGlzLmNvbnZlcnRlci5waXBlYWJsZShDVVNUT01FUl9USUNLRVRJTkdfRklMRV9OT1JNQUxJWkVSKVxuICAgICAgKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBnZXRVcGxvYWRBdHRhY2htZW50RW5kcG9pbnQoXG4gICAgY3VzdG9tZXJJZDogc3RyaW5nLFxuICAgIHRpY2tldElkOiBzdHJpbmcsXG4gICAgZXZlbnRDb2RlOiBzdHJpbmdcbiAgKTogc3RyaW5nIHtcbiAgICByZXR1cm4gdGhpcy5vY2NFbmRwb2ludHMuYnVpbGRVcmwoJ3VwbG9hZEF0dGFjaG1lbnQnLCB7XG4gICAgICB1cmxQYXJhbXM6IHtcbiAgICAgICAgY3VzdG9tZXJJZCxcbiAgICAgICAgdGlja2V0SWQsXG4gICAgICAgIGV2ZW50Q29kZSxcbiAgICAgIH0sXG4gICAgfSk7XG4gIH1cblxuICBkb3dubG9hZEF0dGFjaG1lbnQoXG4gICAgY3VzdG9tZXJJZDogc3RyaW5nLFxuICAgIHRpY2tldElkOiBzdHJpbmcsXG4gICAgZXZlbnRDb2RlOiBzdHJpbmcsXG4gICAgYXR0YWNobWVudElkOiBzdHJpbmdcbiAgKTogT2JzZXJ2YWJsZTx1bmtub3duPiB7XG4gICAgY29uc3QgaHR0cE9wdGlvbnMgPSB7XG4gICAgICByZXNwb25zZVR5cGU6ICdibG9iJyBhcyAnanNvbicsXG4gICAgfTtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAuZ2V0KFxuICAgICAgICB0aGlzLmdldERvd25sb2FkQXR0YWNobWVudEVuZHBvaW50KFxuICAgICAgICAgIGN1c3RvbWVySWQsXG4gICAgICAgICAgdGlja2V0SWQsXG4gICAgICAgICAgZXZlbnRDb2RlLFxuICAgICAgICAgIGF0dGFjaG1lbnRJZFxuICAgICAgICApLFxuICAgICAgICBodHRwT3B0aW9uc1xuICAgICAgKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PlxuICAgICAgICAgIHRocm93RXJyb3Iobm9ybWFsaXplSHR0cEVycm9yKGVycm9yLCB0aGlzLmxvZ2dlcikpXG4gICAgICAgICksXG4gICAgICAgIHRoaXMuY29udmVydGVyLnBpcGVhYmxlKENVU1RPTUVSX1RJQ0tFVElOR19GSUxFX05PUk1BTElaRVIpXG4gICAgICApO1xuICB9XG5cbiAgcHJvdGVjdGVkIGdldERvd25sb2FkQXR0YWNobWVudEVuZHBvaW50KFxuICAgIGN1c3RvbWVySWQ6IHN0cmluZyxcbiAgICB0aWNrZXRJZDogc3RyaW5nLFxuICAgIGV2ZW50Q29kZTogc3RyaW5nLFxuICAgIGF0dGFjaG1lbnRJZDogc3RyaW5nXG4gICk6IHN0cmluZyB7XG4gICAgcmV0dXJuIHRoaXMub2NjRW5kcG9pbnRzLmJ1aWxkVXJsKCdkb3dubG9hZEF0dGFjaG1lbnQnLCB7XG4gICAgICB1cmxQYXJhbXM6IHtcbiAgICAgICAgY3VzdG9tZXJJZCxcbiAgICAgICAgdGlja2V0SWQsXG4gICAgICAgIGV2ZW50Q29kZSxcbiAgICAgICAgYXR0YWNobWVudElkLFxuICAgICAgfSxcbiAgICB9KTtcbiAgfVxufVxuIl19