import { Component, Optional } from '@angular/core';
import { FormControl, FormGroup } from '@angular/forms';
import { CheckoutSupportedDeliveryModesQueryReloadEvent } from '@spartacus/checkout/base/root';
import { CxDatePipe, EventService, GlobalMessageService, GlobalMessageType, TranslationService, } from '@spartacus/core';
import { OutletContextData } from '@spartacus/storefront';
import { Subscription } from 'rxjs';
import { filter, map } from 'rxjs/operators';
import { RequestedDeliveryDateFacade } from '../../facade/requested-delivery-date.facade';
import { DateValidationService } from '../shared/date-validation.service';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/core";
import * as i2 from "../../facade/requested-delivery-date.facade";
import * as i3 from "../shared/date-validation.service";
import * as i4 from "@spartacus/storefront";
import * as i5 from "@angular/common";
import * as i6 from "@angular/forms";
export class DeliveryModeDatePickerComponent {
    constructor(datePipe, requestedDelDateFacade, dateValidationService, eventService, translation, globalMessageService, deliveryOutlet) {
        this.datePipe = datePipe;
        this.requestedDelDateFacade = requestedDelDateFacade;
        this.dateValidationService = dateValidationService;
        this.eventService = eventService;
        this.translation = translation;
        this.globalMessageService = globalMessageService;
        this.deliveryOutlet = deliveryOutlet;
        this.cartEntry = {};
        this.subscription = new Subscription();
        this.form = new FormGroup({
            requestDeliveryDate: new FormControl(),
        });
        this.isDatePickerReadOnly = true;
    }
    ngOnInit() {
        if (this.deliveryOutlet?.context$) {
            this.subscription.add(this.deliveryOutlet.context$.subscribe((context) => {
                this.cartEntry = context?.item;
                this.isDatePickerReadOnly = context?.readonly || false;
            }));
        }
        if (this.isEarliestRetrievalDatePresent()) {
            this.earliestRetrievalAt = this.cartEntry.earliestRetrievalAt;
        }
        if (this.isRequestedDeliveryDatePresent()) {
            this.requestedRetrievalAt = this.cartEntry.requestedRetrievalAt;
        }
        else {
            //set the value of requestedRetrievalAt as earliestRetrievalAt and update occ.
            this.requestedRetrievalAt = this.earliestRetrievalAt;
            this.form.patchValue({
                requestDeliveryDate: this.requestedRetrievalAt,
            });
            this.setRequestedDeliveryDate();
        }
        this.form.patchValue({
            requestDeliveryDate: this.requestedRetrievalAt,
        });
    }
    isEarliestRetrievalDatePresent() {
        return this.dateValidationService.isDateStringValid(this.cartEntry?.earliestRetrievalAt);
    }
    isRequestedDeliveryDatePresent() {
        return this.dateValidationService.isDateStringValid(this.cartEntry?.requestedRetrievalAt);
    }
    getRequestedDeliveryDateCardContent(isoDate) {
        return this.translation
            .translate('requestedDeliveryDate.readOnlyTextLabel')
            .pipe(filter(() => Boolean(isoDate)), map((textTitle) => {
            return {
                text: [textTitle, isoDate],
            };
        }));
    }
    setRequestedDeliveryDate() {
        const userId = this.cartEntry?.user?.uid || '';
        const cartId = this.cartEntry?.code || '';
        const requestedDate = this.form?.get('requestDeliveryDate')?.value || '';
        if (userId.length === 0 ||
            cartId.length === 0 ||
            requestedDate.length === 0 ||
            !this.dateValidationService.isDateStringValid(requestedDate) ||
            !this.dateValidationService.isDateGreaterOrEqual(requestedDate, this.earliestRetrievalAt || '')) {
            return;
        }
        this.subscription.add(this.requestedDelDateFacade
            .setRequestedDeliveryDate(userId, cartId, requestedDate)
            .subscribe({
            next: () => {
                this.eventService.dispatch({}, CheckoutSupportedDeliveryModesQueryReloadEvent);
                this.globalMessageService.add({ key: 'requestedDeliveryDate.successMessage' }, GlobalMessageType.MSG_TYPE_INFO);
            },
            error: (error) => {
                if (error && this.getErrors(error)?.length) {
                    this.globalMessageService.add({ key: 'requestedDeliveryDate.errorMessage' }, GlobalMessageType.MSG_TYPE_ERROR);
                }
            },
        }));
    }
    getErrors(response) {
        return (response.error?.errors).filter((error) => error?.type === 'UnknownResourceError');
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
}
DeliveryModeDatePickerComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: DeliveryModeDatePickerComponent, deps: [{ token: i1.CxDatePipe }, { token: i2.RequestedDeliveryDateFacade }, { token: i3.DateValidationService }, { token: i1.EventService }, { token: i1.TranslationService }, { token: i1.GlobalMessageService }, { token: i4.OutletContextData, optional: true }], target: i0.ɵɵFactoryTarget.Component });
DeliveryModeDatePickerComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.9", type: DeliveryModeDatePickerComponent, selector: "cx-request-delivery-date", providers: [CxDatePipe], ngImport: i0, template: "<ng-container *ngIf=\"isEarliestRetrievalDatePresent()\">\n  <ng-container *ngIf=\"isDatePickerReadOnly; else datePickerEnabled\">\n    <cx-card\n      [content]=\"\n        getRequestedDeliveryDateCardContent(requestedRetrievalAt | cxDate)\n          | async\n      \"\n    ></cx-card>\n  </ng-container>\n  <ng-template #datePickerEnabled>\n    <div class=\"form-check\">\n      <form [formGroup]=\"form\">\n        <label class=\"row\">\n          <div class=\"pl-4 col-8\">\n            {{ 'requestedDeliveryDate.datePickerLabel' | cxTranslate }}\n          </div>\n          <div class=\"col-4\">\n            <cx-date-picker\n              [control]=\"$any(form.get('requestDeliveryDate'))\"\n              [min]=\"earliestRetrievalAt\"\n              [required]=\"true\"\n              (update)=\"setRequestedDeliveryDate()\"\n            >\n            </cx-date-picker>\n          </div>\n        </label>\n      </form>\n    </div>\n  </ng-template>\n</ng-container>\n", dependencies: [{ kind: "directive", type: i5.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i4.DatePickerComponent, selector: "cx-date-picker", inputs: ["control", "min", "max", "required"], outputs: ["update"] }, { kind: "directive", type: i6.ɵNgNoValidate, selector: "form:not([ngNoForm]):not([ngNativeValidate])" }, { kind: "directive", type: i6.NgControlStatusGroup, selector: "[formGroupName],[formArrayName],[ngModelGroup],[formGroup],form:not([ngNoForm]),[ngForm]" }, { kind: "directive", type: i6.FormGroupDirective, selector: "[formGroup]", inputs: ["formGroup"], outputs: ["ngSubmit"], exportAs: ["ngForm"] }, { kind: "component", type: i4.CardComponent, selector: "cx-card", inputs: ["border", "editMode", "isDefault", "content", "fitToContainer", "truncateText", "charactersLimit", "index"], outputs: ["deleteCard", "setDefaultCard", "sendCard", "editCard", "cancelCard"] }, { kind: "pipe", type: i5.AsyncPipe, name: "async" }, { kind: "pipe", type: i1.TranslatePipe, name: "cxTranslate" }, { kind: "pipe", type: i1.CxDatePipe, name: "cxDate" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: DeliveryModeDatePickerComponent, decorators: [{
            type: Component,
            args: [{ selector: 'cx-request-delivery-date', providers: [CxDatePipe], template: "<ng-container *ngIf=\"isEarliestRetrievalDatePresent()\">\n  <ng-container *ngIf=\"isDatePickerReadOnly; else datePickerEnabled\">\n    <cx-card\n      [content]=\"\n        getRequestedDeliveryDateCardContent(requestedRetrievalAt | cxDate)\n          | async\n      \"\n    ></cx-card>\n  </ng-container>\n  <ng-template #datePickerEnabled>\n    <div class=\"form-check\">\n      <form [formGroup]=\"form\">\n        <label class=\"row\">\n          <div class=\"pl-4 col-8\">\n            {{ 'requestedDeliveryDate.datePickerLabel' | cxTranslate }}\n          </div>\n          <div class=\"col-4\">\n            <cx-date-picker\n              [control]=\"$any(form.get('requestDeliveryDate'))\"\n              [min]=\"earliestRetrievalAt\"\n              [required]=\"true\"\n              (update)=\"setRequestedDeliveryDate()\"\n            >\n            </cx-date-picker>\n          </div>\n        </label>\n      </form>\n    </div>\n  </ng-template>\n</ng-container>\n" }]
        }], ctorParameters: function () { return [{ type: i1.CxDatePipe }, { type: i2.RequestedDeliveryDateFacade }, { type: i3.DateValidationService }, { type: i1.EventService }, { type: i1.TranslationService }, { type: i1.GlobalMessageService }, { type: i4.OutletContextData, decorators: [{
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsaXZlcnktbW9kZS1kYXRlLXBpY2tlci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcmVxdWVzdGVkLWRlbGl2ZXJ5LWRhdGUvcm9vdC9jb21wb25lbnRzL2RlbGl2ZXJ5LW1vZGUtZGF0ZS1waWNrZXIvZGVsaXZlcnktbW9kZS1kYXRlLXBpY2tlci5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcmVxdWVzdGVkLWRlbGl2ZXJ5LWRhdGUvcm9vdC9jb21wb25lbnRzL2RlbGl2ZXJ5LW1vZGUtZGF0ZS1waWNrZXIvZGVsaXZlcnktbW9kZS1kYXRlLXBpY2tlci5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFPQSxPQUFPLEVBQUUsU0FBUyxFQUFxQixRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDdkUsT0FBTyxFQUFFLFdBQVcsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUV4RCxPQUFPLEVBQUUsOENBQThDLEVBQUUsTUFBTSwrQkFBK0IsQ0FBQztBQUMvRixPQUFPLEVBQ0wsVUFBVSxFQUVWLFlBQVksRUFDWixvQkFBb0IsRUFDcEIsaUJBQWlCLEVBQ2pCLGtCQUFrQixHQUNuQixNQUFNLGlCQUFpQixDQUFDO0FBQ3pCLE9BQU8sRUFBUSxpQkFBaUIsRUFBRSxNQUFNLHVCQUF1QixDQUFDO0FBQ2hFLE9BQU8sRUFBYyxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDaEQsT0FBTyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQUM3QyxPQUFPLEVBQUUsMkJBQTJCLEVBQUUsTUFBTSw2Q0FBNkMsQ0FBQztBQUMxRixPQUFPLEVBQUUscUJBQXFCLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQzs7Ozs7Ozs7QUFPMUUsTUFBTSxPQUFPLCtCQUErQjtJQUMxQyxZQUNZ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LEVBQUUsb0NBQW9DLEVBQUUsRUFDN0MsaUJBQWlCLENBQUMsY0FBYyxDQUNqQyxDQUFDO2lCQUNIO1lBQ0gsQ0FBQztTQUNGLENBQUMsQ0FDTCxDQUFDO0lBQ0osQ0FBQztJQUVELFNBQVMsQ0FBQyxRQUEyQjtRQUNuQyxPQUFPLENBQUMsUUFBUSxDQUFDLEtBQUssRUFBRSxNQUFNLENBQUMsQ0FBQyxNQUFNLENBQ3BDLENBQUMsS0FBVSxFQUFFLEVBQUUsQ0FBQyxLQUFLLEVBQUUsSUFBSSxLQUFLLHNCQUFzQixDQUN2RCxDQUFDO0lBQ0osQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsWUFBWSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2xDLENBQUM7OzRIQS9IVSwrQkFBK0I7Z0hBQS9CLCtCQUErQixtREFGL0IsQ0FBQyxVQUFVLENBQUMsMEJDNUJ6QixvOUJBOEJBOzJGREFhLCtCQUErQjtrQkFMM0MsU0FBUzsrQkFDRSwwQkFBMEIsYUFFekIsQ0FBQyxVQUFVLENBQUM7OzBCQVVwQixRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSHR0cEVycm9yUmVzcG9uc2UgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBDb21wb25lbnQsIE9uRGVzdHJveSwgT25Jbml0LCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgRm9ybUNvbnRyb2wsIEZvcm1Hcm91cCB9IGZyb20gJ0Bhbmd1bGFyL2Zvcm1zJztcbmltcG9ydCB7IENhcnQgfSBmcm9tICdAc3BhcnRhY3VzL2NhcnQvYmFzZS9yb290JztcbmltcG9ydCB7IENoZWNrb3V0U3VwcG9ydGVkRGVsaXZlcnlNb2Rlc1F1ZXJ5UmVsb2FkRXZlbnQgfSBmcm9tICdAc3BhcnRhY3VzL2NoZWNrb3V0L2Jhc2Uvcm9vdCc7XG5pbXBvcnQge1xuICBDeERhdGVQaXBlLFxuICBFcnJvck1vZGVsLFxuICBFdmVudFNlcnZpY2UsXG4gIEdsb2JhbE1lc3NhZ2VTZXJ2aWNlLFxuICBHbG9iYWxNZXNzYWdlVHlwZSxcbiAgVHJhbnNsYXRpb25TZXJ2aWNlLFxufSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgQ2FyZCwgT3V0bGV0Q29udGV4dERhdGEgfSBmcm9tICdAc3BhcnRhY3VzL3N0b3JlZnJvbnQnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJlcXVlc3RlZERlbGl2ZXJ5RGF0ZUZhY2FkZSB9IGZyb20gJy4uLy4uL2ZhY2FkZS9yZXF1ZXN0ZWQtZGVsaXZlcnktZGF0ZS5mYWNhZGUnO1xuaW1wb3J0IHsgRGF0ZVZhbGlkYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vc2hhcmVkL2RhdGUtdmFsaWRhdGlvbi5zZXJ2aWNlJztcblxuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnY3gtcmVxdWVzdC1kZWxpdmVyeS1kYXRlJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2RlbGl2ZXJ5LW1vZGUtZGF0ZS1waWNrZXIuY29tcG9uZW50Lmh0bWwnLFxuICBwcm92aWRlcnM6IFtDeERhdGVQaXBlXSxcbn0pXG5leHBvcnQgY2xhc3MgRGVsaXZlcnlNb2RlRGF0ZVBpY2tlckNvbXBvbmVudCBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGRhdGVQaXBlOiBDeERhdGVQaXBlLFxuICAgIHByb3RlY3RlZCByZXF1ZXN0ZWREZWxEYXRlRmFjYWRlOiBSZXF1ZXN0ZWREZWxpdmVyeURhdGVGYWNhZGUsXG4gICAgcHJvdGVjdGVkIGRhdGVWYWxpZGF0aW9uU2VydmljZTogRGF0ZVZhbGlkYXRpb25TZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBldmVudFNlcnZpY2U6IEV2ZW50U2VydmljZSxcbiAgICBwcm90ZWN0ZWQgdHJhbnNsYXRpb246IFRyYW5zbGF0aW9uU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgZ2xvYmFsTWVzc2FnZVNlcnZpY2U6IEdsb2JhbE1lc3NhZ2VTZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByb3RlY3RlZCBkZWxpdmVyeU91dGxldD86IE91dGxldENvbnRleHREYXRhXG4gICkge31cblxuICBwcm90ZWN0ZWQgY2FydEVudHJ5OiBDYXJ0ID0ge307XG4gIHByb3RlY3RlZCBzdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG5cbiAgcHJvdGVjdGVkIGVhcmxpZXN0UmV0cmlldmFsQXQ6IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgcHJvdGVjdGVkIHJlcXVlc3RlZFJldHJpZXZhbEF0OiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIHByb3RlY3RlZCBmb3JtOiBGb3JtR3JvdXAgPSBuZXcgRm9ybUdyb3VwKHtcbiAgICByZXF1ZXN0RGVsaXZlcnlEYXRlOiBuZXcgRm9ybUNvbnRyb2woKSxcbiAgfSk7XG4gIHByb3RlY3RlZCBpc0RhdGVQaWNrZXJSZWFkT25seTogYm9vbGVhbiA9IHRydWU7XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuZGVsaXZlcnlPdXRsZXQ/LmNvbnRleHQkKSB7XG4gICAgICB0aGlzLnN1YnNjcmlwdGlvbi5hZGQoXG4gICAgICAgIHRoaXMuZGVsaXZlcnlPdXRsZXQuY29udGV4dCQuc3Vic2NyaWJlKChjb250ZXh0KSA9PiB7XG4gICAgICAgICAgdGhpcy5jYXJ0RW50cnkgPSBjb250ZXh0Py5pdGVtO1xuICAgICAgICAgIHRoaXMuaXNEYXRlUGlja2VyUmVhZE9ubHkgPSBjb250ZXh0Py5yZWFkb25seSB8fCBmYWxzZTtcbiAgICAgICAgfSlcbiAgICAgICk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuaXNFYXJsaWVzdFJldHJpZXZhbERhdGVQcmVzZW50KCkpIHtcbiAgICAgIHRoaXMuZWFybGllc3RSZXRyaWV2YWxBdCA9IHRoaXMuY2FydEVudHJ5LmVhcmxpZXN0UmV0cmlldmFsQXQ7XG4gICAgfVxuICAgIGlmICh0aGlzLmlzUmVxdWVzdGVkRGVsaXZlcnlEYXRlUHJlc2VudCgpKSB7XG4gICAgICB0aGlzLnJlcXVlc3RlZFJldHJpZXZhbEF0ID0gdGhpcy5jYXJ0RW50cnkucmVxdWVzdGVkUmV0cmlldmFsQXQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vc2V0IHRoZSB2YWx1ZSBvZiByZXF1ZXN0ZWRSZXRyaWV2YWxBdCBhcyBlYXJsaWVzdFJldHJpZXZhbEF0IGFuZCB1cGRhdGUgb2NjLlxuICAgICAgdGhpcy5yZXF1ZXN0ZWRSZXRyaWV2YWxBdCA9IHRoaXMuZWFybGllc3RSZXRyaWV2YWxBdDtcbiAgICAgIHRoaXMuZm9ybS5wYXRjaFZhbHVlKHtcbiAgICAgICAgcmVxdWVzdERlbGl2ZXJ5RGF0ZTogdGhpcy5yZXF1ZXN0ZWRSZXRyaWV2YWxBdCxcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zZXRSZXF1ZXN0ZWREZWxpdmVyeURhdGUoKTtcbiAgICB9XG4gICAgdGhpcy5mb3JtLnBhdGNoVmFsdWUoe1xuICAgICAgcmVxdWVzdERlbGl2ZXJ5RGF0ZTogdGhpcy5yZXF1ZXN0ZWRSZXRyaWV2YWxBdCxcbiAgICB9KTtcbiAgfVxuXG4gIGlzRWFybGllc3RSZXRyaWV2YWxEYXRlUHJlc2VudCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5kYXRlVmFsaWRhdGlvblNlcnZpY2UuaXNEYXRlU3RyaW5nVmFsaWQoXG4gICAgICB0aGlzLmNhcnRFbnRyeT8uZWFybGllc3RSZXRyaWV2YWxBdFxuICAgICk7XG4gIH1cblxuICBpc1JlcXVlc3RlZERlbGl2ZXJ5RGF0ZVByZXNlbnQoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuZGF0ZVZhbGlkYXRpb25TZXJ2aWNlLmlzRGF0ZVN0cmluZ1ZhbGlkKFxuICAgICAgdGhpcy5jYXJ0RW50cnk/LnJlcXVlc3RlZFJldHJpZXZhbEF0XG4gICAgKTtcbiAgfVxuXG4gIGdldFJlcXVlc3RlZERlbGl2ZXJ5RGF0ZUNhcmRDb250ZW50KFxuICAgIGlzb0RhdGU6IHN0cmluZyB8IG51bGxcbiAgKTogT2JzZXJ2YWJsZTxDYXJkPiB7XG4gICAgcmV0dXJuIHRoaXMudHJhbnNsYXRpb25cbiAgICAgIC50cmFuc2xhdGUoJ3JlcXVlc3RlZERlbGl2ZXJ5RGF0ZS5yZWFkT25seVRleHRMYWJlbCcpXG4gICAgICAucGlwZShcbiAgICAgICAgZmlsdGVyKCgpID0+IEJvb2xlYW4oaXNvRGF0ZSkpLFxuICAgICAgICBtYXAoKHRleHRUaXRsZSkgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0ZXh0OiBbdGV4dFRpdGxlLCBpc29EYXRlXSxcbiAgICAgICAgICB9IGFzIENhcmQ7XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgc2V0UmVxdWVzdGVkRGVsaXZlcnlEYXRlKCkge1xuICAgIGNvbnN0IHVzZXJJZCA9IHRoaXMuY2FydEVudHJ5Py51c2VyPy51aWQgfHwgJyc7XG4gICAgY29uc3QgY2FydElkID0gdGhpcy5jYXJ0RW50cnk/LmNvZGUgfHwgJyc7XG4gICAgY29uc3QgcmVxdWVzdGVkRGF0ZSA9IHRoaXMuZm9ybT8uZ2V0KCdyZXF1ZXN0RGVsaXZlcnlEYXRlJyk/LnZhbHVlIHx8ICcnO1xuXG4gICAgaWYgKFxuICAgICAgdXNlcklkLmxlbmd0aCA9PT0gMCB8fFxuICAgICAgY2FydElkLmxlbmd0aCA9PT0gMCB8fFxuICAgICAgcmVxdWVzdGVkRGF0ZS5sZW5ndGggPT09IDAgfHxcbiAgICAgICF0aGlzLmRhdGVWYWxpZGF0aW9uU2VydmljZS5pc0RhdGVTdHJpbmdWYWxpZChyZXF1ZXN0ZWREYXRlKSB8fFxuICAgICAgIXRoaXMuZGF0ZVZhbGlkYXRpb25TZXJ2aWNlLmlzRGF0ZUdyZWF0ZXJPckVxdWFsKFxuICAgICAgICByZXF1ZXN0ZWREYXRlLFxuICAgICAgICB0aGlzLmVhcmxpZXN0UmV0cmlldmFsQXQgfHwgJydcbiAgICAgIClcbiAgICApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgdGhpcy5zdWJzY3JpcHRpb24uYWRkKFxuICAgICAgdGhpcy5yZXF1ZXN0ZWREZWxEYXRlRmFjYWRlXG4gICAgICAgIC5zZXRSZXF1ZXN0ZWREZWxpdmVyeURhdGUodXNlcklkLCBjYXJ0SWQsIHJlcXVlc3RlZERhdGUpXG4gICAgICAgIC5zdWJzY3JpYmUoe1xuICAgICAgICAgIG5leHQ6ICgpID0+IHtcbiAgICAgICAgICAgIHRoaXMuZXZlbnRTZXJ2aWNlLmRpc3BhdGNoKFxuICAgICAgICAgICAgICB7fSxcbiAgICAgICAgICAgICAgQ2hlY2tvdXRTdXBwb3J0ZWREZWxpdmVyeU1vZGVzUXVlcnlSZWxvYWRFdmVudFxuICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIHRoaXMuZ2xvYmFsTWVzc2FnZVNlcnZpY2UuYWRkKFxuICAgICAgICAgICAgICB7IGtleTogJ3JlcXVlc3RlZERlbGl2ZXJ5RGF0ZS5zdWNjZXNzTWVzc2FnZScgfSxcbiAgICAgICAgICAgICAgR2xvYmFsTWVzc2FnZVR5cGUuTVNHX1RZUEVfSU5GT1xuICAgICAgICAgICAgKTtcbiAgICAgICAgICB9LFxuICAgICAgICAgIGVycm9yOiAoZXJyb3I6IEh0dHBFcnJvclJlc3BvbnNlKSA9PiB7XG4gICAgICAgICAgICBpZiAoZXJyb3IgJiYgdGhpcy5nZXRFcnJvcnMoZXJyb3IpPy5sZW5ndGgpIHtcbiAgICAgICAgICAgICAgdGhpcy5nbG9iYWxNZXNzYWdlU2VydmljZS5hZGQoXG4gICAgICAgICAgICAgICAgeyBrZXk6ICdyZXF1ZXN0ZWREZWxpdmVyeURhdGUuZXJyb3JNZXNzYWdlJyB9LFxuICAgICAgICAgICAgICAgIEdsb2JhbE1lc3NhZ2VUeXBlLk1TR19UWVBFX0VSUk9SXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSxcbiAgICAgICAgfSlcbiAgICApO1xuICB9XG5cbiAgZ2V0RXJyb3JzKHJlc3BvbnNlOiBIdHRwRXJyb3JSZXNwb25zZSk6IEVycm9yTW9kZWxbXSB7XG4gICAgcmV0dXJuIChyZXNwb25zZS5lcnJvcj8uZXJyb3JzKS5maWx0ZXIoXG4gICAgICAoZXJyb3I6IGFueSkgPT4gZXJyb3I/LnR5cGUgPT09ICdVbmtub3duUmVzb3VyY2VFcnJvcidcbiAgICApO1xuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxufVxuIiwiPG5nLWNvbnRhaW5lciAqbmdJZj1cImlzRWFybGllc3RSZXRyaWV2YWxEYXRlUHJlc2VudCgpXCI+XG4gIDxuZy1jb250YWluZXIgKm5nSWY9XCJpc0RhdGVQaWNrZXJSZWFkT25seTsgZWxzZSBkYXRlUGlja2VyRW5hYmxlZFwiPlxuICAgIDxjeC1jYXJkXG4gICAgICBbY29udGVudF09XCJcbiAgICAgICAgZ2V0UmVxdWVzdGVkRGVsaXZlcnlEYXRlQ2FyZENvbnRlbnQocmVxdWVzdGVkUmV0cmlldmFsQXQgfCBjeERhdGUpXG4gICAgICAgICAgfCBhc3luY1xuICAgICAgXCJcbiAgICA+PC9jeC1jYXJkPlxuICA8L25nLWNvbnRhaW5lcj5cbiAgPG5nLXRlbXBsYXRlICNkYXRlUGlja2VyRW5hYmxlZD5cbiAgICA8ZGl2IGNsYXNzPVwiZm9ybS1jaGVja1wiPlxuICAgICAgPGZvcm0gW2Zvcm1Hcm91cF09XCJmb3JtXCI+XG4gICAgICAgIDxsYWJlbCBjbGFzcz1cInJvd1wiPlxuICAgICAgICAgIDxkaXYgY2xhc3M9XCJwbC00IGNvbC04XCI+XG4gICAgICAgICAgICB7eyAncmVxdWVzdGVkRGVsaXZlcnlEYXRlLmRhdGVQaWNrZXJMYWJlbCcgfCBjeFRyYW5zbGF0ZSB9fVxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxkaXYgY2xhc3M9XCJjb2wtNFwiPlxuICAgICAgICAgICAgPGN4LWRhdGUtcGlja2VyXG4gICAgICAgICAgICAgIFtjb250cm9sXT1cIiRhbnkoZm9ybS5nZXQoJ3JlcXVlc3REZWxpdmVyeURhdGUnKSlcIlxuICAgICAgICAgICAgICBbbWluXT1cImVhcmxpZXN0UmV0cmlldmFsQXRcIlxuICAgICAgICAgICAgICBbcmVxdWlyZWRdPVwidHJ1ZVwiXG4gICAgICAgICAgICAgICh1cGRhdGUpPVwic2V0UmVxdWVzdGVkRGVsaXZlcnlEYXRlKClcIlxuICAgICAgICAgICAgPlxuICAgICAgICAgICAgPC9jeC1kYXRlLXBpY2tlcj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9sYWJlbD5cbiAgICAgIDwvZm9ybT5cbiAgICA8L2Rpdj5cbiAgPC9uZy10ZW1wbGF0ZT5cbjwvbmctY29udGFpbmVyPlxuIl19