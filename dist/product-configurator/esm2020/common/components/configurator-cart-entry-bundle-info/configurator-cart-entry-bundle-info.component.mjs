/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Component, Optional } from '@angular/core';
import { EMPTY } from 'rxjs';
import { map, take } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "../../shared/utils/common-configurator-utils.service";
import * as i2 from "./configurator-cart-entry-bundle-info.service";
import * as i3 from "@spartacus/storefront";
import * as i4 from "@spartacus/core";
import * as i5 from "@spartacus/cart/base/root";
import * as i6 from "@angular/common";
import * as i7 from "../configure-cart-entry/configure-cart-entry.component";
/**
 * Requires default change detection strategy, as the disabled state of the quantity from control may change,
 * which would not be proper detected with onPush strategy.
 */
export class ConfiguratorCartEntryBundleInfoComponent {
    constructor(commonConfigUtilsService, configCartEntryBundleInfoService, breakpointService, translation, cartItemContext) {
        this.commonConfigUtilsService = commonConfigUtilsService;
        this.configCartEntryBundleInfoService = configCartEntryBundleInfoService;
        this.breakpointService = breakpointService;
        this.translation = translation;
        this.cartItemContext = cartItemContext;
        this.orderEntry$ = this.cartItemContext?.item$ ?? EMPTY;
        this.quantityControl$ = this.cartItemContext?.quantityControl$ ?? EMPTY;
        this.readonly$ = this.cartItemContext?.readonly$ ?? EMPTY;
        this.hideItems = true;
        this.lineItems$ = this.orderEntry$.pipe(map((entry) => this.configCartEntryBundleInfoService.retrieveLineItems(entry)));
        this.numberOfLineItems$ = this.lineItems$.pipe(map((items) => items.length));
        // TODO: remove the logic below when configurable products support "Saved Cart" and "Save For Later"
        this.shouldShowButton$ = this.commonConfigUtilsService.isActiveCartContext(this.cartItemContext);
    }
    /**
     * Toggles the state of the items list.
     */
    toggleItems() {
        this.hideItems = !this.hideItems;
    }
    /**
     * Verifies whether the configurator type is a bundle based one.
     *
     * @param {OrderEntry} entry - Order entry
     * @returns {boolean} - 'true' if the expected configurator type, otherwise 'false'
     */
    isBundleBasedConfigurator(entry) {
        const configInfos = entry.configurationInfos;
        return configInfos
            ? this.commonConfigUtilsService.isBundleBasedConfigurator(configInfos[0]?.configuratorType)
            : false;
    }
    getButtonText(translatedText) {
        if (!translatedText) {
            translatedText = '';
        }
        if (this.hideItems) {
            this.translation
                .translate('configurator.header.show')
                .pipe(take(1))
                .subscribe((text) => (translatedText += text));
        }
        else {
            this.translation
                .translate('configurator.header.hide')
                .pipe(take(1))
                .subscribe((text) => (translatedText += text));
        }
        return translatedText;
    }
    getItemsMsg(items) {
        let translatedText = '';
        this.translation
            .translate('configurator.a11y.cartEntryBundleInfo', { items: items })
            .pipe(take(1))
            .subscribe((text) => (translatedText = text));
        return this.getButtonText(translatedText);
    }
    getHiddenItemInfo(item) {
        let translatedText = '';
        if (item.name && item.formattedPrice && item.formattedQuantity) {
            this.translation
                .translate('configurator.a11y.cartEntryBundle', {
                name: item.name,
                price: item.formattedPrice,
                quantity: item.formattedQuantity,
            })
                .pipe(take(1))
                .subscribe((text) => (translatedText = text));
        }
        else if (item.name && item.formattedPrice) {
            this.translation
                .translate('configurator.a11y.cartEntryBundleNameWithPrice', {
                name: item.name,
                price: item.formattedPrice,
            })
                .pipe(take(1))
                .subscribe((text) => (translatedText = text));
        }
        else if (item.name && item.formattedQuantity) {
            this.translation
                .translate('configurator.a11y.cartEntryBundleNameWithQuantity', {
                name: item.name,
                quantity: item.formattedQuantity,
            })
                .pipe(take(1))
                .subscribe((text) => (translatedText = text));
        }
        else {
            this.translation
                .translate('configurator.a11y.cartEntryBundleName', {
                name: item.name,
            })
                .pipe(take(1))
                .subscribe((text) => (translatedText = text));
        }
        return translatedText;
    }
    getHiddenItemInfoId(index) {
        return 'cx-item-hidden-info-' + index.toString();
    }
}
ConfiguratorCartEntryBundleInfoComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ConfiguratorCartEntryBundleInfoComponent, deps: [{ token: i1.CommonConfiguratorUtilsService }, { token: i2.ConfiguratorCartEntryBundleInfoService }, { token: i3.BreakpointService }, { token: i4.TranslationService }, { token: i5.CartItemContext, optional: true }], target: i0.ɵɵFactoryTarget.Component });
ConfiguratorCartEntryBundleInfoComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.9", type: ConfiguratorCartEntryBundleInfoComponent, selector: "cx-configurator-cart-entry-bundle-info", ngImport: i0, template: "<ng-container *ngIf=\"orderEntry$ | async as orderEntry\">\n  <ng-container *ngIf=\"isBundleBasedConfigurator(orderEntry)\">\n    <ng-container *ngIf=\"numberOfLineItems$ | async as numberOfItems\">\n      <div class=\"cx-number-items\">\n        {{\n          'configurator.header.items' | cxTranslate: { count: numberOfItems }\n        }}\n      </div>\n      <button\n        (click)=\"toggleItems()\"\n        [attr.aria-expanded]=\"!this.hideItems\"\n        [attr.aria-label]=\"getItemsMsg(numberOfItems)\"\n      >\n        <div class=\"cx-toggle-hide-items\">\n          {{ getButtonText() }}\n        </div>\n      </button>\n\n      <div class=\"cx-item-infos\" [class.open]=\"!hideItems\">\n        <div\n          *ngFor=\"let lineItem of lineItems$ | async; let i = index\"\n          class=\"cx-item-info\"\n          attr.aria-describedby=\"{{ getHiddenItemInfoId(i) }}\"\n        >\n          <span id=\"{{ getHiddenItemInfoId(i) }}\" class=\"cx-visually-hidden\">\n            {{ getHiddenItemInfo(lineItem) }}\n          </span>\n          <div class=\"cx-item-name\" aria-hidden=\"true\">\n            {{ lineItem?.name }}\n          </div>\n          <div class=\"cx-item-quantity\" aria-hidden=\"true\">\n            <ng-container *ngIf=\"lineItem?.formattedQuantity\">\n              <span class=\"cx-identifier\">{{\n                'configurator.attribute.quantity' | cxTranslate\n              }}</span>\n              <span class=\"cx-item\">{{\n                lineItem?.formattedQuantity | cxNumeric\n              }}</span>\n            </ng-container>\n          </div>\n          <div class=\"cx-item-price\" aria-hidden=\"true\">\n            <ng-container *ngIf=\"lineItem?.formattedPrice\">\n              <span class=\"cx-identifier\">{{\n                'configurator.overviewForm.itemPrice' | cxTranslate\n              }}</span>\n              <span class=\"cx-item\">{{ lineItem?.formattedPrice }}</span>\n            </ng-container>\n          </div>\n        </div>\n      </div>\n    </ng-container>\n    <ng-container *ngIf=\"quantityControl$ | async as quantityControl\">\n      <cx-configure-cart-entry\n        *ngIf=\"(shouldShowButton$ | async) && orderEntry?.product?.configurable\"\n        [cartEntry]=\"orderEntry\"\n        [readOnly]=\"(readonly$ | async) ?? true\"\n        [msgBanner]=\"false\"\n        [disabled]=\"quantityControl.disabled\"\n      ></cx-configure-cart-entry\n    ></ng-container>\n  </ng-container>\n</ng-container>\n", dependencies: [{ kind: "directive", type: i6.NgForOf, selector: "[ngFor][ngForOf]", inputs: ["ngForOf", "ngForTrackBy", "ngForTemplate"] }, { kind: "directive", type: i6.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i7.ConfigureCartEntryComponent, selector: "cx-configure-cart-entry", inputs: ["cartEntry", "readOnly", "msgBanner", "disabled"] }, { kind: "pipe", type: i6.AsyncPipe, name: "async" }, { kind: "pipe", type: i4.TranslatePipe, name: "cxTranslate" }, { kind: "pipe", type: i4.CxNumericPipe, name: "cxNumeric" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ConfiguratorCartEntryBundleInfoComponent, decorators: [{
            type: Component,
            args: [{ selector: 'cx-configurator-cart-entry-bundle-info', template: "<ng-container *ngIf=\"orderEntry$ | async as orderEntry\">\n  <ng-container *ngIf=\"isBundleBasedConfigurator(orderEntry)\">\n    <ng-container *ngIf=\"numberOfLineItems$ | async as numberOfItems\">\n      <div class=\"cx-number-items\">\n        {{\n          'configurator.header.items' | cxTranslate: { count: numberOfItems }\n        }}\n      </div>\n      <button\n        (click)=\"toggleItems()\"\n        [attr.aria-expanded]=\"!this.hideItems\"\n        [attr.aria-label]=\"getItemsMsg(numberOfItems)\"\n      >\n        <div class=\"cx-toggle-hide-items\">\n          {{ getButtonText() }}\n        </div>\n      </button>\n\n      <div class=\"cx-item-infos\" [class.open]=\"!hideItems\">\n        <div\n          *ngFor=\"let lineItem of lineItems$ | async; let i = index\"\n          class=\"cx-item-info\"\n          attr.aria-describedby=\"{{ getHiddenItemInfoId(i) }}\"\n        >\n          <span id=\"{{ getHiddenItemInfoId(i) }}\" class=\"cx-visually-hidden\">\n            {{ getHiddenItemInfo(lineItem) }}\n          </span>\n          <div class=\"cx-item-name\" aria-hidden=\"true\">\n            {{ lineItem?.name }}\n          </div>\n          <div class=\"cx-item-quantity\" aria-hidden=\"true\">\n            <ng-container *ngIf=\"lineItem?.formattedQuantity\">\n              <span class=\"cx-identifier\">{{\n                'configurator.attribute.quantity' | cxTranslate\n              }}</span>\n              <span class=\"cx-item\">{{\n                lineItem?.formattedQuantity | cxNumeric\n              }}</span>\n            </ng-container>\n          </div>\n          <div class=\"cx-item-price\" aria-hidden=\"true\">\n            <ng-container *ngIf=\"lineItem?.formattedPrice\">\n              <span class=\"cx-identifier\">{{\n                'configurator.overviewForm.itemPrice' | cxTranslate\n              }}</span>\n              <span class=\"cx-item\">{{ lineItem?.formattedPrice }}</span>\n            </ng-container>\n          </div>\n        </div>\n      </div>\n    </ng-container>\n    <ng-container *ngIf=\"quantityControl$ | async as quantityControl\">\n      <cx-configure-cart-entry\n        *ngIf=\"(shouldShowButton$ | async) && orderEntry?.product?.configurable\"\n        [cartEntry]=\"orderEntry\"\n        [readOnly]=\"(readonly$ | async) ?? true\"\n        [msgBanner]=\"false\"\n        [disabled]=\"quantityControl.disabled\"\n      ></cx-configure-cart-entry\n    ></ng-container>\n  </ng-container>\n</ng-container>\n" }]
        }], ctorParameters: function () { return [{ type: i1.CommonConfiguratorUtilsService }, { type: i2.ConfiguratorCartEntryBundleInfoService }, { type: i3.BreakpointService }, { type: i4.TranslationService }, { type: i5.CartItemContext, decorators: [{
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlndXJhdG9yLWNhcnQtZW50cnktYnVuZGxlLWluZm8uY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL3Byb2R1Y3QtY29uZmlndXJhdG9yL2NvbW1vbi9jb21wb25lbnRzL2NvbmZpZ3VyYXRvci1jYXJ0LWVudHJ5LWJ1bmRsZS1pbmZvL2NvbmZpZ3VyYXRvci1jYXJ0LWVudHJ5LWJ1bmRsZS1pbmZvLmNvbXBvbmVudC50cyIsIi4uLy4uLy4uLy4uLy4uLy4uL2ZlYXR1cmUtbGlicy9wcm9kdWN0LWNvbmZpZ3VyYXRvci9jb21tb24vY29tcG9uZW50cy9jb25maWd1cmF0b3ItY2FydC1lbnRyeS1idW5kbGUtaW5mby9jb25maWd1cmF0b3ItY2FydC1lbnRyeS1idW5kbGUtaW5mby5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUFFLFNBQVMsRUFBRSxRQUFRLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFLcEQsT0FBTyxFQUFFLEtBQUssRUFBYyxNQUFNLE1BQU0sQ0FBQztBQUN6QyxPQUFPLEVBQUUsR0FBRyxFQUFFLElBQUksRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7Ozs7Ozs7QUFLM0M7OztHQUdHO0FBS0gsTUFBTSxPQUFPLHdDQUF3QztJQUNuRCxZQUNZLHdCQUF3RCxFQUN4RCxnQ0FBd0UsRUFDeEUsaUJBQW9DLEVBQ3BDLFdBQStCLEVBQ25CLGVBQWlDO1FBSjdDLDZCQUF3QixHQUF4Qix3QkFBd0IsQ0FBZ0M7UUFDeEQscUNBQWdDLEdBQWhDLGdDQUFnQyxDQUF3QztRQUN4RSxzQkFBaUIsR0FBakIsaUJBQWlCLENBQW1CO1FBQ3BDLGdCQUFXLEdBQVgsV0FBVyxDQUFvQjtRQUNuQixvQkFBZSxHQUFmLGVBQWUsQ0FBa0I7UUFHaEQsZ0JBQVcsR0FDbEIsSUFBSSxDQUFDLGVBQWUsRUFBRSxLQUFLLElBQUksS0FBSyxDQUFDO1FBRTlCLHFCQUFnQixHQUN2QixJQUFJLENBQUMsZUFBZSxFQUFFLGdCQUFnQixJQUFJLEtBQUssQ0FBQztRQUV6QyxjQUFTLEdBQ2hCLElBQUksQ0FBQyxlQUFlLEVBQUUsU0FBUyxJQUFJLEtBQUssQ0FBQztRQUUzQyxjQUFTLEdBQUcsSUFBSSxDQUFDO1FBRWpCLGVBQVUsR0FBMkIsSUFBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQ3hELEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQ1osSUFBSSxDQUFDLGdDQUFnQyxDQUFDLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxDQUMvRCxDQUNGLENBQUM7UUFFRix1QkFBa0IsR0FBdUIsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQzNELEdBQUcsQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUM3QixDQUFDO1FBd0JGLG9HQUFvRztRQUMzRixzQkFBaUIsR0FDeEIsSUFBSSxDQUFDLHdCQUF3QixDQUFDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztJQS9DdkUsQ0FBQztJQXVCSjs7T0FFRztJQUNILFdBQVc7UUFDVCxJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQztJQUNuQyxDQUFDO0lBRUQ7Ozs7O09BS0c7SUFDSCx5QkFBeUIsQ0FBQyxLQUFpQjtRQUN6QyxNQUFNLFdBQVcsR0FBRyxLQUFLLENBQUMsa0JBQWtCLENBQUM7UUFDN0MsT0FBTyxXQUFXO1lBQ2hCLENBQUMsQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMseUJBQXlCLENBQ3JELFdBQVcsQ0FBQyxDQUFDLENBQUMsRUFBRSxnQkFBZ0IsQ0FDakM7WUFDSCxDQUFDLENBQUMsS0FBSyxDQUFDO0lBQ1osQ0FBQztJQU1ELGFBQWEsQ0FBQyxjQUF1QjtRQUNuQyxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ25CLGNBQWMsR0FBRyxFQUFFLENBQUM7U0FDckI7UUFDRCxJQUFJLElBQUksQ0FBQyxTQUFTLEVBQUU7WUFDbEIsSUFBSSxDQUFDLFdBQVc7aUJBQ2IsU0FBUyxDQUFDLDBCQUEwQixDQUFDO2lCQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNiLFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNsRDthQUFNO1lBQ0wsSUFBSSxDQUFDLFdBQVc7aUJBQ2IsU0FBUyxDQUFDLDBCQUEwQixDQUFDO2lCQUNyQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNiLFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxjQUFjLElBQUksSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNsRDtRQUVELE9BQU8sY0FBYyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxXQUFXLENBQUMsS0FBYTtRQUN2QixJQUFJLGNBQWMsR0FBRyxFQUFFLENBQUM7UUFDeEIsSUFBSSxDQUFDLFdBQVc7YUFDYixTQUFTLENBQUMsdUNBQXVDLEVBQUUsRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLENBQUM7YUFDcEUsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQzthQUNiLFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztRQUVoRCxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUM7SUFDNUMsQ0FBQztJQUVELGlCQUFpQixDQUFDLElBQWM7UUFDOUIsSUFBSSxjQUFjLEdBQUcsRUFBRSxDQUFDO1FBRXhCLElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsY0FBYyxJQUFJLElBQUksQ0FBQyxpQkFBaUIsRUFBRTtZQUM5RCxJQUFJLENBQUMsV0FBVztpQkFDYixTQUFTLENBQUMsbUNBQW1DLEVBQUU7Z0JBQzlDLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtnQkFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLGNBQWM7Z0JBQzFCLFFBQVEsRUFBRSxJQUFJLENBQUMsaUJBQWlCO2FBQ2pDLENBQUM7aUJBQ0QsSUFBSSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztpQkFDYixTQUFTLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsY0FBYyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7U0FDakQ7YUFBTSxJQUFJLElBQUksQ0FBQyxJQUFJLElBQUksSUFBSSxDQUFDLGNBQWMsRUFBRTtZQUMzQyxJQUFJLENBQUMsV0FBVztpQkFDYixTQUFTLENBQUMsZ0RBQWdELEVBQUU7Z0JBQzNELElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtnQkFDZixLQUFLLEVBQUUsSUFBSSxDQUFDLGNBQWM7YUFDM0IsQ0FBQztpQkFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNiLFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNqRDthQUFNLElBQUksSUFBSSxDQUFDLElBQUksSUFBSSxJQUFJLENBQUMsaUJBQWlCLEVBQUU7WUFDOUMsSUFBSSxDQUFDLFdBQVc7aUJBQ2IsU0FBUyxDQUFDLG1EQUFtRCxFQUFFO2dCQUM5RCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7Z0JBQ2YsUUFBUSxFQUFFLElBQUksQ0FBQyxpQkFBaUI7YUFDakMsQ0FBQztpQkFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNiLFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNqRDthQUFNO1lBQ0wsSUFBSSxDQUFDLFdBQVc7aUJBQ2IsU0FBUyxDQUFDLHVDQUF1QyxFQUFFO2dCQUNsRCxJQUFJLEVBQUUsSUFBSSxDQUFDLElBQUk7YUFDaEIsQ0FBQztpQkFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO2lCQUNiLFNBQVMsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLENBQUMsQ0FBQztTQUNqRDtRQUVELE9BQU8sY0FBYyxDQUFDO0lBQ3hCLENBQUM7SUFFRCxtQkFBbUIsQ0FBQyxLQUFhO1FBQy9CLE9BQU8sc0JBQXNCLEdBQUcsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ25ELENBQUM7O3FJQS9IVSx3Q0FBd0M7eUhBQXhDLHdDQUF3Qyw4RUN6QnJELCs3RUE4REE7MkZEckNhLHdDQUF3QztrQkFKcEQsU0FBUzsrQkFDRSx3Q0FBd0M7OzBCQVMvQyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgQ29tcG9uZW50LCBPcHRpb25hbCB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgVW50eXBlZEZvcm1Db250cm9sIH0gZnJvbSAnQGFuZ3VsYXIvZm9ybXMnO1xuaW1wb3J0IHsgQ2FydEl0ZW1Db250ZXh0LCBPcmRlckVudHJ5IH0gZnJvbSAnQHNwYXJ0YWN1cy9jYXJ0L2Jhc2Uvcm9vdCc7XG5pbXBvcnQgeyBUcmFuc2xhdGlvblNlcnZpY2UgfSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgQnJlYWtwb2ludFNlcnZpY2UgfSBmcm9tICdAc3BhcnRhY3VzL3N0b3JlZnJvbnQnO1xuaW1wb3J0IHsgRU1QVFksIE9ic2VydmFibGUgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IG1hcCwgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENvbW1vbkNvbmZpZ3VyYXRvclV0aWxzU2VydmljZSB9IGZyb20gJy4uLy4uL3NoYXJlZC91dGlscy9jb21tb24tY29uZmlndXJhdG9yLXV0aWxzLnNlcnZpY2UnO1xuaW1wb3J0IHsgTGluZUl0ZW0gfSBmcm9tICcuL2NvbmZpZ3VyYXRvci1jYXJ0LWVudHJ5LWJ1bmRsZS1pbmZvLm1vZGVsJztcbmltcG9ydCB7IENvbmZpZ3VyYXRvckNhcnRFbnRyeUJ1bmRsZUluZm9TZXJ2aWNlIH0gZnJvbSAnLi9jb25maWd1cmF0b3ItY2FydC1lbnRyeS1idW5kbGUtaW5mby5zZXJ2aWNlJztcblxuLyoqXG4gKiBSZXF1aXJlcyBkZWZhdWx0IGNoYW5nZSBkZXRlY3Rpb24gc3RyYXRlZ3ksIGFzIHRoZSBkaXNhYmxlZCBzdGF0ZSBvZiB0aGUgcXVhbnRpdHkgZnJvbSBjb250cm9sIG1heSBjaGFuZ2UsXG4gKiB3aGljaCB3b3VsZCBub3QgYmUgcHJvcGVyIGRldGVjdGVkIHdpdGggb25QdXNoIHN0cmF0ZWd5LlxuICovXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjeC1jb25maWd1cmF0b3ItY2FydC1lbnRyeS1idW5kbGUtaW5mbycsXG4gIHRlbXBsYXRlVXJsOiAnLi9jb25maWd1cmF0b3ItY2FydC1lbnRyeS1idW5kbGUtaW5mby5jb21wb25lbnQuaHRtbCcsXG59KVxuZXhwb3J0IGNsYXNzIENvbmZpZ3VyYXRvckNhcnRFbnRyeUJ1bmRsZUluZm9Db21wb25lbnQge1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgY29tbW9uQ29uZmlnVXRpbHNTZXJ2aWNlOiBDb21tb25Db25maWd1cmF0b3JVdGlsc1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGNvbmZpZ0NhcnRFbnRyeUJ1bmRsZUluZm9TZXJ2aWNlOiBDb25maWd1cmF0b3JDYXJ0RW50cnlCdW5kbGVJbmZvU2VydmljZSxcbiAgICBwcm90ZWN0ZWQgYnJlYWtwb2ludFNlcnZpY2U6IEJyZWFrcG9pbnRTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCB0cmFuc2xhdGlvbjogVHJhbnNsYXRpb25TZXJ2aWNlLFxuICAgIEBPcHRpb25hbCgpIHByb3RlY3RlZCBjYXJ0SXRlbUNvbnRleHQ/OiBDYXJ0SXRlbUNvbnRleHRcbiAgKSB7fVxuXG4gIHJlYWRvbmx5IG9yZGVyRW50cnkkOiBPYnNlcnZhYmxlPE9yZGVyRW50cnk+ID1cbiAgICB0aGlzLmNhcnRJdGVtQ29udGV4dD8uaXRlbSQgPz8gRU1QVFk7XG5cbiAgcmVhZG9ubHkgcXVhbnRpdHlDb250cm9sJDogT2JzZXJ2YWJsZTxVbnR5cGVkRm9ybUNvbnRyb2w+ID1cbiAgICB0aGlzLmNhcnRJdGVtQ29udGV4dD8ucXVhbnRpdHlDb250cm9sJCA/PyBFTVBUWTtcblxuICByZWFkb25seSByZWFkb25seSQ6IE9ic2VydmFibGU8Ym9vbGVhbj4gPVxuICAgIHRoaXMuY2FydEl0ZW1Db250ZXh0Py5yZWFkb25seSQgPz8gRU1QVFk7XG5cbiAgaGlkZUl0ZW1zID0gdHJ1ZTtcblxuICBsaW5lSXRlbXMkOiBPYnNlcnZhYmxlPExpbmVJdGVtW10+ID0gdGhpcy5vcmRlckVudHJ5JC5waXBlKFxuICAgIG1hcCgoZW50cnkpID0+XG4gICAgICB0aGlzLmNvbmZpZ0NhcnRFbnRyeUJ1bmRsZUluZm9TZXJ2aWNlLnJldHJpZXZlTGluZUl0ZW1zKGVudHJ5KVxuICAgIClcbiAgKTtcblxuICBudW1iZXJPZkxpbmVJdGVtcyQ6IE9ic2VydmFibGU8bnVtYmVyPiA9IHRoaXMubGluZUl0ZW1zJC5waXBlKFxuICAgIG1hcCgoaXRlbXMpID0+IGl0ZW1zLmxlbmd0aClcbiAgKTtcblxuICAvKipcbiAgICogVG9nZ2xlcyB0aGUgc3RhdGUgb2YgdGhlIGl0ZW1zIGxpc3QuXG4gICAqL1xuICB0b2dnbGVJdGVtcygpOiB2b2lkIHtcbiAgICB0aGlzLmhpZGVJdGVtcyA9ICF0aGlzLmhpZGVJdGVtcztcbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmllcyB3aGV0aGVyIHRoZSBjb25maWd1cmF0b3IgdHlwZSBpcyBhIGJ1bmRsZSBiYXNlZCBvbmUuXG4gICAqXG4gICAqIEBwYXJhbSB7T3JkZXJFbnRyeX0gZW50cnkgLSBPcmRlciBlbnRyeVxuICAgKiBAcmV0dXJucyB7Ym9vbGVhbn0gLSAndHJ1ZScgaWYgdGhlIGV4cGVjdGVkIGNvbmZpZ3VyYXRvciB0eXBlLCBvdGhlcndpc2UgJ2ZhbHNlJ1xuICAgKi9cbiAgaXNCdW5kbGVCYXNlZENvbmZpZ3VyYXRvcihlbnRyeTogT3JkZXJFbnRyeSk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGNvbmZpZ0luZm9zID0gZW50cnkuY29uZmlndXJhdGlvbkluZm9zO1xuICAgIHJldHVybiBjb25maWdJbmZvc1xuICAgICAgPyB0aGlzLmNvbW1vbkNvbmZpZ1V0aWxzU2VydmljZS5pc0J1bmRsZUJhc2VkQ29uZmlndXJhdG9yKFxuICAgICAgICAgIGNvbmZpZ0luZm9zWzBdPy5jb25maWd1cmF0b3JUeXBlXG4gICAgICAgIClcbiAgICAgIDogZmFsc2U7XG4gIH1cblxuICAvLyBUT0RPOiByZW1vdmUgdGhlIGxvZ2ljIGJlbG93IHdoZW4gY29uZmlndXJhYmxlIHByb2R1Y3RzIHN1cHBvcnQgXCJTYXZlZCBDYXJ0XCIgYW5kIFwiU2F2ZSBGb3IgTGF0ZXJcIlxuICByZWFkb25seSBzaG91bGRTaG93QnV0dG9uJDogT2JzZXJ2YWJsZTxib29sZWFuPiA9XG4gICAgdGhpcy5jb21tb25Db25maWdVdGlsc1NlcnZpY2UuaXNBY3RpdmVDYXJ0Q29udGV4dCh0aGlzLmNhcnRJdGVtQ29udGV4dCk7XG5cbiAgZ2V0QnV0dG9uVGV4dCh0cmFuc2xhdGVkVGV4dD86IHN0cmluZyk6IHN0cmluZyB7XG4gICAgaWYgKCF0cmFuc2xhdGVkVGV4dCkge1xuICAgICAgdHJhbnNsYXRlZFRleHQgPSAnJztcbiAgICB9XG4gICAgaWYgKHRoaXMuaGlkZUl0ZW1zKSB7XG4gICAgICB0aGlzLnRyYW5zbGF0aW9uXG4gICAgICAgIC50cmFuc2xhdGUoJ2NvbmZpZ3VyYXRvci5oZWFkZXIuc2hvdycpXG4gICAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAgIC5zdWJzY3JpYmUoKHRleHQpID0+ICh0cmFuc2xhdGVkVGV4dCArPSB0ZXh0KSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMudHJhbnNsYXRpb25cbiAgICAgICAgLnRyYW5zbGF0ZSgnY29uZmlndXJhdG9yLmhlYWRlci5oaWRlJylcbiAgICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgICAgLnN1YnNjcmliZSgodGV4dCkgPT4gKHRyYW5zbGF0ZWRUZXh0ICs9IHRleHQpKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJhbnNsYXRlZFRleHQ7XG4gIH1cblxuICBnZXRJdGVtc01zZyhpdGVtczogbnVtYmVyKTogc3RyaW5nIHtcbiAgICBsZXQgdHJhbnNsYXRlZFRleHQgPSAnJztcbiAgICB0aGlzLnRyYW5zbGF0aW9uXG4gICAgICAudHJhbnNsYXRlKCdjb25maWd1cmF0b3IuYTExeS5jYXJ0RW50cnlCdW5kbGVJbmZvJywgeyBpdGVtczogaXRlbXMgfSlcbiAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAuc3Vic2NyaWJlKCh0ZXh0KSA9PiAodHJhbnNsYXRlZFRleHQgPSB0ZXh0KSk7XG5cbiAgICByZXR1cm4gdGhpcy5nZXRCdXR0b25UZXh0KHRyYW5zbGF0ZWRUZXh0KTtcbiAgfVxuXG4gIGdldEhpZGRlbkl0ZW1JbmZvKGl0ZW06IExpbmVJdGVtKTogc3RyaW5nIHtcbiAgICBsZXQgdHJhbnNsYXRlZFRleHQgPSAnJztcblxuICAgIGlmIChpdGVtLm5hbWUgJiYgaXRlbS5mb3JtYXR0ZWRQcmljZSAmJiBpdGVtLmZvcm1hdHRlZFF1YW50aXR5KSB7XG4gICAgICB0aGlzLnRyYW5zbGF0aW9uXG4gICAgICAgIC50cmFuc2xhdGUoJ2NvbmZpZ3VyYXRvci5hMTF5LmNhcnRFbnRyeUJ1bmRsZScsIHtcbiAgICAgICAgICBuYW1lOiBpdGVtLm5hbWUsXG4gICAgICAgICAgcHJpY2U6IGl0ZW0uZm9ybWF0dGVkUHJpY2UsXG4gICAgICAgICAgcXVhbnRpdHk6IGl0ZW0uZm9ybWF0dGVkUXVhbnRpdHksXG4gICAgICAgIH0pXG4gICAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAgIC5zdWJzY3JpYmUoKHRleHQpID0+ICh0cmFuc2xhdGVkVGV4dCA9IHRleHQpKTtcbiAgICB9IGVsc2UgaWYgKGl0ZW0ubmFtZSAmJiBpdGVtLmZvcm1hdHRlZFByaWNlKSB7XG4gICAgICB0aGlzLnRyYW5zbGF0aW9uXG4gICAgICAgIC50cmFuc2xhdGUoJ2NvbmZpZ3VyYXRvci5hMTF5LmNhcnRFbnRyeUJ1bmRsZU5hbWVXaXRoUHJpY2UnLCB7XG4gICAgICAgICAgbmFtZTogaXRlbS5uYW1lLFxuICAgICAgICAgIHByaWNlOiBpdGVtLmZvcm1hdHRlZFByaWNlLFxuICAgICAgICB9KVxuICAgICAgICAucGlwZSh0YWtlKDEpKVxuICAgICAgICAuc3Vic2NyaWJlKCh0ZXh0KSA9PiAodHJhbnNsYXRlZFRleHQgPSB0ZXh0KSk7XG4gICAgfSBlbHNlIGlmIChpdGVtLm5hbWUgJiYgaXRlbS5mb3JtYXR0ZWRRdWFudGl0eSkge1xuICAgICAgdGhpcy50cmFuc2xhdGlvblxuICAgICAgICAudHJhbnNsYXRlKCdjb25maWd1cmF0b3IuYTExeS5jYXJ0RW50cnlCdW5kbGVOYW1lV2l0aFF1YW50aXR5Jywge1xuICAgICAgICAgIG5hbWU6IGl0ZW0ubmFtZSxcbiAgICAgICAgICBxdWFudGl0eTogaXRlbS5mb3JtYXR0ZWRRdWFudGl0eSxcbiAgICAgICAgfSlcbiAgICAgICAgLnBpcGUodGFrZSgxKSlcbiAgICAgICAgLnN1YnNjcmliZSgodGV4dCkgPT4gKHRyYW5zbGF0ZWRUZXh0ID0gdGV4dCkpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLnRyYW5zbGF0aW9uXG4gICAgICAgIC50cmFuc2xhdGUoJ2NvbmZpZ3VyYXRvci5hMTF5LmNhcnRFbnRyeUJ1bmRsZU5hbWUnLCB7XG4gICAgICAgICAgbmFtZTogaXRlbS5uYW1lLFxuICAgICAgICB9KVxuICAgICAgICAucGlwZSh0YWtlKDEpKVxuICAgICAgICAuc3Vic2NyaWJlKCh0ZXh0KSA9PiAodHJhbnNsYXRlZFRleHQgPSB0ZXh0KSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRyYW5zbGF0ZWRUZXh0O1xuICB9XG5cbiAgZ2V0SGlkZGVuSXRlbUluZm9JZChpbmRleDogbnVtYmVyKTogc3RyaW5nIHtcbiAgICByZXR1cm4gJ2N4LWl0ZW0taGlkZGVuLWluZm8tJyArIGluZGV4LnRvU3RyaW5nKCk7XG4gIH1cbn1cbiIsIjxuZy1jb250YWluZXIgKm5nSWY9XCJvcmRlckVudHJ5JCB8IGFzeW5jIGFzIG9yZGVyRW50cnlcIj5cbiAgPG5nLWNvbnRhaW5lciAqbmdJZj1cImlzQnVuZGxlQmFzZWRDb25maWd1cmF0b3Iob3JkZXJFbnRyeSlcIj5cbiAgICA8bmctY29udGFpbmVyICpuZ0lmPVwibnVtYmVyT2ZMaW5lSXRlbXMkIHwgYXN5bmMgYXMgbnVtYmVyT2ZJdGVtc1wiPlxuICAgICAgPGRpdiBjbGFzcz1cImN4LW51bWJlci1pdGVtc1wiPlxuICAgICAgICB7e1xuICAgICAgICAgICdjb25maWd1cmF0b3IuaGVhZGVyLml0ZW1zJyB8IGN4VHJhbnNsYXRlOiB7IGNvdW50OiBudW1iZXJPZkl0ZW1zIH1cbiAgICAgICAgfX1cbiAgICAgIDwvZGl2PlxuICAgICAgPGJ1dHRvblxuICAgICAgICAoY2xpY2spPVwidG9nZ2xlSXRlbXMoKVwiXG4gICAgICAgIFthdHRyLmFyaWEtZXhwYW5kZWRdPVwiIXRoaXMuaGlkZUl0ZW1zXCJcbiAgICAgICAgW2F0dHIuYXJpYS1sYWJlbF09XCJnZXRJdGVtc01zZyhudW1iZXJPZkl0ZW1zKVwiXG4gICAgICA+XG4gICAgICAgIDxkaXYgY2xhc3M9XCJjeC10b2dnbGUtaGlkZS1pdGVtc1wiPlxuICAgICAgICAgIHt7IGdldEJ1dHRvblRleHQoKSB9fVxuICAgICAgICA8L2Rpdj5cbiAgICAgIDwvYnV0dG9uPlxuXG4gICAgICA8ZGl2IGNsYXNzPVwiY3gtaXRlbS1pbmZvc1wiIFtjbGFzcy5vcGVuXT1cIiFoaWRlSXRlbXNcIj5cbiAgICAgICAgPGRpdlxuICAgICAgICAgICpuZ0Zvcj1cImxldCBsaW5lSXRlbSBvZiBsaW5lSXRlbXMkIHwgYXN5bmM7IGxldCBpID0gaW5kZXhcIlxuICAgICAgICAgIGNsYXNzPVwiY3gtaXRlbS1pbmZvXCJcbiAgICAgICAgICBhdHRyLmFyaWEtZGVzY3JpYmVkYnk9XCJ7eyBnZXRIaWRkZW5JdGVtSW5mb0lkKGkpIH19XCJcbiAgICAgICAgPlxuICAgICAgICAgIDxzcGFuIGlkPVwie3sgZ2V0SGlkZGVuSXRlbUluZm9JZChpKSB9fVwiIGNsYXNzPVwiY3gtdmlzdWFsbHktaGlkZGVuXCI+XG4gICAgICAgICAgICB7eyBnZXRIaWRkZW5JdGVtSW5mbyhsaW5lSXRlbSkgfX1cbiAgICAgICAgICA8L3NwYW4+XG4gICAgICAgICAgPGRpdiBjbGFzcz1cImN4LWl0ZW0tbmFtZVwiIGFyaWEtaGlkZGVuPVwidHJ1ZVwiPlxuICAgICAgICAgICAge3sgbGluZUl0ZW0/Lm5hbWUgfX1cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgICA8ZGl2IGNsYXNzPVwiY3gtaXRlbS1xdWFudGl0eVwiIGFyaWEtaGlkZGVuPVwidHJ1ZVwiPlxuICAgICAgICAgICAgPG5nLWNvbnRhaW5lciAqbmdJZj1cImxpbmVJdGVtPy5mb3JtYXR0ZWRRdWFudGl0eVwiPlxuICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cImN4LWlkZW50aWZpZXJcIj57e1xuICAgICAgICAgICAgICAgICdjb25maWd1cmF0b3IuYXR0cmlidXRlLnF1YW50aXR5JyB8IGN4VHJhbnNsYXRlXG4gICAgICAgICAgICAgIH19PC9zcGFuPlxuICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cImN4LWl0ZW1cIj57e1xuICAgICAgICAgICAgICAgIGxpbmVJdGVtPy5mb3JtYXR0ZWRRdWFudGl0eSB8IGN4TnVtZXJpY1xuICAgICAgICAgICAgICB9fTwvc3Bhbj5cbiAgICAgICAgICAgIDwvbmctY29udGFpbmVyPlxuICAgICAgICAgIDwvZGl2PlxuICAgICAgICAgIDxkaXYgY2xhc3M9XCJjeC1pdGVtLXByaWNlXCIgYXJpYS1oaWRkZW49XCJ0cnVlXCI+XG4gICAgICAgICAgICA8bmctY29udGFpbmVyICpuZ0lmPVwibGluZUl0ZW0/LmZvcm1hdHRlZFByaWNlXCI+XG4gICAgICAgICAgICAgIDxzcGFuIGNsYXNzPVwiY3gtaWRlbnRpZmllclwiPnt7XG4gICAgICAgICAgICAgICAgJ2NvbmZpZ3VyYXRvci5vdmVydmlld0Zvcm0uaXRlbVByaWNlJyB8IGN4VHJhbnNsYXRlXG4gICAgICAgICAgICAgIH19PC9zcGFuPlxuICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cImN4LWl0ZW1cIj57eyBsaW5lSXRlbT8uZm9ybWF0dGVkUHJpY2UgfX08L3NwYW4+XG4gICAgICAgICAgICA8L25nLWNvbnRhaW5lcj5cbiAgICAgICAgICA8L2Rpdj5cbiAgICAgICAgPC9kaXY+XG4gICAgICA8L2Rpdj5cbiAgICA8L25nLWNvbnRhaW5lcj5cbiAgICA8bmctY29udGFpbmVyICpuZ0lmPVwicXVhbnRpdHlDb250cm9sJCB8IGFzeW5jIGFzIHF1YW50aXR5Q29udHJvbFwiPlxuICAgICAgPGN4LWNvbmZpZ3VyZS1jYXJ0LWVudHJ5XG4gICAgICAgICpuZ0lmPVwiKHNob3VsZFNob3dCdXR0b24kIHwgYXN5bmMpICYmIG9yZGVyRW50cnk/LnByb2R1Y3Q/LmNvbmZpZ3VyYWJsZVwiXG4gICAgICAgIFtjYXJ0RW50cnldPVwib3JkZXJFbnRyeVwiXG4gICAgICAgIFtyZWFkT25seV09XCIocmVhZG9ubHkkIHwgYXN5bmMpID8/IHRydWVcIlxuICAgICAgICBbbXNnQmFubmVyXT1cImZhbHNlXCJcbiAgICAgICAgW2Rpc2FibGVkXT1cInF1YW50aXR5Q29udHJvbC5kaXNhYmxlZFwiXG4gICAgICA+PC9jeC1jb25maWd1cmUtY2FydC1lbnRyeVxuICAgID48L25nLWNvbnRhaW5lcj5cbiAgPC9uZy1jb250YWluZXI+XG48L25nLWNvbnRhaW5lcj5cbiJdfQ==