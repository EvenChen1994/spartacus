/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { ChangeDetectionStrategy, Component, Optional, } from '@angular/core';
import { UntypedFormControl } from '@angular/forms';
import { CommonConfigurator } from '@spartacus/product-configurator/common';
import { of, timer } from 'rxjs';
import { debounce, map } from 'rxjs/operators';
import { Configurator } from '../../../../core/model/configurator.model';
import { ConfiguratorAttributeBaseComponent } from '../base/configurator-attribute-base.component';
import * as i0 from "@angular/core";
import * as i1 from "../../../config/configurator-ui-settings.config";
import * as i2 from "../../composition/configurator-attribute-composition.model";
import * as i3 from "../../../../core/facade/configurator-commons.service";
import * as i4 from "../../../service/configurator-storefront-utils.service";
import * as i5 from "@spartacus/storefront";
import * as i6 from "@angular/forms";
import * as i7 from "@angular/common";
import * as i8 from "@spartacus/core";
export class ConfiguratorAttributeInputFieldComponent extends ConfiguratorAttributeBaseComponent {
    // TODO (CXSPA-3392): make ConfiguratorStorefrontUtilsService a required dependency
    constructor(config, attributeComponentContext, configuratorCommonsService, configuratorStorefrontUtilsService) {
        super();
        this.config = config;
        this.attributeComponentContext = attributeComponentContext;
        this.configuratorCommonsService = configuratorCommonsService;
        this.configuratorStorefrontUtilsService = configuratorStorefrontUtilsService;
        this.attributeInputForm = new UntypedFormControl('');
        this.showRequiredErrorMessage$ = of(false);
        /**
         * In case no config is injected, or when the debounce time is not configured at all,
         * this value will be used as fallback.
         */
        this.FALLBACK_DEBOUNCE_TIME = 500;
        this.attribute = attributeComponentContext.attribute;
        this.group = attributeComponentContext.group.id;
        this.owner = attributeComponentContext.owner;
        this.ownerKey = attributeComponentContext.owner.key;
        this.ownerType = attributeComponentContext.owner.type;
        if (this.configuratorStorefrontUtilsService) {
            this.showRequiredErrorMessage$ = this.configuratorStorefrontUtilsService
                .isCartEntryOrGroupVisited(this.owner, this.group)
                .pipe(map((result) => result
                ? this.isRequiredErrorMsg(this.attribute) &&
                    this.isUserInput(this.attribute)
                : false));
        }
    }
    ngOnInit() {
        this.attributeInputForm.setValue(this.attribute.userInput);
        if (this.ownerType === CommonConfigurator.OwnerType.CART_ENTRY &&
            this.attribute.required &&
            this.attribute.incomplete &&
            !this.attributeInputForm.value) {
            this.attributeInputForm.markAsTouched();
        }
        this.sub = this.attributeInputForm.valueChanges
            .pipe(debounce(() => timer(this.config.productConfigurator?.updateDebounceTime?.input ??
            this.FALLBACK_DEBOUNCE_TIME)))
            .subscribe(() => this.onChange());
    }
    onChange() {
        if (!this.attributeInputForm.invalid) {
            this.configuratorCommonsService.updateConfiguration(this.ownerKey, {
                ...this.attribute,
                userInput: this.attributeInputForm.value,
                selectedSingleValue: this.attributeInputForm.value,
            }, Configurator.UpdateType.ATTRIBUTE);
        }
    }
    ngOnDestroy() {
        if (this.sub) {
            this.sub.unsubscribe();
        }
    }
    /**
     * Verifies if the user input has a non-blank value.
     * @returns {boolean} - 'True' if the user input is undefined, empty or contains only blanks, otherwise 'false'.
     */
    get isUserInputEmpty() {
        return (!this.attribute.userInput || this.attribute.userInput.trim().length === 0);
    }
    /**
     * Checks if the component needs to be marked as required.
     * This is never the case if it is used as sub component for an attribute type which allows an additional value
     * @returns Required?
     */
    get isRequired() {
        return this.isUserInput(this.attribute)
            ? this.attribute.required ?? false
            : false;
    }
}
ConfiguratorAttributeInputFieldComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ConfiguratorAttributeInputFieldComponent, deps: [{ token: i1.ConfiguratorUISettingsConfig }, { token: i2.ConfiguratorAttributeCompositionContext }, { token: i3.ConfiguratorCommonsService }, { token: i4.ConfiguratorStorefrontUtilsService, optional: true }], target: i0.ɵɵFactoryTarget.Component });
ConfiguratorAttributeInputFieldComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.9", type: ConfiguratorAttributeInputFieldComponent, selector: "cx-configurator-attribute-input-field", usesInheritance: true, ngImport: i0, template: "<div id=\"{{ createAttributeIdForConfigurator(attribute) }}\" class=\"form-group\">\n  <ng-container *cxFeatureLevel=\"'!6.2'\">\n    <input\n      [formControl]=\"attributeInputForm\"\n      [required]=\"isRequired\"\n      class=\"form-control\"\n      attr.required=\"{{ attribute.required }}\"\n      maxlength=\"{{ attribute.maxlength }}\"\n      [attr.aria-label]=\"\n        isUserInputEmpty\n          ? ('configurator.a11y.valueOfAttributeBlank'\n            | cxTranslate\n              : {\n                  attribute: attribute.label\n                })\n          : ('configurator.a11y.valueOfAttributeFull'\n            | cxTranslate\n              : {\n                  value: attribute.userInput,\n                  attribute: attribute.label\n                })\n      \"\n      [attr.aria-describedby]=\"createAttributeUiKey('label', attribute.name)\"\n      [cxFocus]=\"{\n        key: createAttributeIdForConfigurator(attribute)\n      }\"\n    />\n  </ng-container>\n  <ng-container *cxFeatureLevel=\"'6.2'\">\n    <input\n      [formControl]=\"attributeInputForm\"\n      class=\"form-control\"\n      [ngClass]=\"{\n        'cx-required-error-msg ': (showRequiredErrorMessage$ | async)\n      }\"\n      [class.ng-invalid]=\"isRequired && isUserInputEmpty\"\n      maxlength=\"{{ attribute.maxlength }}\"\n      [attr.aria-label]=\"\n        isUserInputEmpty\n          ? ('configurator.a11y.valueOfAttributeBlank'\n            | cxTranslate\n              : {\n                  attribute: attribute.label\n                })\n          : ('configurator.a11y.valueOfAttributeFull'\n            | cxTranslate\n              : {\n                  value: attribute.userInput,\n                  attribute: attribute.label\n                })\n      \"\n      [attr.aria-describedby]=\"createAttributeUiKey('label', attribute.name)\"\n      [cxFocus]=\"{\n        key: createAttributeIdForConfigurator(attribute)\n      }\"\n    />\n  </ng-container>\n</div>\n", dependencies: [{ kind: "directive", type: i5.FocusDirective, selector: "[cxFocus]", inputs: ["cxFocus"] }, { kind: "directive", type: i6.DefaultValueAccessor, selector: "input:not([type=checkbox])[formControlName],textarea[formControlName],input:not([type=checkbox])[formControl],textarea[formControl],input:not([type=checkbox])[ngModel],textarea[ngModel],[ngDefaultControl]" }, { kind: "directive", type: i6.NgControlStatus, selector: "[formControlName],[ngModel],[formControl]" }, { kind: "directive", type: i6.RequiredValidator, selector: ":not([type=checkbox])[required][formControlName],:not([type=checkbox])[required][formControl],:not([type=checkbox])[required][ngModel]", inputs: ["required"] }, { kind: "directive", type: i6.MaxLengthValidator, selector: "[maxlength][formControlName],[maxlength][formControl],[maxlength][ngModel]", inputs: ["maxlength"] }, { kind: "directive", type: i6.FormControlDirective, selector: "[formControl]", inputs: ["formControl", "disabled", "ngModel"], outputs: ["ngModelChange"], exportAs: ["ngForm"] }, { kind: "directive", type: i7.NgClass, selector: "[ngClass]", inputs: ["class", "ngClass"] }, { kind: "directive", type: i8.FeatureLevelDirective, selector: "[cxFeatureLevel]", inputs: ["cxFeatureLevel"] }, { kind: "pipe", type: i7.AsyncPipe, name: "async" }, { kind: "pipe", type: i8.TranslatePipe, name: "cxTranslate" }], changeDetection: i0.ChangeDetectionStrategy.OnPush });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ConfiguratorAttributeInputFieldComponent, decorators: [{
            type: Component,
            args: [{ selector: 'cx-configurator-attribute-input-field', changeDetection: ChangeDetectionStrategy.OnPush, template: "<div id=\"{{ createAttributeIdForConfigurator(attribute) }}\" class=\"form-group\">\n  <ng-container *cxFeatureLevel=\"'!6.2'\">\n    <input\n      [formControl]=\"attributeInputForm\"\n      [required]=\"isRequired\"\n      class=\"form-control\"\n      attr.required=\"{{ attribute.required }}\"\n      maxlength=\"{{ attribute.maxlength }}\"\n      [attr.aria-label]=\"\n        isUserInputEmpty\n          ? ('configurator.a11y.valueOfAttributeBlank'\n            | cxTranslate\n              : {\n                  attribute: attribute.label\n                })\n          : ('configurator.a11y.valueOfAttributeFull'\n            | cxTranslate\n              : {\n                  value: attribute.userInput,\n                  attribute: attribute.label\n                })\n      \"\n      [attr.aria-describedby]=\"createAttributeUiKey('label', attribute.name)\"\n      [cxFocus]=\"{\n        key: createAttributeIdForConfigurator(attribute)\n      }\"\n    />\n  </ng-container>\n  <ng-container *cxFeatureLevel=\"'6.2'\">\n    <input\n      [formControl]=\"attributeInputForm\"\n      class=\"form-control\"\n      [ngClass]=\"{\n        'cx-required-error-msg ': (showRequiredErrorMessage$ | async)\n      }\"\n      [class.ng-invalid]=\"isRequired && isUserInputEmpty\"\n      maxlength=\"{{ attribute.maxlength }}\"\n      [attr.aria-label]=\"\n        isUserInputEmpty\n          ? ('configurator.a11y.valueOfAttributeBlank'\n            | cxTranslate\n              : {\n                  attribute: attribute.label\n                })\n          : ('configurator.a11y.valueOfAttributeFull'\n            | cxTranslate\n              : {\n                  value: attribute.userInput,\n                  attribute: attribute.label\n                })\n      \"\n      [attr.aria-describedby]=\"createAttributeUiKey('label', attribute.name)\"\n      [cxFocus]=\"{\n        key: createAttributeIdForConfigurator(attribute)\n      }\"\n    />\n  </ng-container>\n</div>\n" }]
        }], ctorParameters: function () { return [{ type: i1.ConfiguratorUISettingsConfig }, { type: i2.ConfiguratorAttributeCompositionContext }, { type: i3.ConfiguratorCommonsService }, { type: i4.ConfiguratorStorefrontUtilsService, decorators: [{
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlndXJhdG9yLWF0dHJpYnV0ZS1pbnB1dC1maWVsZC5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcHJvZHVjdC1jb25maWd1cmF0b3IvcnVsZWJhc2VkL2NvbXBvbmVudHMvYXR0cmlidXRlL3R5cGVzL2lucHV0LWZpZWxkL2NvbmZpZ3VyYXRvci1hdHRyaWJ1dGUtaW5wdXQtZmllbGQuY29tcG9uZW50LnRzIiwiLi4vLi4vLi4vLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL3Byb2R1Y3QtY29uZmlndXJhdG9yL3J1bGViYXNlZC9jb21wb25lbnRzL2F0dHJpYnV0ZS90eXBlcy9pbnB1dC1maWVsZC9jb25maWd1cmF0b3ItYXR0cmlidXRlLWlucHV0LWZpZWxkLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQ0wsdUJBQXVCLEVBQ3ZCLFNBQVMsRUFHVCxRQUFRLEdBQ1QsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDcEQsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sd0NBQXdDLENBQUM7QUFFNUUsT0FBTyxFQUFjLEVBQUUsRUFBZ0IsS0FBSyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNELE9BQU8sRUFBRSxRQUFRLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDL0MsT0FBTyxFQUFFLFlBQVksRUFBRSxNQUFNLDJDQUEyQyxDQUFDO0FBR3pFLE9BQU8sRUFBRSxrQ0FBa0MsRUFBRSxNQUFNLCtDQUErQyxDQUFDOzs7Ozs7Ozs7O0FBUW5HLE1BQU0sT0FBTyx3Q0FDWCxTQUFRLGtDQUFrQztJQXNDMUMsbUZBQW1GO0lBQ25GLFlBQ1ksTUFBb0MsRUFDcEMseUJBQWtFLEVBQ2xFLDBCQUFzRCxFQUV0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RTtZQUNaLElBQUksQ0FBQyxHQUFHLENBQUMsV0FBVyxFQUFFLENBQUM7U0FDeEI7SUFDSCxDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsSUFBSSxnQkFBZ0I7UUFDbEIsT0FBTyxDQUNMLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLENBQUMsTUFBTSxLQUFLLENBQUMsQ0FDMUUsQ0FBQztJQUNKLENBQUM7SUFFRDs7OztPQUlHO0lBQ0gsSUFBSSxVQUFVO1FBQ1osT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUM7WUFDckMsQ0FBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxJQUFJLEtBQUs7WUFDbEMsQ0FBQyxDQUFDLEtBQUssQ0FBQztJQUNaLENBQUM7O3FJQWxJVSx3Q0FBd0M7eUhBQXhDLHdDQUF3QyxvR0M3QnJELGk4REEwREE7MkZEN0JhLHdDQUF3QztrQkFMcEQsU0FBUzsrQkFDRSx1Q0FBdUMsbUJBRWhDLHVCQUF1QixDQUFDLE1BQU07OzBCQThDNUMsUUFBUSIsInNvdXJjZXNDb250ZW50IjpbIi8qXG4gKiBTUERYLUZpbGVDb3B5cmlnaHRUZXh0OiAyMDIzIFNBUCBTcGFydGFjdXMgdGVhbSA8c3BhcnRhY3VzLXRlYW1Ac2FwLmNvbT5cbiAqXG4gKiBTUERYLUxpY2Vuc2UtSWRlbnRpZmllcjogQXBhY2hlLTIuMFxuICovXG5cbmltcG9ydCB7XG4gIENoYW5nZURldGVjdGlvblN0cmF0ZWd5LFxuICBDb21wb25lbnQsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPcHRpb25hbCxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBVbnR5cGVkRm9ybUNvbnRyb2wgfSBmcm9tICdAYW5ndWxhci9mb3Jtcyc7XG5pbXBvcnQgeyBDb21tb25Db25maWd1cmF0b3IgfSBmcm9tICdAc3BhcnRhY3VzL3Byb2R1Y3QtY29uZmlndXJhdG9yL2NvbW1vbic7XG5pbXBvcnQgeyBDb25maWd1cmF0b3JDb21tb25zU2VydmljZSB9IGZyb20gJy4uLy4uLy4uLy4uL2NvcmUvZmFjYWRlL2NvbmZpZ3VyYXRvci1jb21tb25zLnNlcnZpY2UnO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgb2YsIFN1YnNjcmlwdGlvbiwgdGltZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGRlYm91bmNlLCBtYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb25maWd1cmF0b3IgfSBmcm9tICcuLi8uLi8uLi8uLi9jb3JlL21vZGVsL2NvbmZpZ3VyYXRvci5tb2RlbCc7XG5pbXBvcnQgeyBDb25maWd1cmF0b3JBdHRyaWJ1dGVDb21wb3NpdGlvbkNvbnRleHQgfSBmcm9tICcuLi8uLi9jb21wb3NpdGlvbi9jb25maWd1cmF0b3ItYXR0cmlidXRlLWNvbXBvc2l0aW9uLm1vZGVsJztcbmltcG9ydCB7IENvbmZpZ3VyYXRvclVJU2V0dGluZ3NDb25maWcgfSBmcm9tICcuLi8uLi8uLi9jb25maWcvY29uZmlndXJhdG9yLXVpLXNldHRpbmdzLmNvbmZpZyc7XG5pbXBvcnQgeyBDb25maWd1cmF0b3JBdHRyaWJ1dGVCYXNlQ29tcG9uZW50IH0gZnJvbSAnLi4vYmFzZS9jb25maWd1cmF0b3ItYXR0cmlidXRlLWJhc2UuY29tcG9uZW50JztcbmltcG9ydCB7IENvbmZpZ3VyYXRvclN0b3JlZnJvbnRVdGlsc1NlcnZpY2UgfSBmcm9tICcuLi8uLi8uLi9zZXJ2aWNlL2NvbmZpZ3VyYXRvci1zdG9yZWZyb250LXV0aWxzLnNlcnZpY2UnO1xuXG5AQ29tcG9uZW50KHtcbiAgc2VsZWN0b3I6ICdjeC1jb25maWd1cmF0b3ItYXR0cmlidXRlLWlucHV0LWZpZWxkJyxcbiAgdGVtcGxhdGVVcmw6ICcuL2NvbmZpZ3VyYXRvci1hdHRyaWJ1dGUtaW5wdXQtZmllbGQuY29tcG9uZW50Lmh0bWwnLFxuICBjaGFuZ2VEZXRlY3Rpb246IENoYW5nZURldGVjdGlvblN0cmF0ZWd5Lk9uUHVzaCxcbn0pXG5leHBvcnQgY2xhc3MgQ29uZmlndXJhdG9yQXR0cmlidXRlSW5wdXRGaWVsZENvbXBvbmVudFxuICBleHRlbmRzIENvbmZpZ3VyYXRvckF0dHJpYnV0ZUJhc2VDb21wb25lbnRcbiAgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveVxue1xuICBhdHRyaWJ1dGVJbnB1dEZvcm0gPSBuZXcgVW50eXBlZEZvcm1Db250cm9sKCcnKTtcbiAgcHJvdGVjdGVkIHN1YjogU3Vic2NyaXB0aW9uO1xuXG4gIGF0dHJpYnV0ZTogQ29uZmlndXJhdG9yLkF0dHJpYnV0ZTtcbiAgZ3JvdXA6IHN0cmluZztcbiAgb3duZXI6IENvbW1vbkNvbmZpZ3VyYXRvci5Pd25lcjtcbiAgb3duZXJLZXk6IHN0cmluZztcbiAgb3duZXJUeXBlOiBDb21tb25Db25maWd1cmF0b3IuT3duZXJUeXBlO1xuXG4gIHNob3dSZXF1aXJlZEVycm9yTWVzc2FnZSQ6IE9ic2VydmFibGU8Ym9vbGVhbj4gPSBvZihmYWxzZSk7XG5cbiAgLyoqXG4gICAqIEluIGNhc2Ugbm8gY29uZmlnIGlzIGluamVjdGVkLCBvciB3aGVuIHRoZSBkZWJvdW5jZSB0aW1lIGlzIG5vdCBjb25maWd1cmVkIGF0IGFsbCxcbiAgICogdGhpcyB2YWx1ZSB3aWxsIGJlIHVzZWQgYXMgZmFsbGJhY2suXG4gICAqL1xuICBwcm90ZWN0ZWQgcmVhZG9ubHkgRkFMTEJBQ0tfREVCT1VOQ0VfVElNRSA9IDUwMDtcblxuICAvLyBUT0RPIChDWFNQQS0zMzkyKTogbWFrZSBDb25maWd1cmF0b3JTdG9yZWZyb250VXRpbHNTZXJ2aWNlIGEgcmVxdWlyZWQgZGVwZW5kZW5jeVxuICBjb25zdHJ1Y3RvcihcbiAgICBjb25maWc6IENvbmZpZ3VyYXRvclVJU2V0dGluZ3NDb25maWcsXG4gICAgYXR0cmlidXRlQ29tcG9uZW50Q29udGV4dDogQ29uZmlndXJhdG9yQXR0cmlidXRlQ29tcG9zaXRpb25Db250ZXh0LFxuICAgIGNvbmZpZ3VyYXRvckNvbW1vbnNTZXJ2aWNlOiBDb25maWd1cmF0b3JDb21tb25zU2VydmljZSxcbiAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgQHR5cGVzY3JpcHQtZXNsaW50L3VuaWZpZWQtc2lnbmF0dXJlc1xuICAgIGNvbmZpZ3VyYXRvclN0b3JlZnJvbnRVdGlsc1NlcnZpY2U/OiBDb25maWd1cmF0b3JTdG9yZWZyb250VXRpbHNTZXJ2aWNlXG4gICk7XG5cbiAgLyoqXG4gICAqIEBkZXByZWNhdGVkIHNpbmNlIDYuMlxuICAgKi9cbiAgY29uc3RydWN0b3IoXG4gICAgY29uZmlnOiBDb25maWd1cmF0b3JVSVNldHRpbmdzQ29uZmlnLFxuICAgIGF0dHJpYnV0ZUNvbXBvbmVudENvbnRleHQ6IENvbmZpZ3VyYXRvckF0dHJpYnV0ZUNvbXBvc2l0aW9uQ29udGV4dCxcbiAgICBjb25maWd1cmF0b3JDb21tb25zU2VydmljZTogQ29uZmlndXJhdG9yQ29tbW9uc1NlcnZpY2VcbiAgKTtcblxuICAvLyBUT0RPIChDWFNQQS0zMzkyKTogbWFrZSBDb25maWd1cmF0b3JTdG9yZWZyb250VXRpbHNTZXJ2aWNlIGEgcmVxdWlyZWQgZGVwZW5kZW5jeVxuICBjb25zdHJ1Y3RvcihcbiAgICBwcm90ZWN0ZWQgY29uZmlnOiBDb25maWd1cmF0b3JVSVNldHRpbmdzQ29uZmlnLFxuICAgIHByb3RlY3RlZCBhdHRyaWJ1dGVDb21wb25lbnRDb250ZXh0OiBDb25maWd1cmF0b3JBdHRyaWJ1dGVDb21wb3NpdGlvbkNvbnRleHQsXG4gICAgcHJvdGVjdGVkIGNvbmZpZ3VyYXRvckNvbW1vbnNTZXJ2aWNlOiBDb25maWd1cmF0b3JDb21tb25zU2VydmljZSxcbiAgICBAT3B0aW9uYWwoKVxuICAgIHByb3RlY3RlZCBjb25maWd1cmF0b3JTdG9yZWZyb250VXRpbHNTZXJ2aWNlPzogQ29uZmlndXJhdG9yU3RvcmVmcm9udFV0aWxzU2VydmljZVxuICApIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5hdHRyaWJ1dGUgPSBhdHRyaWJ1dGVDb21wb25lbnRDb250ZXh0LmF0dHJpYnV0ZTtcbiAgICB0aGlzLmdyb3VwID0gYXR0cmlidXRlQ29tcG9uZW50Q29udGV4dC5ncm91cC5pZDtcbiAgICB0aGlzLm93bmVyID0gYXR0cmlidXRlQ29tcG9uZW50Q29udGV4dC5vd25lcjtcbiAgICB0aGlzLm93bmVyS2V5ID0gYXR0cmlidXRlQ29tcG9uZW50Q29udGV4dC5vd25lci5rZXk7XG4gICAgdGhpcy5vd25lclR5cGUgPSBhdHRyaWJ1dGVDb21wb25lbnRDb250ZXh0Lm93bmVyLnR5cGU7XG5cbiAgICBpZiAodGhpcy5jb25maWd1cmF0b3JTdG9yZWZyb250VXRpbHNTZXJ2aWNlKSB7XG4gICAgICB0aGlzLnNob3dSZXF1aXJlZEVycm9yTWVzc2FnZSQgPSB0aGlzLmNvbmZpZ3VyYXRvclN0b3JlZnJvbnRVdGlsc1NlcnZpY2VcbiAgICAgICAgLmlzQ2FydEVudHJ5T3JHcm91cFZpc2l0ZWQodGhpcy5vd25lciwgdGhpcy5ncm91cClcbiAgICAgICAgLnBpcGUoXG4gICAgICAgICAgbWFwKChyZXN1bHQpID0+XG4gICAgICAgICAgICByZXN1bHRcbiAgICAgICAgICAgICAgPyB0aGlzLmlzUmVxdWlyZWRFcnJvck1zZyh0aGlzLmF0dHJpYnV0ZSkgJiZcbiAgICAgICAgICAgICAgICB0aGlzLmlzVXNlcklucHV0KHRoaXMuYXR0cmlidXRlKVxuICAgICAgICAgICAgICA6IGZhbHNlXG4gICAgICAgICAgKVxuICAgICAgICApO1xuICAgIH1cbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIHRoaXMuYXR0cmlidXRlSW5wdXRGb3JtLnNldFZhbHVlKHRoaXMuYXR0cmlidXRlLnVzZXJJbnB1dCk7XG4gICAgaWYgKFxuICAgICAgdGhpcy5vd25lclR5cGUgPT09IENvbW1vbkNvbmZpZ3VyYXRvci5Pd25lclR5cGUuQ0FSVF9FTlRSWSAmJlxuICAgICAgdGhpcy5hdHRyaWJ1dGUucmVxdWlyZWQgJiZcbiAgICAgIHRoaXMuYXR0cmlidXRlLmluY29tcGxldGUgJiZcbiAgICAgICF0aGlzLmF0dHJpYnV0ZUlucHV0Rm9ybS52YWx1ZVxuICAgICkge1xuICAgICAgdGhpcy5hdHRyaWJ1dGVJbnB1dEZvcm0ubWFya0FzVG91Y2hlZCgpO1xuICAgIH1cbiAgICB0aGlzLnN1YiA9IHRoaXMuYXR0cmlidXRlSW5wdXRGb3JtLnZhbHVlQ2hhbmdlc1xuICAgICAgLnBpcGUoXG4gICAgICAgIGRlYm91bmNlKCgpID0+XG4gICAgICAgICAgdGltZXIoXG4gICAgICAgICAgICB0aGlzLmNvbmZpZy5wcm9kdWN0Q29uZmlndXJhdG9yPy51cGRhdGVEZWJvdW5jZVRpbWU/LmlucHV0ID8/XG4gICAgICAgICAgICAgIHRoaXMuRkFMTEJBQ0tfREVCT1VOQ0VfVElNRVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgoKSA9PiB0aGlzLm9uQ2hhbmdlKCkpO1xuICB9XG5cbiAgb25DaGFuZ2UoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLmF0dHJpYnV0ZUlucHV0Rm9ybS5pbnZhbGlkKSB7XG4gICAgICB0aGlzLmNvbmZpZ3VyYXRvckNvbW1vbnNTZXJ2aWNlLnVwZGF0ZUNvbmZpZ3VyYXRpb24oXG4gICAgICAgIHRoaXMub3duZXJLZXksXG4gICAgICAgIHtcbiAgICAgICAgICAuLi50aGlzLmF0dHJpYnV0ZSxcbiAgICAgICAgICB1c2VySW5wdXQ6IHRoaXMuYXR0cmlidXRlSW5wdXRGb3JtLnZhbHVlLFxuICAgICAgICAgIHNlbGVjdGVkU2luZ2xlVmFsdWU6IHRoaXMuYXR0cmlidXRlSW5wdXRGb3JtLnZhbHVlLFxuICAgICAgICB9LFxuICAgICAgICBDb25maWd1cmF0b3IuVXBkYXRlVHlwZS5BVFRSSUJVVEVcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKSB7XG4gICAgaWYgKHRoaXMuc3ViKSB7XG4gICAgICB0aGlzLnN1Yi51bnN1YnNjcmliZSgpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBWZXJpZmllcyBpZiB0aGUgdXNlciBpbnB1dCBoYXMgYSBub24tYmxhbmsgdmFsdWUuXG4gICAqIEByZXR1cm5zIHtib29sZWFufSAtICdUcnVlJyBpZiB0aGUgdXNlciBpbnB1dCBpcyB1bmRlZmluZWQsIGVtcHR5IG9yIGNvbnRhaW5zIG9ubHkgYmxhbmtzLCBvdGhlcndpc2UgJ2ZhbHNlJy5cbiAgICovXG4gIGdldCBpc1VzZXJJbnB1dEVtcHR5KCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiAoXG4gICAgICAhdGhpcy5hdHRyaWJ1dGUudXNlcklucHV0IHx8IHRoaXMuYXR0cmlidXRlLnVzZXJJbnB1dC50cmltKCkubGVuZ3RoID09PSAwXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVja3MgaWYgdGhlIGNvbXBvbmVudCBuZWVkcyB0byBiZSBtYXJrZWQgYXMgcmVxdWlyZWQuXG4gICAqIFRoaXMgaXMgbmV2ZXIgdGhlIGNhc2UgaWYgaXQgaXMgdXNlZCBhcyBzdWIgY29tcG9uZW50IGZvciBhbiBhdHRyaWJ1dGUgdHlwZSB3aGljaCBhbGxvd3MgYW4gYWRkaXRpb25hbCB2YWx1ZVxuICAgKiBAcmV0dXJucyBSZXF1aXJlZD9cbiAgICovXG4gIGdldCBpc1JlcXVpcmVkKCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiB0aGlzLmlzVXNlcklucHV0KHRoaXMuYXR0cmlidXRlKVxuICAgICAgPyB0aGlzLmF0dHJpYnV0ZS5yZXF1aXJlZCA/PyBmYWxzZVxuICAgICAgOiBmYWxzZTtcbiAgfVxufVxuIiwiPGRpdiBpZD1cInt7IGNyZWF0ZUF0dHJpYnV0ZUlkRm9yQ29uZmlndXJhdG9yKGF0dHJpYnV0ZSkgfX1cIiBjbGFzcz1cImZvcm0tZ3JvdXBcIj5cbiAgPG5nLWNvbnRhaW5lciAqY3hGZWF0dXJlTGV2ZWw9XCInITYuMidcIj5cbiAgICA8aW5wdXRcbiAgICAgIFtmb3JtQ29udHJvbF09XCJhdHRyaWJ1dGVJbnB1dEZvcm1cIlxuICAgICAgW3JlcXVpcmVkXT1cImlzUmVxdWlyZWRcIlxuICAgICAgY2xhc3M9XCJmb3JtLWNvbnRyb2xcIlxuICAgICAgYXR0ci5yZXF1aXJlZD1cInt7IGF0dHJpYnV0ZS5yZXF1aXJlZCB9fVwiXG4gICAgICBtYXhsZW5ndGg9XCJ7eyBhdHRyaWJ1dGUubWF4bGVuZ3RoIH19XCJcbiAgICAgIFthdHRyLmFyaWEtbGFiZWxdPVwiXG4gICAgICAgIGlzVXNlcklucHV0RW1wdHlcbiAgICAgICAgICA/ICgnY29uZmlndXJhdG9yLmExMXkudmFsdWVPZkF0dHJpYnV0ZUJsYW5rJ1xuICAgICAgICAgICAgfCBjeFRyYW5zbGF0ZVxuICAgICAgICAgICAgICA6IHtcbiAgICAgICAgICAgICAgICAgIGF0dHJpYnV0ZTogYXR0cmlidXRlLmxhYmVsXG4gICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICA6ICgnY29uZmlndXJhdG9yLmExMXkudmFsdWVPZkF0dHJpYnV0ZUZ1bGwnXG4gICAgICAgICAgICB8IGN4VHJhbnNsYXRlXG4gICAgICAgICAgICAgIDoge1xuICAgICAgICAgICAgICAgICAgdmFsdWU6IGF0dHJpYnV0ZS51c2VySW5wdXQsXG4gICAgICAgICAgICAgICAgICBhdHRyaWJ1dGU6IGF0dHJpYnV0ZS5sYWJlbFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICBcIlxuICAgICAgW2F0dHIuYXJpYS1kZXNjcmliZWRieV09XCJjcmVhdGVBdHRyaWJ1dGVVaUtleSgnbGFiZWwnLCBhdHRyaWJ1dGUubmFtZSlcIlxuICAgICAgW2N4Rm9jdXNdPVwie1xuICAgICAgICBrZXk6IGNyZWF0ZUF0dHJpYnV0ZUlkRm9yQ29uZmlndXJhdG9yKGF0dHJpYnV0ZSlcbiAgICAgIH1cIlxuICAgIC8+XG4gIDwvbmctY29udGFpbmVyPlxuICA8bmctY29udGFpbmVyICpjeEZlYXR1cmVMZXZlbD1cIic2LjInXCI+XG4gICAgPGlucHV0XG4gICAgICBbZm9ybUNvbnRyb2xdPVwiYXR0cmlidXRlSW5wdXRGb3JtXCJcbiAgICAgIGNsYXNzPVwiZm9ybS1jb250cm9sXCJcbiAgICAgIFtuZ0NsYXNzXT1cIntcbiAgICAgICAgJ2N4LXJlcXVpcmVkLWVycm9yLW1zZyAnOiAoc2hvd1JlcXVpcmVkRXJyb3JNZXNzYWdlJCB8IGFzeW5jKVxuICAgICAgfVwiXG4gICAgICBbY2xhc3MubmctaW52YWxpZF09XCJpc1JlcXVpcmVkICYmIGlzVXNlcklucHV0RW1wdHlcIlxuICAgICAgbWF4bGVuZ3RoPVwie3sgYXR0cmlidXRlLm1heGxlbmd0aCB9fVwiXG4gICAgICBbYXR0ci5hcmlhLWxhYmVsXT1cIlxuICAgICAgICBpc1VzZXJJbnB1dEVtcHR5XG4gICAgICAgICAgPyAoJ2NvbmZpZ3VyYXRvci5hMTF5LnZhbHVlT2ZBdHRyaWJ1dGVCbGFuaydcbiAgICAgICAgICAgIHwgY3hUcmFuc2xhdGVcbiAgICAgICAgICAgICAgOiB7XG4gICAgICAgICAgICAgICAgICBhdHRyaWJ1dGU6IGF0dHJpYnV0ZS5sYWJlbFxuICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgOiAoJ2NvbmZpZ3VyYXRvci5hMTF5LnZhbHVlT2ZBdHRyaWJ1dGVGdWxsJ1xuICAgICAgICAgICAgfCBjeFRyYW5zbGF0ZVxuICAgICAgICAgICAgICA6IHtcbiAgICAgICAgICAgICAgICAgIHZhbHVlOiBhdHRyaWJ1dGUudXNlcklucHV0LFxuICAgICAgICAgICAgICAgICAgYXR0cmlidXRlOiBhdHRyaWJ1dGUubGFiZWxcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgXCJcbiAgICAgIFthdHRyLmFyaWEtZGVzY3JpYmVkYnldPVwiY3JlYXRlQXR0cmlidXRlVWlLZXkoJ2xhYmVsJywgYXR0cmlidXRlLm5hbWUpXCJcbiAgICAgIFtjeEZvY3VzXT1cIntcbiAgICAgICAga2V5OiBjcmVhdGVBdHRyaWJ1dGVJZEZvckNvbmZpZ3VyYXRvcihhdHRyaWJ1dGUpXG4gICAgICB9XCJcbiAgICAvPlxuICA8L25nLWNvbnRhaW5lcj5cbjwvZGl2PlxuIl19