/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { HttpHeaders, HttpContext } from '@angular/common/http';
import { Injectable } from '@angular/core';
import { CART_MODIFICATION_NORMALIZER, } from '@spartacus/cart/base/root';
import { OCC_HTTP_TOKEN, } from '@spartacus/core';
import { ConfiguratorModelUtils, } from '@spartacus/product-configurator/common';
import { map, take, tap } from 'rxjs/operators';
import { VARIANT_CONFIGURATOR_ADD_TO_CART_SERIALIZER, VARIANT_CONFIGURATOR_NORMALIZER, VARIANT_CONFIGURATOR_OVERVIEW_NORMALIZER, VARIANT_CONFIGURATOR_OVERVIEW_SERIALIZER, VARIANT_CONFIGURATOR_PRICE_NORMALIZER, VARIANT_CONFIGURATOR_SERIALIZER, VARIANT_CONFIGURATOR_UPDATE_CART_ENTRY_SERIALIZER, } from './variant-configurator-occ.converters';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
import * as i2 from "@spartacus/core";
import * as i3 from "../../core/services/configurator-expert-mode.service";
export class VariantConfiguratorOccAdapter {
    constructor(http, occEndpointsService, converterService, configExpertModeService) {
        this.http = http;
        this.occEndpointsService = occEndpointsService;
        this.converterService = converterService;
        this.configExpertModeService = configExpertModeService;
    }
    getConfiguratorType() {
        return "CPQCONFIGURATOR" /* ConfiguratorType.VARIANT */;
    }
    getExpModeRequested() {
        let expMode = false;
        this.configExpertModeService
            .getExpModeRequested()
            .pipe(take(1))
            .subscribe((mode) => (expMode = mode));
        return expMode;
    }
    setExpModeActive(expMode) {
        this.configExpertModeService.setExpModeActive(expMode);
    }
    createConfiguration(owner, configIdTemplate, forceReset = false) {
        const productCode = owner.id;
        const expMode = this.getExpModeRequested();
        return this.http
            .get(this.occEndpointsService.buildUrl('createVariantConfiguration', {
            urlParams: { productCode },
            queryParams: configIdTemplate
                ? { configIdTemplate, expMode, forceReset }
                : { expMode, forceReset },
        }), { context: this.indicateSendUserForAsm() })
            .pipe(this.converterService.pipeable(VARIANT_CONFIGURATOR_NORMALIZER), tap((resultConfiguration) => {
            this.setExpModeActive(resultConfiguration.kbKey !== undefined);
        }), map((resultConfiguration) => {
            return {
                ...resultConfiguration,
                owner: owner,
            };
        }));
    }
    readConfiguration(configId, groupId, configurationOwner) {
        const expMode = this.getExpModeRequested();
        return this.http
            .get(this.occEndpointsService.buildUrl('readVariantConfiguration', {
            urlParams: { configId },
            queryParams: { groupId, expMode },
        }), { context: this.indicateSendUserForAsm() })
            .pipe(this.converterService.pipeable(VARIANT_CONFIGURATOR_NORMALIZER), tap((resultConfiguration) => {
            this.setExpModeActive(resultConfiguration.kbKey !== undefined);
        }), map((resultConfiguration) => {
            return {
                ...resultConfiguration,
                owner: configurationOwner,
                newConfiguration: false,
            };
        }));
    }
    updateConfiguration(configuration) {
        const configId = configuration.configId;
        const expMode = this.getExpModeRequested();
        const url = this.occEndpointsService.buildUrl('updateVariantConfiguration', {
            urlParams: { configId },
            queryParams: { expMode },
        });
        const occConfiguration = this.converterService.convert(configuration, VARIANT_CONFIGURATOR_SERIALIZER);
        return this.http
            .patch(url, occConfiguration, {
            context: this.indicateSendUserForAsm(),
        })
            .pipe(this.converterService.pipeable(VARIANT_CONFIGURATOR_NORMALIZER), tap((resultConfiguration) => {
            this.setExpModeActive(resultConfiguration.kbKey !== undefined);
        }), map((resultConfiguration) => {
            return {
                ...resultConfiguration,
                owner: configuration.owner,
            };
        }));
    }
    addToCart(parameters) {
        const url = this.occEndpointsService.buildUrl('addVariantConfigurationToCart', { urlParams: { userId: parameters.userId, cartId: parameters.cartId } });
        const occAddToCartParameters = this.converterService.convert(parameters, VARIANT_CONFIGURATOR_ADD_TO_CART_SERIALIZER);
        const headers = new HttpHeaders({
            'Content-Type': 'application/json',
        });
        return this.http
            .post(url, occAddToCartParameters, { headers })
            .pipe(this.converterService.pipeable(CART_MODIFICATION_NORMALIZER));
    }
    readConfigurationForCartEntry(parameters) {
        const expMode = this.getExpModeRequested();
        const url = this.occEndpointsService.buildUrl('readVariantConfigurationForCartEntry', {
            urlParams: {
                userId: parameters.userId,
                cartId: parameters.cartId,
                cartEntryNumber: parameters.cartEntryNumber,
            },
            queryParams: { expMode },
        });
        return this.http.get(url).pipe(this.converterService.pipeable(VARIANT_CONFIGURATOR_NORMALIZER), tap((resultConfiguration) => {
            this.setExpModeActive(resultConfiguration.kbKey !== undefined);
        }), map((resultConfiguration) => {
            return {
                ...resultConfiguration,
                owner: parameters.owner,
            };
        }));
    }
    updateConfigurationForCartEntry(parameters) {
        const url = this.occEndpointsService.buildUrl('updateVariantConfigurationForCartEntry', {
            urlParams: {
                userId: parameters.userId,
                cartId: parameters.cartId,
                cartEntryNumber: parameters.cartEntryNumber,
            },
        });
        const headers = new HttpHeaders({
            'Content-Type': 'application/json',
        });
        const occUpdateCartEntryParameters = this.converterService.convert(parameters, VARIANT_CONFIGURATOR_UPDATE_CART_ENTRY_SERIALIZER);
        return this.http
            .put(url, occUpdateCartEntryParameters, { headers })
            .pipe(this.converterService.pipeable(CART_MODIFICATION_NORMALIZER));
    }
    readConfigurationForOrderEntry(parameters) {
        const url = this.occEndpointsService.buildUrl('readVariantConfigurationOverviewForOrderEntry', {
            urlParams: {
                userId: parameters.userId,
                orderId: parameters.orderId,
                orderEntryNumber: parameters.orderEntryNumber,
            },
        });
        return this.http.get(url).pipe(this.converterService.pipeable(VARIANT_CONFIGURATOR_OVERVIEW_NORMALIZER), map((overview) => {
            const configuration = {
                configId: overview.configId,
                productCode: overview.productCode,
                groups: [],
                flatGroups: [],
                interactionState: {},
                overview: overview,
                owner: ConfiguratorModelUtils.createInitialOwner(),
            };
            return configuration;
        }), map((resultConfiguration) => {
            return {
                ...resultConfiguration,
                owner: parameters.owner,
            };
        }));
    }
    readPriceSummary(configuration) {
        const url = this.occEndpointsService.buildUrl('readVariantConfigurationPriceSummary', {
            urlParams: {
                configId: configuration.configId,
            },
            queryParams: { groupId: configuration.interactionState.currentGroup },
        });
        return this.http.get(url, { context: this.indicateSendUserForAsm() }).pipe(this.converterService.pipeable(VARIANT_CONFIGURATOR_PRICE_NORMALIZER), map((configResult) => {
            const result = {
                ...configuration,
                priceSummary: configResult.priceSummary,
                priceSupplements: configResult.priceSupplements,
            };
            return result;
        }));
    }
    getConfigurationOverview(configId) {
        const url = this.occEndpointsService.buildUrl('getVariantConfigurationOverview', { urlParams: { configId } });
        return this.http
            .get(url, {
            context: this.indicateSendUserForAsm(),
        })
            .pipe(this.converterService.pipeable(VARIANT_CONFIGURATOR_OVERVIEW_NORMALIZER));
    }
    updateConfigurationOverview(ovInput) {
        const url = this.occEndpointsService.buildUrl('getVariantConfigurationOverview', { urlParams: { configId: ovInput.configId } });
        const occOverview = this.converterService.convert(ovInput, VARIANT_CONFIGURATOR_OVERVIEW_SERIALIZER);
        return this.http
            .patch(url, occOverview, {
            context: this.indicateSendUserForAsm(),
        })
            .pipe(this.converterService.pipeable(VARIANT_CONFIGURATOR_OVERVIEW_NORMALIZER), map((overview) => ({
            ...overview,
            attributeFilters: ovInput.attributeFilters,
            groupFilters: ovInput.groupFilters,
            possibleGroups: ovInput.possibleGroups,
        })));
    }
    searchVariants(configId) {
        const url = this.occEndpointsService.buildUrl('searchConfiguratorVariants', { urlParams: { configId } });
        //no need to work with a converter here, as Configurator.Variant is a projection of the OCC
        //variant representation
        return this.http.get(url, {
            context: this.indicateSendUserForAsm(),
        });
    }
    /**
     * Prepares http context indicating that emulated user has to be added to the request in ASM mode
     *
     * The actual calls to the commerce backend will only be changed if the ASM setting
     * userIdHttpHeader:{
     *  enable:true
     * },
     * is active
     * @returns http context indicating that emulated user has to be added to the request in ASM mode
     */
    indicateSendUserForAsm() {
        return new HttpContext().set(OCC_HTTP_TOKEN, {
            sendUserIdAsHeader: true,
        });
    }
}
VariantConfiguratorOccAdapter.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: VariantConfiguratorOccAdapter, deps: [{ token: i1.HttpClient }, { token: i2.OccEndpointsService }, { token: i2.ConverterService }, { token: i3.ConfiguratorExpertModeService }], target: i0.ɵɵFactoryTarget.Injectable });
VariantConfiguratorOccAdapter.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: VariantConfiguratorOccAdapter });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: VariantConfiguratorOccAdapter, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.HttpClient }, { type: i2.OccEndpointsService }, { type: i2.ConverterService }, { type: i3.ConfiguratorExpertModeService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmFyaWFudC1jb25maWd1cmF0b3Itb2NjLmFkYXB0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcHJvZHVjdC1jb25maWd1cmF0b3IvcnVsZWJhc2VkL29jYy92YXJpYW50L3ZhcmlhbnQtY29uZmlndXJhdG9yLW9jYy5hZGFwdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQWMsV0FBVyxFQUFFLFdBQVcsRUFBRSxNQUFNLHNCQUFzQixDQUFDO0FBQzVFLE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDM0MsT0FBTyxFQUVMLDRCQUE0QixHQUM3QixNQUFNLDJCQUEyQixDQUFDO0FBQ25DLE9BQU8sRUFHTCxjQUFjLEdBQ2YsTUFBTSxpQkFBaUIsQ0FBQztBQUN6QixPQUFPLEVBRUwsc0JBQXNCLEdBRXZCLE1BQU0sd0NBQXdDLENBQUM7QUFFaEQsT0FBTyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFHaEQsT0FBTyxFQUNMLDJDQUEyQyxFQUMzQywrQkFBK0IsRUFDL0Isd0NBQXdDLEVBQ3hDLHdDQUF3QyxFQUN4QyxxQ0FBcUMsRUFDckMsK0JBQStCLEVBQy9CLGlEQUFpRCxHQUNsRCxNQUFNLHVDQUF1QyxDQUFDOzs7OztBQUsvQyxNQUFNLE9BQU8sNkJBQTZCO0lBR3hDLFlBQ1ksSUFBZ0IsRUFDaEIsbUJBQXdDLEVBQ3hDLGdCQUFrQyxFQUNsQyx1QkFBc0Q7UUFIdEQsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUNoQix3QkFBbUIsR0FBbkIsbUJBQW1CLENBQXFCO1FBQ3hDLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsNEJBQXVCLEdBQXZCLHVCQUF1QixDQUErQjtJQUMvRCxDQUFDO0lBRUosbUJBQW1CO1FBQ2pCLHdEQUFnQztJQUNsQyxDQUFDO0lBRVMsbUJBQW1CO1FBQzNCLElBQUksT0FBTyxHQUFHLEtBQUssQ0FBQztRQUNwQixJQUFJLENBQUMsdUJBQXVCO2FBQ3pCLG1CQUFtQixFQUFFO2FBQ3JCLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUM7YUFDYixTQUFTLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUFDLENBQUMsT0FBTyxHQUFHLElBQUksQ0FBQyxDQUFDLENBQUM7UUFDekMsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVTLGdCQUFnQixDQUFDLE9BQWdCO1FBQ3pDLElBQUksQ0FBQyx1QkFBdUIsQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN6RCxDQUFDO0lBRUQsbUJBQW1CLENBQ2pCLEtBQStCLEVBQy9CLGdCQUF5QixFQUN6QixhQUFzQixLQUFLO1FBRTNCLE1BQU0sV0FBVyxHQUFHLEtBQUssQ0FBQyxFQUFFLENBQUM7UUFDN0IsTUFBTSxPQUFPLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7UUFDM0MsT0FBTyxJQUFJLENBQUMsSUFBSTthQUNiLEdBQUcsQ0FDRixJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUFDLDRCQUE0QixFQUFFO1lBQzlELFNBQVMsRUFBRSxFQUFFLFdBQVcsRUFBRTtZQUMxQixXQUFXLEVBQUUsZ0JBQWdCO2dCQUMzQixDQUFDLENBQUMsRUFBRSxnQkFBZ0IsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFO2dCQUMzQyxDQUFDLENBQUMsRUFBRSxPQUFPLEVBQUUsVUFBVSxFQUFFO1NBQzVCLENBQUMsRUFDRixFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsc0JBQXNCLEVBQUUsRUFBRSxDQUMzQzthQUNBLElBQUksQ0FDSCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLCtCQUErQixDQUFDLEVBQy9ELEdBQUcsQ0FBQyxDQUFDLG1CQUFtQixFQUFFLEVBQUU7WUFDMUIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQztRQUNqRSxDQUFDLENBQUMsRUFDRixHQUFHLENBQUMsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFO1lBQzFCLE9BQU87Z0JBQ0wsR0FBRyxtQkFBbUI7Z0JBQ3RCLEtBQUssRUFBRSxLQUFLO2FBQ2IsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDTixDQUFDO0lBRUQsaUJBQWlCLENBQ2YsUUFBZ0IsRUFDaEIsT0FBZSxFQUNmLGtCQUE0QztRQUU1QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUMzQyxPQUFPLElBQUksQ0FBQyxJQUFJO2FBQ2IsR0FBRyxDQUNGLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQUMsMEJBQTBCLEVBQUU7WUFDNUQsU0FBUyxFQUFFLEVBQUUsUUFBUSxFQUFFO1lBQ3ZCLFdBQVcsRUFBRSxFQUFFLE9BQU8sRUFBRSxPQUFPLEVBQUU7U0FDbEMsQ0FBQyxFQUNGLEVBQUUsT0FBTyxFQUFFLElBQUksQ0FBQyxzQkFBc0IsRUFBRSxFQUFFLENBQzNDO2FBQ0EsSUFBSSxDQUNILElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsK0JBQStCLENBQUMsRUFDL0QsR0FBRyxDQUFDLENBQUMsbUJBQW1CLEVBQUUsRUFBRTtZQUMxQixJQUFJLENBQUMsZ0JBQWdCLENBQUMsbUJBQW1CLENBQUMsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDO1FBQ2pFLENBQUMsQ0FBQyxFQUNGLEdBQUcsQ0FBQyxDQUFDLG1CQUFtQixFQUFFLEVBQUU7WUFDMUIsT0FBTztnQkFDTCxHQUFHLG1CQUFtQjtnQkFDdEIsS0FBSyxFQUFFLGtCQUFrQjtnQkFDekIsZ0JBQWdCLEVBQUUsS0FBSzthQUN4QixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNOLENBQUM7SUFFRCxtQkFBbUIsQ0FDakIsYUFBeUM7UUFFekMsTUFBTSxRQUFRLEdBQUcsYUFBYSxDQUFDLFFBQVEsQ0FBQztRQUN4QyxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsQ0FBQztRQUMzQyxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUMzQyw0QkFBNEIsRUFDNUI7WUFDRSxTQUFTLEVBQUUsRUFBRSxRQUFRLEVBQUU7WUFDdkIsV0FBVyxFQUFFLEVBQUUsT0FBTyxFQUFFO1NBQ3pCLENBQ0YsQ0FBQztRQUNGLE1BQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FDcEQsYUFBYSxFQUNiLCtCQUErQixDQUNoQyxDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUMsSUFBSTthQUNiLEtBQUssQ0FBZ0MsR0FBRyxFQUFFLGdCQUFnQixFQUFFO1lBQzNELE9BQU8sRUFBRSxJQUFJLENBQUMsc0JBQXNCLEVBQUU7U0FDdkMsQ0FBQzthQUNELElBQUksQ0FDSCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLCtCQUErQixDQUFDLEVBQy9ELEdBQUcsQ0FBQyxDQUFDLG1CQUFtQixFQUFFLEVBQUU7WUFDMUIsSUFBSSxDQUFDLGdCQUFnQixDQUFDLG1CQUFtQixDQUFDLEtBQUssS0FBSyxTQUFTLENBQUMsQ0FBQztRQUNqRSxDQUFDLENBQUMsRUFDRixHQUFHLENBQUMsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFO1lBQzFCLE9BQU87Z0JBQ0wsR0FBRyxtQkFBbUI7Z0JBQ3RCLEtBQUssRUFBRSxhQUFhLENBQUMsS0FBSzthQUMzQixDQUFDO1FBQ0osQ0FBQyxDQUFDLENBQ0gsQ0FBQztJQUNOLENBQUM7SUFFRCxTQUFTLENBQ1AsVUFBNEM7UUFFNUMsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsQ0FDM0MsK0JBQStCLEVBQy9CLEVBQUUsU0FBUyxFQUFFLEVBQUUsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNLEVBQUUsTUFBTSxFQUFFLFVBQVUsQ0FBQyxNQUFNLEVBQUUsRUFBRSxDQUN4RSxDQUFDO1FBRUYsTUFBTSxzQkFBc0IsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsT0FBTyxDQUMxRCxVQUFVLEVBQ1YsMkNBQTJDLENBQzVDLENBQUM7UUFFRixNQUFNLE9BQU8sR0FBRyxJQUFJLFdBQVcsQ0FBQztZQUM5QixjQUFjLEVBQUUsa0JBQWtCO1NBQ25DLENBQUMsQ0FBQztRQUVILE9BQU8sSUFBSSxDQUFDLElBQUk7YUFDYixJQUFJLENBQW1CLEdBQUcsRUFBRSxzQkFBc0IsRUFBRSxFQUFFLE9BQU8sRUFBRSxDQUFDO2FBQ2hFLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLDRCQUE0QixDQUFDLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRUQsNkJBQTZCLENBQzNCLFVBQXVFO1FBRXZFLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1FBQzNDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQzNDLHNDQUFzQyxFQUN0QztZQUNFLFNBQVMsRUFBRTtnQkFDVCxNQUFNLEVBQUUsVUFBVSxDQUFDLE1BQU07Z0JBQ3pCLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtnQkFDekIsZUFBZSxFQUFFLFVBQVUsQ0FBQyxlQUFlO2FBQzVDO1lBQ0QsV0FBVyxFQUFFLEVBQUUsT0FBTyxFQUFFO1NBQ3pCLENBQ0YsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQWdDLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FDM0QsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQywrQkFBK0IsQ0FBQyxFQUMvRCxHQUFHLENBQUMsQ0FBQyxtQkFBbUIsRUFBRSxFQUFFO1lBQzFCLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxtQkFBbUIsQ0FBQyxLQUFLLEtBQUssU0FBUyxDQUFDLENBQUM7UUFDakUsQ0FBQyxDQUFDLEVBQ0YsR0FBRyxDQUFDLENBQUMsbUJBQW1CLEVBQUUsRUFBRTtZQUMxQixPQUFPO2dCQUNMLEdBQUcsbUJBQW1CO2dCQUN0QixLQUFLLEVBQUUsVUFBVSxDQUFDLEtBQUs7YUFDeEIsQ0FBQztRQUNKLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRUQsK0JBQStCLENBQzdCLFVBQWtFO1FBRWxFLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQzNDLHdDQUF3QyxFQUN4QztZQUNFLFNBQVMsRUFBRTtnQkFDVCxNQUFNLEVBQUUsVUFBVSxDQUFDLE1BQU07Z0JBQ3pCLE1BQU0sRUFBRSxVQUFVLENBQUMsTUFBTTtnQkFDekIsZUFBZSxFQUFFLFVBQVUsQ0FBQyxlQUFlO2FBQzVDO1NBQ0YsQ0FDRixDQUFDO1FBRUYsTUFBTSxPQUFPLEdBQUcsSUFBSSxXQUFXLENBQUM7WUFDOUIsY0FBYyxFQUFFLGtCQUFrQjtTQUNuQyxDQUFDLENBQUM7UUFFSCxNQUFNLDRCQUE0QixHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxPQUFPLENBQ2hFLFVBQVUsRUFDVixpREFBaUQsQ0FDbEQsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDLElBQUk7YUFDYixHQUFHLENBQW1CLEdBQUcsRUFBRSw0QkFBNEIsRUFBRSxFQUFFLE9BQU8sRUFBRSxDQUFDO2FBQ3JFLElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLDRCQUE0QixDQUFDLENBQUMsQ0FBQztJQUN4RSxDQUFDO0lBRUQsOEJBQThCLENBQzVCLFVBQXdFO1FBRXhFLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQzNDLCtDQUErQyxFQUMvQztZQUNFLFNBQVMsRUFBRTtnQkFDVCxNQUFNLEVBQUUsVUFBVSxDQUFDLE1BQU07Z0JBQ3pCLE9BQU8sRUFBRSxVQUFVLENBQUMsT0FBTztnQkFDM0IsZ0JBQWdCLEVBQUUsVUFBVSxDQUFDLGdCQUFnQjthQUM5QztTQUNGLENBQ0YsQ0FBQztRQUVGLE9BQU8sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQTJCLEdBQUcsQ0FBQyxDQUFDLElBQUksQ0FDdEQsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FBQyx3Q0FBd0MsQ0FBQyxFQUN4RSxHQUFHLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUNmLE1BQU0sYUFBYSxHQUErQjtnQkFDaEQsUUFBUSxFQUFFLFFBQVEsQ0FBQyxRQUFRO2dCQUMzQixXQUFXLEVBQUUsUUFBUSxDQUFDLFdBQVc7Z0JBQ2pDLE1BQU0sRUFBRSxFQUFFO2dCQUNWLFVBQVUsRUFBRSxFQUFFO2dCQUNkLGdCQUFnQixFQUFFLEVBQUU7Z0JBQ3BCLFFBQVEsRUFBRSxRQUFRO2dCQUNsQixLQUFLLEVBQUUsc0JBQXNCLENBQUMsa0JBQWtCLEVBQUU7YUFDbkQsQ0FBQztZQUNGLE9BQU8sYUFBYSxDQUFDO1FBQ3ZCLENBQUMsQ0FBQyxFQUNGLEdBQUcsQ0FBQyxDQUFDLG1CQUFtQixFQUFFLEVBQUU7WUFDMUIsT0FBTztnQkFDTCxHQUFHLG1CQUFtQjtnQkFDdEIsS0FBSyxFQUFFLFVBQVUsQ0FBQyxLQUFLO2FBQ3hCLENBQUM7UUFDSixDQUFDLENBQUMsQ0FDSCxDQUFDO0lBQ0osQ0FBQztJQUVELGdCQUFnQixDQUNkLGFBQXlDO1FBRXpDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQzNDLHNDQUFzQyxFQUN0QztZQUNFLFNBQVMsRUFBRTtnQkFDVCxRQUFRLEVBQUUsYUFBYSxDQUFDLFFBQVE7YUFDakM7WUFDRCxXQUFXLEVBQUUsRUFBRSxPQUFPLEVBQUUsYUFBYSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRTtTQUN0RSxDQUNGLENBQUM7UUFFRixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsc0JBQXNCLEVBQUUsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUN4RSxJQUFJLENBQUMsZ0JBQWdCLENBQUMsUUFBUSxDQUFDLHFDQUFxQyxDQUFDLEVBQ3JFLEdBQUcsQ0FBQyxDQUFDLFlBQVksRUFBRSxFQUFFO1lBQ25CLE1BQU0sTUFBTSxHQUErQjtnQkFDekMsR0FBRyxhQUFhO2dCQUNoQixZQUFZLEVBQUUsWUFBWSxDQUFDLFlBQVk7Z0JBQ3ZDLGdCQUFnQixFQUFFLFlBQVksQ0FBQyxnQkFBZ0I7YUFDaEQsQ0FBQztZQUNGLE9BQU8sTUFBTSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0lBRUQsd0JBQXdCLENBQ3RCLFFBQWdCO1FBRWhCLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxRQUFRLENBQzNDLGlDQUFpQyxFQUNqQyxFQUFFLFNBQVMsRUFBRSxFQUFFLFFBQVEsRUFBRSxFQUFFLENBQzVCLENBQUM7UUFFRixPQUFPLElBQUksQ0FBQyxJQUFJO2FBQ2IsR0FBRyxDQUEyQixHQUFHLEVBQUU7WUFDbEMsT0FBTyxFQUFFLElBQUksQ0FBQyxzQkFBc0IsRUFBRTtTQUN2QyxDQUFDO2FBQ0QsSUFBSSxDQUNILElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLENBQUMsd0NBQXdDLENBQUMsQ0FDekUsQ0FBQztJQUNOLENBQUM7SUFFRCwyQkFBMkIsQ0FDekIsT0FBOEI7UUFFOUIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLG1CQUFtQixDQUFDLFFBQVEsQ0FDM0MsaUNBQWlDLEVBQ2pDLEVBQUUsU0FBUyxFQUFFLEVBQUUsUUFBUSxFQUFFLE9BQU8sQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUM5QyxDQUFDO1FBRUYsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE9BQU8sQ0FDL0MsT0FBTyxFQUNQLHdDQUF3QyxDQUN6QyxDQUFDO1FBRUYsT0FBTyxJQUFJLENBQUMsSUFBSTthQUNiLEtBQUssQ0FBMkIsR0FBRyxFQUFFLFdBQVcsRUFBRTtZQUNqRCxPQUFPLEVBQUUsSUFBSSxDQUFDLHNCQUFzQixFQUFFO1NBQ3ZDLENBQUM7YUFDRCxJQUFJLENBQ0gsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFFBQVEsQ0FDNUIsd0NBQXdDLENBQ3pDLEVBQ0QsR0FBRyxDQUFDLENBQUMsUUFBUSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1lBQ2pCLEdBQUcsUUFBUTtZQUNYLGdCQUFnQixFQUFFLE9BQU8sQ0FBQyxnQkFBZ0I7WUFDMUMsWUFBWSxFQUFFLE9BQU8sQ0FBQyxZQUFZO1lBQ2xDLGNBQWMsRUFBRSxPQUFPLENBQUMsY0FBYztTQUN2QyxDQUFDLENBQUMsQ0FDSixDQUFDO0lBQ04sQ0FBQztJQUVELGNBQWMsQ0FBQyxRQUFnQjtRQUM3QixNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsUUFBUSxDQUMzQyw0QkFBNEIsRUFDNUIsRUFBRSxTQUFTLEVBQUUsRUFBRSxRQUFRLEVBQUUsRUFBRSxDQUM1QixDQUFDO1FBQ0YsMkZBQTJGO1FBQzNGLHdCQUF3QjtRQUN4QixPQUFPLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUF5QixHQUFHLEVBQUU7WUFDaEQsT0FBTyxFQUFFLElBQUksQ0FBQyxzQkFBc0IsRUFBRTtTQUN2QyxDQUFDLENBQUM7SUFDTCxDQUFDO0lBRUQ7Ozs7Ozs7OztPQVNHO0lBQ08sc0JBQXNCO1FBQzlCLE9BQU8sSUFBSSxXQUFXLEVBQUUsQ0FBQyxHQUFHLENBQUMsY0FBYyxFQUFFO1lBQzNDLGtCQUFrQixFQUFFLElBQUk7U0FDekIsQ0FBQyxDQUFDO0lBQ0wsQ0FBQzs7MEhBbFZVLDZCQUE2Qjs4SEFBN0IsNkJBQTZCOzJGQUE3Qiw2QkFBNkI7a0JBRHpDLFVBQVUiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMyBTQVAgU3BhcnRhY3VzIHRlYW0gPHNwYXJ0YWN1cy10ZWFtQHNhcC5jb20+XG4gKlxuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQgeyBIdHRwQ2xpZW50LCBIdHRwSGVhZGVycywgSHR0cENvbnRleHQgfSBmcm9tICdAYW5ndWxhci9jb21tb24vaHR0cCc7XG5pbXBvcnQgeyBJbmplY3RhYmxlIH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQge1xuICBDYXJ0TW9kaWZpY2F0aW9uLFxuICBDQVJUX01PRElGSUNBVElPTl9OT1JNQUxJWkVSLFxufSBmcm9tICdAc3BhcnRhY3VzL2NhcnQvYmFzZS9yb290JztcbmltcG9ydCB7XG4gIENvbnZlcnRlclNlcnZpY2UsXG4gIE9jY0VuZHBvaW50c1NlcnZpY2UsXG4gIE9DQ19IVFRQX1RPS0VOLFxufSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHtcbiAgQ29tbW9uQ29uZmlndXJhdG9yLFxuICBDb25maWd1cmF0b3JNb2RlbFV0aWxzLFxuICBDb25maWd1cmF0b3JUeXBlLFxufSBmcm9tICdAc3BhcnRhY3VzL3Byb2R1Y3QtY29uZmlndXJhdG9yL2NvbW1vbic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBtYXAsIHRha2UsIHRhcCB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IFJ1bGViYXNlZENvbmZpZ3VyYXRvckFkYXB0ZXIgfSBmcm9tICcuLi8uLi9jb3JlL2Nvbm5lY3RvcnMvcnVsZWJhc2VkLWNvbmZpZ3VyYXRvci5hZGFwdGVyJztcbmltcG9ydCB7IENvbmZpZ3VyYXRvciB9IGZyb20gJy4uLy4uL2NvcmUvbW9kZWwvY29uZmlndXJhdG9yLm1vZGVsJztcbmltcG9ydCB7XG4gIFZBUklBTlRfQ09ORklHVVJBVE9SX0FERF9UT19DQVJUX1NFUklBTElaRVIsXG4gIFZBUklBTlRfQ09ORklHVVJBVE9SX05PUk1BTElaRVIsXG4gIFZBUklBTlRfQ09ORklHVVJBVE9SX09WRVJWSUVXX05PUk1BTElaRVIsXG4gIFZBUklBTlRfQ09ORklHVVJBVE9SX09WRVJWSUVXX1NFUklBTElaRVIsXG4gIFZBUklBTlRfQ09ORklHVVJBVE9SX1BSSUNFX05PUk1BTElaRVIsXG4gIFZBUklBTlRfQ09ORklHVVJBVE9SX1NFUklBTElaRVIsXG4gIFZBUklBTlRfQ09ORklHVVJBVE9SX1VQREFURV9DQVJUX0VOVFJZX1NFUklBTElaRVIsXG59IGZyb20gJy4vdmFyaWFudC1jb25maWd1cmF0b3Itb2NjLmNvbnZlcnRlcnMnO1xuaW1wb3J0IHsgT2NjQ29uZmlndXJhdG9yIH0gZnJvbSAnLi92YXJpYW50LWNvbmZpZ3VyYXRvci1vY2MubW9kZWxzJztcbmltcG9ydCB7IENvbmZpZ3VyYXRvckV4cGVydE1vZGVTZXJ2aWNlIH0gZnJvbSAnLi4vLi4vY29yZS9zZXJ2aWNlcy9jb25maWd1cmF0b3ItZXhwZXJ0LW1vZGUuc2VydmljZSc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBWYXJpYW50Q29uZmlndXJhdG9yT2NjQWRhcHRlclxuICBpbXBsZW1lbnRzIFJ1bGViYXNlZENvbmZpZ3VyYXRvckFkYXB0ZXJcbntcbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGh0dHA6IEh0dHBDbGllbnQsXG4gICAgcHJvdGVjdGVkIG9jY0VuZHBvaW50c1NlcnZpY2U6IE9jY0VuZHBvaW50c1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGNvbnZlcnRlclNlcnZpY2U6IENvbnZlcnRlclNlcnZpY2UsXG4gICAgcHJvdGVjdGVkIGNvbmZpZ0V4cGVydE1vZGVTZXJ2aWNlOiBDb25maWd1cmF0b3JFeHBlcnRNb2RlU2VydmljZVxuICApIHt9XG5cbiAgZ2V0Q29uZmlndXJhdG9yVHlwZSgpOiBzdHJpbmcge1xuICAgIHJldHVybiBDb25maWd1cmF0b3JUeXBlLlZBUklBTlQ7XG4gIH1cblxuICBwcm90ZWN0ZWQgZ2V0RXhwTW9kZVJlcXVlc3RlZCgpOiBib29sZWFuIHtcbiAgICBsZXQgZXhwTW9kZSA9IGZhbHNlO1xuICAgIHRoaXMuY29uZmlnRXhwZXJ0TW9kZVNlcnZpY2VcbiAgICAgIC5nZXRFeHBNb2RlUmVxdWVzdGVkKClcbiAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAuc3Vic2NyaWJlKChtb2RlKSA9PiAoZXhwTW9kZSA9IG1vZGUpKTtcbiAgICByZXR1cm4gZXhwTW9kZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBzZXRFeHBNb2RlQWN0aXZlKGV4cE1vZGU6IGJvb2xlYW4pIHtcbiAgICB0aGlzLmNvbmZpZ0V4cGVydE1vZGVTZXJ2aWNlLnNldEV4cE1vZGVBY3RpdmUoZXhwTW9kZSk7XG4gIH1cblxuICBjcmVhdGVDb25maWd1cmF0aW9uKFxuICAgIG93bmVyOiBDb21tb25Db25maWd1cmF0b3IuT3duZXIsXG4gICAgY29uZmlnSWRUZW1wbGF0ZT86IHN0cmluZyxcbiAgICBmb3JjZVJlc2V0OiBib29sZWFuID0gZmFsc2VcbiAgKTogT2JzZXJ2YWJsZTxDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvbj4ge1xuICAgIGNvbnN0IHByb2R1Y3RDb2RlID0gb3duZXIuaWQ7XG4gICAgY29uc3QgZXhwTW9kZSA9IHRoaXMuZ2V0RXhwTW9kZVJlcXVlc3RlZCgpO1xuICAgIHJldHVybiB0aGlzLmh0dHBcbiAgICAgIC5nZXQ8T2NjQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24+KFxuICAgICAgICB0aGlzLm9jY0VuZHBvaW50c1NlcnZpY2UuYnVpbGRVcmwoJ2NyZWF0ZVZhcmlhbnRDb25maWd1cmF0aW9uJywge1xuICAgICAgICAgIHVybFBhcmFtczogeyBwcm9kdWN0Q29kZSB9LFxuICAgICAgICAgIHF1ZXJ5UGFyYW1zOiBjb25maWdJZFRlbXBsYXRlXG4gICAgICAgICAgICA/IHsgY29uZmlnSWRUZW1wbGF0ZSwgZXhwTW9kZSwgZm9yY2VSZXNldCB9XG4gICAgICAgICAgICA6IHsgZXhwTW9kZSwgZm9yY2VSZXNldCB9LFxuICAgICAgICB9KSxcbiAgICAgICAgeyBjb250ZXh0OiB0aGlzLmluZGljYXRlU2VuZFVzZXJGb3JBc20oKSB9XG4gICAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgdGhpcy5jb252ZXJ0ZXJTZXJ2aWNlLnBpcGVhYmxlKFZBUklBTlRfQ09ORklHVVJBVE9SX05PUk1BTElaRVIpLFxuICAgICAgICB0YXAoKHJlc3VsdENvbmZpZ3VyYXRpb24pID0+IHtcbiAgICAgICAgICB0aGlzLnNldEV4cE1vZGVBY3RpdmUocmVzdWx0Q29uZmlndXJhdGlvbi5rYktleSAhPT0gdW5kZWZpbmVkKTtcbiAgICAgICAgfSksXG4gICAgICAgIG1hcCgocmVzdWx0Q29uZmlndXJhdGlvbikgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi5yZXN1bHRDb25maWd1cmF0aW9uLFxuICAgICAgICAgICAgb3duZXI6IG93bmVyLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgcmVhZENvbmZpZ3VyYXRpb24oXG4gICAgY29uZmlnSWQ6IHN0cmluZyxcbiAgICBncm91cElkOiBzdHJpbmcsXG4gICAgY29uZmlndXJhdGlvbk93bmVyOiBDb21tb25Db25maWd1cmF0b3IuT3duZXJcbiAgKTogT2JzZXJ2YWJsZTxDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvbj4ge1xuICAgIGNvbnN0IGV4cE1vZGUgPSB0aGlzLmdldEV4cE1vZGVSZXF1ZXN0ZWQoKTtcbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAuZ2V0PE9jY0NvbmZpZ3VyYXRvci5Db25maWd1cmF0aW9uPihcbiAgICAgICAgdGhpcy5vY2NFbmRwb2ludHNTZXJ2aWNlLmJ1aWxkVXJsKCdyZWFkVmFyaWFudENvbmZpZ3VyYXRpb24nLCB7XG4gICAgICAgICAgdXJsUGFyYW1zOiB7IGNvbmZpZ0lkIH0sXG4gICAgICAgICAgcXVlcnlQYXJhbXM6IHsgZ3JvdXBJZCwgZXhwTW9kZSB9LFxuICAgICAgICB9KSxcbiAgICAgICAgeyBjb250ZXh0OiB0aGlzLmluZGljYXRlU2VuZFVzZXJGb3JBc20oKSB9XG4gICAgICApXG4gICAgICAucGlwZShcbiAgICAgICAgdGhpcy5jb252ZXJ0ZXJTZXJ2aWNlLnBpcGVhYmxlKFZBUklBTlRfQ09ORklHVVJBVE9SX05PUk1BTElaRVIpLFxuICAgICAgICB0YXAoKHJlc3VsdENvbmZpZ3VyYXRpb24pID0+IHtcbiAgICAgICAgICB0aGlzLnNldEV4cE1vZGVBY3RpdmUocmVzdWx0Q29uZmlndXJhdGlvbi5rYktleSAhPT0gdW5kZWZpbmVkKTtcbiAgICAgICAgfSksXG4gICAgICAgIG1hcCgocmVzdWx0Q29uZmlndXJhdGlvbikgPT4ge1xuICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAuLi5yZXN1bHRDb25maWd1cmF0aW9uLFxuICAgICAgICAgICAgb3duZXI6IGNvbmZpZ3VyYXRpb25Pd25lcixcbiAgICAgICAgICAgIG5ld0NvbmZpZ3VyYXRpb246IGZhbHNlLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgdXBkYXRlQ29uZmlndXJhdGlvbihcbiAgICBjb25maWd1cmF0aW9uOiBDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvblxuICApOiBPYnNlcnZhYmxlPENvbmZpZ3VyYXRvci5Db25maWd1cmF0aW9uPiB7XG4gICAgY29uc3QgY29uZmlnSWQgPSBjb25maWd1cmF0aW9uLmNvbmZpZ0lkO1xuICAgIGNvbnN0IGV4cE1vZGUgPSB0aGlzLmdldEV4cE1vZGVSZXF1ZXN0ZWQoKTtcbiAgICBjb25zdCB1cmwgPSB0aGlzLm9jY0VuZHBvaW50c1NlcnZpY2UuYnVpbGRVcmwoXG4gICAgICAndXBkYXRlVmFyaWFudENvbmZpZ3VyYXRpb24nLFxuICAgICAge1xuICAgICAgICB1cmxQYXJhbXM6IHsgY29uZmlnSWQgfSxcbiAgICAgICAgcXVlcnlQYXJhbXM6IHsgZXhwTW9kZSB9LFxuICAgICAgfVxuICAgICk7XG4gICAgY29uc3Qgb2NjQ29uZmlndXJhdGlvbiA9IHRoaXMuY29udmVydGVyU2VydmljZS5jb252ZXJ0KFxuICAgICAgY29uZmlndXJhdGlvbixcbiAgICAgIFZBUklBTlRfQ09ORklHVVJBVE9SX1NFUklBTElaRVJcbiAgICApO1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnBhdGNoPE9jY0NvbmZpZ3VyYXRvci5Db25maWd1cmF0aW9uPih1cmwsIG9jY0NvbmZpZ3VyYXRpb24sIHtcbiAgICAgICAgY29udGV4dDogdGhpcy5pbmRpY2F0ZVNlbmRVc2VyRm9yQXNtKCksXG4gICAgICB9KVxuICAgICAgLnBpcGUoXG4gICAgICAgIHRoaXMuY29udmVydGVyU2VydmljZS5waXBlYWJsZShWQVJJQU5UX0NPTkZJR1VSQVRPUl9OT1JNQUxJWkVSKSxcbiAgICAgICAgdGFwKChyZXN1bHRDb25maWd1cmF0aW9uKSA9PiB7XG4gICAgICAgICAgdGhpcy5zZXRFeHBNb2RlQWN0aXZlKHJlc3VsdENvbmZpZ3VyYXRpb24ua2JLZXkgIT09IHVuZGVmaW5lZCk7XG4gICAgICAgIH0pLFxuICAgICAgICBtYXAoKHJlc3VsdENvbmZpZ3VyYXRpb24pID0+IHtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4ucmVzdWx0Q29uZmlndXJhdGlvbixcbiAgICAgICAgICAgIG93bmVyOiBjb25maWd1cmF0aW9uLm93bmVyLFxuICAgICAgICAgIH07XG4gICAgICAgIH0pXG4gICAgICApO1xuICB9XG5cbiAgYWRkVG9DYXJ0KFxuICAgIHBhcmFtZXRlcnM6IENvbmZpZ3VyYXRvci5BZGRUb0NhcnRQYXJhbWV0ZXJzXG4gICk6IE9ic2VydmFibGU8Q2FydE1vZGlmaWNhdGlvbj4ge1xuICAgIGNvbnN0IHVybCA9IHRoaXMub2NjRW5kcG9pbnRzU2VydmljZS5idWlsZFVybChcbiAgICAgICdhZGRWYXJpYW50Q29uZmlndXJhdGlvblRvQ2FydCcsXG4gICAgICB7IHVybFBhcmFtczogeyB1c2VySWQ6IHBhcmFtZXRlcnMudXNlcklkLCBjYXJ0SWQ6IHBhcmFtZXRlcnMuY2FydElkIH0gfVxuICAgICk7XG5cbiAgICBjb25zdCBvY2NBZGRUb0NhcnRQYXJhbWV0ZXJzID0gdGhpcy5jb252ZXJ0ZXJTZXJ2aWNlLmNvbnZlcnQoXG4gICAgICBwYXJhbWV0ZXJzLFxuICAgICAgVkFSSUFOVF9DT05GSUdVUkFUT1JfQUREX1RPX0NBUlRfU0VSSUFMSVpFUlxuICAgICk7XG5cbiAgICBjb25zdCBoZWFkZXJzID0gbmV3IEh0dHBIZWFkZXJzKHtcbiAgICAgICdDb250ZW50LVR5cGUnOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAucG9zdDxDYXJ0TW9kaWZpY2F0aW9uPih1cmwsIG9jY0FkZFRvQ2FydFBhcmFtZXRlcnMsIHsgaGVhZGVycyB9KVxuICAgICAgLnBpcGUodGhpcy5jb252ZXJ0ZXJTZXJ2aWNlLnBpcGVhYmxlKENBUlRfTU9ESUZJQ0FUSU9OX05PUk1BTElaRVIpKTtcbiAgfVxuXG4gIHJlYWRDb25maWd1cmF0aW9uRm9yQ2FydEVudHJ5KFxuICAgIHBhcmFtZXRlcnM6IENvbW1vbkNvbmZpZ3VyYXRvci5SZWFkQ29uZmlndXJhdGlvbkZyb21DYXJ0RW50cnlQYXJhbWV0ZXJzXG4gICk6IE9ic2VydmFibGU8Q29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24+IHtcbiAgICBjb25zdCBleHBNb2RlID0gdGhpcy5nZXRFeHBNb2RlUmVxdWVzdGVkKCk7XG4gICAgY29uc3QgdXJsID0gdGhpcy5vY2NFbmRwb2ludHNTZXJ2aWNlLmJ1aWxkVXJsKFxuICAgICAgJ3JlYWRWYXJpYW50Q29uZmlndXJhdGlvbkZvckNhcnRFbnRyeScsXG4gICAgICB7XG4gICAgICAgIHVybFBhcmFtczoge1xuICAgICAgICAgIHVzZXJJZDogcGFyYW1ldGVycy51c2VySWQsXG4gICAgICAgICAgY2FydElkOiBwYXJhbWV0ZXJzLmNhcnRJZCxcbiAgICAgICAgICBjYXJ0RW50cnlOdW1iZXI6IHBhcmFtZXRlcnMuY2FydEVudHJ5TnVtYmVyLFxuICAgICAgICB9LFxuICAgICAgICBxdWVyeVBhcmFtczogeyBleHBNb2RlIH0sXG4gICAgICB9XG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PE9jY0NvbmZpZ3VyYXRvci5Db25maWd1cmF0aW9uPih1cmwpLnBpcGUoXG4gICAgICB0aGlzLmNvbnZlcnRlclNlcnZpY2UucGlwZWFibGUoVkFSSUFOVF9DT05GSUdVUkFUT1JfTk9STUFMSVpFUiksXG4gICAgICB0YXAoKHJlc3VsdENvbmZpZ3VyYXRpb24pID0+IHtcbiAgICAgICAgdGhpcy5zZXRFeHBNb2RlQWN0aXZlKHJlc3VsdENvbmZpZ3VyYXRpb24ua2JLZXkgIT09IHVuZGVmaW5lZCk7XG4gICAgICB9KSxcbiAgICAgIG1hcCgocmVzdWx0Q29uZmlndXJhdGlvbikgPT4ge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIC4uLnJlc3VsdENvbmZpZ3VyYXRpb24sXG4gICAgICAgICAgb3duZXI6IHBhcmFtZXRlcnMub3duZXIsXG4gICAgICAgIH07XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICB1cGRhdGVDb25maWd1cmF0aW9uRm9yQ2FydEVudHJ5KFxuICAgIHBhcmFtZXRlcnM6IENvbmZpZ3VyYXRvci5VcGRhdGVDb25maWd1cmF0aW9uRm9yQ2FydEVudHJ5UGFyYW1ldGVyc1xuICApOiBPYnNlcnZhYmxlPENhcnRNb2RpZmljYXRpb24+IHtcbiAgICBjb25zdCB1cmwgPSB0aGlzLm9jY0VuZHBvaW50c1NlcnZpY2UuYnVpbGRVcmwoXG4gICAgICAndXBkYXRlVmFyaWFudENvbmZpZ3VyYXRpb25Gb3JDYXJ0RW50cnknLFxuICAgICAge1xuICAgICAgICB1cmxQYXJhbXM6IHtcbiAgICAgICAgICB1c2VySWQ6IHBhcmFtZXRlcnMudXNlcklkLFxuICAgICAgICAgIGNhcnRJZDogcGFyYW1ldGVycy5jYXJ0SWQsXG4gICAgICAgICAgY2FydEVudHJ5TnVtYmVyOiBwYXJhbWV0ZXJzLmNhcnRFbnRyeU51bWJlcixcbiAgICAgICAgfSxcbiAgICAgIH1cbiAgICApO1xuXG4gICAgY29uc3QgaGVhZGVycyA9IG5ldyBIdHRwSGVhZGVycyh7XG4gICAgICAnQ29udGVudC1UeXBlJzogJ2FwcGxpY2F0aW9uL2pzb24nLFxuICAgIH0pO1xuXG4gICAgY29uc3Qgb2NjVXBkYXRlQ2FydEVudHJ5UGFyYW1ldGVycyA9IHRoaXMuY29udmVydGVyU2VydmljZS5jb252ZXJ0KFxuICAgICAgcGFyYW1ldGVycyxcbiAgICAgIFZBUklBTlRfQ09ORklHVVJBVE9SX1VQREFURV9DQVJUX0VOVFJZX1NFUklBTElaRVJcbiAgICApO1xuXG4gICAgcmV0dXJuIHRoaXMuaHR0cFxuICAgICAgLnB1dDxDYXJ0TW9kaWZpY2F0aW9uPih1cmwsIG9jY1VwZGF0ZUNhcnRFbnRyeVBhcmFtZXRlcnMsIHsgaGVhZGVycyB9KVxuICAgICAgLnBpcGUodGhpcy5jb252ZXJ0ZXJTZXJ2aWNlLnBpcGVhYmxlKENBUlRfTU9ESUZJQ0FUSU9OX05PUk1BTElaRVIpKTtcbiAgfVxuXG4gIHJlYWRDb25maWd1cmF0aW9uRm9yT3JkZXJFbnRyeShcbiAgICBwYXJhbWV0ZXJzOiBDb21tb25Db25maWd1cmF0b3IuUmVhZENvbmZpZ3VyYXRpb25Gcm9tT3JkZXJFbnRyeVBhcmFtZXRlcnNcbiAgKTogT2JzZXJ2YWJsZTxDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvbj4ge1xuICAgIGNvbnN0IHVybCA9IHRoaXMub2NjRW5kcG9pbnRzU2VydmljZS5idWlsZFVybChcbiAgICAgICdyZWFkVmFyaWFudENvbmZpZ3VyYXRpb25PdmVydmlld0Zvck9yZGVyRW50cnknLFxuICAgICAge1xuICAgICAgICB1cmxQYXJhbXM6IHtcbiAgICAgICAgICB1c2VySWQ6IHBhcmFtZXRlcnMudXNlcklkLFxuICAgICAgICAgIG9yZGVySWQ6IHBhcmFtZXRlcnMub3JkZXJJZCxcbiAgICAgICAgICBvcmRlckVudHJ5TnVtYmVyOiBwYXJhbWV0ZXJzLm9yZGVyRW50cnlOdW1iZXIsXG4gICAgICAgIH0sXG4gICAgICB9XG4gICAgKTtcblxuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PE9jY0NvbmZpZ3VyYXRvci5PdmVydmlldz4odXJsKS5waXBlKFxuICAgICAgdGhpcy5jb252ZXJ0ZXJTZXJ2aWNlLnBpcGVhYmxlKFZBUklBTlRfQ09ORklHVVJBVE9SX09WRVJWSUVXX05PUk1BTElaRVIpLFxuICAgICAgbWFwKChvdmVydmlldykgPT4ge1xuICAgICAgICBjb25zdCBjb25maWd1cmF0aW9uOiBDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvbiA9IHtcbiAgICAgICAgICBjb25maWdJZDogb3ZlcnZpZXcuY29uZmlnSWQsXG4gICAgICAgICAgcHJvZHVjdENvZGU6IG92ZXJ2aWV3LnByb2R1Y3RDb2RlLFxuICAgICAgICAgIGdyb3VwczogW10sXG4gICAgICAgICAgZmxhdEdyb3VwczogW10sXG4gICAgICAgICAgaW50ZXJhY3Rpb25TdGF0ZToge30sXG4gICAgICAgICAgb3ZlcnZpZXc6IG92ZXJ2aWV3LFxuICAgICAgICAgIG93bmVyOiBDb25maWd1cmF0b3JNb2RlbFV0aWxzLmNyZWF0ZUluaXRpYWxPd25lcigpLFxuICAgICAgICB9O1xuICAgICAgICByZXR1cm4gY29uZmlndXJhdGlvbjtcbiAgICAgIH0pLFxuICAgICAgbWFwKChyZXN1bHRDb25maWd1cmF0aW9uKSA9PiB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgLi4ucmVzdWx0Q29uZmlndXJhdGlvbixcbiAgICAgICAgICBvd25lcjogcGFyYW1ldGVycy5vd25lcixcbiAgICAgICAgfTtcbiAgICAgIH0pXG4gICAgKTtcbiAgfVxuXG4gIHJlYWRQcmljZVN1bW1hcnkoXG4gICAgY29uZmlndXJhdGlvbjogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb25cbiAgKTogT2JzZXJ2YWJsZTxDb25maWd1cmF0b3IuQ29uZmlndXJhdGlvbj4ge1xuICAgIGNvbnN0IHVybCA9IHRoaXMub2NjRW5kcG9pbnRzU2VydmljZS5idWlsZFVybChcbiAgICAgICdyZWFkVmFyaWFudENvbmZpZ3VyYXRpb25QcmljZVN1bW1hcnknLFxuICAgICAge1xuICAgICAgICB1cmxQYXJhbXM6IHtcbiAgICAgICAgICBjb25maWdJZDogY29uZmlndXJhdGlvbi5jb25maWdJZCxcbiAgICAgICAgfSxcbiAgICAgICAgcXVlcnlQYXJhbXM6IHsgZ3JvdXBJZDogY29uZmlndXJhdGlvbi5pbnRlcmFjdGlvblN0YXRlLmN1cnJlbnRHcm91cCB9LFxuICAgICAgfVxuICAgICk7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwLmdldCh1cmwsIHsgY29udGV4dDogdGhpcy5pbmRpY2F0ZVNlbmRVc2VyRm9yQXNtKCkgfSkucGlwZShcbiAgICAgIHRoaXMuY29udmVydGVyU2VydmljZS5waXBlYWJsZShWQVJJQU5UX0NPTkZJR1VSQVRPUl9QUklDRV9OT1JNQUxJWkVSKSxcbiAgICAgIG1hcCgoY29uZmlnUmVzdWx0KSA9PiB7XG4gICAgICAgIGNvbnN0IHJlc3VsdDogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24gPSB7XG4gICAgICAgICAgLi4uY29uZmlndXJhdGlvbixcbiAgICAgICAgICBwcmljZVN1bW1hcnk6IGNvbmZpZ1Jlc3VsdC5wcmljZVN1bW1hcnksXG4gICAgICAgICAgcHJpY2VTdXBwbGVtZW50czogY29uZmlnUmVzdWx0LnByaWNlU3VwcGxlbWVudHMsXG4gICAgICAgIH07XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9KVxuICAgICk7XG4gIH1cblxuICBnZXRDb25maWd1cmF0aW9uT3ZlcnZpZXcoXG4gICAgY29uZmlnSWQ6IHN0cmluZ1xuICApOiBPYnNlcnZhYmxlPENvbmZpZ3VyYXRvci5PdmVydmlldz4ge1xuICAgIGNvbnN0IHVybCA9IHRoaXMub2NjRW5kcG9pbnRzU2VydmljZS5idWlsZFVybChcbiAgICAgICdnZXRWYXJpYW50Q29uZmlndXJhdGlvbk92ZXJ2aWV3JyxcbiAgICAgIHsgdXJsUGFyYW1zOiB7IGNvbmZpZ0lkIH0gfVxuICAgICk7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAuZ2V0PE9jY0NvbmZpZ3VyYXRvci5PdmVydmlldz4odXJsLCB7XG4gICAgICAgIGNvbnRleHQ6IHRoaXMuaW5kaWNhdGVTZW5kVXNlckZvckFzbSgpLFxuICAgICAgfSlcbiAgICAgIC5waXBlKFxuICAgICAgICB0aGlzLmNvbnZlcnRlclNlcnZpY2UucGlwZWFibGUoVkFSSUFOVF9DT05GSUdVUkFUT1JfT1ZFUlZJRVdfTk9STUFMSVpFUilcbiAgICAgICk7XG4gIH1cblxuICB1cGRhdGVDb25maWd1cmF0aW9uT3ZlcnZpZXcoXG4gICAgb3ZJbnB1dDogQ29uZmlndXJhdG9yLk92ZXJ2aWV3XG4gICk6IE9ic2VydmFibGU8Q29uZmlndXJhdG9yLk92ZXJ2aWV3PiB7XG4gICAgY29uc3QgdXJsID0gdGhpcy5vY2NFbmRwb2ludHNTZXJ2aWNlLmJ1aWxkVXJsKFxuICAgICAgJ2dldFZhcmlhbnRDb25maWd1cmF0aW9uT3ZlcnZpZXcnLFxuICAgICAgeyB1cmxQYXJhbXM6IHsgY29uZmlnSWQ6IG92SW5wdXQuY29uZmlnSWQgfSB9XG4gICAgKTtcblxuICAgIGNvbnN0IG9jY092ZXJ2aWV3ID0gdGhpcy5jb252ZXJ0ZXJTZXJ2aWNlLmNvbnZlcnQoXG4gICAgICBvdklucHV0LFxuICAgICAgVkFSSUFOVF9DT05GSUdVUkFUT1JfT1ZFUlZJRVdfU0VSSUFMSVpFUlxuICAgICk7XG5cbiAgICByZXR1cm4gdGhpcy5odHRwXG4gICAgICAucGF0Y2g8T2NjQ29uZmlndXJhdG9yLk92ZXJ2aWV3Pih1cmwsIG9jY092ZXJ2aWV3LCB7XG4gICAgICAgIGNvbnRleHQ6IHRoaXMuaW5kaWNhdGVTZW5kVXNlckZvckFzbSgpLFxuICAgICAgfSlcbiAgICAgIC5waXBlKFxuICAgICAgICB0aGlzLmNvbnZlcnRlclNlcnZpY2UucGlwZWFibGUoXG4gICAgICAgICAgVkFSSUFOVF9DT05GSUdVUkFUT1JfT1ZFUlZJRVdfTk9STUFMSVpFUlxuICAgICAgICApLFxuICAgICAgICBtYXAoKG92ZXJ2aWV3KSA9PiAoe1xuICAgICAgICAgIC4uLm92ZXJ2aWV3LFxuICAgICAgICAgIGF0dHJpYnV0ZUZpbHRlcnM6IG92SW5wdXQuYXR0cmlidXRlRmlsdGVycyxcbiAgICAgICAgICBncm91cEZpbHRlcnM6IG92SW5wdXQuZ3JvdXBGaWx0ZXJzLFxuICAgICAgICAgIHBvc3NpYmxlR3JvdXBzOiBvdklucHV0LnBvc3NpYmxlR3JvdXBzLFxuICAgICAgICB9KSlcbiAgICAgICk7XG4gIH1cblxuICBzZWFyY2hWYXJpYW50cyhjb25maWdJZDogc3RyaW5nKTogT2JzZXJ2YWJsZTxDb25maWd1cmF0b3IuVmFyaWFudFtdPiB7XG4gICAgY29uc3QgdXJsID0gdGhpcy5vY2NFbmRwb2ludHNTZXJ2aWNlLmJ1aWxkVXJsKFxuICAgICAgJ3NlYXJjaENvbmZpZ3VyYXRvclZhcmlhbnRzJyxcbiAgICAgIHsgdXJsUGFyYW1zOiB7IGNvbmZpZ0lkIH0gfVxuICAgICk7XG4gICAgLy9ubyBuZWVkIHRvIHdvcmsgd2l0aCBhIGNvbnZlcnRlciBoZXJlLCBhcyBDb25maWd1cmF0b3IuVmFyaWFudCBpcyBhIHByb2plY3Rpb24gb2YgdGhlIE9DQ1xuICAgIC8vdmFyaWFudCByZXByZXNlbnRhdGlvblxuICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0PENvbmZpZ3VyYXRvci5WYXJpYW50W10+KHVybCwge1xuICAgICAgY29udGV4dDogdGhpcy5pbmRpY2F0ZVNlbmRVc2VyRm9yQXNtKCksXG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogUHJlcGFyZXMgaHR0cCBjb250ZXh0IGluZGljYXRpbmcgdGhhdCBlbXVsYXRlZCB1c2VyIGhhcyB0byBiZSBhZGRlZCB0byB0aGUgcmVxdWVzdCBpbiBBU00gbW9kZVxuICAgKlxuICAgKiBUaGUgYWN0dWFsIGNhbGxzIHRvIHRoZSBjb21tZXJjZSBiYWNrZW5kIHdpbGwgb25seSBiZSBjaGFuZ2VkIGlmIHRoZSBBU00gc2V0dGluZ1xuICAgKiB1c2VySWRIdHRwSGVhZGVyOntcbiAgICogIGVuYWJsZTp0cnVlXG4gICAqIH0sXG4gICAqIGlzIGFjdGl2ZVxuICAgKiBAcmV0dXJucyBodHRwIGNvbnRleHQgaW5kaWNhdGluZyB0aGF0IGVtdWxhdGVkIHVzZXIgaGFzIHRvIGJlIGFkZGVkIHRvIHRoZSByZXF1ZXN0IGluIEFTTSBtb2RlXG4gICAqL1xuICBwcm90ZWN0ZWQgaW5kaWNhdGVTZW5kVXNlckZvckFzbSgpOiBIdHRwQ29udGV4dCB7XG4gICAgcmV0dXJuIG5ldyBIdHRwQ29udGV4dCgpLnNldChPQ0NfSFRUUF9UT0tFTiwge1xuICAgICAgc2VuZFVzZXJJZEFzSGVhZGVyOiB0cnVlLFxuICAgIH0pO1xuICB9XG59XG4iXX0=