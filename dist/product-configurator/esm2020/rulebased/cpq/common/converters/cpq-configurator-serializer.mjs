/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { Configurator } from '@spartacus/product-configurator/rulebased';
import { CpqConfiguratorUtils } from '../../rest/cpq-configurator-utils';
import * as i0 from "@angular/core";
const VALUE_SEPARATOR = ',';
export class CpqConfiguratorSerializer {
    convert(source) {
        const attribute = CpqConfiguratorUtils.findFirstChangedAttribute(source);
        let updateAttribute;
        if (source.updateType === Configurator.UpdateType.ATTRIBUTE_QUANTITY) {
            updateAttribute = this.convertQuantity(attribute, source.configId);
        }
        else {
            updateAttribute = this.convertAttribute(attribute, source.configId);
        }
        return updateAttribute;
    }
    convertQuantity(attribute, configId) {
        const updateInformation = CpqConfiguratorUtils.getUpdateInformation(attribute);
        const updateAttribute = {
            configurationId: configId,
            standardAttributeCode: updateInformation.standardAttributeCode,
            changeAttributeValue: { quantity: attribute.quantity },
            tabId: updateInformation.tabId,
        };
        return updateAttribute;
    }
    convertAttribute(attribute, configurationId) {
        const updateInformation = CpqConfiguratorUtils.getUpdateInformation(attribute);
        const updateAttribute = {
            configurationId: configurationId,
            standardAttributeCode: updateInformation.standardAttributeCode,
            changeAttributeValue: {},
            tabId: updateInformation.tabId,
        };
        if (attribute.uiType === Configurator.UiType.DROPDOWN ||
            attribute.uiType === Configurator.UiType.DROPDOWN_PRODUCT ||
            attribute.uiType === Configurator.UiType.RADIOBUTTON ||
            attribute.uiType === Configurator.UiType.RADIOBUTTON_PRODUCT ||
            attribute.uiType === Configurator.UiType.SINGLE_SELECTION_IMAGE) {
            updateAttribute.changeAttributeValue.attributeValueIds =
                this.processSelectedSingleValue(attribute.selectedSingleValue);
        }
        else if (attribute.uiType === Configurator.UiType.CHECKBOXLIST ||
            attribute.uiType === Configurator.UiType.CHECKBOXLIST_PRODUCT ||
            attribute.uiType === Configurator.UiType.CHECKBOX ||
            attribute.uiType === Configurator.UiType.MULTI_SELECTION_IMAGE) {
            updateAttribute.changeAttributeValue.attributeValueIds =
                this.prepareValueIds(attribute);
        }
        else if (attribute.uiType === Configurator.UiType.STRING ||
            attribute.uiType === Configurator.UiType.NUMERIC) {
            updateAttribute.changeAttributeValue.userInput = attribute.userInput;
            if (!updateAttribute.changeAttributeValue?.userInput) {
                updateAttribute.changeAttributeValue.userInput = ' ';
            }
        }
        return updateAttribute;
    }
    processValueCode(valueCode) {
        return valueCode && valueCode === Configurator.RetractValueCode
            ? '0'
            : valueCode;
    }
    processSelectedSingleValue(singleValue) {
        let processedValue = this.processValueCode(singleValue);
        if (!processedValue) {
            // Is required to remove the value
            processedValue = VALUE_SEPARATOR;
        }
        return processedValue;
    }
    prepareValueIds(attribute) {
        let valueIds = '';
        const selectedValues = attribute.values?.filter((value) => value.selected);
        if (selectedValues && selectedValues.length > 0) {
            selectedValues.forEach((value) => {
                valueIds += value.valueCode + VALUE_SEPARATOR;
            });
        }
        else {
            // Is required to remove the value
            valueIds = VALUE_SEPARATOR;
        }
        return valueIds;
    }
}
CpqConfiguratorSerializer.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CpqConfiguratorSerializer, deps: [], target: i0.ɵɵFactoryTarget.Injectable });
CpqConfiguratorSerializer.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CpqConfiguratorSerializer });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CpqConfiguratorSerializer, decorators: [{
            type: Injectable
        }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3BxLWNvbmZpZ3VyYXRvci1zZXJpYWxpemVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL3Byb2R1Y3QtY29uZmlndXJhdG9yL3J1bGViYXNlZC9jcHEvY29tbW9uL2NvbnZlcnRlcnMvY3BxLWNvbmZpZ3VyYXRvci1zZXJpYWxpemVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUV6RSxPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSxtQ0FBbUMsQ0FBQzs7QUFFekUsTUFBTSxlQUFlLEdBQUcsR0FBRyxDQUFDO0FBRzVCLE1BQU0sT0FBTyx5QkFBeUI7SUFHcEMsT0FBTyxDQUFDLE1BQWtDO1FBQ3hDLE1BQU0sU0FBUyxHQUNiLG9CQUFvQixDQUFDLHlCQUF5QixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQ3pELElBQUksZUFBb0MsQ0FBQztRQUN6QyxJQUFJLE1BQU0sQ0FBQyxVQUFVLEtBQUssWUFBWSxDQUFDLFVBQVUsQ0FBQyxrQkFBa0IsRUFBRTtZQUNwRSxlQUFlLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3BFO2FBQU07WUFDTCxlQUFlLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7U0FDckU7UUFDRCxPQUFPLGVBQWUsQ0FBQztJQUN6QixDQUFDO0lBRVMsZUFBZSxDQUN2QixTQUFpQyxFQUNqQyxRQUFnQjtRQUVoQixNQUFNLGlCQUFpQixHQUNyQixvQkFBb0IsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUV2RCxNQUFNLGVBQWUsR0FBd0I7WUFDM0MsZUFBZSxFQUFFLFFBQVE7WUFDekIscUJBQXFCLEVBQUUsaUJBQWlCLENBQUMscUJBQXFCO1lBQzlELG9CQUFvQixFQUFFLEVBQUUsUUFBUSxFQUFFLFNBQVMsQ0FBQyxRQUFRLEVBQUU7WUFDdEQsS0FBSyxFQUFFLGlCQUFpQixDQUFDLEtBQUs7U0FDL0IsQ0FBQztRQUNGLE9BQU8sZUFBZSxDQUFDO0lBQ3pCLENBQUM7SUFFUyxnQkFBZ0IsQ0FDeEIsU0FBaUMsRUFDakMsZUFBdUI7UUFFdkIsTUFBTSxpQkFBaUIsR0FDckIsb0JBQW9CLENBQUMsb0JBQW9CLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDdkQsTUFBTSxlQUFlLEdBQXdCO1lBQzNDLGVBQWUsRUFBRSxlQUFlO1lBQ2hDLHFCQUFxQixFQUFFLGlCQUFpQixDQUFDLHFCQUFxQjtZQUM5RCxvQkFBb0IsRUFBRSxFQUFFO1lBQ3hCLEtBQUssRUFBRSxpQkFBaUIsQ0FBQyxLQUFLO1NBQy9CLENBQUM7UUFFRixJQUNFLFNBQVMsQ0FBQyxNQUFNLEtBQUssWUFBWSxDQUFDLE1BQU0sQ0FBQyxRQUFRO1lBQ2pELFNBQVMsQ0FBQyxNQUFNLEtBQUssWUFBWSxDQUFDLE1BQU0sQ0FBQyxnQkFBZ0I7WUFDekQsU0FBUyxDQUFDLE1BQU0sS0FBSyxZQUFZLENBQUMsTUFBTSxDQUFDLFdBQVc7WUFDcEQsU0FBUyxDQUFDLE1BQU0sS0FBSyxZQUFZLENBQUMsTUFBTSxDQUFDLG1CQUFtQjtZQUM1RCxTQUFTLENBQUMsTUFBTSxLQUFLLFlBQVksQ0FBQyxNQUFNLENBQUMsc0JBQXNCLEVBQy9EO1lBQ0EsZUFBZSxDQUFDLG9CQUFvQixDQUFDLGlCQUFpQjtnQkFDcEQsSUFBSSxDQUFDLDBCQUEwQixDQUFDLFNBQVMsQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1NBQ2xFO2FBQU0sSUFDTCxTQUFTLENBQUMsTUFBTSxLQUFLLFlBQVksQ0FBQyxNQUFNLENBQUMsWUFBWTtZQUNyRCxTQUFTLENBQUMsTUFBTSxLQUFLLFlBQVksQ0FBQyxNQUFNLENBQUMsb0JBQW9CO1lBQzdELFNBQVMsQ0FBQyxNQUFNLEtBQUssWUFBWSxDQUFDLE1BQU0sQ0FBQyxRQUFRO1lBQ2pELFNBQVMsQ0FBQyxNQUFNLEtBQUssWUFBWSxDQUFDLE1BQU0sQ0FBQyxxQkFBcUIsRUFDOUQ7WUFDQSxlQUFlLENBQUMsb0JBQW9CLENBQUMsaUJBQWlCO2dCQUNwRCxJQUFJLENBQUMsZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1NBQ25DO2FBQU0sSUFDTCxTQUFTLENBQUMsTUFBTSxLQUFLLFlBQVksQ0FBQyxNQUFNLENBQUMsTUFBTTtZQUMvQyxTQUFTLENBQUMsTUFBTSxLQUFLLFlBQVksQ0FBQyxNQUFNLENBQUMsT0FBTyxFQUNoRDtZQUNBLGVBQWUsQ0FBQyxvQkFBb0IsQ0FBQyxTQUFTLEdBQUcsU0FBUyxDQUFDLFNBQVMsQ0FBQztZQUNyRSxJQUFJLENBQUMsZUFBZSxDQUFDLG9CQUFvQixFQUFFLFNBQVMsRUFBRTtnQkFDcEQsZUFBZSxDQUFDLG9CQUFvQixDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUM7YUFDdEQ7U0FDRjtRQUNELE9BQU8sZUFBZSxDQUFDO0lBQ3pCLENBQUM7SUFFUyxnQkFBZ0IsQ0FBQyxTQUFrQjtRQUMzQyxPQUFPLFNBQVMsSUFBSSxTQUFTLEtBQUssWUFBWSxDQUFDLGdCQUFnQjtZQUM3RCxDQUFDLENBQUMsR0FBRztZQUNMLENBQUMsQ0FBQyxTQUFTLENBQUM7SUFDaEIsQ0FBQztJQUVTLDBCQUEwQixDQUFDLFdBQW9CO1FBQ3ZELElBQUksY0FBYyxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN4RCxJQUFJLENBQUMsY0FBYyxFQUFFO1lBQ25CLGtDQUFrQztZQUNsQyxjQUFjLEdBQUcsZUFBZSxDQUFDO1NBQ2xDO1FBQ0QsT0FBTyxjQUFjLENBQUM7SUFDeEIsQ0FBQztJQUVTLGVBQWUsQ0FBQyxTQUFpQztRQUN6RCxJQUFJLFFBQVEsR0FBRyxFQUFFLENBQUM7UUFDbEIsTUFBTSxjQUFjLEdBQUcsU0FBUyxDQUFDLE1BQU0sRUFBRSxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUUzRSxJQUFJLGNBQWMsSUFBSSxjQUFjLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRTtZQUMvQyxjQUFjLENBQUMsT0FBTyxDQUFDLENBQUMsS0FBSyxFQUFFLEVBQUU7Z0JBQy9CLFFBQVEsSUFBSSxLQUFLLENBQUMsU0FBUyxHQUFHLGVBQWUsQ0FBQztZQUNoRCxDQUFDLENBQUMsQ0FBQztTQUNKO2FBQU07WUFDTCxrQ0FBa0M7WUFDbEMsUUFBUSxHQUFHLGVBQWUsQ0FBQztTQUM1QjtRQUNELE9BQU8sUUFBUSxDQUFDO0lBQ2xCLENBQUM7O3NIQXJHVSx5QkFBeUI7MEhBQXpCLHlCQUF5QjsyRkFBekIseUJBQXlCO2tCQURyQyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udmVydGVyIH0gZnJvbSAnQHNwYXJ0YWN1cy9jb3JlJztcbmltcG9ydCB7IENvbmZpZ3VyYXRvciB9IGZyb20gJ0BzcGFydGFjdXMvcHJvZHVjdC1jb25maWd1cmF0b3IvcnVsZWJhc2VkJztcbmltcG9ydCB7IENwcSB9IGZyb20gJy4uL2NwcS5tb2RlbHMnO1xuaW1wb3J0IHsgQ3BxQ29uZmlndXJhdG9yVXRpbHMgfSBmcm9tICcuLi8uLi9yZXN0L2NwcS1jb25maWd1cmF0b3ItdXRpbHMnO1xuXG5jb25zdCBWQUxVRV9TRVBBUkFUT1IgPSAnLCc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDcHFDb25maWd1cmF0b3JTZXJpYWxpemVyXG4gIGltcGxlbWVudHMgQ29udmVydGVyPENvbmZpZ3VyYXRvci5Db25maWd1cmF0aW9uLCBDcHEuVXBkYXRlQXR0cmlidXRlPlxue1xuICBjb252ZXJ0KHNvdXJjZTogQ29uZmlndXJhdG9yLkNvbmZpZ3VyYXRpb24pOiBDcHEuVXBkYXRlQXR0cmlidXRlIHtcbiAgICBjb25zdCBhdHRyaWJ1dGU6IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGUgPVxuICAgICAgQ3BxQ29uZmlndXJhdG9yVXRpbHMuZmluZEZpcnN0Q2hhbmdlZEF0dHJpYnV0ZShzb3VyY2UpO1xuICAgIGxldCB1cGRhdGVBdHRyaWJ1dGU6IENwcS5VcGRhdGVBdHRyaWJ1dGU7XG4gICAgaWYgKHNvdXJjZS51cGRhdGVUeXBlID09PSBDb25maWd1cmF0b3IuVXBkYXRlVHlwZS5BVFRSSUJVVEVfUVVBTlRJVFkpIHtcbiAgICAgIHVwZGF0ZUF0dHJpYnV0ZSA9IHRoaXMuY29udmVydFF1YW50aXR5KGF0dHJpYnV0ZSwgc291cmNlLmNvbmZpZ0lkKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdXBkYXRlQXR0cmlidXRlID0gdGhpcy5jb252ZXJ0QXR0cmlidXRlKGF0dHJpYnV0ZSwgc291cmNlLmNvbmZpZ0lkKTtcbiAgICB9XG4gICAgcmV0dXJuIHVwZGF0ZUF0dHJpYnV0ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBjb252ZXJ0UXVhbnRpdHkoXG4gICAgYXR0cmlidXRlOiBDb25maWd1cmF0b3IuQXR0cmlidXRlLFxuICAgIGNvbmZpZ0lkOiBzdHJpbmdcbiAgKTogQ3BxLlVwZGF0ZUF0dHJpYnV0ZSB7XG4gICAgY29uc3QgdXBkYXRlSW5mb3JtYXRpb24gPVxuICAgICAgQ3BxQ29uZmlndXJhdG9yVXRpbHMuZ2V0VXBkYXRlSW5mb3JtYXRpb24oYXR0cmlidXRlKTtcblxuICAgIGNvbnN0IHVwZGF0ZUF0dHJpYnV0ZTogQ3BxLlVwZGF0ZUF0dHJpYnV0ZSA9IHtcbiAgICAgIGNvbmZpZ3VyYXRpb25JZDogY29uZmlnSWQsXG4gICAgICBzdGFuZGFyZEF0dHJpYnV0ZUNvZGU6IHVwZGF0ZUluZm9ybWF0aW9uLnN0YW5kYXJkQXR0cmlidXRlQ29kZSxcbiAgICAgIGNoYW5nZUF0dHJpYnV0ZVZhbHVlOiB7IHF1YW50aXR5OiBhdHRyaWJ1dGUucXVhbnRpdHkgfSxcbiAgICAgIHRhYklkOiB1cGRhdGVJbmZvcm1hdGlvbi50YWJJZCxcbiAgICB9O1xuICAgIHJldHVybiB1cGRhdGVBdHRyaWJ1dGU7XG4gIH1cblxuICBwcm90ZWN0ZWQgY29udmVydEF0dHJpYnV0ZShcbiAgICBhdHRyaWJ1dGU6IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGUsXG4gICAgY29uZmlndXJhdGlvbklkOiBzdHJpbmdcbiAgKTogQ3BxLlVwZGF0ZUF0dHJpYnV0ZSB7XG4gICAgY29uc3QgdXBkYXRlSW5mb3JtYXRpb24gPVxuICAgICAgQ3BxQ29uZmlndXJhdG9yVXRpbHMuZ2V0VXBkYXRlSW5mb3JtYXRpb24oYXR0cmlidXRlKTtcbiAgICBjb25zdCB1cGRhdGVBdHRyaWJ1dGU6IENwcS5VcGRhdGVBdHRyaWJ1dGUgPSB7XG4gICAgICBjb25maWd1cmF0aW9uSWQ6IGNvbmZpZ3VyYXRpb25JZCxcbiAgICAgIHN0YW5kYXJkQXR0cmlidXRlQ29kZTogdXBkYXRlSW5mb3JtYXRpb24uc3RhbmRhcmRBdHRyaWJ1dGVDb2RlLFxuICAgICAgY2hhbmdlQXR0cmlidXRlVmFsdWU6IHt9LFxuICAgICAgdGFiSWQ6IHVwZGF0ZUluZm9ybWF0aW9uLnRhYklkLFxuICAgIH07XG5cbiAgICBpZiAoXG4gICAgICBhdHRyaWJ1dGUudWlUeXBlID09PSBDb25maWd1cmF0b3IuVWlUeXBlLkRST1BET1dOIHx8XG4gICAgICBhdHRyaWJ1dGUudWlUeXBlID09PSBDb25maWd1cmF0b3IuVWlUeXBlLkRST1BET1dOX1BST0RVQ1QgfHxcbiAgICAgIGF0dHJpYnV0ZS51aVR5cGUgPT09IENvbmZpZ3VyYXRvci5VaVR5cGUuUkFESU9CVVRUT04gfHxcbiAgICAgIGF0dHJpYnV0ZS51aVR5cGUgPT09IENvbmZpZ3VyYXRvci5VaVR5cGUuUkFESU9CVVRUT05fUFJPRFVDVCB8fFxuICAgICAgYXR0cmlidXRlLnVpVHlwZSA9PT0gQ29uZmlndXJhdG9yLlVpVHlwZS5TSU5HTEVfU0VMRUNUSU9OX0lNQUdFXG4gICAgKSB7XG4gICAgICB1cGRhdGVBdHRyaWJ1dGUuY2hhbmdlQXR0cmlidXRlVmFsdWUuYXR0cmlidXRlVmFsdWVJZHMgPVxuICAgICAgICB0aGlzLnByb2Nlc3NTZWxlY3RlZFNpbmdsZVZhbHVlKGF0dHJpYnV0ZS5zZWxlY3RlZFNpbmdsZVZhbHVlKTtcbiAgICB9IGVsc2UgaWYgKFxuICAgICAgYXR0cmlidXRlLnVpVHlwZSA9PT0gQ29uZmlndXJhdG9yLlVpVHlwZS5DSEVDS0JPWExJU1QgfHxcbiAgICAgIGF0dHJpYnV0ZS51aVR5cGUgPT09IENvbmZpZ3VyYXRvci5VaVR5cGUuQ0hFQ0tCT1hMSVNUX1BST0RVQ1QgfHxcbiAgICAgIGF0dHJpYnV0ZS51aVR5cGUgPT09IENvbmZpZ3VyYXRvci5VaVR5cGUuQ0hFQ0tCT1ggfHxcbiAgICAgIGF0dHJpYnV0ZS51aVR5cGUgPT09IENvbmZpZ3VyYXRvci5VaVR5cGUuTVVMVElfU0VMRUNUSU9OX0lNQUdFXG4gICAgKSB7XG4gICAgICB1cGRhdGVBdHRyaWJ1dGUuY2hhbmdlQXR0cmlidXRlVmFsdWUuYXR0cmlidXRlVmFsdWVJZHMgPVxuICAgICAgICB0aGlzLnByZXBhcmVWYWx1ZUlkcyhhdHRyaWJ1dGUpO1xuICAgIH0gZWxzZSBpZiAoXG4gICAgICBhdHRyaWJ1dGUudWlUeXBlID09PSBDb25maWd1cmF0b3IuVWlUeXBlLlNUUklORyB8fFxuICAgICAgYXR0cmlidXRlLnVpVHlwZSA9PT0gQ29uZmlndXJhdG9yLlVpVHlwZS5OVU1FUklDXG4gICAgKSB7XG4gICAgICB1cGRhdGVBdHRyaWJ1dGUuY2hhbmdlQXR0cmlidXRlVmFsdWUudXNlcklucHV0ID0gYXR0cmlidXRlLnVzZXJJbnB1dDtcbiAgICAgIGlmICghdXBkYXRlQXR0cmlidXRlLmNoYW5nZUF0dHJpYnV0ZVZhbHVlPy51c2VySW5wdXQpIHtcbiAgICAgICAgdXBkYXRlQXR0cmlidXRlLmNoYW5nZUF0dHJpYnV0ZVZhbHVlLnVzZXJJbnB1dCA9ICcgJztcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIHVwZGF0ZUF0dHJpYnV0ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwcm9jZXNzVmFsdWVDb2RlKHZhbHVlQ29kZT86IHN0cmluZyk6IHN0cmluZyB8IHVuZGVmaW5lZCB7XG4gICAgcmV0dXJuIHZhbHVlQ29kZSAmJiB2YWx1ZUNvZGUgPT09IENvbmZpZ3VyYXRvci5SZXRyYWN0VmFsdWVDb2RlXG4gICAgICA/ICcwJ1xuICAgICAgOiB2YWx1ZUNvZGU7XG4gIH1cblxuICBwcm90ZWN0ZWQgcHJvY2Vzc1NlbGVjdGVkU2luZ2xlVmFsdWUoc2luZ2xlVmFsdWU/OiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGxldCBwcm9jZXNzZWRWYWx1ZSA9IHRoaXMucHJvY2Vzc1ZhbHVlQ29kZShzaW5nbGVWYWx1ZSk7XG4gICAgaWYgKCFwcm9jZXNzZWRWYWx1ZSkge1xuICAgICAgLy8gSXMgcmVxdWlyZWQgdG8gcmVtb3ZlIHRoZSB2YWx1ZVxuICAgICAgcHJvY2Vzc2VkVmFsdWUgPSBWQUxVRV9TRVBBUkFUT1I7XG4gICAgfVxuICAgIHJldHVybiBwcm9jZXNzZWRWYWx1ZTtcbiAgfVxuXG4gIHByb3RlY3RlZCBwcmVwYXJlVmFsdWVJZHMoYXR0cmlidXRlOiBDb25maWd1cmF0b3IuQXR0cmlidXRlKTogc3RyaW5nIHtcbiAgICBsZXQgdmFsdWVJZHMgPSAnJztcbiAgICBjb25zdCBzZWxlY3RlZFZhbHVlcyA9IGF0dHJpYnV0ZS52YWx1ZXM/LmZpbHRlcigodmFsdWUpID0+IHZhbHVlLnNlbGVjdGVkKTtcblxuICAgIGlmIChzZWxlY3RlZFZhbHVlcyAmJiBzZWxlY3RlZFZhbHVlcy5sZW5ndGggPiAwKSB7XG4gICAgICBzZWxlY3RlZFZhbHVlcy5mb3JFYWNoKCh2YWx1ZSkgPT4ge1xuICAgICAgICB2YWx1ZUlkcyArPSB2YWx1ZS52YWx1ZUNvZGUgKyBWQUxVRV9TRVBBUkFUT1I7XG4gICAgICB9KTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gSXMgcmVxdWlyZWQgdG8gcmVtb3ZlIHRoZSB2YWx1ZVxuICAgICAgdmFsdWVJZHMgPSBWQUxVRV9TRVBBUkFUT1I7XG4gICAgfVxuICAgIHJldHVybiB2YWx1ZUlkcztcbiAgfVxufVxuIl19