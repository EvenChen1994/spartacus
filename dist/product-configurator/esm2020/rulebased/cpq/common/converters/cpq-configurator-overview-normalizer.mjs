/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { Configurator } from '@spartacus/product-configurator/rulebased';
import { take } from 'rxjs/operators';
import { Cpq } from '../cpq.models';
import * as i0 from "@angular/core";
import * as i1 from "./cpq-configurator-normalizer-utils.service";
import * as i2 from "@spartacus/core";
const INITIAL_OV_VALUE_ATTRIBUTE_NAME = '';
export class CpqConfiguratorOverviewNormalizer {
    constructor(cpqConfiguratorNormalizerUtilsService, translation) {
        this.cpqConfiguratorNormalizerUtilsService = cpqConfiguratorNormalizerUtilsService;
        this.translation = translation;
        this.NO_OPTION_SELECTED = 0;
    }
    convert(source, target) {
        const resultTarget = {
            ...target,
            configId: source.configurationId ? source.configurationId : '',
            productCode: source.productSystemId,
            priceSummary: this.cpqConfiguratorNormalizerUtilsService.convertPriceSummary(source),
            groups: source.tabs
                ?.flatMap((tab) => this.convertTab(tab, source.currencyISOCode))
                .filter((tab) => tab.attributes && tab.attributes.length > 0),
            totalNumberOfIssues: this.calculateTotalNumberOfIssues(source),
        };
        return resultTarget;
    }
    convertTab(tab, currency) {
        let ovAttributes = [];
        tab.attributes?.forEach((attr) => {
            ovAttributes = ovAttributes.concat(this.convertAttribute(attr, currency));
        });
        const groupOverview = {
            id: tab.id.toString(),
            groupDescription: tab.displayName,
            attributes: ovAttributes,
        };
        if (groupOverview.id === '0') {
            this.translation
                .translate('configurator.group.general')
                .pipe(take(1))
                .subscribe((generalText) => (groupOverview.groupDescription = generalText));
        }
        return groupOverview;
    }
    convertAttribute(attr, currency) {
        const attributeOverviewType = attr?.values &&
            this.cpqConfiguratorNormalizerUtilsService.hasAnyProducts(attr?.values)
            ? Configurator.AttributeOverviewType.BUNDLE
            : Configurator.AttributeOverviewType.GENERAL;
        const ovAttr = [];
        this.convertAttributeValue(attr, currency).forEach((ovValue) => {
            ovAttr.push({
                ...ovValue,
                type: attributeOverviewType,
                attribute: this.cpqConfiguratorNormalizerUtilsService.convertAttributeLabel(attr),
                attributeId: attr.stdAttrCode.toString(),
            });
        });
        return ovAttr;
    }
    convertAttributeValue(attr, currency) {
        const ovValues = [];
        switch (attr.displayAs) {
            case Cpq.DisplayAs.INPUT:
                if (attr?.dataType === Cpq.DataType.INPUT_STRING) {
                    if (attr.userInput && attr.userInput.length > 0) {
                        ovValues.push(this.extractValueUserInput(attr, currency));
                    }
                }
                else {
                    ovValues.push({
                        attribute: INITIAL_OV_VALUE_ATTRIBUTE_NAME,
                        value: 'NOT_IMPLEMENTED',
                    });
                }
                break;
            case Cpq.DisplayAs.RADIO_BUTTON:
            case Cpq.DisplayAs.DROPDOWN:
                const selectedValue = attr.values?.find((val) => val.selected && val.paV_ID !== this.NO_OPTION_SELECTED);
                if (selectedValue) {
                    ovValues.push(this.extractValue(selectedValue, attr, currency));
                }
                break;
            case Cpq.DisplayAs.CHECK_BOX:
                attr.values
                    ?.filter((val) => val.selected)
                    ?.forEach((valueSelected) => {
                    ovValues.push(this.extractValue(valueSelected, attr, currency));
                });
                break;
            default:
                ovValues.push({
                    attribute: INITIAL_OV_VALUE_ATTRIBUTE_NAME,
                    value: 'NOT_IMPLEMENTED',
                });
        }
        return ovValues;
    }
    extractValue(valueSelected, attr, currency) {
        const ovValue = {
            attribute: INITIAL_OV_VALUE_ATTRIBUTE_NAME,
            value: valueSelected.valueDisplay ?? valueSelected.paV_ID.toString(),
            valueId: valueSelected.paV_ID.toString(),
            productCode: valueSelected.productSystemId,
            quantity: this.cpqConfiguratorNormalizerUtilsService.convertQuantity(valueSelected, attr),
            valuePrice: this.cpqConfiguratorNormalizerUtilsService.convertValuePrice(valueSelected, currency),
        };
        ovValue.valuePriceTotal =
            this.cpqConfiguratorNormalizerUtilsService.calculateValuePriceTotal(ovValue.quantity ?? 1, ovValue.valuePrice);
        return ovValue;
    }
    extractValueUserInput(attr, currency) {
        const value = attr.values ? attr.values[0] : undefined;
        const ovValue = {
            attribute: INITIAL_OV_VALUE_ATTRIBUTE_NAME,
            value: attr.userInput ?? attr.stdAttrCode.toString(),
            valueId: value?.paV_ID.toString(),
            quantity: 1,
        };
        if (value) {
            ovValue.valuePrice =
                this.cpqConfiguratorNormalizerUtilsService.convertValuePrice(value, currency);
            ovValue.valuePriceTotal =
                this.cpqConfiguratorNormalizerUtilsService.calculateValuePriceTotal(ovValue.quantity ?? 1, ovValue.valuePrice);
        }
        return ovValue;
    }
    calculateTotalNumberOfIssues(source) {
        const numberOfIssues = (source.incompleteAttributes?.length ?? 0) +
            (source.incompleteMessages?.length ?? 0) +
            (source.invalidMessages?.length ?? 0) +
            (source.failedValidations?.length ?? 0) +
            (source.errorMessages?.length ?? 0);
        return numberOfIssues;
    }
}
CpqConfiguratorOverviewNormalizer.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CpqConfiguratorOverviewNormalizer, deps: [{ token: i1.CpqConfiguratorNormalizerUtilsService }, { token: i2.TranslationService }], target: i0.ɵɵFactoryTarget.Injectable });
CpqConfiguratorOverviewNormalizer.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CpqConfiguratorOverviewNormalizer });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CpqConfiguratorOverviewNormalizer, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.CpqConfiguratorNormalizerUtilsService }, { type: i2.TranslationService }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3BxLWNvbmZpZ3VyYXRvci1vdmVydmlldy1ub3JtYWxpemVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL3Byb2R1Y3QtY29uZmlndXJhdG9yL3J1bGViYXNlZC9jcHEvY29tbW9uL2NvbnZlcnRlcnMvY3BxLWNvbmZpZ3VyYXRvci1vdmVydmlldy1ub3JtYWxpemVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQUUsVUFBVSxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBRTNDLE9BQU8sRUFBRSxZQUFZLEVBQUUsTUFBTSwyQ0FBMkMsQ0FBQztBQUN6RSxPQUFPLEVBQUUsSUFBSSxFQUFFLE1BQU0sZ0JBQWdCLENBQUM7QUFDdEMsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLGVBQWUsQ0FBQzs7OztBQUdwQyxNQUFNLCtCQUErQixHQUFHLEVBQUUsQ0FBQztBQUczQyxNQUFNLE9BQU8saUNBQWlDO0lBSzVDLFlBQ1kscUNBQTRFLEVBQzVFLFdBQStCO1FBRC9CLDBDQUFxQyxHQUFyQyxxQ0FBcUMsQ0FBdUM7UUFDNUUsZ0JBQVcsR0FBWCxXQUFXLENBQW9CO1FBSnhCLHVCQUFrQixHQUFHLENBQUMsQ0FBQztJQUt2QyxDQUFDO0lBRUosT0FBTyxDQUNMLE1BQXlCLEVBQ3pCLE1BQThCO1FBRTlCLE1BQU0sWUFBWSxHQUEwQjtZQUMxQyxHQUFHLE1BQU07WUFDVCxRQUFRLEVBQUUsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsRUFBRTtZQUM5RCxXQUFXLEVBQUUsTUFBTSxDQUFDLGVBQWU7WUFDbkMsWUFBWSxFQUNWLElBQUksQ0FBQyxxQ0FBcUMsQ0FBQyxtQkFBbUIsQ0FBQyxNQUFNLENBQUM7WUFDeEUsTUFBTSxFQUFFLE1BQU0sQ0FBQyxJQUFJO2dCQUNqQixFQUFFLE9BQU8s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QUFPLENBQUMsVUFBVTtnQkFDaEIsSUFBSSxDQUFDLHFDQUFxQyxDQUFDLGlCQUFpQixDQUMxRCxLQUFLLEVBQ0wsUUFBUSxDQUNULENBQUM7WUFDSixPQUFPLENBQUMsZUFBZTtnQkFDckIsSUFBSSxDQUFDLHFDQUFxQyxDQUFDLHdCQUF3QixDQUNqRSxPQUFPLENBQUMsUUFBUSxJQUFJLENBQUMsRUFDckIsT0FBTyxDQUFDLFVBQVUsQ0FDbkIsQ0FBQztTQUNMO1FBQ0QsT0FBTyxPQUFPLENBQUM7SUFDakIsQ0FBQztJQUVTLDRCQUE0QixDQUFDLE1BQXlCO1FBQzlELE1BQU0sY0FBYyxHQUNsQixDQUFDLE1BQU0sQ0FBQyxvQkFBb0IsRUFBRSxNQUFNLElBQUksQ0FBQyxDQUFDO1lBQzFDLENBQUMsTUFBTSxDQUFDLGtCQUFrQixFQUFFLE1BQU0sSUFBSSxDQUFDLENBQUM7WUFDeEMsQ0FBQyxNQUFNLENBQUMsZUFBZSxFQUFFLE1BQU0sSUFBSSxDQUFDLENBQUM7WUFDckMsQ0FBQyxNQUFNLENBQUMsaUJBQWlCLEVBQUUsTUFBTSxJQUFJLENBQUMsQ0FBQztZQUN2QyxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsTUFBTSxJQUFJLENBQUMsQ0FBQyxDQUFDO1FBQ3RDLE9BQU8sY0FBYyxDQUFDO0lBQ3hCLENBQUM7OzhIQXBMVSxpQ0FBaUM7a0lBQWpDLGlDQUFpQzsyRkFBakMsaUNBQWlDO2tCQUQ3QyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQ29udmVydGVyLCBUcmFuc2xhdGlvblNlcnZpY2UgfSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgQ29uZmlndXJhdG9yIH0gZnJvbSAnQHNwYXJ0YWN1cy9wcm9kdWN0LWNvbmZpZ3VyYXRvci9ydWxlYmFzZWQnO1xuaW1wb3J0IHsgdGFrZSB9IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcbmltcG9ydCB7IENwcSB9IGZyb20gJy4uL2NwcS5tb2RlbHMnO1xuaW1wb3J0IHsgQ3BxQ29uZmlndXJhdG9yTm9ybWFsaXplclV0aWxzU2VydmljZSB9IGZyb20gJy4vY3BxLWNvbmZpZ3VyYXRvci1ub3JtYWxpemVyLXV0aWxzLnNlcnZpY2UnO1xuXG5jb25zdCBJTklUSUFMX09WX1ZBTFVFX0FUVFJJQlVURV9OQU1FID0gJyc7XG5cbkBJbmplY3RhYmxlKClcbmV4cG9ydCBjbGFzcyBDcHFDb25maWd1cmF0b3JPdmVydmlld05vcm1hbGl6ZXJcbiAgaW1wbGVtZW50cyBDb252ZXJ0ZXI8Q3BxLkNvbmZpZ3VyYXRpb24sIENvbmZpZ3VyYXRvci5PdmVydmlldz5cbntcbiAgcHJvdGVjdGVkIHJlYWRvbmx5IE5PX09QVElPTl9TRUxFQ1RFRCA9IDA7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGNwcUNvbmZpZ3VyYXRvck5vcm1hbGl6ZXJVdGlsc1NlcnZpY2U6IENwcUNvbmZpZ3VyYXRvck5vcm1hbGl6ZXJVdGlsc1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHRyYW5zbGF0aW9uOiBUcmFuc2xhdGlvblNlcnZpY2VcbiAgKSB7fVxuXG4gIGNvbnZlcnQoXG4gICAgc291cmNlOiBDcHEuQ29uZmlndXJhdGlvbixcbiAgICB0YXJnZXQ/OiBDb25maWd1cmF0b3IuT3ZlcnZpZXdcbiAgKTogQ29uZmlndXJhdG9yLk92ZXJ2aWV3IHtcbiAgICBjb25zdCByZXN1bHRUYXJnZXQ6IENvbmZpZ3VyYXRvci5PdmVydmlldyA9IHtcbiAgICAgIC4uLnRhcmdldCxcbiAgICAgIGNvbmZpZ0lkOiBzb3VyY2UuY29uZmlndXJhdGlvbklkID8gc291cmNlLmNvbmZpZ3VyYXRpb25JZCA6ICcnLFxuICAgICAgcHJvZHVjdENvZGU6IHNvdXJjZS5wcm9kdWN0U3lzdGVtSWQsXG4gICAgICBwcmljZVN1bW1hcnk6XG4gICAgICAgIHRoaXMuY3BxQ29uZmlndXJhdG9yTm9ybWFsaXplclV0aWxzU2VydmljZS5jb252ZXJ0UHJpY2VTdW1tYXJ5KHNvdXJjZSksXG4gICAgICBncm91cHM6IHNvdXJjZS50YWJzXG4gICAgICAgID8uZmxhdE1hcCgodGFiKSA9PiB0aGlzLmNvbnZlcnRUYWIodGFiLCBzb3VyY2UuY3VycmVuY3lJU09Db2RlKSlcbiAgICAgICAgLmZpbHRlcigodGFiKSA9PiB0YWIuYXR0cmlidXRlcyAmJiB0YWIuYXR0cmlidXRlcy5sZW5ndGggPiAwKSxcbiAgICAgIHRvdGFsTnVtYmVyT2ZJc3N1ZXM6IHRoaXMuY2FsY3VsYXRlVG90YWxOdW1iZXJPZklzc3Vlcyhzb3VyY2UpLFxuICAgIH07XG4gICAgcmV0dXJuIHJlc3VsdFRhcmdldDtcbiAgfVxuXG4gIHByb3RlY3RlZCBjb252ZXJ0VGFiKFxuICAgIHRhYjogQ3BxLlRhYixcbiAgICBjdXJyZW5jeTogc3RyaW5nXG4gICk6IENvbmZpZ3VyYXRvci5Hcm91cE92ZXJ2aWV3IHtcbiAgICBsZXQgb3ZBdHRyaWJ1dGVzOiBDb25maWd1cmF0b3IuQXR0cmlidXRlT3ZlcnZpZXdbXSA9IFtdO1xuICAgIHRhYi5hdHRyaWJ1dGVzPy5mb3JFYWNoKChhdHRyKSA9PiB7XG4gICAgICBvdkF0dHJpYnV0ZXMgPSBvdkF0dHJpYnV0ZXMuY29uY2F0KHRoaXMuY29udmVydEF0dHJpYnV0ZShhdHRyLCBjdXJyZW5jeSkpO1xuICAgIH0pO1xuICAgIGNvbnN0IGdyb3VwT3ZlcnZpZXc6IENvbmZpZ3VyYXRvci5Hcm91cE92ZXJ2aWV3ID0ge1xuICAgICAgaWQ6IHRhYi5pZC50b1N0cmluZygpLFxuICAgICAgZ3JvdXBEZXNjcmlwdGlvbjogdGFiLmRpc3BsYXlOYW1lLFxuICAgICAgYXR0cmlidXRlczogb3ZBdHRyaWJ1dGVzLFxuICAgIH07XG4gICAgaWYgKGdyb3VwT3ZlcnZpZXcuaWQgPT09ICcwJykge1xuICAgICAgdGhpcy50cmFuc2xhdGlvblxuICAgICAgICAudHJhbnNsYXRlKCdjb25maWd1cmF0b3IuZ3JvdXAuZ2VuZXJhbCcpXG4gICAgICAgIC5waXBlKHRha2UoMSkpXG4gICAgICAgIC5zdWJzY3JpYmUoXG4gICAgICAgICAgKGdlbmVyYWxUZXh0KSA9PiAoZ3JvdXBPdmVydmlldy5ncm91cERlc2NyaXB0aW9uID0gZ2VuZXJhbFRleHQpXG4gICAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBncm91cE92ZXJ2aWV3O1xuICB9XG5cbiAgcHJvdGVjdGVkIGNvbnZlcnRBdHRyaWJ1dGUoXG4gICAgYXR0cjogQ3BxLkF0dHJpYnV0ZSxcbiAgICBjdXJyZW5jeTogc3RyaW5nXG4gICk6IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGVPdmVydmlld1tdIHtcbiAgICBjb25zdCBhdHRyaWJ1dGVPdmVydmlld1R5cGU6IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGVPdmVydmlld1R5cGUgPVxuICAgICAgYXR0cj8udmFsdWVzICYmXG4gICAgICB0aGlzLmNwcUNvbmZpZ3VyYXRvck5vcm1hbGl6ZXJVdGlsc1NlcnZpY2UuaGFzQW55UHJvZHVjdHMoYXR0cj8udmFsdWVzKVxuICAgICAgICA/IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGVPdmVydmlld1R5cGUuQlVORExFXG4gICAgICAgIDogQ29uZmlndXJhdG9yLkF0dHJpYnV0ZU92ZXJ2aWV3VHlwZS5HRU5FUkFMO1xuICAgIGNvbnN0IG92QXR0cjogQ29uZmlndXJhdG9yLkF0dHJpYnV0ZU92ZXJ2aWV3W10gPSBbXTtcbiAgICB0aGlzLmNvbnZlcnRBdHRyaWJ1dGVWYWx1ZShhdHRyLCBjdXJyZW5jeSkuZm9yRWFjaCgob3ZWYWx1ZSkgPT4ge1xuICAgICAgb3ZBdHRyLnB1c2goe1xuICAgICAgICAuLi5vdlZhbHVlLFxuICAgICAgICB0eXBlOiBhdHRyaWJ1dGVPdmVydmlld1R5cGUsXG4gICAgICAgIGF0dHJpYnV0ZTpcbiAgICAgICAgICB0aGlzLmNwcUNvbmZpZ3VyYXRvck5vcm1hbGl6ZXJVdGlsc1NlcnZpY2UuY29udmVydEF0dHJpYnV0ZUxhYmVsKFxuICAgICAgICAgICAgYXR0clxuICAgICAgICAgICksXG4gICAgICAgIGF0dHJpYnV0ZUlkOiBhdHRyLnN0ZEF0dHJDb2RlLnRvU3RyaW5nKCksXG4gICAgICB9KTtcbiAgICB9KTtcbiAgICByZXR1cm4gb3ZBdHRyO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNvbnZlcnRBdHRyaWJ1dGVWYWx1ZShcbiAgICBhdHRyOiBDcHEuQXR0cmlidXRlLFxuICAgIGN1cnJlbmN5OiBzdHJpbmdcbiAgKTogQ29uZmlndXJhdG9yLkF0dHJpYnV0ZU92ZXJ2aWV3W10ge1xuICAgIGNvbnN0IG92VmFsdWVzOiBDb25maWd1cmF0b3IuQXR0cmlidXRlT3ZlcnZpZXdbXSA9IFtdO1xuICAgIHN3aXRjaCAoYXR0ci5kaXNwbGF5QXMpIHtcbiAgICAgIGNhc2UgQ3BxLkRpc3BsYXlBcy5JTlBVVDpcbiAgICAgICAgaWYgKGF0dHI/LmRhdGFUeXBlID09PSBDcHEuRGF0YVR5cGUuSU5QVVRfU1RSSU5HKSB7XG4gICAgICAgICAgaWYgKGF0dHIudXNlcklucHV0ICYmIGF0dHIudXNlcklucHV0Lmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgIG92VmFsdWVzLnB1c2godGhpcy5leHRyYWN0VmFsdWVVc2VySW5wdXQoYXR0ciwgY3VycmVuY3kpKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgb3ZWYWx1ZXMucHVzaCh7XG4gICAgICAgICAgICBhdHRyaWJ1dGU6IElOSVRJQUxfT1ZfVkFMVUVfQVRUUklCVVRFX05BTUUsXG4gICAgICAgICAgICB2YWx1ZTogJ05PVF9JTVBMRU1FTlRFRCcsXG4gICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlIENwcS5EaXNwbGF5QXMuUkFESU9fQlVUVE9OOlxuICAgICAgY2FzZSBDcHEuRGlzcGxheUFzLkRST1BET1dOOlxuICAgICAgICBjb25zdCBzZWxlY3RlZFZhbHVlID0gYXR0ci52YWx1ZXM/LmZpbmQoXG4gICAgICAgICAgKHZhbCkgPT4gdmFsLnNlbGVjdGVkICYmIHZhbC5wYVZfSUQgIT09IHRoaXMuTk9fT1BUSU9OX1NFTEVDVEVEXG4gICAgICAgICk7XG4gICAgICAgIGlmIChzZWxlY3RlZFZhbHVlKSB7XG4gICAgICAgICAgb3ZWYWx1ZXMucHVzaCh0aGlzLmV4dHJhY3RWYWx1ZShzZWxlY3RlZFZhbHVlLCBhdHRyLCBjdXJyZW5jeSkpO1xuICAgICAgICB9XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSBDcHEuRGlzcGxheUFzLkNIRUNLX0JPWDpcbiAgICAgICAgYXR0ci52YWx1ZXNcbiAgICAgICAgICA/LmZpbHRlcigodmFsKSA9PiB2YWwuc2VsZWN0ZWQpXG4gICAgICAgICAgPy5mb3JFYWNoKCh2YWx1ZVNlbGVjdGVkKSA9PiB7XG4gICAgICAgICAgICBvdlZhbHVlcy5wdXNoKHRoaXMuZXh0cmFjdFZhbHVlKHZhbHVlU2VsZWN0ZWQsIGF0dHIsIGN1cnJlbmN5KSk7XG4gICAgICAgICAgfSk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgb3ZWYWx1ZXMucHVzaCh7XG4gICAgICAgICAgYXR0cmlidXRlOiBJTklUSUFMX09WX1ZBTFVFX0FUVFJJQlVURV9OQU1FLFxuICAgICAgICAgIHZhbHVlOiAnTk9UX0lNUExFTUVOVEVEJyxcbiAgICAgICAgfSk7XG4gICAgfVxuICAgIHJldHVybiBvdlZhbHVlcztcbiAgfVxuXG4gIHByb3RlY3RlZCBleHRyYWN0VmFsdWUoXG4gICAgdmFsdWVTZWxlY3RlZDogQ3BxLlZhbHVlLFxuICAgIGF0dHI6IENwcS5BdHRyaWJ1dGUsXG4gICAgY3VycmVuY3k6IHN0cmluZ1xuICApOiBDb25maWd1cmF0b3IuQXR0cmlidXRlT3ZlcnZpZXcge1xuICAgIGNvbnN0IG92VmFsdWU6IENvbmZpZ3VyYXRvci5BdHRyaWJ1dGVPdmVydmlldyA9IHtcbiAgICAgIGF0dHJpYnV0ZTogSU5JVElBTF9PVl9WQUxVRV9BVFRSSUJVVEVfTkFNRSxcbiAgICAgIHZhbHVlOiB2YWx1ZVNlbGVjdGVkLnZhbHVlRGlzcGxheSA/PyB2YWx1ZVNlbGVjdGVkLnBhVl9JRC50b1N0cmluZygpLFxuICAgICAgdmFsdWVJZDogdmFsdWVTZWxlY3RlZC5wYVZfSUQudG9TdHJpbmcoKSxcbiAgICAgIHByb2R1Y3RDb2RlOiB2YWx1ZVNlbGVjdGVkLnByb2R1Y3RTeXN0ZW1JZCxcbiAgICAgIHF1YW50aXR5OiB0aGlzLmNwcUNvbmZpZ3VyYXRvck5vcm1hbGl6ZXJVdGlsc1NlcnZpY2UuY29udmVydFF1YW50aXR5KFxuICAgICAgICB2YWx1ZVNlbGVjdGVkLFxuICAgICAgICBhdHRyXG4gICAgICApLFxuICAgICAgdmFsdWVQcmljZTogdGhpcy5jcHFDb25maWd1cmF0b3JOb3JtYWxpemVyVXRpbHNTZXJ2aWNlLmNvbnZlcnRWYWx1ZVByaWNlKFxuICAgICAgICB2YWx1ZVNlbGVjdGVkLFxuICAgICAgICBjdXJyZW5jeVxuICAgICAgKSxcbiAgICB9O1xuICAgIG92VmFsdWUudmFsdWVQcmljZVRvdGFsID1cbiAgICAgIHRoaXMuY3BxQ29uZmlndXJhdG9yTm9ybWFsaXplclV0aWxzU2VydmljZS5jYWxjdWxhdGVWYWx1ZVByaWNlVG90YWwoXG4gICAgICAgIG92VmFsdWUucXVhbnRpdHkgPz8gMSxcbiAgICAgICAgb3ZWYWx1ZS52YWx1ZVByaWNlXG4gICAgICApO1xuICAgIHJldHVybiBvdlZhbHVlO1xuICB9XG5cbiAgcHJvdGVjdGVkIGV4dHJhY3RWYWx1ZVVzZXJJbnB1dChcbiAgICBhdHRyOiBDcHEuQXR0cmlidXRlLFxuICAgIGN1cnJlbmN5OiBzdHJpbmdcbiAgKTogQ29uZmlndXJhdG9yLkF0dHJpYnV0ZU92ZXJ2aWV3IHtcbiAgICBjb25zdCB2YWx1ZSA9IGF0dHIudmFsdWVzID8gYXR0ci52YWx1ZXNbMF0gOiB1bmRlZmluZWQ7XG4gICAgY29uc3Qgb3ZWYWx1ZTogQ29uZmlndXJhdG9yLkF0dHJpYnV0ZU92ZXJ2aWV3ID0ge1xuICAgICAgYXR0cmlidXRlOiBJTklUSUFMX09WX1ZBTFVFX0FUVFJJQlVURV9OQU1FLFxuICAgICAgdmFsdWU6IGF0dHIudXNlcklucHV0ID8/IGF0dHIuc3RkQXR0ckNvZGUudG9TdHJpbmcoKSxcbiAgICAgIHZhbHVlSWQ6IHZhbHVlPy5wYVZfSUQudG9TdHJpbmcoKSxcbiAgICAgIHF1YW50aXR5OiAxLFxuICAgIH07XG4gICAgaWYgKHZhbHVlKSB7XG4gICAgICBvdlZhbHVlLnZhbHVlUHJpY2UgPVxuICAgICAgICB0aGlzLmNwcUNvbmZpZ3VyYXRvck5vcm1hbGl6ZXJVdGlsc1NlcnZpY2UuY29udmVydFZhbHVlUHJpY2UoXG4gICAgICAgICAgdmFsdWUsXG4gICAgICAgICAgY3VycmVuY3lcbiAgICAgICAgKTtcbiAgICAgIG92VmFsdWUudmFsdWVQcmljZVRvdGFsID1cbiAgICAgICAgdGhpcy5jcHFDb25maWd1cmF0b3JOb3JtYWxpemVyVXRpbHNTZXJ2aWNlLmNhbGN1bGF0ZVZhbHVlUHJpY2VUb3RhbChcbiAgICAgICAgICBvdlZhbHVlLnF1YW50aXR5ID8/IDEsXG4gICAgICAgICAgb3ZWYWx1ZS52YWx1ZVByaWNlXG4gICAgICAgICk7XG4gICAgfVxuICAgIHJldHVybiBvdlZhbHVlO1xuICB9XG5cbiAgcHJvdGVjdGVkIGNhbGN1bGF0ZVRvdGFsTnVtYmVyT2ZJc3N1ZXMoc291cmNlOiBDcHEuQ29uZmlndXJhdGlvbik6IG51bWJlciB7XG4gICAgY29uc3QgbnVtYmVyT2ZJc3N1ZXM6IG51bWJlciA9XG4gICAgICAoc291cmNlLmluY29tcGxldGVBdHRyaWJ1dGVzPy5sZW5ndGggPz8gMCkgK1xuICAgICAgKHNvdXJjZS5pbmNvbXBsZXRlTWVzc2FnZXM/Lmxlbmd0aCA/PyAwKSArXG4gICAgICAoc291cmNlLmludmFsaWRNZXNzYWdlcz8ubGVuZ3RoID8/IDApICtcbiAgICAgIChzb3VyY2UuZmFpbGVkVmFsaWRhdGlvbnM/Lmxlbmd0aCA/PyAwKSArXG4gICAgICAoc291cmNlLmVycm9yTWVzc2FnZXM/Lmxlbmd0aCA/PyAwKTtcbiAgICByZXR1cm4gbnVtYmVyT2ZJc3N1ZXM7XG4gIH1cbn1cbiJdfQ==