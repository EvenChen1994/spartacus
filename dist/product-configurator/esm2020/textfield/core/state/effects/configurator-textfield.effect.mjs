/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable, inject } from '@angular/core';
import { createEffect, ofType } from '@ngrx/effects';
import { CartActions } from '@spartacus/cart/base/core';
import { LoggerService, normalizeHttpError } from '@spartacus/core';
import { of } from 'rxjs';
import { catchError, map, switchMap } from 'rxjs/operators';
import { ConfiguratorTextfieldActions } from '../actions/index';
import * as i0 from "@angular/core";
import * as i1 from "@ngrx/effects";
import * as i2 from "../../connectors/configurator-textfield.connector";
export class ConfiguratorTextfieldEffects {
    constructor(actions$, configuratorTextfieldConnector) {
        this.actions$ = actions$;
        this.configuratorTextfieldConnector = configuratorTextfieldConnector;
        this.logger = inject(LoggerService);
        this.createConfiguration$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorTextfieldActions.CREATE_CONFIGURATION), map((action) => action.payload), switchMap((payload) => {
            return this.configuratorTextfieldConnector
                .createConfiguration(payload.productCode, payload.owner)
                .pipe(switchMap((configuration) => {
                return [
                    new ConfiguratorTextfieldActions.CreateConfigurationSuccess(configuration),
                ];
            }), catchError((error) => of(new ConfiguratorTextfieldActions.CreateConfigurationFail(normalizeHttpError(error, this.logger)))));
        })));
        this.addToCart$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorTextfieldActions.ADD_TO_CART), map((action) => action.payload), switchMap((payload) => {
            return this.configuratorTextfieldConnector.addToCart(payload).pipe(switchMap(() => {
                return [
                    new ConfiguratorTextfieldActions.RemoveConfiguration(),
                    new CartActions.LoadCart({
                        cartId: payload.cartId,
                        userId: payload.userId,
                    }),
                ];
            }), catchError((error) => of(new ConfiguratorTextfieldActions.AddToCartFail(normalizeHttpError(error, this.logger)))));
        })));
        this.updateCartEntry$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorTextfieldActions.UPDATE_CART_ENTRY_CONFIGURATION), map((action) => action.payload), switchMap((payload) => {
            return this.configuratorTextfieldConnector
                .updateConfigurationForCartEntry(payload)
                .pipe(switchMap(() => {
                return [
                    new ConfiguratorTextfieldActions.RemoveConfiguration(),
                    new CartActions.LoadCart({
                        cartId: payload.cartId,
                        userId: payload.userId,
                    }),
                ];
            }), catchError((error) => of(new ConfiguratorTextfieldActions.UpdateCartEntryConfigurationFail(normalizeHttpError(error, this.logger)))));
        })));
        this.readConfigurationForCartEntry$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorTextfieldActions.READ_CART_ENTRY_CONFIGURATION), switchMap((action) => {
            const parameters = action.payload;
            return this.configuratorTextfieldConnector
                .readConfigurationForCartEntry(parameters)
                .pipe(switchMap((result) => [
                new ConfiguratorTextfieldActions.ReadCartEntryConfigurationSuccess(result),
            ]), catchError((error) => [
                new ConfiguratorTextfieldActions.ReadCartEntryConfigurationFail(normalizeHttpError(error, this.logger)),
            ]));
        })));
        this.readConfigurationForOrderEntry$ = createEffect(() => this.actions$.pipe(ofType(ConfiguratorTextfieldActions.READ_ORDER_ENTRY_CONFIGURATION), switchMap((action) => {
            const parameters = action.payload;
            return this.configuratorTextfieldConnector
                .readConfigurationForOrderEntry(parameters)
                .pipe(switchMap((result) => [
                new ConfiguratorTextfieldActions.ReadOrderEntryConfigurationSuccess(result),
            ]), catchError((error) => [
                new ConfiguratorTextfieldActions.ReadOrderEntryConfigurationFail(normalizeHttpError(error, this.logger)),
            ]));
        })));
    }
}
ConfiguratorTextfieldEffects.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ConfiguratorTextfieldEffects, deps: [{ token: i1.Actions }, { token: i2.ConfiguratorTextfieldConnector }], target: i0.ɵɵFactoryTarget.Injectable });
ConfiguratorTextfieldEffects.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ConfiguratorTextfieldEffects });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: ConfiguratorTextfieldEffects, decorators: [{
            type: Injectable
        }], ctorParameters: function () { return [{ type: i1.Actions }, { type: i2.ConfiguratorTextfieldConnector }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29uZmlndXJhdG9yLXRleHRmaWVsZC5lZmZlY3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcHJvZHVjdC1jb25maWd1cmF0b3IvdGV4dGZpZWxkL2NvcmUvc3RhdGUvZWZmZWN0cy9jb25maWd1cmF0b3ItdGV4dGZpZWxkLmVmZmVjdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDbkQsT0FBTyxFQUFXLFlBQVksRUFBRSxNQUFNLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDOUQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLDJCQUEyQixDQUFDO0FBQ3hELE9BQU8sRUFBRSxhQUFhLEVBQUUsa0JBQWtCLEVBQUUsTUFBTSxpQkFBaUIsQ0FBQztBQUVwRSxPQUFPLEVBQWMsRUFBRSxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQ3RDLE9BQU8sRUFBRSxVQUFVLEVBQUUsR0FBRyxFQUFFLFNBQVMsRUFBRSxNQUFNLGdCQUFnQixDQUFDO0FBRzVELE9BQU8sRUFBRSw0QkFBNEIsRUFBRSxNQUFNLGtCQUFrQixDQUFDOzs7O0FBR2hFLE1BQU0sT0FBTyw0QkFBNEI7SUFtS3ZDLFlBQ1UsUUFBaUIsRUFDakIsOEJBQThEO1FBRDlELGFBQVEsR0FBUixRQUFRLENBQVM7UUFDakIsbUNBQThCLEdBQTlCLDhCQUE4QixDQUFnQztRQXBLOUQsV0FBTSxHQUFHLE1BQU0sQ0FBQyxhQUFhLENBQUMsQ0FBQztRQUV6Qyx5QkFBb0IsR0FHaEIsWUFBWSxDQUFDLEdBQUcsRUFBRSxDQUNwQixJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksQ0FDaEIsTUFBTSxDQUFDLDRCQUE0QixDQUFDLG9CQUFvQixDQUFDLEVBQ3pELEdBQUcsQ0FDRCxDQUFDLE1BQXdELEVBQUUsRUFBRSxDQUMzRCxNQUFN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Q0FBQywrQkFBK0IsQ0FDOUQsa0JBQWtCLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FDdkM7YUFDRixDQUFDLENBQ0gsQ0FBQztRQUNOLENBQUMsQ0FDRixDQUNGLENBQ0YsQ0FBQztJQUtDLENBQUM7O3lIQXRLTyw0QkFBNEI7NkhBQTVCLDRCQUE0QjsyRkFBNUIsNEJBQTRCO2tCQUR4QyxVQUFVIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSwgaW5qZWN0IH0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBBY3Rpb25zLCBjcmVhdGVFZmZlY3QsIG9mVHlwZSB9IGZyb20gJ0BuZ3J4L2VmZmVjdHMnO1xuaW1wb3J0IHsgQ2FydEFjdGlvbnMgfSBmcm9tICdAc3BhcnRhY3VzL2NhcnQvYmFzZS9jb3JlJztcbmltcG9ydCB7IExvZ2dlclNlcnZpY2UsIG5vcm1hbGl6ZUh0dHBFcnJvciB9IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5pbXBvcnQgeyBDb21tb25Db25maWd1cmF0b3IgfSBmcm9tICdAc3BhcnRhY3VzL3Byb2R1Y3QtY29uZmlndXJhdG9yL2NvbW1vbic7XG5pbXBvcnQgeyBPYnNlcnZhYmxlLCBvZiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHsgY2F0Y2hFcnJvciwgbWFwLCBzd2l0Y2hNYXAgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5pbXBvcnQgeyBDb25maWd1cmF0b3JUZXh0ZmllbGRDb25uZWN0b3IgfSBmcm9tICcuLi8uLi9jb25uZWN0b3JzL2NvbmZpZ3VyYXRvci10ZXh0ZmllbGQuY29ubmVjdG9yJztcbmltcG9ydCB7IENvbmZpZ3VyYXRvclRleHRmaWVsZCB9IGZyb20gJy4uLy4uL21vZGVsL2NvbmZpZ3VyYXRvci10ZXh0ZmllbGQubW9kZWwnO1xuaW1wb3J0IHsgQ29uZmlndXJhdG9yVGV4dGZpZWxkQWN0aW9ucyB9IGZyb20gJy4uL2FjdGlvbnMvaW5kZXgnO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgQ29uZmlndXJhdG9yVGV4dGZpZWxkRWZmZWN0cyB7XG4gIHByb3RlY3RlZCBsb2dnZXIgPSBpbmplY3QoTG9nZ2VyU2VydmljZSk7XG5cbiAgY3JlYXRlQ29uZmlndXJhdGlvbiQ6IE9ic2VydmFibGU8XG4gICAgfCBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLkNyZWF0ZUNvbmZpZ3VyYXRpb25TdWNjZXNzXG4gICAgfCBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLkNyZWF0ZUNvbmZpZ3VyYXRpb25GYWlsXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoQ29uZmlndXJhdG9yVGV4dGZpZWxkQWN0aW9ucy5DUkVBVEVfQ09ORklHVVJBVElPTiksXG4gICAgICBtYXAoXG4gICAgICAgIChhY3Rpb246IENvbmZpZ3VyYXRvclRleHRmaWVsZEFjdGlvbnMuQ3JlYXRlQ29uZmlndXJhdGlvbikgPT5cbiAgICAgICAgICBhY3Rpb24ucGF5bG9hZFxuICAgICAgKSxcbiAgICAgIHN3aXRjaE1hcCgocGF5bG9hZCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5jb25maWd1cmF0b3JUZXh0ZmllbGRDb25uZWN0b3JcbiAgICAgICAgICAuY3JlYXRlQ29uZmlndXJhdGlvbihwYXlsb2FkLnByb2R1Y3RDb2RlLCBwYXlsb2FkLm93bmVyKVxuICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgc3dpdGNoTWFwKChjb25maWd1cmF0aW9uOiBDb25maWd1cmF0b3JUZXh0ZmllbGQuQ29uZmlndXJhdGlvbikgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAgIG5ldyBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLkNyZWF0ZUNvbmZpZ3VyYXRpb25TdWNjZXNzKFxuICAgICAgICAgICAgICAgICAgY29uZmlndXJhdGlvblxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgIF07XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PlxuICAgICAgICAgICAgICBvZihcbiAgICAgICAgICAgICAgICBuZXcgQ29uZmlndXJhdG9yVGV4dGZpZWxkQWN0aW9ucy5DcmVhdGVDb25maWd1cmF0aW9uRmFpbChcbiAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKVxuICApO1xuXG4gIGFkZFRvQ2FydCQ6IE9ic2VydmFibGU8XG4gICAgfCBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLlJlbW92ZUNvbmZpZ3VyYXRpb25cbiAgICB8IENvbmZpZ3VyYXRvclRleHRmaWVsZEFjdGlvbnMuQWRkVG9DYXJ0RmFpbFxuICAgIHwgQ2FydEFjdGlvbnMuTG9hZENhcnRcbiAgPiA9IGNyZWF0ZUVmZmVjdCgoKSA9PlxuICAgIHRoaXMuYWN0aW9ucyQucGlwZShcbiAgICAgIG9mVHlwZShDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLkFERF9UT19DQVJUKSxcbiAgICAgIG1hcCgoYWN0aW9uOiBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLkFkZFRvQ2FydCkgPT4gYWN0aW9uLnBheWxvYWQpLFxuICAgICAgc3dpdGNoTWFwKChwYXlsb2FkKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ3VyYXRvclRleHRmaWVsZENvbm5lY3Rvci5hZGRUb0NhcnQocGF5bG9hZCkucGlwZShcbiAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIFtcbiAgICAgICAgICAgICAgbmV3IENvbmZpZ3VyYXRvclRleHRmaWVsZEFjdGlvbnMuUmVtb3ZlQ29uZmlndXJhdGlvbigpLFxuICAgICAgICAgICAgICBuZXcgQ2FydEFjdGlvbnMuTG9hZENhcnQoe1xuICAgICAgICAgICAgICAgIGNhcnRJZDogcGF5bG9hZC5jYXJ0SWQsXG4gICAgICAgICAgICAgICAgdXNlcklkOiBwYXlsb2FkLnVzZXJJZCxcbiAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBdO1xuICAgICAgICAgIH0pLFxuICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PlxuICAgICAgICAgICAgb2YoXG4gICAgICAgICAgICAgIG5ldyBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLkFkZFRvQ2FydEZhaWwoXG4gICAgICAgICAgICAgICAgbm9ybWFsaXplSHR0cEVycm9yKGVycm9yLCB0aGlzLmxvZ2dlcilcbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKVxuICAgICAgICAgIClcbiAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKVxuICApO1xuXG4gIHVwZGF0ZUNhcnRFbnRyeSQ6IE9ic2VydmFibGU8XG4gICAgfCBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLlJlbW92ZUNvbmZpZ3VyYXRpb25cbiAgICB8IENvbmZpZ3VyYXRvclRleHRmaWVsZEFjdGlvbnMuVXBkYXRlQ2FydEVudHJ5Q29uZmlndXJhdGlvbkZhaWxcbiAgICB8IENhcnRBY3Rpb25zLkxvYWRDYXJ0XG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoQ29uZmlndXJhdG9yVGV4dGZpZWxkQWN0aW9ucy5VUERBVEVfQ0FSVF9FTlRSWV9DT05GSUdVUkFUSU9OKSxcbiAgICAgIG1hcChcbiAgICAgICAgKGFjdGlvbjogQ29uZmlndXJhdG9yVGV4dGZpZWxkQWN0aW9ucy5VcGRhdGVDYXJ0RW50cnlDb25maWd1cmF0aW9uKSA9PlxuICAgICAgICAgIGFjdGlvbi5wYXlsb2FkXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKChwYXlsb2FkKSA9PiB7XG4gICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ3VyYXRvclRleHRmaWVsZENvbm5lY3RvclxuICAgICAgICAgIC51cGRhdGVDb25maWd1cmF0aW9uRm9yQ2FydEVudHJ5KHBheWxvYWQpXG4gICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICBzd2l0Y2hNYXAoKCkgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gW1xuICAgICAgICAgICAgICAgIG5ldyBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLlJlbW92ZUNvbmZpZ3VyYXRpb24oKSxcbiAgICAgICAgICAgICAgICBuZXcgQ2FydEFjdGlvbnMuTG9hZENhcnQoe1xuICAgICAgICAgICAgICAgICAgY2FydElkOiBwYXlsb2FkLmNhcnRJZCxcbiAgICAgICAgICAgICAgICAgIHVzZXJJZDogcGF5bG9hZC51c2VySWQsXG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgIF07XG4gICAgICAgICAgICB9KSxcbiAgICAgICAgICAgIGNhdGNoRXJyb3IoKGVycm9yKSA9PlxuICAgICAgICAgICAgICBvZihcbiAgICAgICAgICAgICAgICBuZXcgQ29uZmlndXJhdG9yVGV4dGZpZWxkQWN0aW9ucy5VcGRhdGVDYXJ0RW50cnlDb25maWd1cmF0aW9uRmFpbChcbiAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICAgKTtcbiAgICAgIH0pXG4gICAgKVxuICApO1xuXG4gIHJlYWRDb25maWd1cmF0aW9uRm9yQ2FydEVudHJ5JDogT2JzZXJ2YWJsZTxcbiAgICB8IENvbmZpZ3VyYXRvclRleHRmaWVsZEFjdGlvbnMuUmVhZENhcnRFbnRyeUNvbmZpZ3VyYXRpb25TdWNjZXNzXG4gICAgfCBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLlJlYWRDYXJ0RW50cnlDb25maWd1cmF0aW9uRmFpbFxuICA+ID0gY3JlYXRlRWZmZWN0KCgpID0+XG4gICAgdGhpcy5hY3Rpb25zJC5waXBlKFxuICAgICAgb2ZUeXBlKENvbmZpZ3VyYXRvclRleHRmaWVsZEFjdGlvbnMuUkVBRF9DQVJUX0VOVFJZX0NPTkZJR1VSQVRJT04pLFxuICAgICAgc3dpdGNoTWFwKFxuICAgICAgICAoYWN0aW9uOiBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLlJlYWRDYXJ0RW50cnlDb25maWd1cmF0aW9uKSA9PiB7XG4gICAgICAgICAgY29uc3QgcGFyYW1ldGVyczogQ29tbW9uQ29uZmlndXJhdG9yLlJlYWRDb25maWd1cmF0aW9uRnJvbUNhcnRFbnRyeVBhcmFtZXRlcnMgPVxuICAgICAgICAgICAgYWN0aW9uLnBheWxvYWQ7XG5cbiAgICAgICAgICByZXR1cm4gdGhpcy5jb25maWd1cmF0b3JUZXh0ZmllbGRDb25uZWN0b3JcbiAgICAgICAgICAgIC5yZWFkQ29uZmlndXJhdGlvbkZvckNhcnRFbnRyeShwYXJhbWV0ZXJzKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgIHN3aXRjaE1hcCgocmVzdWx0OiBDb25maWd1cmF0b3JUZXh0ZmllbGQuQ29uZmlndXJhdGlvbikgPT4gW1xuICAgICAgICAgICAgICAgIG5ldyBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLlJlYWRDYXJ0RW50cnlDb25maWd1cmF0aW9uU3VjY2VzcyhcbiAgICAgICAgICAgICAgICAgIHJlc3VsdFxuICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgIF0pLFxuICAgICAgICAgICAgICBjYXRjaEVycm9yKChlcnJvcikgPT4gW1xuICAgICAgICAgICAgICAgIG5ldyBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLlJlYWRDYXJ0RW50cnlDb25maWd1cmF0aW9uRmFpbChcbiAgICAgICAgICAgICAgICAgIG5vcm1hbGl6ZUh0dHBFcnJvcihlcnJvciwgdGhpcy5sb2dnZXIpXG4gICAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgXSlcbiAgICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIClcbiAgICApXG4gICk7XG5cbiAgcmVhZENvbmZpZ3VyYXRpb25Gb3JPcmRlckVudHJ5JDogT2JzZXJ2YWJsZTxcbiAgICB8IENvbmZpZ3VyYXRvclRleHRmaWVsZEFjdGlvbnMuUmVhZE9yZGVyRW50cnlDb25maWd1cmF0aW9uU3VjY2Vzc1xuICAgIHwgQ29uZmlndXJhdG9yVGV4dGZpZWxkQWN0aW9ucy5SZWFkT3JkZXJFbnRyeUNvbmZpZ3VyYXRpb25GYWlsXG4gID4gPSBjcmVhdGVFZmZlY3QoKCkgPT5cbiAgICB0aGlzLmFjdGlvbnMkLnBpcGUoXG4gICAgICBvZlR5cGUoQ29uZmlndXJhdG9yVGV4dGZpZWxkQWN0aW9ucy5SRUFEX09SREVSX0VOVFJZX0NPTkZJR1VSQVRJT04pLFxuICAgICAgc3dpdGNoTWFwKFxuICAgICAgICAoYWN0aW9uOiBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLlJlYWRPcmRlckVudHJ5Q29uZmlndXJhdGlvbikgPT4ge1xuICAgICAgICAgIGNvbnN0IHBhcmFtZXRlcnM6IENvbW1vbkNvbmZpZ3VyYXRvci5SZWFkQ29uZmlndXJhdGlvbkZyb21PcmRlckVudHJ5UGFyYW1ldGVycyA9XG4gICAgICAgICAgICBhY3Rpb24ucGF5bG9hZDtcblxuICAgICAgICAgIHJldHVybiB0aGlzLmNvbmZpZ3VyYXRvclRleHRmaWVsZENvbm5lY3RvclxuICAgICAgICAgICAgLnJlYWRDb25maWd1cmF0aW9uRm9yT3JkZXJFbnRyeShwYXJhbWV0ZXJzKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgIHN3aXRjaE1hcCgocmVzdWx0OiBDb25maWd1cmF0b3JUZXh0ZmllbGQuQ29uZmlndXJhdGlvbikgPT4gW1xuICAgICAgICAgICAgICAgIG5ldyBDb25maWd1cmF0b3JUZXh0ZmllbGRBY3Rpb25zLlJlYWRPcmRlckVudHJ5Q29uZmlndXJhdGlvblN1Y2Nlc3MoXG4gICAgICAgICAgICAgICAgICByZXN1bHRcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICBdKSxcbiAgICAgICAgICAgICAgY2F0Y2hFcnJvcigoZXJyb3IpID0+IFtcbiAgICAgICAgICAgICAgICBuZXcgQ29uZmlndXJhdG9yVGV4dGZpZWxkQWN0aW9ucy5SZWFkT3JkZXJFbnRyeUNvbmZpZ3VyYXRpb25GYWlsKFxuICAgICAgICAgICAgICAgICAgbm9ybWFsaXplSHR0cEVycm9yKGVycm9yLCB0aGlzLmxvZ2dlcilcbiAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICBdKVxuICAgICAgICAgICAgKTtcbiAgICAgICAgfVxuICAgICAgKVxuICAgIClcbiAgKTtcblxuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIGFjdGlvbnMkOiBBY3Rpb25zLFxuICAgIHByaXZhdGUgY29uZmlndXJhdG9yVGV4dGZpZWxkQ29ubmVjdG9yOiBDb25maWd1cmF0b3JUZXh0ZmllbGRDb25uZWN0b3JcbiAgKSB7fVxufVxuIl19