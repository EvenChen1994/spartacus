/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Injectable } from '@angular/core';
import { getProperty, } from '@spartacus/pickup-in-store/root';
import { combineLatest, iif, of } from 'rxjs';
import { filter, map, mergeMap, switchMap, tap } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/cart/base/root";
import * as i2 from "@spartacus/pickup-in-store/root";
import * as i3 from "@spartacus/order/root";
/**
 * A service to get the Delivery Points Of Service for items to be picked up in store for the active cart
 */
export class DeliveryPointsService {
    constructor(activeCartFacade, pickupLocationsSearchFacade, orderFacade) {
        this.activeCartFacade = activeCartFacade;
        this.pickupLocationsSearchFacade = pickupLocationsSearchFacade;
        this.orderFacade = orderFacade;
    }
    /*
     * deliveryPointsOfService$ comprises arrays within an array.
     * It has an array of stores, and then for each store, an array of products to be collected from that store.
     * We need to get data from two different services. One of the services has the product data, ie the products to be picked up from in store.
     * This data only has the store name, no other information about the store eg address etc.
     * We then use another service to get data about the store. This service has two methods that must be called.
     * loadStoreDetails is called to make the api call. The data returned from this call populates an area of the ngrx store.
     * Then getStoreDetails is used to get store detail data from the relevant slice of state in the ngrx store.
     * So the below:
     * - gets active cart
     * - gets items in the cart
     * - gets those items that are to be picked up from a store
     * - get the data about each store
     *
     * Some of the below involves turning array data into lookup object data simply because this is easier to deal with
     */
    getDeliveryPointsOfServiceFromCart() {
        return this.activeCartFacade.getPickupEntries().pipe(filter((entries) => !!entries && !!entries.length), switchMap((entries) => this.getDeliveryPointsOfService(entries)));
    }
    getDeliveryPointsOfServiceFromOrder() {
        return this.orderFacade.getPickupEntries().pipe(filter((entries) => !!entries && !!entries.length), switchMap((entries) => this.getDeliveryPointsOfService(entries)));
    }
    getDeliveryPointsOfService(entries) {
        return of(entries).pipe(map((items) => items.filter((entry) => !!entry.deliveryPointOfService)), switchMap((elements) => iif(() => !!elements.length, of(elements).pipe(map((_elements) => {
            const COPY = [..._elements];
            COPY.sort((a, b) => a.deliveryPointOfService?.name?.localeCompare(getProperty(b.deliveryPointOfService, 'name') || '') || 0);
            return COPY;
        }), map((sortedArray) => sortedArray.reduce((accumulator, value) => {
            const DELIVERY_POINT_OF_SERVICE = value
                .deliveryPointOfService?.name;
            const existingValue = accumulator[DELIVERY_POINT_OF_SERVICE]
                ? accumulator[DELIVERY_POINT_OF_SERVICE]
                : [];
            return {
                ...accumulator,
                [DELIVERY_POINT_OF_SERVICE]: [...existingValue, value],
            };
        }, {})), map((deliveryPointOfServiceMap) => Object.keys(deliveryPointOfServiceMap).map((key) => ({
            name: key,
            value: deliveryPointOfServiceMap[key],
        }))), tap((deliveryPointOfServiceMap) => deliveryPointOfServiceMap
            .map((deliveryPointOfService) => deliveryPointOfService.name)
            .forEach((name) => this.pickupLocationsSearchFacade.loadStoreDetails(name))), mergeMap((deliveryPointOfServiceMap) => combineLatest(deliveryPointOfServiceMap
            .map((deliveryPointOfService) => deliveryPointOfService.name)
            .map((name) => this.pickupLocationsSearchFacade.getStoreDetails(name))).pipe(map((storeDetails) => {
            const STORE_DETAILS_MAP = storeDetails
                .filter((_storeDetails) => !!_storeDetails)
                .reduce((accumulator, value) => ({
                ...accumulator,
                [value.name]: value,
            }), {});
            return deliveryPointOfServiceMap.map((store) => ({
                ...store,
                storeDetails: STORE_DETAILS_MAP[store.name],
            }));
        })))), of([]))));
    }
}
DeliveryPointsService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: DeliveryPointsService, deps: [{ token: i1.ActiveCartFacade }, { token: i2.PickupLocationsSearchFacade }, { token: i3.OrderFacade }], target: i0.ɵɵFactoryTarget.Injectable });
DeliveryPointsService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: DeliveryPointsService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: DeliveryPointsService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root',
                }]
        }], ctorParameters: function () { return [{ type: i1.ActiveCartFacade }, { type: i2.PickupLocationsSearchFacade }, { type: i3.OrderFacade }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVsaXZlcnktcG9pbnRzLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcGlja3VwLWluLXN0b3JlL2NvbXBvbmVudHMvc2VydmljZXMvZGVsaXZlcnktcG9pbnRzLnNlcnZpY2UudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7R0FJRztBQUVILE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFJM0MsT0FBTyxFQUVMLFdBQVcsR0FFWixNQUFNLGlDQUFpQyxDQUFDO0FBQ3pDLE9BQU8sRUFBRSxhQUFhLEVBQUUsR0FBRyxFQUFjLEVBQUUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUMxRCxPQUFPLEVBQUUsTUFBTSxFQUFFLEdBQUcsRUFBRSxRQUFRLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLGdCQUFnQixDQUFDOzs7OztBQUV2RTs7R0FFRztBQUlILE1BQU0sT0FBTyxxQkFBcUI7SUFDaEMsWUFDWSxnQkFBa0MsRUFDbEMsMkJBQXdELEVBQ3hELFdBQXdCO1FBRnhCLHFCQUFnQixHQUFoQixnQkFBZ0IsQ0FBa0I7UUFDbEMsZ0NBQTJCLEdBQTNCLDJCQUEyQixDQUE2QjtRQUN4RCxnQkFBVyxHQUFYLFdBQVcsQ0FBYTtJQUNqQyxDQUFDO0lBRUo7Ozs7Ozs7Ozs7Ozs7OztPQWVHO0lBQ0gsa0NBQWtDO1FBR2hDLE9BQU8sSUFBSSxDQUFDLGdCQUFnQixDQUFDLGdCQUFnQixFQUFFLENBQUMsSUFBSSxDQUNsRCxNQUFNLENBQUMsQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxPQUFPLElBQUksQ0FBQyxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsRUFDbEQsU0FBUyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FDakUsQ0FBQztJQUNKLENBQUM7SUFF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QUFHLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRSxDQUNaLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLENBQ3ZELENBQ0osQ0FBQyxJQUFJLENBQ0osR0FBRyxDQUFDLENBQUMsWUFBWSxFQUFFLEVBQUU7WUFDbkIsTUFBTSxpQkFBaUIsR0FBRyxZQUFZO2lCQUNuQyxNQUFNLENBQUMsQ0FBQyxhQUFhLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUM7aUJBQzFDLE1BQU0sQ0FDTCxDQUFDLFdBQVcsRUFBRSxLQUFLLEVBQWtDLEVBQUUsQ0FBQyxDQUFDO2dCQUN2RCxHQUFHLFdBQVc7Z0JBQ2QsQ0FBQyxLQUFLLENBQUMsSUFBYyxDQUFDLEVBQUUsS0FBSzthQUM5QixDQUFDLEVBQ0YsRUFBb0MsQ0FDckMsQ0FBQztZQUNKLE9BQU8seUJBQXlCLENBQUMsR0FBRyxDQUNsQyxDQUNFLEtBQUssRUFLTCxFQUFFLENBQUMsQ0FBQztnQkFDSixHQUFHLEtBQUs7Z0JBQ1IsWUFBWSxFQUFFLGlCQUFpQixDQUFDLEtBQUssQ0FBQyxJQUFjLENBQUM7YUFDdEQsQ0FBQyxDQUNILENBQUM7UUFDSixDQUFDLENBQUMsQ0FDSCxDQUNGLENBQ0YsRUFDRCxFQUFFLENBQUMsRUFBRSxDQUFDLENBQ1AsQ0FDRixDQUNGLENBQUM7SUFDSixDQUFDOztrSEF2SVUscUJBQXFCO3NIQUFyQixxQkFBcUIsY0FGcEIsTUFBTTsyRkFFUCxxQkFBcUI7a0JBSGpDLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25CIiwic291cmNlc0NvbnRlbnQiOlsiLypcbiAqIFNQRFgtRmlsZUNvcHlyaWdodFRleHQ6IDIwMjMgU0FQIFNwYXJ0YWN1cyB0ZWFtIDxzcGFydGFjdXMtdGVhbUBzYXAuY29tPlxuICpcbiAqIFNQRFgtTGljZW5zZS1JZGVudGlmaWVyOiBBcGFjaGUtMi4wXG4gKi9cblxuaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgQWN0aXZlQ2FydEZhY2FkZSwgT3JkZXJFbnRyeSB9IGZyb20gJ0BzcGFydGFjdXMvY2FydC9iYXNlL3Jvb3QnO1xuaW1wb3J0IHsgUG9pbnRPZlNlcnZpY2UgfSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHsgT3JkZXJGYWNhZGUgfSBmcm9tICdAc3BhcnRhY3VzL29yZGVyL3Jvb3QnO1xuaW1wb3J0IHtcbiAgRGVsaXZlcnlQb2ludE9mU2VydmljZSxcbiAgZ2V0UHJvcGVydHksXG4gIFBpY2t1cExvY2F0aW9uc1NlYXJjaEZhY2FkZSxcbn0gZnJvbSAnQHNwYXJ0YWN1cy9waWNrdXAtaW4tc3RvcmUvcm9vdCc7XG5pbXBvcnQgeyBjb21iaW5lTGF0ZXN0LCBpaWYsIE9ic2VydmFibGUsIG9mIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBmaWx0ZXIsIG1hcCwgbWVyZ2VNYXAsIHN3aXRjaE1hcCwgdGFwIH0gZnJvbSAncnhqcy9vcGVyYXRvcnMnO1xuXG4vKipcbiAqIEEgc2VydmljZSB0byBnZXQgdGhlIERlbGl2ZXJ5IFBvaW50cyBPZiBTZXJ2aWNlIGZvciBpdGVtcyB0byBiZSBwaWNrZWQgdXAgaW4gc3RvcmUgZm9yIHRoZSBhY3RpdmUgY2FydFxuICovXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290Jyxcbn0pXG5leHBvcnQgY2xhc3MgRGVsaXZlcnlQb2ludHNTZXJ2aWNlIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGFjdGl2ZUNhcnRGYWNhZGU6IEFjdGl2ZUNhcnRGYWNhZGUsXG4gICAgcHJvdGVjdGVkIHBpY2t1cExvY2F0aW9uc1NlYXJjaEZhY2FkZTogUGlja3VwTG9jYXRpb25zU2VhcmNoRmFjYWRlLFxuICAgIHByb3RlY3RlZCBvcmRlckZhY2FkZTogT3JkZXJGYWNhZGVcbiAgKSB7fVxuXG4gIC8qXG4gICAqIGRlbGl2ZXJ5UG9pbnRzT2ZTZXJ2aWNlJCBjb21wcmlzZXMgYXJyYXlzIHdpdGhpbiBhbiBhcnJheS5cbiAgICogSXQgaGFzIGFuIGFycmF5IG9mIHN0b3JlcywgYW5kIHRoZW4gZm9yIGVhY2ggc3RvcmUsIGFuIGFycmF5IG9mIHByb2R1Y3RzIHRvIGJlIGNvbGxlY3RlZCBmcm9tIHRoYXQgc3RvcmUuXG4gICAqIFdlIG5lZWQgdG8gZ2V0IGRhdGEgZnJvbSB0d28gZGlmZmVyZW50IHNlcnZpY2VzLiBPbmUgb2YgdGhlIHNlcnZpY2VzIGhhcyB0aGUgcHJvZHVjdCBkYXRhLCBpZSB0aGUgcHJvZHVjdHMgdG8gYmUgcGlja2VkIHVwIGZyb20gaW4gc3RvcmUuXG4gICAqIFRoaXMgZGF0YSBvbmx5IGhhcyB0aGUgc3RvcmUgbmFtZSwgbm8gb3RoZXIgaW5mb3JtYXRpb24gYWJvdXQgdGhlIHN0b3JlIGVnIGFkZHJlc3MgZXRjLlxuICAgKiBXZSB0aGVuIHVzZSBhbm90aGVyIHNlcnZpY2UgdG8gZ2V0IGRhdGEgYWJvdXQgdGhlIHN0b3JlLiBUaGlzIHNlcnZpY2UgaGFzIHR3byBtZXRob2RzIHRoYXQgbXVzdCBiZSBjYWxsZWQuXG4gICAqIGxvYWRTdG9yZURldGFpbHMgaXMgY2FsbGVkIHRvIG1ha2UgdGhlIGFwaSBjYWxsLiBUaGUgZGF0YSByZXR1cm5lZCBmcm9tIHRoaXMgY2FsbCBwb3B1bGF0ZXMgYW4gYXJlYSBvZiB0aGUgbmdyeCBzdG9yZS5cbiAgICogVGhlbiBnZXRTdG9yZURldGFpbHMgaXMgdXNlZCB0byBnZXQgc3RvcmUgZGV0YWlsIGRhdGEgZnJvbSB0aGUgcmVsZXZhbnQgc2xpY2Ugb2Ygc3RhdGUgaW4gdGhlIG5ncnggc3RvcmUuXG4gICAqIFNvIHRoZSBiZWxvdzpcbiAgICogLSBnZXRzIGFjdGl2ZSBjYXJ0XG4gICAqIC0gZ2V0cyBpdGVtcyBpbiB0aGUgY2FydFxuICAgKiAtIGdldHMgdGhvc2UgaXRlbXMgdGhhdCBhcmUgdG8gYmUgcGlja2VkIHVwIGZyb20gYSBzdG9yZVxuICAgKiAtIGdldCB0aGUgZGF0YSBhYm91dCBlYWNoIHN0b3JlXG4gICAqXG4gICAqIFNvbWUgb2YgdGhlIGJlbG93IGludm9sdmVzIHR1cm5pbmcgYXJyYXkgZGF0YSBpbnRvIGxvb2t1cCBvYmplY3QgZGF0YSBzaW1wbHkgYmVjYXVzZSB0aGlzIGlzIGVhc2llciB0byBkZWFsIHdpdGhcbiAgICovXG4gIGdldERlbGl2ZXJ5UG9pbnRzT2ZTZXJ2aWNlRnJvbUNhcnQoKTogT2JzZXJ2YWJsZTxcbiAgICBBcnJheTxEZWxpdmVyeVBvaW50T2ZTZXJ2aWNlPlxuICA+IHtcbiAgICByZXR1cm4gdGhpcy5hY3RpdmVDYXJ0RmFjYWRlLmdldFBpY2t1cEVudHJpZXMoKS5waXBlKFxuICAgICAgZmlsdGVyKChlbnRyaWVzKSA9PiAhIWVudHJpZXMgJiYgISFlbnRyaWVzLmxlbmd0aCksXG4gICAgICBzd2l0Y2hNYXAoKGVudHJpZXMpID0+IHRoaXMuZ2V0RGVsaXZlcnlQb2ludHNPZlNlcnZpY2UoZW50cmllcykpXG4gICAgKTtcbiAgfVxuXG4gIGdldERlbGl2ZXJ5UG9pbnRzT2ZTZXJ2aWNlRnJvbU9yZGVyKCk6IE9ic2VydmFibGU8XG4gICAgQXJyYXk8RGVsaXZlcnlQb2ludE9mU2VydmljZT5cbiAgPiB7XG4gICAgcmV0dXJuIHRoaXMub3JkZXJGYWNhZGUuZ2V0UGlja3VwRW50cmllcygpLnBpcGUoXG4gICAgICBmaWx0ZXIoKGVudHJpZXMpID0+ICEhZW50cmllcyAmJiAhIWVudHJpZXMubGVuZ3RoKSxcbiAgICAgIHN3aXRjaE1hcCgoZW50cmllcykgPT4gdGhpcy5nZXREZWxpdmVyeVBvaW50c09mU2VydmljZShlbnRyaWVzKSlcbiAgICApO1xuICB9XG5cbiAgZ2V0RGVsaXZlcnlQb2ludHNPZlNlcnZpY2UoXG4gICAgZW50cmllczogQXJyYXk8T3JkZXJFbnRyeT5cbiAgKTogT2JzZXJ2YWJsZTxBcnJheTxEZWxpdmVyeVBvaW50T2ZTZXJ2aWNlPj4ge1xuICAgIHJldHVybiBvZihlbnRyaWVzKS5waXBlKFxuICAgICAgbWFwKFxuICAgICAgICAoaXRlbXMpOiBBcnJheTxPcmRlckVudHJ5PiA9PlxuICAgICAgICAgIGl0ZW1zLmZpbHRlcigoZW50cnkpID0+ICEhZW50cnkuZGVsaXZlcnlQb2ludE9mU2VydmljZSlcbiAgICAgICksXG4gICAgICBzd2l0Y2hNYXAoKGVsZW1lbnRzKSA9PlxuICAgICAgICBpaWYoXG4gICAgICAgICAgKCkgPT4gISFlbGVtZW50cy5sZW5ndGgsXG4gICAgICAgICAgb2YoZWxlbWVudHMpLnBpcGUoXG4gICAgICAgICAgICBtYXAoKF9lbGVtZW50cyk6IEFycmF5PE9yZGVyRW50cnk+ID0+IHtcbiAgICAgICAgICAgICAgY29uc3QgQ09QWSA9IFsuLi5fZWxlbWVudHNdO1xuICAgICAgICAgICAgICBDT1BZLnNvcnQoXG4gICAgICAgICAgICAgICAgKGE6IE9yZGVyRW50cnksIGI6IE9yZGVyRW50cnkpID0+XG4gICAgICAgICAgICAgICAgICBhLmRlbGl2ZXJ5UG9pbnRPZlNlcnZpY2U/Lm5hbWU/LmxvY2FsZUNvbXBhcmUoXG4gICAgICAgICAgICAgICAgICAgIGdldFByb3BlcnR5KGIuZGVsaXZlcnlQb2ludE9mU2VydmljZSwgJ25hbWUnKSB8fCAnJ1xuICAgICAgICAgICAgICAgICAgKSB8fCAwXG4gICAgICAgICAgICAgICk7XG4gICAgICAgICAgICAgIHJldHVybiBDT1BZO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBtYXAoKHNvcnRlZEFycmF5KSA9PlxuICAgICAgICAgICAgICBzb3J0ZWRBcnJheS5yZWR1Y2UoXG4gICAgICAgICAgICAgICAgKGFjY3VtdWxhdG9yOiBSZWNvcmQ8c3RyaW5nLCBBcnJheTxPcmRlckVudHJ5Pj4sIHZhbHVlKSA9PiB7XG4gICAgICAgICAgICAgICAgICBjb25zdCBERUxJVkVSWV9QT0lOVF9PRl9TRVJWSUNFOiBzdHJpbmcgPSB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICAuZGVsaXZlcnlQb2ludE9mU2VydmljZT8ubmFtZSBhcyBzdHJpbmc7XG4gICAgICAgICAgICAgICAgICBjb25zdCBleGlzdGluZ1ZhbHVlOiBBcnJheTxPcmRlckVudHJ5PiA9IGFjY3VtdWxhdG9yW1xuICAgICAgICAgICAgICAgICAgICBERUxJVkVSWV9QT0lOVF9PRl9TRVJWSUNFXG4gICAgICAgICAgICAgICAgICBdXG4gICAgICAgICAgICAgICAgICAgID8gYWNjdW11bGF0b3JbREVMSVZFUllfUE9JTlRfT0ZfU0VSVklDRV1cbiAgICAgICAgICAgICAgICAgICAgOiBbXTtcbiAgICAgICAgICAgICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICAgICAgICAgIC4uLmFjY3VtdWxhdG9yLFxuICAgICAgICAgICAgICAgICAgICBbREVMSVZFUllfUE9JTlRfT0ZfU0VSVklDRV06IFsuLi5leGlzdGluZ1ZhbHVlLCB2YWx1ZV0sXG4gICAgICAgICAgICAgICAgICB9O1xuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgICAge31cbiAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIG1hcChcbiAgICAgICAgICAgICAgKFxuICAgICAgICAgICAgICAgIGRlbGl2ZXJ5UG9pbnRPZlNlcnZpY2VNYXBcbiAgICAgICAgICAgICAgKTogQXJyYXk8eyBuYW1lOiBzdHJpbmc7IHZhbHVlOiBBcnJheTxPcmRlckVudHJ5PiB9PiA9PlxuICAgICAgICAgICAgICAgIE9iamVjdC5rZXlzKGRlbGl2ZXJ5UG9pbnRPZlNlcnZpY2VNYXApLm1hcCgoa2V5KSA9PiAoe1xuICAgICAgICAgICAgICAgICAgbmFtZToga2V5LFxuICAgICAgICAgICAgICAgICAgdmFsdWU6IGRlbGl2ZXJ5UG9pbnRPZlNlcnZpY2VNYXBba2V5XSxcbiAgICAgICAgICAgICAgICB9KSlcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICB0YXAoKGRlbGl2ZXJ5UG9pbnRPZlNlcnZpY2VNYXApID0+XG4gICAgICAgICAgICAgIGRlbGl2ZXJ5UG9pbnRPZlNlcnZpY2VNYXBcbiAgICAgICAgICAgICAgICAubWFwKChkZWxpdmVyeVBvaW50T2ZTZXJ2aWNlKSA9PiBkZWxpdmVyeVBvaW50T2ZTZXJ2aWNlLm5hbWUpXG4gICAgICAgICAgICAgICAgLmZvckVhY2goKG5hbWUpID0+XG4gICAgICAgICAgICAgICAgICB0aGlzLnBpY2t1cExvY2F0aW9uc1NlYXJjaEZhY2FkZS5sb2FkU3RvcmVEZXRhaWxzKG5hbWUpXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgKSxcbiAgICAgICAgICAgIG1lcmdlTWFwKChkZWxpdmVyeVBvaW50T2ZTZXJ2aWNlTWFwKSA9PlxuICAgICAgICAgICAgICBjb21iaW5lTGF0ZXN0KFxuICAgICAgICAgICAgICAgIGRlbGl2ZXJ5UG9pbnRPZlNlcnZpY2VNYXBcbiAgICAgICAgICAgICAgICAgIC5tYXAoKGRlbGl2ZXJ5UG9pbnRPZlNlcnZpY2UpID0+IGRlbGl2ZXJ5UG9pbnRPZlNlcnZpY2UubmFtZSlcbiAgICAgICAgICAgICAgICAgIC5tYXAoKG5hbWUpID0+XG4gICAgICAgICAgICAgICAgICAgIHRoaXMucGlja3VwTG9jYXRpb25zU2VhcmNoRmFjYWRlLmdldFN0b3JlRGV0YWlscyhuYW1lKVxuICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApLnBpcGUoXG4gICAgICAgICAgICAgICAgbWFwKChzdG9yZURldGFpbHMpID0+IHtcbiAgICAgICAgICAgICAgICAgIGNvbnN0IFNUT1JFX0RFVEFJTFNfTUFQID0gc3RvcmVEZXRhaWxzXG4gICAgICAgICAgICAgICAgICAgIC5maWx0ZXIoKF9zdG9yZURldGFpbHMpID0+ICEhX3N0b3JlRGV0YWlscylcbiAgICAgICAgICAgICAgICAgICAgLnJlZHVjZShcbiAgICAgICAgICAgICAgICAgICAgICAoYWNjdW11bGF0b3IsIHZhbHVlKTogUmVjb3JkPHN0cmluZywgUG9pbnRPZlNlcnZpY2U+ID0+ICh7XG4gICAgICAgICAgICAgICAgICAgICAgICAuLi5hY2N1bXVsYXRvcixcbiAgICAgICAgICAgICAgICAgICAgICAgIFt2YWx1ZS5uYW1lIGFzIHN0cmluZ106IHZhbHVlLFxuICAgICAgICAgICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgICAgICAgICAgIHt9IGFzIFJlY29yZDxzdHJpbmcsIFBvaW50T2ZTZXJ2aWNlPlxuICAgICAgICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgICAgICAgcmV0dXJuIGRlbGl2ZXJ5UG9pbnRPZlNlcnZpY2VNYXAubWFwKFxuICAgICAgICAgICAgICAgICAgICAoXG4gICAgICAgICAgICAgICAgICAgICAgc3RvcmVcbiAgICAgICAgICAgICAgICAgICAgKToge1xuICAgICAgICAgICAgICAgICAgICAgIG5hbWU6IHN0cmluZztcbiAgICAgICAgICAgICAgICAgICAgICB2YWx1ZTogQXJyYXk8T3JkZXJFbnRyeT47XG4gICAgICAgICAgICAgICAgICAgICAgc3RvcmVEZXRhaWxzOiBQb2ludE9mU2VydmljZTtcbiAgICAgICAgICAgICAgICAgICAgfSA9PiAoe1xuICAgICAgICAgICAgICAgICAgICAgIC4uLnN0b3JlLFxuICAgICAgICAgICAgICAgICAgICAgIHN0b3JlRGV0YWlsczogU1RPUkVfREVUQUlMU19NQVBbc3RvcmUubmFtZSBhcyBzdHJpbmddLFxuICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgICAgKSxcbiAgICAgICAgICBvZihbXSlcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG4gIH1cbn1cbiJdfQ==