/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Component, ViewChild, } from '@angular/core';
import { getProperty, } from '@spartacus/pickup-in-store/root';
import { combineLatest, iif, of, Subscription } from 'rxjs';
import { concatMap, filter, map, startWith, switchMap, take, tap, } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/storefront";
import * as i2 from "@spartacus/pickup-in-store/root";
import * as i3 from "@angular/common";
import * as i4 from "../../presentational/pickup-options/pickup-options.component";
/** Custom type guard to ensure we have a product a defined code */
function isProductWithCode(product) {
    return !!product?.code;
}
/**
 * A container component of the pair of the pickup options radio buttons for cart entry.
 */
export class PdpPickupOptionsContainerComponent {
    constructor(currentProductService, intendedPickupLocationService, launchDialogService, pickupOptionFacade, preferredStoreFacade, pickupLocationsSearchService, vcr) {
        this.currentProductService = currentProductService;
        this.intendedPickupLocationService = intendedPickupLocationService;
        this.launchDialogService = launchDialogService;
        this.pickupOptionFacade = pickupOptionFacade;
        this.preferredStoreFacade = preferredStoreFacade;
        this.pickupLocationsSearchService = pickupLocationsSearchService;
        this.vcr = vcr;
        this.subscription = new Subscription();
        this.availableForPickup = false;
        this.displayNameIsSet = false;
        // Intentional empty constructor
    }
    ngOnInit() {
        this.pickupOptionFacade.setPageContext('PDP');
        const productCode$ = this.currentProductService.getProduct().pipe(filter(isProductWithCode), map((product) => {
            this.productCode = product.code;
            this.availableForPickup = !!product.availableForPickup;
            return this.productCode;
        }), tap((productCode) => (this.pickupOption$ =
            this.intendedPickupLocationService.getPickupOption(productCode))));
        this.displayPickupLocation$ = this.currentProductService.getProduct().pipe(filter(isProductWithCode), map((product) => product.code), switchMap((productCode) => this.intendedPickupLocationService
            .getIntendedLocation(productCode)
            .pipe(map((intendedLocation) => ({ intendedLocation, productCode })))), switchMap(({ intendedLocation, productCode }) => iif(() => !!intendedLocation && !!intendedLocation.displayName, of(getProperty(intendedLocation, 'displayName')), this.preferredStoreFacade
            .getPreferredStoreWithProductInStock(productCode)
            .pipe(map(({ name }) => name), tap((storeName) => this.pickupLocationsSearchService.loadStoreDetails(storeName)), concatMap((storeName) => this.pickupLocationsSearchService.getStoreDetails(storeName)), filter((storeDetails) => !!storeDetails), tap((storeDetails) => {
            this.intendedPickupLocationService.setIntendedLocation(productCode, {
                ...storeDetails,
                pickupOption: 'delivery',
            });
        })))), tap(() => (this.displayNameIsSet = true)));
        this.intendedPickupLocation$ = this.currentProductService.getProduct().pipe(filter(isProductWithCode), map((product) => product.code), switchMap((productCode) => this.intendedPickupLocationService.getIntendedLocation(productCode)));
        this.subscription.add(combineLatest([
            productCode$,
            this.launchDialogService.dialogClose.pipe(filter((reason) => reason !== undefined), startWith(undefined)),
        ])
            .pipe(switchMap(([productCode]) => this.intendedPickupLocationService.getIntendedLocation(productCode)))
            .subscribe());
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
    openDialog() {
        const dialog = this.launchDialogService.openDialog("PICKUP_IN_STORE" /* LAUNCH_CALLER.PICKUP_IN_STORE */, this.element, this.vcr, { productCode: this.productCode });
        if (dialog) {
            dialog.pipe(take(1)).subscribe();
        }
    }
    onPickupOptionChange(option) {
        this.intendedPickupLocationService.setPickupOption(this.productCode, option);
        if (option === 'delivery') {
            return;
        }
        if (!this.displayNameIsSet) {
            this.openDialog();
        }
    }
}
PdpPickupOptionsContainerComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: PdpPickupOptionsContainerComponent, deps: [{ token: i1.CurrentProductService }, { token: i2.IntendedPickupLocationFacade }, { token: i1.LaunchDialogService }, { token: i2.PickupOptionFacade }, { token: i2.PreferredStoreFacade }, { token: i2.PickupLocationsSearchFacade }, { token: i0.ViewContainerRef }], target: i0.ɵɵFactoryTarget.Component });
PdpPickupOptionsContainerComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.9", type: PdpPickupOptionsContainerComponent, selector: "cx-cart-pickup-options-container", viewQueries: [{ propertyName: "element", first: true, predicate: ["open"], descendants: true }], ngImport: i0, template: "<ng-container *ngIf=\"availableForPickup\">\n  <cx-pickup-options\n    [selectedOption]=\"pickupOption$ | async\"\n    [displayPickupLocation]=\"displayPickupLocation$ | async\"\n    (pickupOptionChange)=\"onPickupOptionChange($event)\"\n    (pickupLocationChange)=\"openDialog()\"\n  ></cx-pickup-options>\n</ng-container>\n", dependencies: [{ kind: "directive", type: i3.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i4.PickupOptionsComponent, selector: "cx-pickup-options", inputs: ["selectedOption", "displayPickupLocation", "disableControls"], outputs: ["pickupOptionChange", "pickupLocationChange"] }, { kind: "pipe", type: i3.AsyncPipe, name: "async" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: PdpPickupOptionsContainerComponent, decorators: [{
            type: Component,
            args: [{ selector: 'cx-cart-pickup-options-container', template: "<ng-container *ngIf=\"availableForPickup\">\n  <cx-pickup-options\n    [selectedOption]=\"pickupOption$ | async\"\n    [displayPickupLocation]=\"displayPickupLocation$ | async\"\n    (pickupOptionChange)=\"onPickupOptionChange($event)\"\n    (pickupLocationChange)=\"openDialog()\"\n  ></cx-pickup-options>\n</ng-container>\n" }]
        }], ctorParameters: function () { return [{ type: i1.CurrentProductService }, { type: i2.IntendedPickupLocationFacade }, { type: i1.LaunchDialogService }, { type: i2.PickupOptionFacade }, { type: i2.PreferredStoreFacade }, { type: i2.PickupLocationsSearchFacade }, { type: i0.ViewContainerRef }]; }, propDecorators: { element: [{
                type: ViewChild,
                args: ['open']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGRwLXBpY2t1cC1vcHRpb25zLWNvbnRhaW5lci5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcGlja3VwLWluLXN0b3JlL2NvbXBvbmVudHMvY29udGFpbmVyL3BkcC1waWNrdXAtb3B0aW9ucy1jb250YWluZXIvcGRwLXBpY2t1cC1vcHRpb25zLWNvbnRhaW5lci5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcGlja3VwLWluLXN0b3JlL2NvbXBvbmVudHMvY29udGFpbmVyL3BkcC1waWNrdXAtb3B0aW9ucy1jb250YWluZXIvcGRwLXBpY2t1cC1vcHRpb25zLWNvbnRhaW5lci5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQTs7OztHQUlHO0FBRUgsT0FBTyxFQUNMLFNBQVMsRUFJVCxTQUFTLEdBRVYsTUFBTSxlQUFlLENBQUM7QUFHdkIsT0FBTyxFQUVMLFdBQVcsR0FPWixNQUFNLGlDQUFpQyxDQUFDO0FBTXpDLE9BQU8sRUFBRSxhQUFhLEVBQUUsR0FBRyxFQUFjLEVBQUUsRUFBRSxZQUFZLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEUsT0FBTyxFQUNMLFNBQVMsRUFDVCxNQUFNLEVBQ04sR0FBRyxFQUNILFNBQVMsRUFDVCxTQUFTLEVBQ1QsSUFBSSxFQUNKLEdBQUcsR0FDSixNQUFNLGdCQUFnQixDQUFDOzs7Ozs7QUFFeEIsbUVBQW1FO0FBQ25FLFNBQVMsaUJBQWlCLENBQ3hCLE9BQXVCO0lBRXZCLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxJQUFJLENBQUM7QUFDekIsQ0FBQztBQUVEOztHQUVHO0FBS0gsTUFBTSxPQUFPLGtDQUFrQztJQVc3QyxZQUNZLHFCQUE0QyxFQUM1Qyw2QkFBMkQsRUFDM0QsbUJBQXdDLEVBQ3hDLGtCQUFzQyxFQUN0QyxvQkFBMEMsRUFDMUMsNEJBQXlELEVBQ3pE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VSx3REFFaEQsSUFBSSxDQUFDLE9BQU8sRUFDWixJQUFJLENBQUMsR0FBRyxFQUNSLEVBQUUsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsQ0FDbEMsQ0FBQztRQUVGLElBQUksTUFBTSxFQUFFO1lBQ1YsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsQ0FBQztTQUNsQztJQUNILENBQUM7SUFFRCxvQkFBb0IsQ0FBQyxNQUFvQjtRQUN2QyxJQUFJLENBQUMsNkJBQTZCLENBQUMsZUFBZSxDQUNoRCxJQUFJLENBQUMsV0FBVyxFQUNoQixNQUFNLENBQ1AsQ0FBQztRQUNGLElBQUksTUFBTSxLQUFLLFVBQVUsRUFBRTtZQUN6QixPQUFPO1NBQ1I7UUFDRCxJQUFJLENBQUMsSUFBSSxDQUFDLGdCQUFnQixFQUFFO1lBQzFCLElBQUksQ0FBQyxVQUFVLEVBQUUsQ0FBQztTQUNuQjtJQUNILENBQUM7OytIQWxJVSxrQ0FBa0M7bUhBQWxDLGtDQUFrQyx5S0N4RC9DLHVVQVFBOzJGRGdEYSxrQ0FBa0M7a0JBSjlDLFNBQVM7K0JBQ0Usa0NBQWtDO3NVQUl6QixPQUFPO3NCQUF6QixTQUFTO3VCQUFDLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMyBTQVAgU3BhcnRhY3VzIHRlYW0gPHNwYXJ0YWN1cy10ZWFtQHNhcC5jb20+XG4gKlxuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQge1xuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBWaWV3Q2hpbGQsXG4gIFZpZXdDb250YWluZXJSZWYsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHsgUHJvZHVjdCB9IGZyb20gJ0BzcGFydGFjdXMvY29yZSc7XG5cbmltcG9ydCB7XG4gIEF1Z21lbnRlZFBvaW50T2ZTZXJ2aWNlLFxuICBnZXRQcm9wZXJ0eSxcbiAgSW50ZW5kZWRQaWNrdXBMb2NhdGlvbkZhY2FkZSxcbiAgUGlja3VwTG9jYXRpb25zU2VhcmNoRmFjYWRlLFxuICBQaWNrdXBPcHRpb24sXG4gIFBpY2t1cE9wdGlvbkZhY2FkZSxcbiAgUHJlZmVycmVkU3RvcmVGYWNhZGUsXG4gIFJlcXVpcmVkRGVlcFBhdGgsXG59IGZyb20gJ0BzcGFydGFjdXMvcGlja3VwLWluLXN0b3JlL3Jvb3QnO1xuaW1wb3J0IHtcbiAgQ3VycmVudFByb2R1Y3RTZXJ2aWNlLFxuICBMYXVuY2hEaWFsb2dTZXJ2aWNlLFxuICBMQVVOQ0hfQ0FMTEVSLFxufSBmcm9tICdAc3BhcnRhY3VzL3N0b3JlZnJvbnQnO1xuaW1wb3J0IHsgY29tYmluZUxhdGVzdCwgaWlmLCBPYnNlcnZhYmxlLCBvZiwgU3Vic2NyaXB0aW9uIH0gZnJvbSAncnhqcyc7XG5pbXBvcnQge1xuICBjb25jYXRNYXAsXG4gIGZpbHRlcixcbiAgbWFwLFxuICBzdGFydFdpdGgsXG4gIHN3aXRjaE1hcCxcbiAgdGFrZSxcbiAgdGFwLFxufSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbi8qKiBDdXN0b20gdHlwZSBndWFyZCB0byBlbnN1cmUgd2UgaGF2ZSBhIHByb2R1Y3QgYSBkZWZpbmVkIGNvZGUgKi9cbmZ1bmN0aW9uIGlzUHJvZHVjdFdpdGhDb2RlKFxuICBwcm9kdWN0OiBQcm9kdWN0IHwgbnVsbFxuKTogcHJvZHVjdCBpcyBSZXF1aXJlZERlZXBQYXRoPFByb2R1Y3QsICdjb2RlJz4ge1xuICByZXR1cm4gISFwcm9kdWN0Py5jb2RlO1xufVxuXG4vKipcbiAqIEEgY29udGFpbmVyIGNvbXBvbmVudCBvZiB0aGUgcGFpciBvZiB0aGUgcGlja3VwIG9wdGlvbnMgcmFkaW8gYnV0dG9ucyBmb3IgY2FydCBlbnRyeS5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnY3gtY2FydC1waWNrdXAtb3B0aW9ucy1jb250YWluZXInLFxuICB0ZW1wbGF0ZVVybDogJ3BkcC1waWNrdXAtb3B0aW9ucy1jb250YWluZXIuY29tcG9uZW50Lmh0bWwnLFxufSlcbmV4cG9ydCBjbGFzcyBQZHBQaWNrdXBPcHRpb25zQ29udGFpbmVyQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBPbkRlc3Ryb3kge1xuICBAVmlld0NoaWxkKCdvcGVuJykgZWxlbWVudDogRWxlbWVudFJlZjtcbiAgc3Vic2NyaXB0aW9uID0gbmV3IFN1YnNjcmlwdGlvbigpO1xuXG4gIGF2YWlsYWJsZUZvclBpY2t1cCA9IGZhbHNlO1xuICBkaXNwbGF5UGlja3VwTG9jYXRpb24kOiBPYnNlcnZhYmxlPHN0cmluZyB8IHVuZGVmaW5lZD47XG4gIHBpY2t1cE9wdGlvbiQ6IE9ic2VydmFibGU8UGlja3VwT3B0aW9uPjtcbiAgaW50ZW5kZWRQaWNrdXBMb2NhdGlvbiQ6IE9ic2VydmFibGU8QXVnbWVudGVkUG9pbnRPZlNlcnZpY2UgfCB1bmRlZmluZWQ+O1xuICBwcml2YXRlIHByb2R1Y3RDb2RlOiBzdHJpbmc7XG4gIHByaXZhdGUgZGlzcGxheU5hbWVJc1NldCA9IGZhbHNlO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIHByb3RlY3RlZCBjdXJyZW50UHJvZHVjdFNlcnZpY2U6IEN1cnJlbnRQcm9kdWN0U2VydmljZSxcbiAgICBwcm90ZWN0ZWQgaW50ZW5kZWRQaWNrdXBMb2NhdGlvblNlcnZpY2U6IEludGVuZGVkUGlja3VwTG9jYXRpb25GYWNhZGUsXG4gICAgcHJvdGVjdGVkIGxhdW5jaERpYWxvZ1NlcnZpY2U6IExhdW5jaERpYWxvZ1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHBpY2t1cE9wdGlvbkZhY2FkZTogUGlja3VwT3B0aW9uRmFjYWRlLFxuICAgIHByb3RlY3RlZCBwcmVmZXJyZWRTdG9yZUZhY2FkZTogUHJlZmVycmVkU3RvcmVGYWNhZGUsXG4gICAgcHJvdGVjdGVkIHBpY2t1cExvY2F0aW9uc1NlYXJjaFNlcnZpY2U6IFBpY2t1cExvY2F0aW9uc1NlYXJjaEZhY2FkZSxcbiAgICBwcm90ZWN0ZWQgdmNyOiBWaWV3Q29udGFpbmVyUmVmXG4gICkge1xuICAgIC8vIEludGVudGlvbmFsIGVtcHR5IGNvbnN0cnVjdG9yXG4gIH1cblxuICBuZ09uSW5pdCgpIHtcbiAgICB0aGlzLnBpY2t1cE9wdGlvbkZhY2FkZS5zZXRQYWdlQ29udGV4dCgnUERQJyk7XG4gICAgY29uc3QgcHJvZHVjdENvZGUkID0gdGhpcy5jdXJyZW50UHJvZHVjdFNlcnZpY2UuZ2V0UHJvZHVjdCgpLnBpcGUoXG4gICAgICBmaWx0ZXIoaXNQcm9kdWN0V2l0aENvZGUpLFxuICAgICAgbWFwKChwcm9kdWN0KSA9PiB7XG4gICAgICAgIHRoaXMucHJvZHVjdENvZGUgPSBwcm9kdWN0LmNvZGU7XG4gICAgICAgIHRoaXMuYXZhaWxhYmxlRm9yUGlja3VwID0gISFwcm9kdWN0LmF2YWlsYWJsZUZvclBpY2t1cDtcbiAgICAgICAgcmV0dXJuIHRoaXMucHJvZHVjdENvZGU7XG4gICAgICB9KSxcbiAgICAgIHRhcChcbiAgICAgICAgKHByb2R1Y3RDb2RlKSA9PlxuICAgICAgICAgICh0aGlzLnBpY2t1cE9wdGlvbiQgPVxuICAgICAgICAgICAgdGhpcy5pbnRlbmRlZFBpY2t1cExvY2F0aW9uU2VydmljZS5nZXRQaWNrdXBPcHRpb24ocHJvZHVjdENvZGUpKVxuICAgICAgKVxuICAgICk7XG5cbiAgICB0aGlzLmRpc3BsYXlQaWNrdXBMb2NhdGlvbiQgPSB0aGlzLmN1cnJlbnRQcm9kdWN0U2VydmljZS5nZXRQcm9kdWN0KCkucGlwZShcbiAgICAgIGZpbHRlcihpc1Byb2R1Y3RXaXRoQ29kZSksXG4gICAgICBtYXAoKHByb2R1Y3QpID0+IHByb2R1Y3QuY29kZSksXG4gICAgICBzd2l0Y2hNYXAoKHByb2R1Y3RDb2RlKSA9PlxuICAgICAgICB0aGlzLmludGVuZGVkUGlja3VwTG9jYXRpb25TZXJ2aWNlXG4gICAgICAgICAgLmdldEludGVuZGVkTG9jYXRpb24ocHJvZHVjdENvZGUpXG4gICAgICAgICAgLnBpcGUobWFwKChpbnRlbmRlZExvY2F0aW9uKSA9PiAoeyBpbnRlbmRlZExvY2F0aW9uLCBwcm9kdWN0Q29kZSB9KSkpXG4gICAgICApLFxuICAgICAgc3dpdGNoTWFwKCh7IGludGVuZGVkTG9jYXRpb24sIHByb2R1Y3RDb2RlIH0pID0+XG4gICAgICAgIGlpZihcbiAgICAgICAgICAoKSA9PiAhIWludGVuZGVkTG9jYXRpb24gJiYgISFpbnRlbmRlZExvY2F0aW9uLmRpc3BsYXlOYW1lLFxuICAgICAgICAgIG9mKGdldFByb3BlcnR5KGludGVuZGVkTG9jYXRpb24sICdkaXNwbGF5TmFtZScpKSxcbiAgICAgICAgICB0aGlzLnByZWZlcnJlZFN0b3JlRmFjYWRlXG4gICAgICAgICAgICAuZ2V0UHJlZmVycmVkU3RvcmVXaXRoUHJvZHVjdEluU3RvY2socHJvZHVjdENvZGUpXG4gICAgICAgICAgICAucGlwZShcbiAgICAgICAgICAgICAgbWFwKCh7IG5hbWUgfSkgPT4gbmFtZSksXG4gICAgICAgICAgICAgIHRhcCgoc3RvcmVOYW1lKSA9PlxuICAgICAgICAgICAgICAgIHRoaXMucGlja3VwTG9jYXRpb25zU2VhcmNoU2VydmljZS5sb2FkU3RvcmVEZXRhaWxzKHN0b3JlTmFtZSlcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgY29uY2F0TWFwKChzdG9yZU5hbWU6IHN0cmluZykgPT5cbiAgICAgICAgICAgICAgICB0aGlzLnBpY2t1cExvY2F0aW9uc1NlYXJjaFNlcnZpY2UuZ2V0U3RvcmVEZXRhaWxzKHN0b3JlTmFtZSlcbiAgICAgICAgICAgICAgKSxcbiAgICAgICAgICAgICAgZmlsdGVyKChzdG9yZURldGFpbHMpID0+ICEhc3RvcmVEZXRhaWxzKSxcbiAgICAgICAgICAgICAgdGFwKChzdG9yZURldGFpbHMpID0+IHtcbiAgICAgICAgICAgICAgICB0aGlzLmludGVuZGVkUGlja3VwTG9jYXRpb25TZXJ2aWNlLnNldEludGVuZGVkTG9jYXRpb24oXG4gICAgICAgICAgICAgICAgICBwcm9kdWN0Q29kZSxcbiAgICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgICAgLi4uc3RvcmVEZXRhaWxzLFxuICAgICAgICAgICAgICAgICAgICBwaWNrdXBPcHRpb246ICdkZWxpdmVyeScsXG4gICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKSxcbiAgICAgIHRhcCgoKSA9PiAodGhpcy5kaXNwbGF5TmFtZUlzU2V0ID0gdHJ1ZSkpXG4gICAgKTtcblxuICAgIHRoaXMuaW50ZW5kZWRQaWNrdXBMb2NhdGlvbiQgPSB0aGlzLmN1cnJlbnRQcm9kdWN0U2VydmljZS5nZXRQcm9kdWN0KCkucGlwZShcbiAgICAgIGZpbHRlcihpc1Byb2R1Y3RXaXRoQ29kZSksXG4gICAgICBtYXAoKHByb2R1Y3QpID0+IHByb2R1Y3QuY29kZSksXG4gICAgICBzd2l0Y2hNYXAoKHByb2R1Y3RDb2RlKSA9PlxuICAgICAgICB0aGlzLmludGVuZGVkUGlja3VwTG9jYXRpb25TZXJ2aWNlLmdldEludGVuZGVkTG9jYXRpb24ocHJvZHVjdENvZGUpXG4gICAgICApXG4gICAgKTtcblxuICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgIGNvbWJpbmVMYXRlc3QoW1xuICAgICAgICBwcm9kdWN0Q29kZSQsXG4gICAgICAgIHRoaXMubGF1bmNoRGlhbG9nU2VydmljZS5kaWFsb2dDbG9zZS5waXBlKFxuICAgICAgICAgIGZpbHRlcigocmVhc29uKSA9PiByZWFzb24gIT09IHVuZGVmaW5lZCksXG4gICAgICAgICAgc3RhcnRXaXRoKHVuZGVmaW5lZClcbiAgICAgICAgKSxcbiAgICAgIF0pXG4gICAgICAgIC5waXBlKFxuICAgICAgICAgIHN3aXRjaE1hcCgoW3Byb2R1Y3RDb2RlXSkgPT5cbiAgICAgICAgICAgIHRoaXMuaW50ZW5kZWRQaWNrdXBMb2NhdGlvblNlcnZpY2UuZ2V0SW50ZW5kZWRMb2NhdGlvbihwcm9kdWN0Q29kZSlcbiAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICAgLnN1YnNjcmliZSgpXG4gICAgKTtcbiAgfVxuXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xuICAgIHRoaXMuc3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XG4gIH1cblxuICBvcGVuRGlhbG9nKCk6IHZvaWQge1xuICAgIGNvbnN0IGRpYWxvZyA9IHRoaXMubGF1bmNoRGlhbG9nU2VydmljZS5vcGVuRGlhbG9nKFxuICAgICAgTEFVTkNIX0NBTExFUi5QSUNLVVBfSU5fU1RPUkUsXG4gICAgICB0aGlzLmVsZW1lbnQsXG4gICAgICB0aGlzLnZjcixcbiAgICAgIHsgcHJvZHVjdENvZGU6IHRoaXMucHJvZHVjdENvZGUgfVxuICAgICk7XG5cbiAgICBpZiAoZGlhbG9nKSB7XG4gICAgICBkaWFsb2cucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cblxuICBvblBpY2t1cE9wdGlvbkNoYW5nZShvcHRpb246IFBpY2t1cE9wdGlvbikge1xuICAgIHRoaXMuaW50ZW5kZWRQaWNrdXBMb2NhdGlvblNlcnZpY2Uuc2V0UGlja3VwT3B0aW9uKFxuICAgICAgdGhpcy5wcm9kdWN0Q29kZSxcbiAgICAgIG9wdGlvblxuICAgICk7XG4gICAgaWYgKG9wdGlvbiA9PT0gJ2RlbGl2ZXJ5Jykge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBpZiAoIXRoaXMuZGlzcGxheU5hbWVJc1NldCkge1xuICAgICAgdGhpcy5vcGVuRGlhbG9nKCk7XG4gICAgfVxuICB9XG59XG4iLCI8bmctY29udGFpbmVyICpuZ0lmPVwiYXZhaWxhYmxlRm9yUGlja3VwXCI+XG4gIDxjeC1waWNrdXAtb3B0aW9uc1xuICAgIFtzZWxlY3RlZE9wdGlvbl09XCJwaWNrdXBPcHRpb24kIHwgYXN5bmNcIlxuICAgIFtkaXNwbGF5UGlja3VwTG9jYXRpb25dPVwiZGlzcGxheVBpY2t1cExvY2F0aW9uJCB8IGFzeW5jXCJcbiAgICAocGlja3VwT3B0aW9uQ2hhbmdlKT1cIm9uUGlja3VwT3B0aW9uQ2hhbmdlKCRldmVudClcIlxuICAgIChwaWNrdXBMb2NhdGlvbkNoYW5nZSk9XCJvcGVuRGlhbG9nKClcIlxuICA+PC9jeC1waWNrdXAtb3B0aW9ucz5cbjwvbmctY29udGFpbmVyPlxuIl19