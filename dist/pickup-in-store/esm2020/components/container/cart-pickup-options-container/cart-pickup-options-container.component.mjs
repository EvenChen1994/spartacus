/*
 * SPDX-FileCopyrightText: 2023 SAP Spartacus team <spartacus-team@sap.com>
 *
 * SPDX-License-Identifier: Apache-2.0
 */
import { Component, Optional, ViewChild, } from '@angular/core';
import { CartType, } from '@spartacus/cart/base/root';
import { cartWithIdAndUserId, getProperty, } from '@spartacus/pickup-in-store/root';
import { EMPTY, iif, of, Subscription } from 'rxjs';
import { concatMap, filter, map, startWith, switchMap, take, tap, withLatestFrom, } from 'rxjs/operators';
import * as i0 from "@angular/core";
import * as i1 from "@spartacus/cart/base/root";
import * as i2 from "@spartacus/storefront";
import * as i3 from "@spartacus/pickup-in-store/root";
import * as i4 from "@spartacus/core";
import * as i5 from "@angular/common";
import * as i6 from "../../presentational/pickup-options/pickup-options.component";
/** Custom type guard to ensure we have an order entry with all the required fields */
export function orderEntryWithRequiredFields(orderEntry) {
    return (!!orderEntry &&
        orderEntry.entryNumber !== undefined &&
        orderEntry.quantity !== undefined &&
        orderEntry.product !== undefined &&
        orderEntry.product.code !== undefined &&
        orderEntry.product.availableForPickup !== undefined);
}
/**
 * A container component of the pair of the pickup options radio buttons for cart entry.
 */
export class CartPickupOptionsContainerComponent {
    constructor(activeCartFacade, launchDialogService, pickupLocationsSearchService, pickupOptionFacade, preferredStoreFacade, vcr, cmsService, intendedPickupLocationService, outlet) {
        this.activeCartFacade = activeCartFacade;
        this.launchDialogService = launchDialogService;
        this.pickupLocationsSearchService = pickupLocationsSearchService;
        this.pickupOptionFacade = pickupOptionFacade;
        this.preferredStoreFacade = preferredStoreFacade;
        this.vcr = vcr;
        this.cmsService = cmsService;
        this.intendedPickupLocationService = intendedPickupLocationService;
        this.outlet = outlet;
        this.subscription = new Subscription();
        this.displayNameIsSet = false;
        this.CartType = CartType;
        // Intentional empty constructor
    }
    ngOnInit() {
        const outletContext = this.outlet?.context$?.pipe(map((context) => {
            this.cartType = context.cartType;
            return context.item;
        }), filter(orderEntryWithRequiredFields)) ?? EMPTY;
        this.cmsService
            .getCurrentPage()
            .pipe(filter(Boolean), take(1), tap((cmsPage) => {
            this.page = cmsPage.pageId;
            this.pickupOptionFacade.setPageContext(cmsPage.pageId ?? '');
        }))
            .subscribe();
        this.availableForPickup$ = outletContext.pipe(map((orderEntry) => !!orderEntry.product.availableForPickup), startWith(false));
        this.pickupOption$ = outletContext.pipe(withLatestFrom(this.activeCartFacade.getActive().pipe(filter(cartWithIdAndUserId))), tap(([orderEntry, cart]) => {
            this.entryNumber = orderEntry.entryNumber;
            this.quantity = orderEntry.quantity;
            this.productCode = orderEntry.product.code;
            this.cartId = cart.user.uid === 'anonymous' ? cart.guid : cart.code;
            this.userId = cart.user.uid;
        }), switchMap(([orderEntry]) => {
            const pickupOption = orderEntry.deliveryPointOfService
                ? 'pickup'
                : 'delivery';
            this.pickupOptionFacade.setPickupOption(this.entryNumber, pickupOption);
            return this.pickupOptionFacade.getPickupOption(this.entryNumber);
        }));
        this.disableControls$ = this.activeCartFacade.getEntries().pipe(map((entries) => entries.map((entry) => entry.product?.code)), switchMap((productCodes) => outletContext.pipe(map((orderEntry) => orderEntry?.product.code), map((orderEntry) => productCodes.filter((productCode) => productCode === orderEntry)
            .length > 1))));
        this.storeDetails$ = outletContext.pipe(map((orderEntry) => ({
            storeName: orderEntry.deliveryPointOfService?.name,
            productCode: orderEntry.product.code,
        })), switchMap(({ storeName, productCode }) => iif(() => !!storeName, of(storeName).pipe(tap((_storeName) => {
            return this.pickupLocationsSearchService.loadStoreDetails(_storeName);
        }), concatMap((_storeName) => this.pickupLocationsSearchService.getStoreDetails(_storeName)), filter((storeDetails) => !!storeDetails), tap((storeDetails) => {
            this.intendedPickupLocationService.setIntendedLocation(productCode, {
                ...storeDetails,
                pickupOption: 'pickup',
            });
        })), this.intendedPickupLocationService
            .getIntendedLocation(productCode)
            .pipe(map((intendedLocation) => ({
            intendedLocation,
            givenProductCode: productCode,
        })), switchMap(({ intendedLocation, givenProductCode }) => iif(() => !!intendedLocation && !!intendedLocation.displayName, of({
            displayName: getProperty(intendedLocation, 'displayName'),
            name: getProperty(intendedLocation, 'name'),
        }), this.preferredStoreFacade
            .getPreferredStoreWithProductInStock(productCode)
            .pipe(map(({ name }) => name), tap((_storeName) => this.pickupLocationsSearchService.loadStoreDetails(_storeName)), concatMap((_storeName) => this.pickupLocationsSearchService.getStoreDetails(_storeName)), filter((storeDetails) => !!storeDetails), tap((storeDetails) => {
            this.intendedPickupLocationService.setIntendedLocation(givenProductCode, {
                ...storeDetails,
                pickupOption: 'delivery',
            });
        }))))))), map(({ displayName, name }) => ({ displayName, name })), tap((_) => (this.displayNameIsSet = true)));
    }
    onPickupOptionChange(pickupOption) {
        this.pickupOptionFacade.setPickupOption(this.entryNumber, pickupOption);
        if (pickupOption === 'delivery') {
            this.activeCartFacade.updateEntry(this.entryNumber, this.quantity, undefined, true);
            return;
        }
        [pickupOption]
            .filter((option) => option === 'pickup')
            .forEach(() => {
            this.subscription.add(this.storeDetails$
                .pipe(filter(({ name }) => !!name), tap(({ name }) => this.activeCartFacade.updateEntry(this.entryNumber, this.quantity, name, true)))
                .subscribe());
        });
        if (!this.displayNameIsSet) {
            this.openDialog();
        }
    }
    ngOnDestroy() {
        this.subscription.unsubscribe();
    }
    openDialog() {
        const dialog = this.launchDialogService.openDialog("PICKUP_IN_STORE" /* LAUNCH_CALLER.PICKUP_IN_STORE */, this.element, this.vcr, {
            productCode: this.productCode,
            entryNumber: this.entryNumber,
            quantity: this.quantity,
        });
        if (dialog) {
            dialog.pipe(take(1)).subscribe();
        }
    }
}
CartPickupOptionsContainerComponent.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CartPickupOptionsContainerComponent, deps: [{ token: i1.ActiveCartFacade }, { token: i2.LaunchDialogService }, { token: i3.PickupLocationsSearchFacade }, { token: i3.PickupOptionFacade }, { token: i3.PreferredStoreFacade }, { token: i0.ViewContainerRef }, { token: i4.CmsService }, { token: i3.IntendedPickupLocationFacade }, { token: i2.OutletContextData, optional: true }], target: i0.ɵɵFactoryTarget.Component });
CartPickupOptionsContainerComponent.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "14.0.0", version: "15.2.9", type: CartPickupOptionsContainerComponent, selector: "cx-cart-pickup-options-container", viewQueries: [{ propertyName: "element", first: true, predicate: ["open"], descendants: true }], ngImport: i0, template: "<ng-container\n  *ngIf=\"\n    (availableForPickup$ | async) &&\n    !(outlet?.context$ | async)?.orderCode &&\n    !(this.cartType === CartType.SELECTIVE)\n  \"\n>\n  <cx-pickup-options\n    [disableControls]=\"disableControls$ | async\"\n    [displayPickupLocation]=\"(storeDetails$ | async)?.displayName\"\n    [selectedOption]=\"pickupOption$ | async\"\n    (pickupOptionChange)=\"onPickupOptionChange($event)\"\n    (pickupLocationChange)=\"openDialog()\"\n  ></cx-pickup-options>\n</ng-container>\n", dependencies: [{ kind: "directive", type: i5.NgIf, selector: "[ngIf]", inputs: ["ngIf", "ngIfThen", "ngIfElse"] }, { kind: "component", type: i6.PickupOptionsComponent, selector: "cx-pickup-options", inputs: ["selectedOption", "displayPickupLocation", "disableControls"], outputs: ["pickupOptionChange", "pickupLocationChange"] }, { kind: "pipe", type: i5.AsyncPipe, name: "async" }] });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.2.9", ngImport: i0, type: CartPickupOptionsContainerComponent, decorators: [{
            type: Component,
            args: [{ selector: 'cx-cart-pickup-options-container', template: "<ng-container\n  *ngIf=\"\n    (availableForPickup$ | async) &&\n    !(outlet?.context$ | async)?.orderCode &&\n    !(this.cartType === CartType.SELECTIVE)\n  \"\n>\n  <cx-pickup-options\n    [disableControls]=\"disableControls$ | async\"\n    [displayPickupLocation]=\"(storeDetails$ | async)?.displayName\"\n    [selectedOption]=\"pickupOption$ | async\"\n    (pickupOptionChange)=\"onPickupOptionChange($event)\"\n    (pickupLocationChange)=\"openDialog()\"\n  ></cx-pickup-options>\n</ng-container>\n" }]
        }], ctorParameters: function () { return [{ type: i1.ActiveCartFacade }, { type: i2.LaunchDialogService }, { type: i3.PickupLocationsSearchFacade }, { type: i3.PickupOptionFacade }, { type: i3.PreferredStoreFacade }, { type: i0.ViewContainerRef }, { type: i4.CmsService }, { type: i3.IntendedPickupLocationFacade }, { type: i2.OutletContextData, decorators: [{
                    type: Optional
                }] }]; }, propDecorators: { element: [{
                type: ViewChild,
                args: ['open']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2FydC1waWNrdXAtb3B0aW9ucy1jb250YWluZXIuY29tcG9uZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vLi4vZmVhdHVyZS1saWJzL3BpY2t1cC1pbi1zdG9yZS9jb21wb25lbnRzL2NvbnRhaW5lci9jYXJ0LXBpY2t1cC1vcHRpb25zLWNvbnRhaW5lci9jYXJ0LXBpY2t1cC1vcHRpb25zLWNvbnRhaW5lci5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi9mZWF0dXJlLWxpYnMvcGlja3VwLWluLXN0b3JlL2NvbXBvbmVudHMvY29udGFpbmVyL2NhcnQtcGlja3VwLW9wdGlvbnMtY29udGFpbmVyL2NhcnQtcGlja3VwLW9wdGlvbnMtY29udGFpbmVyLmNvbXBvbmVudC5odG1sIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBOzs7O0dBSUc7QUFFSCxPQUFPLEVBQ0wsU0FBUyxFQUlULFFBQVEsRUFDUixTQUFTLEdBRVYsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUVMLFFBQVEsR0FFVCxNQUFNLDJCQUEyQixDQUFDO0FBRW5DLE9BQU8sRUFDTCxtQkFBbUIsRUFDbkIsV0FBVyxHQU9aLE1BQU0saUNBQWlDLENBQUM7QUFNekMsT0FBTyxFQUFFLEtBQUssRUFBRSxHQUFHLEVBQWMsRUFBRSxFQUFFLFlBQVksRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNoRSxPQUFPLEVBQ0wsU0FBUyxFQUNULE1BQU0sRUFDTixHQUFHLEVBQ0gsU0FBUyxFQUNULFNBQVMsRUFDVCxJQUFJLEVBQ0osR0FBRyxFQUNILGNBQWMsR0FDZixNQUFNLGdCQUFnQixDQUFDOzs7Ozs7OztBQWF4QixzRkFBc0Y7QUFDdEYsTUFBTSxVQUFVLDRCQUE0QixDQUMxQyxVQUFrQztJQUVsQyxPQUFPLENBQ0wsQ0FBQyxDQUFDLFVBQVU7UUFDWixVQUFVLENBQUMsV0FBVyxLQUFLLFNBQVM7UUFDcEMsVUFBVSxDQUFDLFFBQVEsS0FB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QVksQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNsQyxDQUFDO0lBRUQsVUFBVTtRQUNSLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxVQUFVLHdEQUVoRCxJQUFJLENBQUMsT0FBTyxFQUNaLElBQUksQ0FBQyxHQUFHLEVBQ1I7WUFDRSxXQUFXLEVBQUUsSUFBSSxDQUFDLFdBQVc7WUFDN0IsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO1lBQzdCLFFBQVEsRUFBRSxJQUFJLENBQUMsUUFBUTtTQUN4QixDQUNGLENBQUM7UUFFRixJQUFJLE1BQU0sRUFBRTtZQUNWLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7U0FDbEM7SUFDSCxDQUFDOztnSUF2T1UsbUNBQW1DO29IQUFuQyxtQ0FBbUMseUtDaEZoRCwwZkFlQTsyRkRpRWEsbUNBQW1DO2tCQUovQyxTQUFTOytCQUNFLGtDQUFrQzs7MEJBZ0N6QyxRQUFROzRDQTVCUSxPQUFPO3NCQUF6QixTQUFTO3VCQUFDLE1BQU0iLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogU1BEWC1GaWxlQ29weXJpZ2h0VGV4dDogMjAyMyBTQVAgU3BhcnRhY3VzIHRlYW0gPHNwYXJ0YWN1cy10ZWFtQHNhcC5jb20+XG4gKlxuICogU1BEWC1MaWNlbnNlLUlkZW50aWZpZXI6IEFwYWNoZS0yLjBcbiAqL1xuXG5pbXBvcnQge1xuICBDb21wb25lbnQsXG4gIEVsZW1lbnRSZWYsXG4gIE9uRGVzdHJveSxcbiAgT25Jbml0LFxuICBPcHRpb25hbCxcbiAgVmlld0NoaWxkLFxuICBWaWV3Q29udGFpbmVyUmVmLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7XG4gIEFjdGl2ZUNhcnRGYWNhZGUsXG4gIENhcnRUeXBlLFxuICBPcmRlckVudHJ5LFxufSBmcm9tICdAc3BhcnRhY3VzL2NhcnQvYmFzZS9yb290JztcbmltcG9ydCB7IENtc1NlcnZpY2UsIFBhZ2UgfSBmcm9tICdAc3BhcnRhY3VzL2NvcmUnO1xuaW1wb3J0IHtcbiAgY2FydFdpdGhJZEFuZFVzZXJJZCxcbiAgZ2V0UHJvcGVydHksXG4gIEludGVuZGVkUGlja3VwTG9jYXRpb25GYWNhZGUsXG4gIFBpY2t1cExvY2F0aW9uc1NlYXJjaEZhY2FkZSxcbiAgUGlja3VwT3B0aW9uLFxuICBQaWNrdXBPcHRpb25GYWNhZGUsXG4gIFByZWZlcnJlZFN0b3JlRmFjYWRlLFxuICBSZXF1aXJlZERlZXBQYXRoLFxufSBmcm9tICdAc3BhcnRhY3VzL3BpY2t1cC1pbi1zdG9yZS9yb290JztcbmltcG9ydCB7XG4gIExhdW5jaERpYWxvZ1NlcnZpY2UsXG4gIExBVU5DSF9DQUxMRVIsXG4gIE91dGxldENvbnRleHREYXRhLFxufSBmcm9tICdAc3BhcnRhY3VzL3N0b3JlZnJvbnQnO1xuaW1wb3J0IHsgRU1QVFksIGlpZiwgT2JzZXJ2YWJsZSwgb2YsIFN1YnNjcmlwdGlvbiB9IGZyb20gJ3J4anMnO1xuaW1wb3J0IHtcbiAgY29uY2F0TWFwLFxuICBmaWx0ZXIsXG4gIG1hcCxcbiAgc3RhcnRXaXRoLFxuICBzd2l0Y2hNYXAsXG4gIHRha2UsXG4gIHRhcCxcbiAgd2l0aExhdGVzdEZyb20sXG59IGZyb20gJ3J4anMvb3BlcmF0b3JzJztcblxudHlwZSBPcmRlckVudHJ5UmVxdWlyZWRGaWVsZHMgPVxuICB8ICdlbnRyeU51bWJlcidcbiAgfCAncXVhbnRpdHknXG4gIHwgJ3Byb2R1Y3QuY29kZSdcbiAgfCAncHJvZHVjdC5hdmFpbGFibGVGb3JQaWNrdXAnO1xuXG4vKiogQW4gb3JkZXIgZW50cnkgd2l0aCBhbGwgdGhlIGZpZWxkcyBuZWVkZWQgZm9yIHVzaW5nIHBpY2t1cCBpbiBzdG9yZSAqL1xudHlwZSBPcmRlckVudHJ5V2l0aFJlcXVpcmVkRmllbGRzID0gUmVxdWlyZWREZWVwUGF0aDxcbiAgT3JkZXJFbnRyeSxcbiAgT3JkZXJFbnRyeVJlcXVpcmVkRmllbGRzXG4+O1xuLyoqIEN1c3RvbSB0eXBlIGd1YXJkIHRvIGVuc3VyZSB3ZSBoYXZlIGFuIG9yZGVyIGVudHJ5IHdpdGggYWxsIHRoZSByZXF1aXJlZCBmaWVsZHMgKi9cbmV4cG9ydCBmdW5jdGlvbiBvcmRlckVudHJ5V2l0aFJlcXVpcmVkRmllbGRzKFxuICBvcmRlckVudHJ5OiBPcmRlckVudHJ5IHwgdW5kZWZpbmVkXG4pOiBvcmRlckVudHJ5IGlzIE9yZGVyRW50cnlXaXRoUmVxdWlyZWRGaWVsZHMge1xuICByZXR1cm4gKFxuICAgICEhb3JkZXJFbnRyeSAmJlxuICAgIG9yZGVyRW50cnkuZW50cnlOdW1iZXIgIT09IHVuZGVmaW5lZCAmJlxuICAgIG9yZGVyRW50cnkucXVhbnRpdHkgIT09IHVuZGVmaW5lZCAmJlxuICAgIG9yZGVyRW50cnkucHJvZHVjdCAhPT0gdW5kZWZpbmVkICYmXG4gICAgb3JkZXJFbnRyeS5wcm9kdWN0LmNvZGUgIT09IHVuZGVmaW5lZCAmJlxuICAgIG9yZGVyRW50cnkucHJvZHVjdC5hdmFpbGFibGVGb3JQaWNrdXAgIT09IHVuZGVmaW5lZFxuICApO1xufVxuXG4vKipcbiAqIEEgY29udGFpbmVyIGNvbXBvbmVudCBvZiB0aGUgcGFpciBvZiB0aGUgcGlja3VwIG9wdGlvbnMgcmFkaW8gYnV0dG9ucyBmb3IgY2FydCBlbnRyeS5cbiAqL1xuQENvbXBvbmVudCh7XG4gIHNlbGVjdG9yOiAnY3gtY2FydC1waWNrdXAtb3B0aW9ucy1jb250YWluZXInLFxuICB0ZW1wbGF0ZVVybDogJ2NhcnQtcGlja3VwLW9wdGlvbnMtY29udGFpbmVyLmNvbXBvbmVudC5odG1sJyxcbn0pXG5leHBvcnQgY2xhc3MgQ2FydFBpY2t1cE9wdGlvbnNDb250YWluZXJDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gIEBWaWV3Q2hpbGQoJ29wZW4nKSBlbGVtZW50OiBFbGVtZW50UmVmO1xuXG4gIHBpY2t1cE9wdGlvbiQ6IE9ic2VydmFibGU8UGlja3VwT3B0aW9uIHwgdW5kZWZpbmVkPjtcbiAgZGlzYWJsZUNvbnRyb2xzJDogT2JzZXJ2YWJsZTxib29sZWFuPjtcbiAgc3RvcmVEZXRhaWxzJDogT2JzZXJ2YWJsZTx7XG4gICAgbmFtZTogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIGRpc3BsYXlOYW1lOiBzdHJpbmcgfCB1bmRlZmluZWQ7XG4gIH0+O1xuICBhdmFpbGFibGVGb3JQaWNrdXAkOiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xuICBzdWJzY3JpcHRpb24gPSBuZXcgU3Vic2NyaXB0aW9uKCk7XG4gIGNhcnRJZDogc3RyaW5nO1xuICBjYXJ0VHlwZTogQ2FydFR5cGU7XG4gIGVudHJ5TnVtYmVyOiBudW1iZXI7XG4gIHByb2R1Y3RDb2RlOiBzdHJpbmc7XG4gIHF1YW50aXR5OiBudW1iZXI7XG4gIHVzZXJJZDogc3RyaW5nO1xuICBwcml2YXRlIGRpc3BsYXlOYW1lSXNTZXQgPSBmYWxzZTtcbiAgcGFnZT86IHN0cmluZztcbiAgcmVhZG9ubHkgQ2FydFR5cGUgPSBDYXJ0VHlwZTtcbiAgY29uc3RydWN0b3IoXG4gICAgcHJvdGVjdGVkIGFjdGl2ZUNhcnRGYWNhZGU6IEFjdGl2ZUNhcnRGYWNhZGUsXG4gICAgcHJvdGVjdGVkIGxhdW5jaERpYWxvZ1NlcnZpY2U6IExhdW5jaERpYWxvZ1NlcnZpY2UsXG4gICAgcHJvdGVjdGVkIHBpY2t1cExvY2F0aW9uc1NlYXJjaFNlcnZpY2U6IFBpY2t1cExvY2F0aW9uc1NlYXJjaEZhY2FkZSxcbiAgICBwcm90ZWN0ZWQgcGlja3VwT3B0aW9uRmFjYWRlOiBQaWNrdXBPcHRpb25GYWNhZGUsXG4gICAgcHJvdGVjdGVkIHByZWZlcnJlZFN0b3JlRmFjYWRlOiBQcmVmZXJyZWRTdG9yZUZhY2FkZSxcbiAgICBwcm90ZWN0ZWQgdmNyOiBWaWV3Q29udGFpbmVyUmVmLFxuICAgIHByb3RlY3RlZCBjbXNTZXJ2aWNlOiBDbXNTZXJ2aWNlLFxuICAgIHByb3RlY3RlZCBpbnRlbmRlZFBpY2t1cExvY2F0aW9uU2VydmljZTogSW50ZW5kZWRQaWNrdXBMb2NhdGlvbkZhY2FkZSxcbiAgICBAT3B0aW9uYWwoKVxuICAgIHByb3RlY3RlZCBvdXRsZXQ6IE91dGxldENvbnRleHREYXRhPHtcbiAgICAgIGl0ZW06IE9yZGVyRW50cnk7XG4gICAgICBjYXJ0VHlwZTogQ2FydFR5cGU7XG4gICAgfT5cbiAgKSB7XG4gICAgLy8gSW50ZW50aW9uYWwgZW1wdHkgY29uc3RydWN0b3JcbiAgfVxuXG4gIG5nT25Jbml0KCkge1xuICAgIGNvbnN0IG91dGxldENvbnRleHQgPVxuICAgICAgdGhpcy5vdXRsZXQ/LmNvbnRleHQkPy5waXBlKFxuICAgICAgICBtYXAoKGNvbnRleHQpID0+IHtcbiAgICAgICAgICB0aGlzLmNhcnRUeXBlID0gY29udGV4dC5jYXJ0VHlwZTtcbiAgICAgICAgICByZXR1cm4gY29udGV4dC5pdGVtO1xuICAgICAgICB9KSxcbiAgICAgICAgZmlsdGVyKG9yZGVyRW50cnlXaXRoUmVxdWlyZWRGaWVsZHMpXG4gICAgICApID8/IEVNUFRZO1xuXG4gICAgdGhpcy5jbXNTZXJ2aWNlXG4gICAgICAuZ2V0Q3VycmVudFBhZ2UoKVxuICAgICAgLnBpcGUoXG4gICAgICAgIGZpbHRlcjxQYWdlPihCb29sZWFuKSxcbiAgICAgICAgdGFrZSgxKSxcbiAgICAgICAgdGFwKChjbXNQYWdlKSA9PiB7XG4gICAgICAgICAgdGhpcy5wYWdlID0gY21zUGFnZS5wYWdlSWQ7XG4gICAgICAgICAgdGhpcy5waWNrdXBPcHRpb25GYWNhZGUuc2V0UGFnZUNvbnRleHQoY21zUGFnZS5wYWdlSWQgPz8gJycpO1xuICAgICAgICB9KVxuICAgICAgKVxuICAgICAgLnN1YnNjcmliZSgpO1xuXG4gICAgdGhpcy5hdmFpbGFibGVGb3JQaWNrdXAkID0gb3V0bGV0Q29udGV4dC5waXBlKFxuICAgICAgbWFwKChvcmRlckVudHJ5KSA9PiAhIW9yZGVyRW50cnkucHJvZHVjdC5hdmFpbGFibGVGb3JQaWNrdXApLFxuICAgICAgc3RhcnRXaXRoKGZhbHNlKVxuICAgICk7XG5cbiAgICB0aGlzLnBpY2t1cE9wdGlvbiQgPSBvdXRsZXRDb250ZXh0LnBpcGUoXG4gICAgICB3aXRoTGF0ZXN0RnJvbShcbiAgICAgICAgdGhpcy5hY3RpdmVDYXJ0RmFjYWRlLmdldEFjdGl2ZSgpLnBpcGUoZmlsdGVyKGNhcnRXaXRoSWRBbmRVc2VySWQpKVxuICAgICAgKSxcbiAgICAgIHRhcCgoW29yZGVyRW50cnksIGNhcnRdKSA9PiB7XG4gICAgICAgIHRoaXMuZW50cnlOdW1iZXIgPSBvcmRlckVudHJ5LmVudHJ5TnVtYmVyO1xuICAgICAgICB0aGlzLnF1YW50aXR5ID0gb3JkZXJFbnRyeS5xdWFudGl0eTtcbiAgICAgICAgdGhpcy5wcm9kdWN0Q29kZSA9IG9yZGVyRW50cnkucHJvZHVjdC5jb2RlO1xuICAgICAgICB0aGlzLmNhcnRJZCA9IGNhcnQudXNlci51aWQgPT09ICdhbm9ueW1vdXMnID8gY2FydC5ndWlkIDogY2FydC5jb2RlO1xuICAgICAgICB0aGlzLnVzZXJJZCA9IGNhcnQudXNlci51aWQ7XG4gICAgICB9KSxcbiAgICAgIHN3aXRjaE1hcCgoW29yZGVyRW50cnldKSA9PiB7XG4gICAgICAgIGNvbnN0IHBpY2t1cE9wdGlvbjogUGlja3VwT3B0aW9uID0gb3JkZXJFbnRyeS5kZWxpdmVyeVBvaW50T2ZTZXJ2aWNlXG4gICAgICAgICAgPyAncGlja3VwJ1xuICAgICAgICAgIDogJ2RlbGl2ZXJ5JztcbiAgICAgICAgdGhpcy5waWNrdXBPcHRpb25GYWNhZGUuc2V0UGlja3VwT3B0aW9uKHRoaXMuZW50cnlOdW1iZXIsIHBpY2t1cE9wdGlvbik7XG4gICAgICAgIHJldHVybiB0aGlzLnBpY2t1cE9wdGlvbkZhY2FkZS5nZXRQaWNrdXBPcHRpb24odGhpcy5lbnRyeU51bWJlcik7XG4gICAgICB9KVxuICAgICk7XG5cbiAgICB0aGlzLmRpc2FibGVDb250cm9scyQgPSB0aGlzLmFjdGl2ZUNhcnRGYWNhZGUuZ2V0RW50cmllcygpLnBpcGUoXG4gICAgICBtYXAoKGVudHJpZXMpID0+IGVudHJpZXMubWFwKChlbnRyeSkgPT4gZW50cnkucHJvZHVjdD8uY29kZSkpLFxuICAgICAgc3dpdGNoTWFwKChwcm9kdWN0Q29kZXMpID0+XG4gICAgICAgIG91dGxldENvbnRleHQucGlwZShcbiAgICAgICAgICBtYXAoKG9yZGVyRW50cnkpID0+IG9yZGVyRW50cnk/LnByb2R1Y3QuY29kZSksXG4gICAgICAgICAgbWFwKFxuICAgICAgICAgICAgKG9yZGVyRW50cnkpID0+XG4gICAgICAgICAgICAgIHByb2R1Y3RDb2Rlcy5maWx0ZXIoKHByb2R1Y3RDb2RlKSA9PiBwcm9kdWN0Q29kZSA9PT0gb3JkZXJFbnRyeSlcbiAgICAgICAgICAgICAgICAubGVuZ3RoID4gMVxuICAgICAgICAgIClcbiAgICAgICAgKVxuICAgICAgKVxuICAgICk7XG5cbiAgICB0aGlzLnN0b3JlRGV0YWlscyQgPSBvdXRsZXRDb250ZXh0LnBpcGUoXG4gICAgICBtYXAoKG9yZGVyRW50cnkpID0+ICh7XG4gICAgICAgIHN0b3JlTmFtZTogb3JkZXJFbnRyeS5kZWxpdmVyeVBvaW50T2ZTZXJ2aWNlPy5uYW1lLFxuICAgICAgICBwcm9kdWN0Q29kZTogb3JkZXJFbnRyeS5wcm9kdWN0LmNvZGUsXG4gICAgICB9KSksXG4gICAgICBzd2l0Y2hNYXAoKHsgc3RvcmVOYW1lLCBwcm9kdWN0Q29kZSB9KSA9PlxuICAgICAgICBpaWYoXG4gICAgICAgICAgKCkgPT4gISFzdG9yZU5hbWUsXG4gICAgICAgICAgb2Yoc3RvcmVOYW1lIGFzIHN0cmluZykucGlwZShcbiAgICAgICAgICAgIHRhcCgoX3N0b3JlTmFtZSkgPT4ge1xuICAgICAgICAgICAgICByZXR1cm4gdGhpcy5waWNrdXBMb2NhdGlvbnNTZWFyY2hTZXJ2aWNlLmxvYWRTdG9yZURldGFpbHMoXG4gICAgICAgICAgICAgICAgX3N0b3JlTmFtZVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSksXG4gICAgICAgICAgICBjb25jYXRNYXAoKF9zdG9yZU5hbWUpID0+XG4gICAgICAgICAgICAgIHRoaXMucGlja3VwTG9jYXRpb25zU2VhcmNoU2VydmljZS5nZXRTdG9yZURldGFpbHMoX3N0b3JlTmFtZSlcbiAgICAgICAgICAgICksXG4gICAgICAgICAgICBmaWx0ZXIoKHN0b3JlRGV0YWlscykgPT4gISFzdG9yZURldGFpbHMpLFxuICAgICAgICAgICAgdGFwKChzdG9yZURldGFpbHMpID0+IHtcbiAgICAgICAgICAgICAgdGhpcy5pbnRlbmRlZFBpY2t1cExvY2F0aW9uU2VydmljZS5zZXRJbnRlbmRlZExvY2F0aW9uKFxuICAgICAgICAgICAgICAgIHByb2R1Y3RDb2RlLFxuICAgICAgICAgICAgICAgIHtcbiAgICAgICAgICAgICAgICAgIC4uLnN0b3JlRGV0YWlscyxcbiAgICAgICAgICAgICAgICAgIHBpY2t1cE9wdGlvbjogJ3BpY2t1cCcsXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICApO1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICApLFxuICAgICAgICAgIHRoaXMuaW50ZW5kZWRQaWNrdXBMb2NhdGlvblNlcnZpY2VcbiAgICAgICAgICAgIC5nZXRJbnRlbmRlZExvY2F0aW9uKHByb2R1Y3RDb2RlKVxuICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgIG1hcCgoaW50ZW5kZWRMb2NhdGlvbikgPT4gKHtcbiAgICAgICAgICAgICAgICBpbnRlbmRlZExvY2F0aW9uLFxuICAgICAgICAgICAgICAgIGdpdmVuUHJvZHVjdENvZGU6IHByb2R1Y3RDb2RlLFxuICAgICAgICAgICAgICB9KSksXG4gICAgICAgICAgICAgIHN3aXRjaE1hcCgoeyBpbnRlbmRlZExvY2F0aW9uLCBnaXZlblByb2R1Y3RDb2RlIH0pID0+XG4gICAgICAgICAgICAgICAgaWlmKFxuICAgICAgICAgICAgICAgICAgKCkgPT4gISFpbnRlbmRlZExvY2F0aW9uICYmICEhaW50ZW5kZWRMb2NhdGlvbi5kaXNwbGF5TmFtZSxcbiAgICAgICAgICAgICAgICAgIG9mKHtcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IGdldFByb3BlcnR5KGludGVuZGVkTG9jYXRpb24sICdkaXNwbGF5TmFtZScpLFxuICAgICAgICAgICAgICAgICAgICBuYW1lOiBnZXRQcm9wZXJ0eShpbnRlbmRlZExvY2F0aW9uLCAnbmFtZScpLFxuICAgICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgICB0aGlzLnByZWZlcnJlZFN0b3JlRmFjYWRlXG4gICAgICAgICAgICAgICAgICAgIC5nZXRQcmVmZXJyZWRTdG9yZVdpdGhQcm9kdWN0SW5TdG9jayhwcm9kdWN0Q29kZSlcbiAgICAgICAgICAgICAgICAgICAgLnBpcGUoXG4gICAgICAgICAgICAgICAgICAgICAgbWFwKCh7IG5hbWUgfSkgPT4gbmFtZSksXG4gICAgICAgICAgICAgICAgICAgICAgdGFwKChfc3RvcmVOYW1lKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5waWNrdXBMb2NhdGlvbnNTZWFyY2hTZXJ2aWNlLmxvYWRTdG9yZURldGFpbHMoXG4gICAgICAgICAgICAgICAgICAgICAgICAgIF9zdG9yZU5hbWVcbiAgICAgICAgICAgICAgICAgICAgICAgIClcbiAgICAgICAgICAgICAgICAgICAgICApLFxuICAgICAgICAgICAgICAgICAgICAgIGNvbmNhdE1hcCgoX3N0b3JlTmFtZTogc3RyaW5nKSA9PlxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5waWNrdXBMb2NhdGlvbnNTZWFyY2hTZXJ2aWNlLmdldFN0b3JlRGV0YWlscyhcbiAgICAgICAgICAgICAgICAgICAgICAgICAgX3N0b3JlTmFtZVxuICAgICAgICAgICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICAgICAgICAgICksXG4gICAgICAgICAgICAgICAgICAgICAgZmlsdGVyKChzdG9yZURldGFpbHMpID0+ICEhc3RvcmVEZXRhaWxzKSxcbiAgICAgICAgICAgICAgICAgICAgICB0YXAoKHN0b3JlRGV0YWlscykgPT4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5pbnRlbmRlZFBpY2t1cExvY2F0aW9uU2VydmljZS5zZXRJbnRlbmRlZExvY2F0aW9uKFxuICAgICAgICAgICAgICAgICAgICAgICAgICBnaXZlblByb2R1Y3RDb2RlLFxuICAgICAgICAgICAgICAgICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgLi4uc3RvcmVEZXRhaWxzLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBpY2t1cE9wdGlvbjogJ2RlbGl2ZXJ5JyxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgICAgKVxuICAgICAgICAgICAgICApXG4gICAgICAgICAgICApXG4gICAgICAgIClcbiAgICAgICksXG4gICAgICBtYXAoKHsgZGlzcGxheU5hbWUsIG5hbWUgfSkgPT4gKHsgZGlzcGxheU5hbWUsIG5hbWUgfSkpLFxuICAgICAgdGFwKChfKSA9PiAodGhpcy5kaXNwbGF5TmFtZUlzU2V0ID0gdHJ1ZSkpXG4gICAgKTtcbiAgfVxuXG4gIG9uUGlja3VwT3B0aW9uQ2hhbmdlKHBpY2t1cE9wdGlvbjogUGlja3VwT3B0aW9uKTogdm9pZCB7XG4gICAgdGhpcy5waWNrdXBPcHRpb25GYWNhZGUuc2V0UGlja3VwT3B0aW9uKHRoaXMuZW50cnlOdW1iZXIsIHBpY2t1cE9wdGlvbik7XG4gICAgaWYgKHBpY2t1cE9wdGlvbiA9PT0gJ2RlbGl2ZXJ5Jykge1xuICAgICAgdGhpcy5hY3RpdmVDYXJ0RmFjYWRlLnVwZGF0ZUVudHJ5KFxuICAgICAgICB0aGlzLmVudHJ5TnVtYmVyLFxuICAgICAgICB0aGlzLnF1YW50aXR5LFxuICAgICAgICB1bmRlZmluZWQsXG4gICAgICAgIHRydWVcbiAgICAgICk7XG4gICAgICByZXR1cm47XG4gICAgfVxuICAgIFtwaWNrdXBPcHRpb25dXG4gICAgICAuZmlsdGVyKChvcHRpb24pID0+IG9wdGlvbiA9PT0gJ3BpY2t1cCcpXG4gICAgICAuZm9yRWFjaCgoKSA9PiB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9uLmFkZChcbiAgICAgICAgICB0aGlzLnN0b3JlRGV0YWlscyRcbiAgICAgICAgICAgIC5waXBlKFxuICAgICAgICAgICAgICBmaWx0ZXIoKHsgbmFtZSB9KSA9PiAhIW5hbWUpLFxuICAgICAgICAgICAgICB0YXAoKHsgbmFtZSB9KSA9PlxuICAgICAgICAgICAgICAgIHRoaXMuYWN0aXZlQ2FydEZhY2FkZS51cGRhdGVFbnRyeShcbiAgICAgICAgICAgICAgICAgIHRoaXMuZW50cnlOdW1iZXIsXG4gICAgICAgICAgICAgICAgICB0aGlzLnF1YW50aXR5LFxuICAgICAgICAgICAgICAgICAgbmFtZSxcbiAgICAgICAgICAgICAgICAgIHRydWVcbiAgICAgICAgICAgICAgICApXG4gICAgICAgICAgICAgIClcbiAgICAgICAgICAgIClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoKVxuICAgICAgICApO1xuICAgICAgfSk7XG5cbiAgICBpZiAoIXRoaXMuZGlzcGxheU5hbWVJc1NldCkge1xuICAgICAgdGhpcy5vcGVuRGlhbG9nKCk7XG4gICAgfVxuICB9XG5cbiAgbmdPbkRlc3Ryb3koKTogdm9pZCB7XG4gICAgdGhpcy5zdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKTtcbiAgfVxuXG4gIG9wZW5EaWFsb2coKTogdm9pZCB7XG4gICAgY29uc3QgZGlhbG9nID0gdGhpcy5sYXVuY2hEaWFsb2dTZXJ2aWNlLm9wZW5EaWFsb2coXG4gICAgICBMQVVOQ0hfQ0FMTEVSLlBJQ0tVUF9JTl9TVE9SRSxcbiAgICAgIHRoaXMuZWxlbWVudCxcbiAgICAgIHRoaXMudmNyLFxuICAgICAge1xuICAgICAgICBwcm9kdWN0Q29kZTogdGhpcy5wcm9kdWN0Q29kZSxcbiAgICAgICAgZW50cnlOdW1iZXI6IHRoaXMuZW50cnlOdW1iZXIsXG4gICAgICAgIHF1YW50aXR5OiB0aGlzLnF1YW50aXR5LFxuICAgICAgfVxuICAgICk7XG5cbiAgICBpZiAoZGlhbG9nKSB7XG4gICAgICBkaWFsb2cucGlwZSh0YWtlKDEpKS5zdWJzY3JpYmUoKTtcbiAgICB9XG4gIH1cbn1cbiIsIjxuZy1jb250YWluZXJcbiAgKm5nSWY9XCJcbiAgICAoYXZhaWxhYmxlRm9yUGlja3VwJCB8IGFzeW5jKSAmJlxuICAgICEob3V0bGV0Py5jb250ZXh0JCB8IGFzeW5jKT8ub3JkZXJDb2RlICYmXG4gICAgISh0aGlzLmNhcnRUeXBlID09PSBDYXJ0VHlwZS5TRUxFQ1RJVkUpXG4gIFwiXG4+XG4gIDxjeC1waWNrdXAtb3B0aW9uc1xuICAgIFtkaXNhYmxlQ29udHJvbHNdPVwiZGlzYWJsZUNvbnRyb2xzJCB8IGFzeW5jXCJcbiAgICBbZGlzcGxheVBpY2t1cExvY2F0aW9uXT1cIihzdG9yZURldGFpbHMkIHwgYXN5bmMpPy5kaXNwbGF5TmFtZVwiXG4gICAgW3NlbGVjdGVkT3B0aW9uXT1cInBpY2t1cE9wdGlvbiQgfCBhc3luY1wiXG4gICAgKHBpY2t1cE9wdGlvbkNoYW5nZSk9XCJvblBpY2t1cE9wdGlvbkNoYW5nZSgkZXZlbnQpXCJcbiAgICAocGlja3VwTG9jYXRpb25DaGFuZ2UpPVwib3BlbkRpYWxvZygpXCJcbiAgPjwvY3gtcGlja3VwLW9wdGlvbnM+XG48L25nLWNvbnRhaW5lcj5cbiJdfQ==